<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>RestTemplate 使用</title>
      <link href="2022/02/27/yuque/RestTemplate%20%E4%BD%BF%E7%94%A8/"/>
      <url>2022/02/27/yuque/RestTemplate%20%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h2><p>restTemplate 是 spring 提供的基于 restful 设计的 http 请求客户端。</p><h2 id="使用介绍"><a href="#使用介绍" class="headerlink" title="使用介绍"></a>使用介绍</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>springboot 默认提供了 restTemplate 相关的 Bean，但也可以通过手动注册同类型的 bean 来自定义一些配置，如通用的请求头，拦截器等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">(ClientHttpRequestFactory factory)</span> </span>&#123;</span><br><span class="line">    RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(factory);</span><br><span class="line">    <span class="comment">// 其他设置，如：拦截器、消息处理器等</span></span><br><span class="line">    <span class="keyword">return</span> restTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><p>一般的会将特定功能的拦截器，注册到独立的 restTemplate bean 中，即设置多个 restTemplate bean（默认同类型下只能存在一个 bean，可以使用包装类，装饰器）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义自定义拦截器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomInterceptor</span> <span class="keyword">implements</span> <span class="title">ClientHttpRequestInterceptor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">intercept</span><span class="params">(HttpRequest request, <span class="keyword">byte</span>[] body, ClientHttpRequestExecution execution)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 自定义方法体</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 执行完毕后放行请求</span></span><br><span class="line">        <span class="keyword">return</span> execution.execute(request, body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 添加拦截器</span></span><br><span class="line">restTemplate.getInterceptors().add(<span class="keyword">new</span> CustomInterceptor())</span><br></pre></td></tr></table></figure><h3 id="自定义消息转换器"><a href="#自定义消息转换器" class="headerlink" title="自定义消息转换器"></a>自定义消息转换器</h3><p>项目中经常使用 <code>FastJson</code> 替换 <code>Jackson</code>，实际上项目中存在一个 Json 处理工具即可，（<code>Jackson</code> 挺好用的，感觉 Bug 少多了）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRestTemplate</span><span class="params">(RestTemplate restTemplate)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 重新设置了消息转换器集合，通过遍历过滤了原有的 Jackson 处理器，最后添加了 FastJson 处理器</span></span><br><span class="line">    <span class="comment">// 也可以直接在原有的 list 中使用 remove 去除，再添加</span></span><br><span class="line">    List&lt;HttpMessageConverter&lt;?&gt;&gt; converters = restTemplate.getMessageConverters();</span><br><span class="line">    List&lt;HttpMessageConverter&lt;?&gt;&gt; convertersValid = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; converter : converters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (converter <span class="keyword">instanceof</span> MappingJackson2HttpMessageConverter</span><br><span class="line">                || converter <span class="keyword">instanceof</span> MappingJackson2XmlHttpMessageConverter) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        convertersValid.add(converter);</span><br><span class="line">    &#125;</span><br><span class="line">    convertersValid.add(fastJsonHttpMessageConverter());</span><br><span class="line">    restTemplate.setMessageConverters(convertersValid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * fastJson 消息转换器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> fastJson 消息转换器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> FastJsonHttpMessageConverter <span class="title">fastJsonHttpMessageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;MediaType&gt; mediaTypes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    mediaTypes.add(MediaType.APPLICATION_JSON);</span><br><span class="line">    FastJsonConfig fastJsonConfig = <span class="keyword">new</span> FastJsonConfig();</span><br><span class="line">    fastJsonConfig.setSerializerFeatures(SerializerFeature.DisableCircularReferenceDetect,</span><br><span class="line">            SerializerFeature.WriteMapNullValue,</span><br><span class="line">            SerializerFeature.WriteDateUseDateFormat);</span><br><span class="line">    fastJsonConfig.setDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">    GsonHttpMessageConverter gsonHttpMessageConverter = <span class="keyword">new</span> GsonHttpMessageConverter();</span><br><span class="line">    gsonHttpMessageConverter.setSupportedMediaTypes(mediaTypes);</span><br><span class="line">    FastJsonHttpMessageConverter fastConverter = <span class="keyword">new</span> FastJsonHttpMessageConverter();</span><br><span class="line">    fastConverter.setSupportedMediaTypes(mediaTypes);</span><br><span class="line">    fastConverter.setFastJsonConfig(fastJsonConfig);</span><br><span class="line">    <span class="keyword">return</span> fastConverter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Get-参数设置"><a href="#Get-参数设置" class="headerlink" title="Get 参数设置"></a>Get 参数设置</h3><p>使用 restful 占位符，设置方式和 controller 层一致，如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testGetParam</span><span class="params">()</span> </span>&#123;</span><br><span class="line">restTemplate.getForObject(</span><br><span class="line">        <span class="string">&#x27;route?param1=&#123;param1&#125;&amp;param2=&#123;param2&#125;&#x27;</span>,</span><br><span class="line">        T.class,</span><br><span class="line">        ...参数</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>ps：当然参数也可以使用 Map</em></p><h3 id="List-类型结果"><a href="#List-类型结果" class="headerlink" title="List 类型结果"></a>List 类型结果</h3><p>对于任意使用 List<T> 的结果集，在泛型类型设置上，使用 <code>T[].class</code> 替代，可以很好的避免 List&lt;?&gt; 无法获取具体类型的问题。<br>当然也可以使用 <code>new ParameterizedTypeReference&lt;List&lt;T&gt;&gt;()&#123;&#125;</code>，但其本身是通过生成匿名类（类中的泛型不会被擦除）的方式来记录泛型信息。<br>使用数组类型无疑更简洁优雅。</p><h3 id="自定义-header"><a href="#自定义-header" class="headerlink" title="自定义 header"></a>自定义 header</h3><h4 id="使用-exchange-方法"><a href="#使用-exchange-方法" class="headerlink" title="使用 exchange 方法"></a>使用 exchange 方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HttpHeaders requestHeaders = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">    HttpEntity&lt;UserModel[]&gt; request = <span class="keyword">new</span> HttpEntity&lt;&gt;(requestHeaders);</span><br><span class="line">    val result = restTemplate.exchange(</span><br><span class="line">            <span class="string">&quot;路由&quot;</span>,</span><br><span class="line">            HttpMethod.GET,</span><br><span class="line">            request,</span><br><span class="line">            T[].class,</span><br><span class="line">            ...参数</span><br><span class="line">    ).getBody();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="使用-execute-方法"><a href="#使用-execute-方法" class="headerlink" title="使用 execute 方法"></a>使用 execute 方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testExecute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HttpHeaders requestHeaders = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">    HttpEntity&lt;UserModel[]&gt; request = <span class="keyword">new</span> HttpEntity&lt;&gt;(requestHeaders);</span><br><span class="line">        val requestCallback = restTemplate.httpEntityCallback(request, T[].class);</span><br><span class="line">        val responseExtractor = restTemplate.responseEntityExtractor(T[].class);</span><br><span class="line">        val result = restTemplate.execute(</span><br><span class="line">                <span class="string">&quot;路由&quot;</span>,</span><br><span class="line">                HttpMethod.GET,</span><br><span class="line">                requestCallback,</span><br><span class="line">                responseExtractor,</span><br><span class="line">                ...参数</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring Boot </category>
          
          <category> Rest Template </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> Rest Template </tag>
            
            <tag> Http 请求 </tag>
            
            <tag> Restful </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WebMvc 测试</title>
      <link href="2022/02/26/yuque/WebMvc%20%E6%B5%8B%E8%AF%95/"/>
      <url>2022/02/26/yuque/WebMvc%20%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h2 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h2><p>需要对 api 编写测试类，可以采用的方式：</p><ol><li>MockMvc</li><li>RestTemple</li></ol><p>但是由于 MockMvc 的结果值是字符串，虽然提供了 jsonPath 方法解析，但是处理过程丧失了面向对象的优雅，可能其对于 controller 层作单元测试，结合 MockBean，应当会更方便，轻量；而在处理完整的 api 测试，使用 restTemplate 通过泛型可以直接获取到结果对象，处理过程更灵活。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><h3 id="获取端口号"><a href="#获取端口号" class="headerlink" title="获取端口号"></a>获取端口号</h3><p><em>ps：使用 RestTemplate 是需要获取端口号的。</em><br>在启用 <code>@SpringBootTest</code> 时，无法直接从配置文件读取端口号，需要指定 ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(</span></span><br><span class="line"><span class="meta">        classes = SampleApplication.class,</span></span><br><span class="line"><span class="meta">        // 启用配置文件中定义的端口号</span></span><br><span class="line"><span class="meta">    // 也可以通过枚举值切换为随机端口等</span></span><br><span class="line"><span class="meta">        webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure><p>否则会出现 -1 或 null 的情况，之后可以通过常规的 spring 注入方式，来获取端口号，如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. server.port 或 local.server.port</span></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. @Value(&quot;$&#123;local.server.port&#125;&quot;) 等价注解</span></span><br><span class="line"><span class="meta">@LocalServerPort</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 环境变量</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">Environment environment;</span><br><span class="line"><span class="keyword">this</span>.environment.getProperty(<span class="string">&quot;server.port&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="MockMvc"><a href="#MockMvc" class="headerlink" title="MockMvc"></a>MockMvc</h3><p>期间也是测试了 MockMvc 的使用，需要 <code>@AutoConfigureMockMvc</code> 注解在测试类上，启用相关配置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testMockMvc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String expected = <span class="string">&quot;预期的 json 字符串&quot;</span>;</span><br><span class="line">        mockMvc.perform(</span><br><span class="line">                            MockMvcRequestBuilders</span><br><span class="line">                                    .get(<span class="string">&quot;路由&quot;</span>)</span><br><span class="line">                    )</span><br><span class="line">                    .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">                    .andExpect(MockMvcResultMatchers.content().json(expected))</span><br><span class="line">                    .andDo(MockMvcResultHandlers.print());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="使用异常"><a href="#使用异常" class="headerlink" title="使用异常"></a>使用异常</h4><p>但使用过程并不顺利，遇到了以下异常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.util.NestedServletException: Request processing failed; nested exception is java.lang.NullPointerException</span><br><span class="line"></span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:898)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:626)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:883)</span><br><span class="line">at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:733)</span><br></pre></td></tr></table></figure><p>通过异常信息，只能获取到空指针异常，无法直接定位到触发原因，但实际上是由于测试时，没有添加请求参数引起的，因此在遇到类似的异常时，需要注意请求本身是否存在违规的操作，缺失 header、参数等信息。</p>]]></content>
      
      
      <categories>
          
          <category> Spring Boot </category>
          
          <category> Unit Test </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> Unit Test </tag>
            
            <tag> MVC </tag>
            
            <tag> Mock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>async setup() 引发异常</title>
      <link href="2021/12/09/yuque/async%20setup()%20%E5%BC%95%E5%8F%91%E5%BC%82%E5%B8%B8/"/>
      <url>2021/12/09/yuque/async%20setup()%20%E5%BC%95%E5%8F%91%E5%BC%82%E5%B8%B8/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在 uniapp 项目中使用 vue3 开发，在 setup script 标签中使用顶层 await 语句，导致页面空白，而控制台打印异常。</p><h3 id="项目环境"><a href="#项目环境" class="headerlink" title="项目环境"></a>项目环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">编译器: HBX 3.3 Beta</span><br><span class="line">vue: 3.2.23</span><br></pre></td></tr></table></figure><h3 id="异常原因"><a href="#异常原因" class="headerlink" title="异常原因"></a>异常原因</h3><p>这是因为 <a href="https://v3.cn.vuejs.org/api/sfc-script-setup.html#%E9%A1%B6%E5%B1%82-await">顶层 await</a> 必须配合 async setup() 必须与 <code>Suspense</code> 组合使用，而<a href="https://ask.dcloud.net.cn/article/id-37834">当前版本的 uniapp 并不支持该组件</a>。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>在 setup script 中使用 <a href="https://vue3js.cn/global/nextTick.html">nextTick</a> 方法，在回调中使用 await 语句，而非在顶层使用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref, nextTick &#125; from &quot;vue&quot;;</span><br><span class="line">&#x2F;&#x2F; 定义任意响应对象</span><br><span class="line">const anything &#x3D; ref(&quot;hello&quot;);</span><br><span class="line">nextTick(async () &#x3D;&gt; &#123;</span><br><span class="line">  &#x2F;&#x2F; 执行异步方法</span><br><span class="line">  const res &#x3D; await asyncFunction();</span><br><span class="line">  &#x2F;&#x2F; 将返回结果，回写到响应对象的值中</span><br><span class="line">  anything.value &#x3D; res;</span><br><span class="line">&#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Vue3 </category>
          
          <category> 异常 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue3 </tag>
            
            <tag> Uniapp </tag>
            
            <tag> async setup </tag>
            
            <tag> 异常 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>重复参数校验</title>
      <link href="2021/11/22/yuque/%E9%87%8D%E5%A4%8D%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C/"/>
      <url>2021/11/22/yuque/%E9%87%8D%E5%A4%8D%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>需要对列表数据中某个字段验重。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>通过自定义注解，借助 spring 参数校验框架，抽象通用逻辑，通过反射获取字段值进行比较。</p><h3 id="注解-NoRepeat"><a href="#注解-NoRepeat" class="headerlink" title="注解 - NoRepeat"></a>注解 - NoRepeat</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 非重复校验</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> daiwenzh5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/11/22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER&#125;)</span></span><br><span class="line"><span class="meta">@Repeatable(NotRepeat.List.class)</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = NotRepeatConstraintValidator.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NotRepeat &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字段名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">field</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增强校验方法注册的 bean 名称 &lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 可以将数据库查重注册为 bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">beanName</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> &quot;</span>&#123;javax.validation.constraints.NotRepeat.message&#125;<span class="string">&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Class&lt;?&gt;[] groups() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @Target(&#123;METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER&#125;)</span></span><br><span class="line"><span class="string">    @Retention(RUNTIME)</span></span><br><span class="line"><span class="string">    @Documented</span></span><br><span class="line"><span class="string">    @interface List &#123;</span></span><br><span class="line"><span class="string">        NotRepeat[] value();</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="校验逻辑"><a href="#校验逻辑" class="headerlink" title="校验逻辑"></a>校验逻辑</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 非重复字段校验</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> daiwenzh5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/11/22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotRepeatConstraintValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">NotRepeat</span>, <span class="title">List</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String field;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;java:S3740&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> IRepeatValidator bean;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(NotRepeat constraintAnnotation)</span> </span>&#123;</span><br><span class="line">        field = constraintAnnotation.field();</span><br><span class="line">        message = constraintAnnotation.message();</span><br><span class="line">        <span class="keyword">if</span> (CharSequenceUtil.isNotEmpty(constraintAnnotation.beanName())) &#123;</span><br><span class="line">            bean = SpringUtil.getBean(constraintAnnotation.beanName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(List&lt;?&gt; value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        Consumer&lt;String&gt; setMessage = param -&gt; &#123;</span><br><span class="line">            context.disableDefaultConstraintViolation();</span><br><span class="line">            context.buildConstraintViolationWithTemplate(String.format(</span><br><span class="line">                            message,</span><br><span class="line">                            param</span><br><span class="line">                    ))</span><br><span class="line">                    .addConstraintViolation();</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">var</span> first = findInList(value);</span><br><span class="line">        <span class="keyword">if</span> (first.isPresent()) &#123;</span><br><span class="line">            setMessage.accept(String.format(</span><br><span class="line">                    message,</span><br><span class="line">                    first.get()</span><br><span class="line">            ));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">            first = findInBean(value);</span><br><span class="line">            <span class="keyword">if</span> (first.isPresent()) &#123;</span><br><span class="line">                setMessage.accept(first.get());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从 bean 方法中查找重复项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Optional&lt;String&gt; <span class="title">findInBean</span><span class="params">(List&lt;?&gt; value)</span> </span>&#123;</span><br><span class="line">        Optional&lt;String&gt; first;</span><br><span class="line">        <span class="comment">//noinspection unchecked</span></span><br><span class="line">        first = bean.pick(value)</span><br><span class="line">                .stream()</span><br><span class="line">                .map(Object::toString)</span><br><span class="line">                .sorted()</span><br><span class="line">                .findFirst();</span><br><span class="line">        <span class="keyword">return</span> first;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从参数中查找</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Optional&lt;String&gt; <span class="title">findInList</span><span class="params">(List&lt;?&gt; value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value.stream()</span><br><span class="line">                <span class="comment">// 获取字段值</span></span><br><span class="line">                .map(<span class="keyword">this</span>::getValue)</span><br><span class="line">                <span class="comment">// 去除 null 值</span></span><br><span class="line">                .filter(Objects::nonNull)</span><br><span class="line">                <span class="comment">// 按值分组，并统计数量</span></span><br><span class="line">                .collect(Collectors.groupingBy(</span><br><span class="line">                        Function.identity(),</span><br><span class="line">                        Collectors.counting()</span><br><span class="line">                )).entrySet()</span><br><span class="line">                .stream()</span><br><span class="line">                <span class="comment">// 筛选数量大于 1</span></span><br><span class="line">                .filter(it -&gt; it.getValue() &gt; <span class="number">1</span>)</span><br><span class="line">                <span class="comment">// 取第一个数</span></span><br><span class="line">                .findFirst()</span><br><span class="line">                .map(Map.Entry::getKey)</span><br><span class="line">                .map(Object::toString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">getValue</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ReflectUtil.getFieldValue(object, field);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="增强校验方法"><a href="#增强校验方法" class="headerlink" title="增强校验方法"></a>增强校验方法</h3><h4 id="简单的建造工厂"><a href="#简单的建造工厂" class="headerlink" title="简单的建造工厂"></a>简单的建造工厂</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于 mybatis plus 的重复校验简单工厂</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> daiwenzh5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/11/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@UtilityClass</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepeatValidatorMybatisPlusFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个基于 mybatis plus 的&#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> baseMapper 基于 mybatis plus mapper 类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> field      字段名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> getter     字段的 getter 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;        待校验数据的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt;        mapper 映射的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, R&gt; <span class="function">IRepeatValidator&lt;T&gt; <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            BaseMapper&lt;R&gt; baseMapper,</span></span></span><br><span class="line"><span class="function"><span class="params">            String field,</span></span></span><br><span class="line"><span class="function"><span class="params">            Function&lt;T, String&gt; getter</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> create(baseMapper, field, getter, (list, rQueryWrapper) -&gt; rQueryWrapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个基于 mybatis plus 的&#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> baseMapper  基于 mybatis plus mapper 类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> field       字段名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> getter      字段的 getter 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> moreWrapper 更多查询条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;         待校验数据的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt;         mapper 映射的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, R&gt; <span class="function">IRepeatValidator&lt;T&gt; <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            BaseMapper&lt;R&gt; baseMapper,</span></span></span><br><span class="line"><span class="function"><span class="params">            String field,</span></span></span><br><span class="line"><span class="function"><span class="params">            Function&lt;T, String&gt; getter,</span></span></span><br><span class="line"><span class="function"><span class="params">            BiFunction&lt;List&lt;T&gt;, QueryWrapper&lt;R&gt;, QueryWrapper&lt;R&gt;&gt; moreWrapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> list -&gt; &#123;</span><br><span class="line">            val collect = list.stream()</span><br><span class="line">                    .map(getter)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            <span class="keyword">return</span> baseMapper.selectObjs(</span><br><span class="line">                    moreWrapper.apply(list, <span class="keyword">new</span> QueryWrapper&lt;R&gt;()</span><br><span class="line">                            .select(field)</span><br><span class="line">                            .in(field, collect))</span><br><span class="line">            );</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个基于 mybatis plus 的&#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125; &lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 防止更新时和自身发生验重</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> baseMapper 基于 mybatis plus mapper 类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> field      字段名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> getter     字段的 getter 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id         主键名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idGetter   主键的 getter 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;        待校验数据的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt;        mapper 映射的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, R&gt; <span class="function">IRepeatValidator&lt;T&gt; <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            BaseMapper&lt;R&gt; baseMapper,</span></span></span><br><span class="line"><span class="function"><span class="params">            String field,</span></span></span><br><span class="line"><span class="function"><span class="params">            Function&lt;T, String&gt; getter,</span></span></span><br><span class="line"><span class="function"><span class="params">            String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            Function&lt;T, Object&gt; idGetter</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> create(baseMapper, field, getter, id, idGetter, (list, rQueryWrapper) -&gt; rQueryWrapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个基于 mybatis plus 的&#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125; &lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 防止更新时和自身发生验重</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> baseMapper  基于 mybatis plus mapper 类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> field       字段名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> getter      字段的 getter 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id          主键名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idGetter    主键的 getter 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> moreWrapper 更多查询条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;         待校验数据的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt;         mapper 映射的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, R&gt; <span class="function">IRepeatValidator&lt;T&gt; <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            BaseMapper&lt;R&gt; baseMapper,</span></span></span><br><span class="line"><span class="function"><span class="params">            String field,</span></span></span><br><span class="line"><span class="function"><span class="params">            Function&lt;T, String&gt; getter,</span></span></span><br><span class="line"><span class="function"><span class="params">            String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            Function&lt;T, Object&gt; idGetter,</span></span></span><br><span class="line"><span class="function"><span class="params">            BiFunction&lt;List&lt;T&gt;, QueryWrapper&lt;R&gt;, QueryWrapper&lt;R&gt;&gt; moreWrapper</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> create(baseMapper, field, getter, (list, rQueryWrapper) -&gt; &#123;</span><br><span class="line">            val ids = list.stream().map(idGetter).collect(Collectors.toList());</span><br><span class="line">            <span class="keyword">return</span> moreWrapper.apply(list, rQueryWrapper.notIn(</span><br><span class="line">                    !ids.isEmpty(),</span><br><span class="line">                    id,</span><br><span class="line">                    ids</span><br><span class="line">            ));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="注册方法"><a href="#注册方法" class="headerlink" title="注册方法"></a>注册方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IRepeatValidator&lt;T&gt; <span class="title">checkSomeField</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RepeatValidatorMybatisPlusFactory.create(</span><br><span class="line">            mapper,</span><br><span class="line">            <span class="string">&quot;字段&quot;</span>,</span><br><span class="line">            T::getField</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>对于更新时的校验，为了防止字段值未修改，但因为在库中查询已存在，导致异常的情况，应该将 id 作为查询条件，筛选出所有不在 id 列表中的数据。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IRepeatValidator&lt;T&gt; <span class="title">checkSomeField</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RepeatValidatorMybatisPlusFactory.create(</span><br><span class="line">            mapper,</span><br><span class="line">            <span class="string">&quot;字段&quot;</span>,</span><br><span class="line">            T::getField,</span><br><span class="line">        <span class="string">&quot;主键&quot;</span>,</span><br><span class="line">        T::getId</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> 参数校验 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 注解 </tag>
            
            <tag> Spring </tag>
            
            <tag> 参数校验 </tag>
            
            <tag> 自定义 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloud Config</title>
      <link href="2021/11/16/yuque/Spring%20Cloud%20Config/"/>
      <url>2021/11/16/yuque/Spring%20Cloud%20Config/</url>
      
        <content type="html"><![CDATA[<h2 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.3.7.RELEASE<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR9<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="常用-API"><a href="#常用-API" class="headerlink" title="常用 API"></a>常用 API</h2><h3 id="查看配置"><a href="#查看配置" class="headerlink" title="查看配置"></a>查看配置</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url = <span class="string">`&#123;&#123;ip&#125;&#125;:&#123;&#123;port&#125;&#125;/&#123;&#123;applitionName&#125;&#125;-&#123;&#123;env&#125;&#125;.yml`</span>;</span><br><span class="line"># 如 http://localhost:10001/client-dev.yml</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1637032589754-b2c9fdd0-f697-4f23-918a-56e0bf8fec20.png#clientId=u91d7d860-cb11-4&from=paste&id=u62516e5c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=129&originWidth=585&originalType=binary%E2%88%B6=1&size=6077&status=done&style=none&taskId=u1cc0e5a8-e346-4c47-a518-b8f4c814de5" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1637032589754-b2c9fdd0-f697-4f23-918a-56e0bf8fec20.png#clientId=u91d7d860-cb11-4&from=paste&id=u62516e5c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=129&originWidth=585&originalType=binary%E2%88%B6=1&size=6077&status=done&style=none&taskId=u1cc0e5a8-e346-4c47-a518-b8f4c814de5" srcset="data:image/png;base64,666" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1637032674037-fdea1b41-ef54-4beb-bef1-47e57c6f0243.png#clientId=u91d7d860-cb11-4&from=paste&id=uf925558c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=124&originWidth=361&originalType=binary%E2%88%B6=1&size=9926&status=done&style=none&taskId=u6930f939-1e03-4a05-8d3b-933922827ca" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1637032674037-fdea1b41-ef54-4beb-bef1-47e57c6f0243.png#clientId=u91d7d860-cb11-4&from=paste&id=uf925558c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=124&originWidth=361&originalType=binary%E2%88%B6=1&size=9926&status=done&style=none&taskId=u6930f939-1e03-4a05-8d3b-933922827ca" srcset="data:image/png;base64,666" alt="image.png"></p><h2 id="本地模式"><a href="#本地模式" class="headerlink" title="本地模式"></a>本地模式</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-server</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">native</span> <span class="comment"># 本地配置的固定启动环境</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">native:</span></span><br><span class="line">          <span class="attr">search-locations:</span> <span class="string">file:///本机地址，支持</span> <span class="string">classpath</span></span><br></pre></td></tr></table></figure><h3 id="环境异常"><a href="#环境异常" class="headerlink" title="环境异常"></a>环境异常</h3><p>当没有指定 <code>spring.profiles.active=native</code> 时，以读取 Git 仓库为配置，出现以下异常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">***************************</span><br><span class="line">APPLICATION FAILED TO START</span><br><span class="line">***************************</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line"></span><br><span class="line">Invalid config server configuration.</span><br><span class="line"></span><br><span class="line">Action:</span><br><span class="line"></span><br><span class="line">If you are using the git profile, you need to set a Git URI in your configuration.  If you are using a native profile and have spring.cloud.config.server.bootstrap&#x3D;true, you need to use a composite configuration.</span><br></pre></td></tr></table></figure><p><strong>注意：</strong>谨防在全局配置了环境变量，由于在系统环境变量中设置了公司常用的环境名，导致配置文件中的激活项被覆盖，而一直无法启动。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1637032468567-08fe3bb9-db11-4448-9ec1-14dc678abab7.png#clientId=u91d7d860-cb11-4&from=paste&height=122&id=ude234aea&margin=%5Bobject%20Object%5D&name=image.png&originHeight=243&originWidth=953&originalType=binary%E2%88%B6=1&size=20704&status=done&style=none&taskId=u8d933ff8-c5b1-421c-9777-4ee2be92e96&width=476.5" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1637032468567-08fe3bb9-db11-4448-9ec1-14dc678abab7.png#clientId=u91d7d860-cb11-4&from=paste&height=122&id=ude234aea&margin=%5Bobject%20Object%5D&name=image.png&originHeight=243&originWidth=953&originalType=binary%E2%88%B6=1&size=20704&status=done&style=none&taskId=u8d933ff8-c5b1-421c-9777-4ee2be92e96&width=476.5" srcset="data:image/png;base64,666" alt="image.png"></p><h2 id="Git-模式"><a href="#Git-模式" class="headerlink" title="Git 模式"></a>Git 模式</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">file:///本机地址</span></span><br></pre></td></tr></table></figure><h3 id="本地仓库"><a href="#本地仓库" class="headerlink" title="本地仓库"></a>本地仓库</h3><p>支持设置 uri 为本地路径，但需要该仓库存在，并且访问的配置（如：client-dev.yml）已被 git 托管。</p><h3 id="远程仓库"><a href="#远程仓库" class="headerlink" title="远程仓库"></a>远程仓库</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">仓库地址</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">用户名</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">密码</span></span><br></pre></td></tr></table></figure><h4 id="加密密码"><a href="#加密密码" class="headerlink" title="加密密码"></a>加密密码</h4><p>由于在项目中使用明文配置密码，不太合适，较好的方式使用对其进行加密。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.ulisesbocchio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jasypt-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 版本号，以 maven 仓库中的配适为准 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jasypt:</span></span><br><span class="line">  <span class="attr">encryptor:</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">加密密码</span></span><br></pre></td></tr></table></figure><p>使用方式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">encrypt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Assertions.assertDoesNotThrow(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> String encrypt = stringEncryptor.encrypt(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        System.out.println(encrypt);</span><br><span class="line">        Assertions.assertEquals(</span><br><span class="line">                <span class="string">&quot;123456&quot;</span>,</span><br><span class="line">                stringEncryptor.decrypt(encrypt)</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在程序中打印出加密后的字符串，并在配置文件中使用 <code>ENC()</code> 包裹，标识其为一串加密字符。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 仅展示密码部分</span></span><br><span class="line"><span class="attr">git:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">ENC(加密字符)</span></span><br></pre></td></tr></table></figure><h2 id="安全认证"><a href="#安全认证" class="headerlink" title="安全认证"></a>安全认证</h2><p>到目前为止，配置中心的所有 api 都是可随意访问的，若需要对公网暴露，则需要添加登录鉴权更安全些。<br>添加 security 依赖，并简单配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-server</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">password123</span></span><br></pre></td></tr></table></figure><h2 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://ip:port/eureka/</span></span><br></pre></td></tr></table></figure><p>并在启动类上添加 <code>@EnableEurekaClient</code> 注解。</p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
          <category> Spring Cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud </tag>
            
            <tag> Config </tag>
            
            <tag> 微服务 </tag>
            
            <tag> 配置中心 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WebFilter 路径匹配模式不生效</title>
      <link href="2021/11/10/yuque/WebFilter%20%E8%B7%AF%E5%BE%84%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%BC%8F%E4%B8%8D%E7%94%9F%E6%95%88/"/>
      <url>2021/11/10/yuque/WebFilter%20%E8%B7%AF%E5%BE%84%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%BC%8F%E4%B8%8D%E7%94%9F%E6%95%88/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在登录授权时，需要从 header 中获取 token 进行鉴权，通常使用过滤器处理指定的访问请求，但在使用 <code>@WebFilter</code> 注解时，发现其路径匹配模式不生效，即 <code>url、urlPatterns</code> 属性配置后，拦截了所有请求。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p><code>@WebServlet，@WebFilter，@WebListener</code> 注解，需要和 <code>@ServletComponentScan</code> 注解配套使用，表明其为 servlet 组件，而不是普通的 spring 组件，当使用 <code>@Component</code> 注解后，会优先被注册为 spring 组件，导致 servlet 扫描器失效。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ServletComponentScan(&quot;包名&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(Application.class, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 扫描所有 user 下的路径</span></span><br><span class="line"><span class="meta">@WebFilter(&quot;user/*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>可以通过 <code>FilterRegistrationBean</code> 装饰器，以编程方式手动注册过滤器。</p>]]></content>
      
      
      <categories>
          
          <category> Spring Boot </category>
          
          <category> WebFilter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> WebFilter </tag>
            
            <tag> 属性失效 </tag>
            
            <tag> urlPatterns </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bootstrap 多环境配置</title>
      <link href="2021/11/06/yuque/Bootstrap%20%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
      <url>2021/11/06/yuque/Bootstrap%20%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>由于在 <code>bootstrap.yml</code> 文件中配置 CI/CD 的环境变量，而本地开发时并没有相关环境，所以需要手动切换其属性，在提交代码时，需要关注该配置文件是否会与云端冲突，极其浪费精力。<br>因此需要能够屏蔽本地与云端配置差异的手段。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>由于在测试过程中，发现使用 <code>bootstrap-local.yml</code> 的方式，无法成功切换环境，因此使用 spring 的指定外部配置文件的方式。通过在项目启动时，添加程序启动参数，手动指定配置文件所在路径 <code>--spring.config.location=classpath:/local/</code>。<br><strong>注意</strong>：<code>local </code> 是在 resources 下建立的目录，需要以 <code>/</code> 结尾表示其为目录。<br>当然，此处亦可精确指定加载哪个配置文件，但每个（放置在 resources 目录下的文件）都需要 <code>classpath:/</code> 开头，以表示其在类加载目录下，多个文件之间以 <code>,</code> 分割。<br>​<img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1636179267460-6b3276bd-cd67-45a0-9dd4-9b163e7b95db.png#clientId=u3f67ee5e-a41f-4&from=paste&height=423&id=u408245c0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=846&originWidth=1304&originalType=binary%E2%88%B6=1&size=105006&status=done&style=none&taskId=u3fbc3b8c-a563-4b16-bfe2-ff87e8c068a&width=652" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1636179267460-6b3276bd-cd67-45a0-9dd4-9b163e7b95db.png#clientId=u3f67ee5e-a41f-4&from=paste&height=423&id=u408245c0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=846&originWidth=1304&originalType=binary%E2%88%B6=1&size=105006&status=done&style=none&taskId=u3fbc3b8c-a563-4b16-bfe2-ff87e8c068a&width=652" srcset="data:image/png;base64,666" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> Spring Boot </category>
          
          <category> 配置文件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 配置文件 </tag>
            
            <tag> 多环境 </tag>
            
            <tag> Bootstrap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>同时处理 XML 和 JSON 接口</title>
      <link href="2021/10/31/yuque/%E5%90%8C%E6%97%B6%E5%A4%84%E7%90%86%20XML%20%E5%92%8C%20JSON%20%E6%8E%A5%E5%8F%A3/"/>
      <url>2021/10/31/yuque/%E5%90%8C%E6%97%B6%E5%A4%84%E7%90%86%20XML%20%E5%92%8C%20JSON%20%E6%8E%A5%E5%8F%A3/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>出入参同时支持 XML 和 JSON 格式。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>在接口请求映射器注解中，指定 consumes 的媒体类型，用于标记入参格式，指定 produces 的媒体类型，用于标记出参格式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;地址&quot;,</span></span><br><span class="line"><span class="meta">           consumes = &#123;</span></span><br><span class="line"><span class="meta">               MediaType.APPLICATION_JSON_VALUE,</span></span><br><span class="line"><span class="meta">               MediaType.APPLICATION_XML_VALUE</span></span><br><span class="line"><span class="meta">           &#125;,</span></span><br><span class="line"><span class="meta">           produces = &#123;</span></span><br><span class="line"><span class="meta">               MediaType.APPLICATION_JSON_VALUE,</span></span><br><span class="line"><span class="meta">               MediaType.APPLICATION_XML_VALUE</span></span><br><span class="line"><span class="meta">           &#125;)</span></span><br></pre></td></tr></table></figure><p>同时，需要在 pom 中添加 xml 处理依赖。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 一般的由默认的 spring jackson 依赖控制版本号 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.jaxrs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-jaxrs-xml-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring Boot </category>
          
          <category> 参数处理 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 参数处理 </tag>
            
            <tag> XML </tag>
            
            <tag> JSON </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>字段类型不一致的问题分析</title>
      <link href="2021/06/11/yuque/%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/"/>
      <url>2021/06/11/yuque/%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>使用 mybatis 的结果集自动映射，发生了实体属性类型与表字段类型不一致；但实际上，相关实体的属性与表结构完全匹配。<br>关于实体类，是使用代码生成读取表结构生成的，但使用了公共父类，其中抽取出了一些通用的字段（包括主键、创建时间等）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span>&lt;<span class="title">Id</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableId</span></span><br><span class="line">    <span class="keyword">protected</span> Id id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;create_by&quot;, fill = INSERT, updateStrategy = NEVER)</span></span><br><span class="line">    <span class="keyword">protected</span> String createBy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;create_time&quot;, fill = INSERT, updateStrategy = NEVER)</span></span><br><span class="line">    <span class="keyword">protected</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;update_by&quot;, fill = FieldFill.UPDATE)</span></span><br><span class="line">    <span class="keyword">protected</span> String updateBy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;update_time&quot;, fill = FieldFill.UPDATE)</span></span><br><span class="line">    <span class="keyword">protected</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(&quot;ext1&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String ext1;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(&quot;ext2&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String ext2;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(&quot;ext3&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String ext3;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(&quot;ext4&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String ext4;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>不必计较父类中设置主键的合理性。</p></blockquote><p>BaseEntity.java 是基于 mybatis-plus，因此所有字段添加了相应的注解。<br>实体中依赖 lombok 隐藏 getter、setter 的实现细节，并使用了 @Builder 辅助实体创建。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><ol><li>使用 mybatis plus 的注解式开发，默认启用了 mybatis 的结果集自动映射，会通过构造器创建实体；</li><li>使用 lombok @Builder，导致实体生成了不包含父类属性的全参构造器；</li><li>mybatis 反射获取实体属性，构建属性类型、字段类型以及字段名称的独立列表；</li><li>mybatis 反射获取到实体构造器，当没有默认构造器时，会根据构造器参数索引顺序匹配字段，由于构造器参数长度是小于字段长度的，导致参数类型不匹配；</li></ol><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>在代码中添加默认构造器（通过反射获取，与可见性无关）。</p><h3 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h3><ol><li>不要在表实体中使用 lombok 的 @Builder，@AllArgsConstructor，防止在继承父类时，产生不完全的“全参”构造器；</li><li>或者强制在表实体中启用 lombok 的 @NoArgsConstructor，保证一定存在无参构造器；</li><li>也可以在表实体目录中强制禁止相关 lombok 注解，防止其他开发无意中使用；</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lombok.allArgsConstructor.flagUsage &#x3D; ERROR</span><br><span class="line">lombok.builder.flagUsage &#x3D; ERROR</span><br></pre></td></tr></table></figure><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><h4 id="DefaultResultSetHandler-java"><a href="#DefaultResultSetHandler-java" class="headerlink" title="DefaultResultSetHandler.java"></a>DefaultResultSetHandler.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getRowValue</span><span class="params">(ResultSetWrapper rsw, ResultMap resultMap, String columnPrefix)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ResultLoaderMap lazyLoader = <span class="keyword">new</span> ResultLoaderMap();</span><br><span class="line">   <span class="comment">// 1、创建结果对象</span></span><br><span class="line">  Object rowValue = createResultObject(rsw, resultMap, lazyLoader, columnPrefix);</span><br><span class="line">  <span class="keyword">if</span> (rowValue != <span class="keyword">null</span> &amp;&amp; !hasTypeHandlerForResultObject(rsw, resultMap.getType())) &#123;</span><br><span class="line">    <span class="keyword">final</span> MetaObject metaObject = configuration.newMetaObject(rowValue);</span><br><span class="line">    <span class="keyword">boolean</span> foundValues = <span class="keyword">this</span>.useConstructorMappings;</span><br><span class="line">    <span class="keyword">if</span> (shouldApplyAutomaticMappings(resultMap, <span class="keyword">false</span>)) &#123;</span><br><span class="line">      foundValues = applyAutomaticMappings(rsw, resultMap, metaObject, columnPrefix) || foundValues;</span><br><span class="line">    &#125;</span><br><span class="line">    foundValues = applyPropertyMappings(rsw, resultMap, metaObject, lazyLoader, columnPrefix) || foundValues;</span><br><span class="line">    foundValues = lazyLoader.size() &gt; <span class="number">0</span> || foundValues;</span><br><span class="line">    rowValue = foundValues || configuration.isReturnInstanceForEmptyRow() ? rowValue : <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> rowValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createResultObject</span><span class="params">(ResultSetWrapper rsw, ResultMap resultMap, ResultLoaderMap lazyLoader, String columnPrefix)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.useConstructorMappings = <span class="keyword">false</span>; <span class="comment">// reset previous mapping result</span></span><br><span class="line">  <span class="keyword">final</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">final</span> List&lt;Object&gt; constructorArgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 2、创建结果对象（使用可能存在的构造参数）</span></span><br><span class="line">  Object resultObject = createResultObject(rsw, resultMap, constructorArgTypes, constructorArgs, columnPrefix);</span><br><span class="line">  <span class="keyword">if</span> (resultObject != <span class="keyword">null</span> &amp;&amp; !hasTypeHandlerForResultObject(rsw, resultMap.getType())) &#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;ResultMapping&gt; propertyMappings = resultMap.getPropertyResultMappings();</span><br><span class="line">    <span class="keyword">for</span> (ResultMapping propertyMapping : propertyMappings) &#123;</span><br><span class="line">      <span class="comment">// issue gcode #109 &amp;&amp; issue #149</span></span><br><span class="line">      <span class="keyword">if</span> (propertyMapping.getNestedQueryId() != <span class="keyword">null</span> &amp;&amp; propertyMapping.isLazy()) &#123;</span><br><span class="line">        resultObject = configuration.getProxyFactory().createProxy(resultObject, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.useConstructorMappings = resultObject != <span class="keyword">null</span> &amp;&amp; !constructorArgTypes.isEmpty(); <span class="comment">// set current mapping result</span></span><br><span class="line">  <span class="keyword">return</span> resultObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createResultObject</span><span class="params">(ResultSetWrapper rsw, ResultMap resultMap, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs, String columnPrefix)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Class&lt;?&gt; resultType = resultMap.getType();</span><br><span class="line">  <span class="keyword">final</span> MetaClass metaType = MetaClass.forClass(resultType, reflectorFactory);</span><br><span class="line">  <span class="keyword">final</span> List&lt;ResultMapping&gt; constructorMappings = resultMap.getConstructorResultMappings();</span><br><span class="line">  <span class="keyword">if</span> (hasTypeHandlerForResultObject(rsw, resultType)) &#123;</span><br><span class="line">    <span class="keyword">return</span> createPrimitiveResultObject(rsw, resultMap, columnPrefix);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!constructorMappings.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">return</span> createParameterizedResultObject(rsw, resultType, constructorMappings, constructorArgTypes, constructorArgs, columnPrefix);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resultType.isInterface() || metaType.hasDefaultConstructor()) &#123;</span><br><span class="line">      <span class="comment">// 2.1、使用无参构造器创建对象</span></span><br><span class="line">    <span class="keyword">return</span> objectFactory.create(resultType);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldApplyAutomaticMappings(resultMap, <span class="keyword">false</span>)) &#123;</span><br><span class="line">      <span class="comment">// 2.2、使用有参的构造器创建对象</span></span><br><span class="line">    <span class="keyword">return</span> createByConstructorSignature(rsw, resultType, constructorArgTypes, constructorArgs);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ExecutorException(<span class="string">&quot;Do not know how to create an instance of &quot;</span> + resultType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createByConstructorSignature</span><span class="params">(ResultSetWrapper rsw, Class&lt;?&gt; resultType, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Constructor&lt;?&gt;[] constructors = resultType.getDeclaredConstructors();</span><br><span class="line">  <span class="comment">// 3、获取构造器</span></span><br><span class="line">  <span class="keyword">final</span> Constructor&lt;?&gt; defaultConstructor = findDefaultConstructor(constructors);</span><br><span class="line">  <span class="keyword">if</span> (defaultConstructor != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 4、使用构造器创建对象</span></span><br><span class="line">    <span class="keyword">return</span> createUsingConstructor(rsw, resultType, constructorArgTypes, constructorArgs, defaultConstructor);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Constructor&lt;?&gt; constructor : constructors) &#123;</span><br><span class="line">      <span class="keyword">if</span> (allowedConstructorUsingTypeHandlers(constructor, rsw.getJdbcTypes())) &#123;</span><br><span class="line">        <span class="keyword">return</span> createUsingConstructor(rsw, resultType, constructorArgTypes, constructorArgs, constructor);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ExecutorException(<span class="string">&quot;No constructor found in &quot;</span> + resultType.getName() + <span class="string">&quot; matching &quot;</span> + rsw.getClassNames());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Constructor&lt;?&gt; findDefaultConstructor(<span class="keyword">final</span> Constructor&lt;?&gt;[] constructors) &#123;</span><br><span class="line">    <span class="comment">// 3.1、仅包含一个构造器直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (constructors.length == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> constructors[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.2、返回包含 @AutomapConstructor 的构造器</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">final</span> Constructor&lt;?&gt; constructor : constructors) &#123;</span><br><span class="line">    <span class="keyword">if</span> (constructor.isAnnotationPresent(AutomapConstructor.class)) &#123;</span><br><span class="line">      <span class="keyword">return</span> constructor;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createUsingConstructor</span><span class="params">(ResultSetWrapper rsw, Class&lt;?&gt; resultType, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs, Constructor&lt;?&gt; constructor)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> foundValues = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; constructor.getParameterTypes().length; i++) &#123;</span><br><span class="line">      <span class="comment">// 4.1、通过构造器参数进行匹配参数类型</span></span><br><span class="line">    Class&lt;?&gt; parameterType = constructor.getParameterTypes()[i];</span><br><span class="line">    String columnName = rsw.getColumnNames().get(i);</span><br><span class="line">    TypeHandler&lt;?&gt; typeHandler = rsw.getTypeHandler(parameterType, columnName);</span><br><span class="line">    Object value = typeHandler.getResult(rsw.getResultSet(), columnName);</span><br><span class="line">    constructorArgTypes.add(parameterType);</span><br><span class="line">    constructorArgs.add(value);</span><br><span class="line">    foundValues = value != <span class="keyword">null</span> || foundValues;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> foundValues ? objectFactory.create(resultType, constructorArgTypes, constructorArgs) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Mybatis </category>
          
          <category> 结果集 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 结果集 </tag>
            
            <tag> Mybatis </tag>
            
            <tag> Lombok </tag>
            
            <tag> 异常分析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JetCache 使用</title>
      <link href="2021/04/23/yuque/JetCache%20%E4%BD%BF%E7%94%A8/"/>
      <url>2021/04/23/yuque/JetCache%20%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="Optional-支持"><a href="#Optional-支持" class="headerlink" title="Optional 支持"></a>Optional 支持</h3><p>由于 Optional 并不支持序列化，因此无法直接将其作为方法返回值、托管给 JetCache。必须对其进行拓展，添加自定义的编码器以及解码器。</p><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><p>依赖于 com.alicp.jetcache:jetcache-core:2.5.16。</p><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>只要将自定义的编码器注册为 bean 即可。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jetcache:</span></span><br><span class="line">  <span class="attr">remote:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">valueEncoder:</span> <span class="string">bean:jetValueEncoder</span></span><br></pre></td></tr></table></figure><h4 id="编码器实现"><a href="#编码器实现" class="headerlink" title="编码器实现"></a>编码器实现</h4><ol><li>在序列化之前，将 Optional 中的值取出，并在打上自定义的标记（IDENTITY_NUMBER 的值），对于非 Optional 类型的数据，则沿用默认的编码器器（JavaValueEncoder）；</li><li>编码器需要注册成 spring bean，启用自定义标记之后，解码器则通过读取自定义标记进行匹配；</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JetValueEncoder</span> <span class="keyword">extends</span> <span class="title">JavaValueEncoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INIT_BUF_SIZE = <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;WeakReference&lt;ByteArrayOutputStream&gt;&gt; THREAD_LOCAL =</span><br><span class="line">            ThreadLocal.withInitial(() -&gt; <span class="keyword">new</span> WeakReference&lt;&gt;(<span class="keyword">new</span> ByteArrayOutputStream(INIT_BUF_SIZE)));</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">int</span> IDENTITY_NUMBER = <span class="number">0x4A953A84</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JetValueEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JetValueEncoder</span><span class="params">(<span class="keyword">boolean</span> useIdentityNumber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(useIdentityNumber);</span><br><span class="line">        registerDecoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册解码器，此处为匿名内部类，直接实例并注册到 DecoderMap，</span></span><br><span class="line">    <span class="comment">// 键值为JetValueEncoder.IDENTITY_NUMBER，自定义标记</span></span><br><span class="line">    <span class="comment">// 实现逻辑，在反序列化之后，将标记匹配的值封装到 Optional 中</span></span><br><span class="line">    <span class="comment">// 标记不匹配的，则被其他解码器处理，不用考虑</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SpringJavaValueDecoder decoder = <span class="keyword">new</span> SpringJavaValueDecoder(<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">doApply</span><span class="params">(<span class="keyword">byte</span>[] buffer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Object obj = <span class="keyword">super</span>.doApply(buffer);</span><br><span class="line">                <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> CacheValueHolder) &#123;</span><br><span class="line">                    CacheValueHolder&lt;Object&gt; valueHolder = (CacheValueHolder&lt;Object&gt;) obj;</span><br><span class="line">                    valueHolder.setValue(Optional.ofNullable(valueHolder.getValue()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> obj;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        DecoderMap.register(JetValueEncoder.IDENTITY_NUMBER, decoder);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] apply(Object value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> CacheValueHolder) &#123;</span><br><span class="line">            CacheValueHolder&lt;Object&gt; valueHolder = (CacheValueHolder&lt;Object&gt;) value;</span><br><span class="line">            Object holderValue = ((CacheValueHolder&lt;?&gt;) value).getValue();</span><br><span class="line">            <span class="keyword">if</span> (holderValue <span class="keyword">instanceof</span> Optional) &#123;</span><br><span class="line">                Optional&lt;?&gt; valeOpt = (Optional&lt;?&gt;) holderValue;</span><br><span class="line">                valeOpt.ifPresent(valueHolder::setValue);</span><br><span class="line">                <span class="keyword">return</span> doApply(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.apply(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从父类中拷贝，由于父类中 IDENTITY_NUMBER 是静态变量，&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     * 且没有提供可重构 getter，所以不得不进行代码搬运法。╮(╯▽╰)╭&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     * 父类中应该使用 getIdentityNumber() 方法获取 IDENTITY_NUMBER 的值，&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> JavaValueEncoder#apply(Object)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] doApply(Object value) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            WeakReference&lt;ByteArrayOutputStream&gt; ref = THREAD_LOCAL.get();</span><br><span class="line">            ByteArrayOutputStream bos = ref.get();</span><br><span class="line">            <span class="keyword">if</span> (bos == <span class="keyword">null</span>) &#123;</span><br><span class="line">                bos = <span class="keyword">new</span> ByteArrayOutputStream(INIT_BUF_SIZE);</span><br><span class="line">                THREAD_LOCAL.set(<span class="keyword">new</span> WeakReference&lt;&gt;(bos));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (useIdentityNumber) &#123;</span><br><span class="line">                    bos.write((IDENTITY_NUMBER &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    bos.write((IDENTITY_NUMBER &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    bos.write((IDENTITY_NUMBER &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    bos.write(IDENTITY_NUMBER &amp; <span class="number">0xFF</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">                oos.writeObject(value);</span><br><span class="line">                oos.flush();</span><br><span class="line">                <span class="keyword">return</span> bos.toByteArray();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                bos.reset();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CacheEncodeException(<span class="string">&quot;Java Encode error. &quot;</span> + <span class="string">&quot;msg=&quot;</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>从源码中 <code>SpringConfigProvider#parseValueEncoder</code> 可以找到编码器的加载入口，当 valueEncoder 属性匹配到 “bean:”前缀的编码器时，则启用该 bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1、ExternalCacheAutoInit#parseGeneralConfig</span></span><br><span class="line">   <span class="comment">// 自动初始化配置</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseGeneralConfig</span><span class="params">(CacheBuilder builder, ConfigTree ct)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.parseGeneralConfig(builder, ct);</span><br><span class="line">       ExternalCacheBuilder ecb = (ExternalCacheBuilder) builder;</span><br><span class="line">       ecb.setKeyPrefix(ct.getProperty(<span class="string">&quot;keyPrefix&quot;</span>));</span><br><span class="line">       <span class="comment">// 设置编码器，指定了配置中的 key：valueEncoder</span></span><br><span class="line">       ecb.setValueEncoder(configProvider.parseValueEncoder(ct.getProperty(<span class="string">&quot;valueEncoder&quot;</span>, CacheConsts.DEFAULT_SERIAL_POLICY)));</span><br><span class="line">       ecb.setValueDecoder(configProvider.parseValueDecoder(ct.getProperty(<span class="string">&quot;valueDecoder&quot;</span>, CacheConsts.DEFAULT_SERIAL_POLICY)));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2、SpringConfigProvider#parseValueEncoder</span></span><br><span class="line">   <span class="comment">// spring 环境中的配置规则，先尝试搜索是否存在注册为 spring bean 的编码器</span></span><br><span class="line">   <span class="keyword">public</span> Function&lt;Object, <span class="keyword">byte</span>[]&gt; parseValueEncoder(String valueEncoder) &#123;</span><br><span class="line">       <span class="comment">// 进入 bean 加载方法</span></span><br><span class="line">       String beanName = parseBeanName(valueEncoder);</span><br><span class="line">       <span class="comment">// bean 名称存在时注册 spring 托管的编码器</span></span><br><span class="line">       <span class="keyword">if</span> (beanName == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">super</span>.parseValueEncoder(valueEncoder);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           Object bean = applicationContext.getBean(beanName);</span><br><span class="line">           <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Function) &#123;</span><br><span class="line">               <span class="keyword">return</span> (Function&lt;Object, <span class="keyword">byte</span>[]&gt;) bean;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> ((SerialPolicy) bean).encoder();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3、SpringConfigProvider#parseBeanName</span></span><br><span class="line"><span class="comment">// bean 名称的解析，需要在配置文件中指定 valueEncode 属性：&#x27;bean:anyName&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">parseBeanName</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 通过 “bean:” 前缀匹配 bean 名称</span></span><br><span class="line">       <span class="keyword">final</span> String beanPrefix = <span class="string">&quot;bean:&quot;</span>;</span><br><span class="line">       <span class="keyword">int</span> len = beanPrefix.length();</span><br><span class="line">       <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; str.startsWith(beanPrefix) &amp;&amp; str.length() &gt; len) &#123;</span><br><span class="line">           <span class="keyword">return</span> str.substring(len);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4、AbstractValueDecoder#apply</span></span><br><span class="line">   <span class="comment">// 解码器入口，对于 useIdentityNumber = true，及开启自定义标记的序列化数据，</span></span><br><span class="line">   <span class="comment">// 需要在 DecoderMap 中通过 identityNumber 进行匹配</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">apply</span><span class="params">(<span class="keyword">byte</span>[] buffer)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (useIdentityNumber) &#123;</span><br><span class="line">               DecoderMap.registerBuildInDecoder();</span><br><span class="line">               <span class="keyword">int</span> identityNumber = parseHeader(buffer);</span><br><span class="line">               AbstractValueDecoder decoder = DecoderMap.getDecoder(identityNumber);</span><br><span class="line">               Objects.requireNonNull(decoder, <span class="string">&quot;no decoder for identity number:&quot;</span> + identityNumber);</span><br><span class="line">               <span class="keyword">return</span> decoder.doApply(buffer);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> doApply(buffer);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> CacheEncodeException(<span class="string">&quot;decode error&quot;</span>, e);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 缓存 </category>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JetCache </tag>
            
            <tag> 多级缓存 </tag>
            
            <tag> 使用 </tag>
            
            <tag> 拓展 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Feign 自定义配置</title>
      <link href="2021/03/30/yuque/Feign%20%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/"/>
      <url>2021/03/30/yuque/Feign%20%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在微服务项目中，需要请求第三方接口，通常情况下我们使用 spring 的 restTemplate。但接触到 feign 之后，这种将远程方法伪装成本地接口，屏蔽请求感知的方式，无疑更优雅。<br>但对于 oauth 认证，需要配置请求头，即设置 feign 的自定义配置。</p><h2 id="自定义授权头信息"><a href="#自定义授权头信息" class="headerlink" title="自定义授权头信息"></a>自定义授权头信息</h2><h3 id="请求远程连接"><a href="#请求远程连接" class="headerlink" title="请求远程连接"></a>请求远程连接</h3><p><code>@FeignClient</code> 用于注册接口为 feign 客户端，在 spring cloud 项目中，需要在其 value（或 name）属性中指定对应的微服务名，url 置空（将自动匹配配置中西地址）。当需要调用任意的 http 请求时，只要给定 url 值即可。<br><strong>注意</strong> ：此时，虽然不是请求微服务接口，仍然需要设置 name，填写任意（不冲突的）名称即可。</p><h3 id="授权流程"><a href="#授权流程" class="headerlink" title="授权流程"></a>授权流程</h3><h3 id="授权配置"><a href="#授权配置" class="headerlink" title="授权配置"></a>授权配置</h3><p>需要通过自定义配置属性来指定请求头，对应 <code>@FeignClient</code> 的 configuration 属性。<br>该属性指定一个自定义配置类，用于设置 feign 的任意配置。</p><h4 id="Basic-认证"><a href="#Basic-认证" class="headerlink" title="Basic 认证"></a>Basic 认证</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @Configuration 托管给 spring 之后，会被注册为全局配置</span></span><br><span class="line"><span class="comment">// 局部配置需要指定在 @FeignClient(configuration = SomeAuthConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeAuthConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BasicAuthRequestInterceptor <span class="title">basicAuthRequestInterceptor</span><span class="params">(SomeProperties someProperties)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// someProperties 是一个属性类</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BasicAuthRequestInterceptor(</span><br><span class="line">                someProperties.getAuth().getUser(),</span><br><span class="line">                someProperties.getAuth().getPassword()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="请求-token"><a href="#请求-token" class="headerlink" title="请求 token"></a>请求 token</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(</span></span><br><span class="line"><span class="meta">        name = &quot;some-auth&quot;, url = &quot;$&#123;some.auth.url&#125;&quot;,</span></span><br><span class="line"><span class="meta">        configuration = SomeAuthConfig.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SomeAuthIntegration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 token</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 授权信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/xxx&quot;)</span></span><br><span class="line">    <span class="function">SomeAuthResponse <span class="title">getToken</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="设置-Authorization-Header"><a href="#设置-Authorization-Header" class="headerlink" title="设置 Authorization Header"></a>设置 Authorization Header</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeTokenConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置 header auth</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authIntegration 授权接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 请求拦截器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestInterceptor <span class="title">requestInterceptor</span><span class="params">(SomeAuthIntegration authIntegration)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 此处使用的是 lambda 表达式返回一个实现 RequestInterceptor 的匿名类，</span></span><br><span class="line">        <span class="comment">// 在 lambda 表达式外部的操作会在 bean 注册时生效，</span></span><br><span class="line">        <span class="comment">// 因此，每次获取 token 的操作，应该放在表达式内部</span></span><br><span class="line">        <span class="keyword">return</span> requestTemplate -&gt; &#123;</span><br><span class="line">            SomeAuthResponse authResponse = authIntegration.getToken();</span><br><span class="line">            requestTemplate.header(</span><br><span class="line">                    AUTHORIZATION,</span><br><span class="line">                    StrUtil.format(<span class="string">&quot;&#123;&#125; &#123;&#125;&quot;</span>, authResponse.getTokenType(), authResponse.getAccessToken())</span><br><span class="line">            );</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="已授权请求"><a href="#已授权请求" class="headerlink" title="已授权请求"></a>已授权请求</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(</span></span><br><span class="line"><span class="meta">        name = &quot;some-reply&quot;, url = &quot;$&#123;some.reply.url&#125;&quot;,</span></span><br><span class="line"><span class="meta">        configuration = SomeTokenConfig.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SomeReplyIntegration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回传状态</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status 状态信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/xxx&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(SomeStatus status)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自定义解码器"><a href="#自定义解码器" class="headerlink" title="自定义解码器"></a>自定义解码器</h2><p>当响应信息实际返回的是 json 格式，但头信息描述类型是 <em>Content-Type: text/xml;charset=utf-8</em> （或其他非 *application/json *类型）时，feign 的默认消息转换器无法解析，此时就需要重新使用自定义解码器。<br>在配置类中注册 Decoder bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Decoder <span class="title">someResponseDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SpringDecoder(() -&gt; <span class="keyword">new</span> HttpMessageConverters(</span><br><span class="line">            <span class="keyword">new</span> MappingJackson2HttpMessageConverter() &#123;</span><br><span class="line">                &#123;</span><br><span class="line">                    setSupportedMediaTypes(Lists.newArrayList(MediaType.TEXT_XML));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>feing 基于 http 请求，在其配置类中，可以实现任意 http 的相关配置，包括超时时间、重试次数等。<br>一般情况下，accessToken 存在过期时间，为了防止频繁请求授权，应该在过期之前进行缓存。</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> Feign </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Feign </tag>
            
            <tag> Configuration </tag>
            
            <tag> HTTP </tag>
            
            <tag> 拦截器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>实现 Jar 多版本共存</title>
      <link href="2021/03/22/yuque/%E5%AE%9E%E7%8E%B0%20Jar%20%E5%A4%9A%E7%89%88%E6%9C%AC%E5%85%B1%E5%AD%98/"/>
      <url>2021/03/22/yuque/%E5%AE%9E%E7%8E%B0%20Jar%20%E5%A4%9A%E7%89%88%E6%9C%AC%E5%85%B1%E5%AD%98/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>现需要实现同时共存两个版本的 SDK，其中存在限定名完全相同的类，但两个类的方法并不完全相同，导致 JVM 在加载时无法按预期的调用类方法。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>由于 SDK 中依赖了大量的封装对象，无法使用简单的反射调用方法，因此自定义类加载器并不能解决。首先想到的是使用 maven 插件，在编译时修改指定的 SDK 的类名，<code>maven-shade-plugin</code> 并不能很好的解决，按照博客中的经验，可以将待处理的模块在一个空白模块中引入，并使用 shade 进行重命名，但是实际类引用的时候，依旧是原类名，只有在 maven 打包后，新名称将被替换值 class 文件中，这就导致了，如果有多个模块进行了调用 SDK，则需要处理多个模块，而且经常出现预期之外的问题，耗费精力。<br>最终是使用 <a href="https://github.com/google/jarjar">jarjar</a> 来解决的。<br><a href="https://code.google.com/archive/p/jarjar/">下载地址</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar jarjar.jar process rule.txt old.jar new.jar</span><br></pre></td></tr></table></figure><p>其中，rule.txt 是任意文件名，其中指定了替换规则：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rule com.old.package.** com.new.package.@1</span><br></pre></td></tr></table></figure><p>或者使用 <a href="http://sonatype.github.io/jarjar-maven-plugin/">jarjar-maven-plugin</a>（未验证）</p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
            <tag> Java </tag>
            
            <tag> Jar 冲突 </tag>
            
            <tag> 多版本 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>打包外部依赖</title>
      <link href="2021/03/21/yuque/%E6%89%93%E5%8C%85%E5%A4%96%E9%83%A8%E4%BE%9D%E8%B5%96/"/>
      <url>2021/03/21/yuque/%E6%89%93%E5%8C%85%E5%A4%96%E9%83%A8%E4%BE%9D%E8%B5%96/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>由于公司 SDK 没有正式上线，只能提供 jar，需要手动添加依赖，在使用 maven 打包的时候提示找不到符号。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>将外部 jar 使用 maven 管理</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 因为实际不会从远程仓库下载，因此坐标可以填写任意值 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>任意值<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>任意值<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>任意值<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- scope 必须是 system，表明是从本地读取信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>项目中的相对路径<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 额外配置，</span></span><br><span class="line"><span class="comment">默认情况下，外部依赖只会在编译时加载，打包后会丢失，</span></span><br><span class="line"><span class="comment">需要增加以下配置</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- includeSystemScope 开启即可--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">includeSystemScope</span>&gt;</span>true<span class="tag">&lt;/<span class="name">includeSystemScope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Maven </category>
          
          <category> 打包 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Maven </tag>
            
            <tag> Lib </tag>
            
            <tag> Install </tag>
            
            <tag> 外部依赖 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LocalDate 解析年月字符串</title>
      <link href="2021/02/07/yuque/LocalDate%20%E8%A7%A3%E6%9E%90%E5%B9%B4%E6%9C%88%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
      <url>2021/02/07/yuque/LocalDate%20%E8%A7%A3%E6%9E%90%E5%B9%B4%E6%9C%88%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>使用 LocalDate 解析 <code>yyyy-MM</code> 格式的字符串时异常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.time.DateTimeException: Unable to obtain LocalDate from TemporalAccessor: &#123;Year&#x3D;2021, MonthOfYear&#x3D;1&#125;,ISO of type java.time.format.Parsed</span><br><span class="line">at java.time.LocalDate.from(LocalDate.java:368)</span><br><span class="line">at java.time.format.Parsed.query(Parsed.java:226)</span><br><span class="line">at java.time.format.DateTimeFormatter.parse(DateTimeFormatter.java:1851)</span><br><span class="line">... 2 more</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>字符串解析到 LocalDate 必须具体到日期，因此需要给年月的格式添加默认日期，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ① 调整 DateTimeFormatter</span></span><br><span class="line">     DateTimeFormatter fmt = <span class="keyword">new</span> DateTimeFormatterBuilder()</span><br><span class="line">            .appendPattern(<span class="string">&quot;yyyy-MM&quot;</span>)</span><br><span class="line">        <span class="comment">// 添加默认日期</span></span><br><span class="line">            .parseDefaulting(ChronoField.DAY_OF_MONTH, <span class="number">1</span>)</span><br><span class="line">            .toFormatter();</span><br><span class="line">    <span class="comment">// ② 使用 YearMonth 转换</span></span><br><span class="line">    YearMonth yearMonth = YearMonth.parse(<span class="string">&quot;2021-01&quot;</span>, fmt);</span><br><span class="line">    LocalDate localDate = yearMonth.atEndOfMonth();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JDK8 </category>
          
          <category> Time </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JDK8 </tag>
            
            <tag> Time </tag>
            
            <tag> LocalDate </tag>
            
            <tag> 日期格式化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>发布到私有仓库</title>
      <link href="2021/02/06/yuque/%E5%8F%91%E5%B8%83%E5%88%B0%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/"/>
      <url>2021/02/06/yuque/%E5%8F%91%E5%B8%83%E5%88%B0%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>需要将工具类发布到公司的私有仓库中，为了避免每次手动在页面上操作，此处借助 maven 命令行和 idea 启动项实现一键发布。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="配置服务器地址"><a href="#配置服务器地址" class="headerlink" title="配置服务器地址"></a>配置服务器地址</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- maven settings.xml --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 未配置时会提示 401 权限不足 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>仓库名<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">username</span>&gt;</span>账号<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">password</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="发布命令"><a href="#发布命令" class="headerlink" title="发布命令"></a>发布命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令</span></span><br><span class="line">mvn deploy:deploy-file</span><br><span class="line"></span><br><span class="line"><span class="comment">## 自定义参数 -Dparam</span></span><br><span class="line"><span class="comment">## -DgroupId=项目</span></span><br><span class="line"><span class="comment">## -DartifactId=模块</span></span><br><span class="line"><span class="comment">## -Dversion=版本号</span></span><br><span class="line"><span class="comment">## -Dpackaging=打包方式</span></span><br><span class="line"><span class="comment">## -Dfile=本地路径</span></span><br><span class="line"><span class="comment">## -Dsources=源码路径</span></span><br><span class="line"><span class="comment">## -Durl=仓库地址</span></span><br><span class="line"><span class="comment">## -DrepositoryId=指定仓库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如:</span></span><br><span class="line">mvn deploy:deploy-file \</span><br><span class="line">-DgroupId=com.xyz \</span><br><span class="line">-DartifactId=<span class="built_in">test</span> \</span><br><span class="line">-Dversion=1.0.0 \</span><br><span class="line">-Dpackaging=jar \</span><br><span class="line">-Dfile=path/name-1.0.0.jar \</span><br><span class="line">-Dsources=path/name-1.0.0-sources.jar \</span><br><span class="line">-Durl=http://ip/nexus/content/repositories/thirdparty/ \</span><br><span class="line">-DrepositoryId=thirdparty</span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令中可以使用 pom 变量，如 -Dversion=$&#123;project.version&#125;</span></span><br></pre></td></tr></table></figure><h3 id="Idea-中的配置"><a href="#Idea-中的配置" class="headerlink" title="Idea 中的配置"></a>Idea 中的配置</h3><p><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1612548053894-e9ae4173-6e15-4b1c-9a75-f21e63819b56.png#align=left&display=inline&height=883&margin=%5Bobject%20Object%5D&name=image.png&originHeight=883&originWidth=1343&size=128863&status=done&style=none&width=1343" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1612548053894-e9ae4173-6e15-4b1c-9a75-f21e63819b56.png#align=left&display=inline&height=883&margin=%5Bobject%20Object%5D&name=image.png&originHeight=883&originWidth=1343&size=128863&status=done&style=none&width=1343" srcset="data:image/png;base64,666" alt="image.png"><br>此后就可以一键发布了。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1612548199808-4f6c438d-580b-4f28-b336-1bf94f167a8c.png#align=left&display=inline&height=40&margin=%5Bobject%20Object%5D&name=image.png&originHeight=40&originWidth=426&size=11831&status=done&style=none&width=426" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1612548199808-4f6c438d-580b-4f28-b336-1bf94f167a8c.png#align=left&display=inline&height=40&margin=%5Bobject%20Object%5D&name=image.png&originHeight=40&originWidth=426&size=11831&status=done&style=none&width=426" srcset="data:image/png;base64,666" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> Maven </category>
          
          <category> 命令行 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Maven </tag>
            
            <tag> Deploy </tag>
            
            <tag> Idea </tag>
            
            <tag> 命令行 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenConnect Client 使用</title>
      <link href="2021/01/02/yuque/OpenConnect%20Client%20%E4%BD%BF%E7%94%A8/"/>
      <url>2021/01/02/yuque/OpenConnect%20Client%20%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><ol><li>代替 Cisco 的 AnyConnect 客户端；</li><li>可以实现无交互的静默登录；</li></ol><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 安装源</span></span></span><br><span class="line">yum install epel-release</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 安装客户端</span></span></span><br><span class="line">yum install openconnect</span><br></pre></td></tr></table></figure><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="查看帮助"><a href="#查看帮助" class="headerlink" title="查看帮助"></a>查看帮助</h3><p>详细设置可以查看帮助。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 查看帮助</span></span><br><span class="line">openconnect -h</span><br></pre></td></tr></table></figure><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><p>此处使用密码登录，无密码登录需要服务端配合设置证书。<br>为了实现自动输入密码，使用了管理命令，也可以使用 expect 实现自动执行 Shell 的交互操作。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">server=服务器地址</span><br><span class="line">group=分组名</span><br><span class="line">user=用户名</span><br><span class="line">password=密码</span><br><span class="line">pid_file=pid 文件路径</span><br><span class="line"></span><br><span class="line"><span class="comment">## 登录</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">login</span></span>() &#123;</span><br><span class="line"><span class="keyword">if</span> [ `pidof openconnect` ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;已登录&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$password</span> | openconnect -b --pid-file=<span class="variable">$pid_file</span> --authgroup <span class="variable">$group</span> -u <span class="variable">$user</span> --no-dtls <span class="variable">$server</span></span><br><span class="line"><span class="comment">## 判断启动状态</span></span><br><span class="line"><span class="keyword">if</span> [ `pidof openconnect` == `cat <span class="variable">$pid_file</span>` ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;登录成功&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;登录失败&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 退出</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">logout</span></span>() &#123;</span><br><span class="line">  <span class="comment"># 通过 pid 结束进程</span></span><br><span class="line"><span class="built_in">kill</span> -9 `cat <span class="variable">$pid_file</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;注销成功&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## [] 计算布尔值，需要前后空格</span></span><br><span class="line"><span class="comment">## &quot;$1&quot; 防止无参，或空格作为一个整体字符串</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;login&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">login</span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;logout&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> 参数输入错误，支持的命令 login 或 <span class="built_in">logout</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h3 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h3><p>在用户或全局环境变量中写入脚本路径的别名，使得脚本可以在当前用户的任意目录中，直接通别名调用。<br><strong>注：</strong></p><ol><li>环境变量中可以直接执行脚本（即设置自启）;</li><li><code>~/.bash_profile</code> 用户变量；</li><li><code>/etc/profile</code>     全局变量；</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 写入用户变量</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;alias 别名=&#x27;脚本路径&#x27;&quot;</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="comment">## 刷新变量</span></span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br><span class="line"><span class="comment">## 执行</span></span><br><span class="line"><span class="comment"># 登录</span></span><br><span class="line">别名 login</span><br><span class="line"><span class="comment"># 注销</span></span><br><span class="line">别名 <span class="built_in">logout</span></span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><h4 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## openconnect 授权指令</span></span><br><span class="line">Authentication:</span><br><span class="line">  -u, --user=NAME                 Set login username</span><br><span class="line">      --no-passwd                 Disable password/SecurID authentication</span><br><span class="line">      --non-inter                 Do not expect user input; <span class="built_in">exit</span> <span class="keyword">if</span> it is required</span><br><span class="line">      --passwd-on-stdin           Read password from standard input</span><br><span class="line">      --authgroup=GROUP           Choose authentication login selection</span><br><span class="line">  -F, --form-entry=FORM:OPT=VALUE Provide authentication form responses</span><br><span class="line">  -c, --certificate=CERT          Use SSL client certificate CERT</span><br><span class="line">  -k, --sslkey=KEY                Use SSL private key file KEY</span><br><span class="line">  -e, --cert-expire-warning=DAYS  Warn when certificate lifetime &lt; DAYS</span><br><span class="line">  -g, --usergroup=GROUP           Set login usergroup</span><br><span class="line">  -p, --key-password=PASS         Set key passphrase or TPM SRK PIN</span><br><span class="line">      --key-password-from-fsid    Key passphrase is fsid of file system</span><br><span class="line">      --token-mode=MODE           Software token <span class="built_in">type</span>: rsa, totp, hotp or oidc</span><br><span class="line">      --token-secret=STRING       Software token secret or oidc token</span><br></pre></td></tr></table></figure><h4 id="异常使用"><a href="#异常使用" class="headerlink" title="异常使用"></a>异常使用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 指令</span></span><br><span class="line">-g GROUP</span><br><span class="line"></span><br><span class="line"><span class="comment">## 报错</span></span><br><span class="line">Failed to obtain WebVPN cookie</span><br><span class="line"></span><br><span class="line"><span class="comment">## 解决，替换指令</span></span><br><span class="line">--authgroup=GROUP</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> VPN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Centos </tag>
            
            <tag> VPN </tag>
            
            <tag> OpenConnect </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cloud Toolkit</title>
      <link href="2020/12/27/yuque/Cloud%20Toolkit/"/>
      <url>2020/12/27/yuque/Cloud%20Toolkit/</url>
      
        <content type="html"><![CDATA[<h2 id="插件介绍"><a href="#插件介绍" class="headerlink" title="插件介绍"></a>插件介绍</h2><p>提供自动部署项目到服务器的能力，并且可以在部署前后执行自定义命令或脚本。</p><h2 id="插件使用"><a href="#插件使用" class="headerlink" title="插件使用"></a>插件使用</h2><h3 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h3><p>在插件市场安装好插件。</p><h3 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h3><ol><li>选择 Alibaba Cloud View 面板：在底部（或侧边栏，或顶部 Tools 导航栏）；</li><li>点击 Add Host：添加服务</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1609011426003-310abca2-44bf-48bf-9b67-e46b63fcfed6.png#align=left&display=inline&height=324&margin=%5Bobject%20Object%5D&name=image.png&originHeight=324&originWidth=1882&size=429886&status=done&style=none&width=1882" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1609011426003-310abca2-44bf-48bf-9b67-e46b63fcfed6.png#align=left&display=inline&height=324&margin=%5Bobject%20Object%5D&name=image.png&originHeight=324&originWidth=1882&size=429886&status=done&style=none&width=1882" srcset="data:image/png;base64,666" alt="image.png"></p><ol><li>填写服务器 ip：可以填多个，换行分隔，但端口得一致；</li><li>指定登录方式：使用 ssh 需要将公钥写入到服务器得 ssh 授权文件中，然后在插件中配置本地私钥路径；</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1609012168668-e935883f-037c-4b39-95f8-86c127b86eb4.png#align=left&display=inline&height=698&margin=%5Bobject%20Object%5D&name=image.png&originHeight=698&originWidth=904&size=58614&status=done&style=none&width=904" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1609012168668-e935883f-037c-4b39-95f8-86c127b86eb4.png#align=left&display=inline&height=698&margin=%5Bobject%20Object%5D&name=image.png&originHeight=698&originWidth=904&size=58614&status=done&style=none&width=904" srcset="data:image/png;base64,666" alt="image.png"></p><h3 id="配置启动项"><a href="#配置启动项" class="headerlink" title="配置启动项"></a>配置启动项</h3><ol><li>选择 Deploy to Host：在 Target Host 中指定（上步添加的）服务器，可以多选;</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1609011861070-2c202c87-3e0b-40ca-9228-5fe051b6d976.png#align=left&display=inline&height=395&margin=%5Bobject%20Object%5D&name=image.png&originHeight=395&originWidth=779&size=35252&status=done&style=none&width=779" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1609011861070-2c202c87-3e0b-40ca-9228-5fe051b6d976.png#align=left&display=inline&height=395&margin=%5Bobject%20Object%5D&name=image.png&originHeight=395&originWidth=779&size=35252&status=done&style=none&width=779" srcset="data:image/png;base64,666" alt="image.png"></p><ol start="2"><li>选择 Upload File：在（聚合项目）使用过程中，Maven Build 会自动（没找到配置项）上传错误的路径，且上传的是 pom，而 Upload File 可以随意指定路径；</li><li>选择 Browse（也可以直接在输入框中填写）：找到打包好的（mvn install 或 target 的）路径；</li><li>填写远程服务器中项目发版的根路径；</li><li>指定部署前执行命令：点击 + 打开拓展菜单；</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1609011815631-31289fd9-1cdd-41c9-9e33-f76f42f969a6.png#align=left&display=inline&height=1033&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1033&originWidth=1343&size=122113&status=done&style=none&width=1343" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1609011815631-31289fd9-1cdd-41c9-9e33-f76f42f969a6.png#align=left&display=inline&height=1033&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1033&originWidth=1343&size=122113&status=done&style=none&width=1343" srcset="data:image/png;base64,666" alt="image.png"></p><ol start="6"><li>选择执行器：此处选择了 maven；</li><li>输入执行命令：填入目标（goal）命令即可，多个命令空格（逗号没试）分隔；</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1609010975617-f3628e9a-6780-4e22-83b6-f8e0d528cf1b.png#align=left&display=inline&height=270&margin=%5Bobject%20Object%5D&name=image.png&originHeight=360&originWidth=310&size=21979&status=done&style=none&width=233" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1609010975617-f3628e9a-6780-4e22-83b6-f8e0d528cf1b.png#align=left&display=inline&height=270&margin=%5Bobject%20Object%5D&name=image.png&originHeight=360&originWidth=310&size=21979&status=done&style=none&width=233" srcset="data:image/png;base64,666" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1609010950894-5ac6e066-0daf-42b8-a964-4f58ac493a14.png#align=left&display=inline&height=108&margin=%5Bobject%20Object%5D&name=image.png&originHeight=195&originWidth=924&size=22623&status=done&style=none&width=510" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1609010950894-5ac6e066-0daf-42b8-a964-4f58ac493a14.png#align=left&display=inline&height=108&margin=%5Bobject%20Object%5D&name=image.png&originHeight=195&originWidth=924&size=22623&status=done&style=none&width=510" srcset="data:image/png;base64,666" alt="image.png"></p><h3 id="后置命令"><a href="#后置命令" class="headerlink" title="后置命令"></a>后置命令</h3><p>在部署（项目上传到服务器）后（在部署的路径中）执行。<br>推荐在服务器上预置脚本来提供更强、更灵活的功能。</p><h4 id="clean-sh"><a href="#clean-sh" class="headerlink" title="clean.sh"></a>clean.sh</h4><p>因为可能会有不同版本号的项目，且没有在打包插件中约定固定的名称，因此服务器上会积累多个版本项目：</p><ol><li>一般的启动脚本（为了忽视版本号），会使用 * 来匹配指定前缀的 jar 以启动项目，如此启动脚本会匹配多个版本的项目，需要清理旧的项目；</li><li>或者需要将之前的 jar 包做成备份；</li></ol><p>所以需要使用脚本找出旧的项目（此时 jar 已经上传）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">file=<span class="string">&#x27;项目名-*&#x27;</span></span><br><span class="line"><span class="comment"># 计算该目录下相同前缀的文件个数</span></span><br><span class="line">num=`ls -tr | grep <span class="variable">$&#123;file&#125;</span> | wc -l`</span><br><span class="line"><span class="built_in">echo</span> 共有 <span class="variable">$num</span> 个文件</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$num</span> -gt 1 ];<span class="keyword">then</span></span><br><span class="line">  <span class="comment"># 计算需要删除的文件个数（保留一个就行）</span></span><br><span class="line">  num=`expr <span class="variable">$num</span> - 1`</span><br><span class="line">  <span class="built_in">echo</span> 找到历史文件: `ls -tr | grep <span class="variable">$&#123;file&#125;</span> | head -<span class="variable">$num</span> | xargs`</span><br><span class="line">  ls -tr  | grep file | head -<span class="variable">$num</span> | xargs -i -n1 rm -rf &#123;&#125; &amp;&amp; <span class="built_in">echo</span> 删除成功!</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> 无历史文件，忽略本次操作</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h4 id="auto-deploy-sh"><a href="#auto-deploy-sh" class="headerlink" title="auto-deploy.sh"></a>auto-deploy.sh</h4><p>脚本的功能上解耦好一点，因此添加一个统一的入口脚本，用来统筹其他的操作，下面的执行方式需要 .sh 的读取权限，通常 <code>chmod 777 ./xxx.sh</code> 给上足够的权限即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">./clean.sh &amp;&amp; ./startup.sh</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ol><li>也可以在 VS Code 安装，（我）用来发前端；</li><li>更多操作，查看<a href="https://www.aliyun.com/product/cloudtoolkit">官方介绍</a> ；</li></ol>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> Intellij Plugin </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Intellij Plugin </tag>
            
            <tag> 运维 </tag>
            
            <tag> 自动部署 </tag>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AnAction</title>
      <link href="2020/12/20/yuque/AnAction/"/>
      <url>2020/12/20/yuque/AnAction/</url>
      
        <content type="html"><![CDATA[<blockquote><p>仅用于记录插件开发时踩的坑</p></blockquote><h2 id="接口介绍"><a href="#接口介绍" class="headerlink" title="接口介绍"></a>接口介绍</h2><p><code>AnAction</code> 是 Intellij Idea SDK 提供的按钮接口实现下的抽象类，通过继承此类，可以轻易的实现符合 Intellij UI 设计风格的自定义按钮组件。<br>Intellij SDK 中就内置了大量 AnAction 子类，下面是自定义实现的主要重写方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按钮点击时执行</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="拓展子类"><a href="#拓展子类" class="headerlink" title="拓展子类"></a>拓展子类</h2><h3 id="ToggleAction"><a href="#ToggleAction" class="headerlink" title="ToggleAction"></a>ToggleAction</h3><p>用于表示具有选定状态，且在执行（点击按钮）时切换其选定状态的动作。如控制台日志滚动时的自动换行按钮，以及滚动跟随按钮。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断按钮是否被选中</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isSelected</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置按钮何时被设置为选中状态</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setSelected</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e, <span class="keyword">boolean</span> state)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="辅助类"><a href="#辅助类" class="headerlink" title="辅助类"></a>辅助类</h2><h3 id="ActionToolbar"><a href="#ActionToolbar" class="headerlink" title="ActionToolbar"></a>ActionToolbar</h3><p>工具栏，用于操作控制台的一组按钮。<br>在 Git 面板，如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445577369-80a7b177-a107-4c1b-a7d2-a3a1bcdac69d.png#align=left&display=inline&height=315&margin=%5Bobject%20Object%5D&name=image.png&originHeight=315&originWidth=604&size=159886&status=done&style=none&width=604" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445577369-80a7b177-a107-4c1b-a7d2-a3a1bcdac69d.png#align=left&display=inline&height=315&margin=%5Bobject%20Object%5D&name=image.png&originHeight=315&originWidth=604&size=159886&status=done&style=none&width=604" srcset="data:image/png;base64,666" alt="image.png"></p><h4 id="创建方法"><a href="#创建方法" class="headerlink" title="创建方法"></a>创建方法</h4><p><code>ActionManager#createActionToolbar(String, ActionGroup, boolean)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createToolbar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 创建一个按钮组</span></span><br><span class="line">     <span class="keyword">final</span> DefaultActionGroup actions = <span class="keyword">new</span> DefaultActionGroup();</span><br><span class="line">     <span class="comment">// 通过 ConsoleView#createConsoleActions() 方法创建默认按钮</span></span><br><span class="line">     actions.addAll(consoleView.createConsoleActions());</span><br><span class="line">     <span class="comment">// 创建工具栏</span></span><br><span class="line">     ActionToolbar actionToolbar = ActionManager.getInstance()</span><br><span class="line">             .createActionToolbar(ActionPlaces.TOOLBAR, actions, <span class="keyword">false</span>);</span><br><span class="line">     <span class="comment">// 添加到控制台</span></span><br><span class="line">     consoleView.getComponent().add(actionToolbar.getComponent());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>在 <code>ConsoleViewImpl#createConsoleActions()</code> 中提供如下按钮组<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445934503-8f3f4941-7dc1-4d11-95de-c71ae22e08a1.png#align=left&display=inline&height=210&margin=%5Bobject%20Object%5D&name=image.png&originHeight=210&originWidth=32&size=1338&status=done&style=none&width=32" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445934503-8f3f4941-7dc1-4d11-95de-c71ae22e08a1.png#align=left&display=inline&height=210&margin=%5Bobject%20Object%5D&name=image.png&originHeight=210&originWidth=32&size=1338&status=done&style=none&width=32" srcset="data:image/png;base64,666" alt="image.png"></p><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p><code>ConsoleView#createConsoleActions</code> 中需要 Editor 组件被初始化，因此需要先执行 <code>ConsoleView#getComponent</code> 方法。</p>]]></content>
      
      
      <categories>
          
          <category> Intellij Idea </category>
          
          <category> plugin </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Intellij Idea </tag>
            
            <tag> plugin </tag>
            
            <tag> swing </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>结果集拦截器</title>
      <link href="2020/12/07/yuque/%E7%BB%93%E6%9E%9C%E9%9B%86%E6%8B%A6%E6%88%AA%E5%99%A8/"/>
      <url>2020/12/07/yuque/%E7%BB%93%E6%9E%9C%E9%9B%86%E6%8B%A6%E6%88%AA%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>修改已有的结果集，可以对查询的字段与 Java 属性直接进行任意的映射。</p><blockquote><p>实际项目中，为了防止修改表结构而造成锁表，因此采用拓展表放置新的字段，为了不修改原有业务逻辑，故需要使用切面来处理结果集新增的部分字段，将其映射到 Map 中。</p></blockquote><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p><strong>ps: 通过修改 XML 可以完成所有复杂查询，但要考虑到方案适配的通用性，</strong><del><strong>XML ヾ(•ω•`)o</strong></del><strong>。</strong><br>Mybatis 内置的 ResultHandler 拦截器可以对其 ResultMap 对象进行拦截。</p><h3 id="关键的数据结构"><a href="#关键的数据结构" class="headerlink" title="关键的数据结构"></a>关键的数据结构</h3><p>ResultMap 是 Mybatis 的结果集映射对象，与 XML 中 <ResultMap/> 相对应，其中通过 ResultMapping 定义了每一列字段与 Java 属性之间的映射关系，具体数据结构如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultMap</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 唯一标识符</span></span><br><span class="line">  <span class="keyword">private</span> String id;</span><br><span class="line">  <span class="comment">// 映射类型，Map 或 Java Bean</span></span><br><span class="line">  <span class="keyword">private</span> Class&lt;?&gt; type;</span><br><span class="line">  <span class="comment">// 每一列对应的映射关系</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; resultMappings;</span><br><span class="line">  <span class="comment">// 主键的映射关系，有助于生成缓存提升性能，可为空</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; idResultMappings;</span><br><span class="line">  <span class="comment">// 构造器映射关系</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; constructorResultMappings;</span><br><span class="line">  <span class="comment">// 属性映射关系</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; propertyResultMappings;</span><br><span class="line">  <span class="comment">// 被映射的列</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; mappedColumns;</span><br><span class="line">  <span class="comment">// 被映射的属性</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; mappedProperties;</span><br><span class="line">  <span class="comment">// 鉴别器，在不同字典值分别使用不同的映射关系时使用</span></span><br><span class="line">  <span class="keyword">private</span> Discriminator discriminator;</span><br><span class="line">  <span class="comment">// 是否存在嵌套的结果集映射，一对多、一对一时为 true</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedResultMaps;</span><br><span class="line">  <span class="comment">// 是否存在嵌套查询，与 &lt;select/&gt; 标签相对于，存在 N+1</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedQueries;</span><br><span class="line">  <span class="comment">// 是否自动映射，列名与属性名完全一致时启用可以取消显示映射</span></span><br><span class="line">  <span class="keyword">private</span> Boolean autoMapping;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Configuration configuration;</span><br><span class="line">  <span class="comment">// 属性名，Map 的 key 值，或 Java Bean 的属性，自动映射时会按照全局策略转换字符串</span></span><br><span class="line">  <span class="comment">// 默认时下划线转小驼峰</span></span><br><span class="line">  <span class="keyword">private</span> String property;</span><br><span class="line">  <span class="comment">// 列名，该列是嵌套结果集时可以为空，否则需要与属性值一一对应</span></span><br><span class="line">  <span class="keyword">private</span> String column;</span><br><span class="line">  <span class="comment">// Java 类型</span></span><br><span class="line">  <span class="keyword">private</span> Class&lt;?&gt; javaType;</span><br><span class="line">  <span class="comment">// Jdbc 类型</span></span><br><span class="line">  <span class="keyword">private</span> JdbcType jdbcType;</span><br><span class="line">  <span class="comment">// 类型处理器，常用的基本类型可以为空，走内置处理器，对于一些特殊的，如 list（程序） 转 string（数据库），</span></span><br><span class="line">  <span class="comment">// 则需要指定自定义的类型处理器，继承 TypeHandler 实现方法即可</span></span><br><span class="line">  <span class="keyword">private</span> TypeHandler&lt;?&gt; typeHandler;</span><br><span class="line">  <span class="comment">// 嵌套结果集的 Id</span></span><br><span class="line">  <span class="keyword">private</span> String nestedResultMapId;</span><br><span class="line">  <span class="comment">// 嵌套查询的 Id</span></span><br><span class="line">  <span class="keyword">private</span> String nestedQueryId;</span><br><span class="line">  <span class="comment">// 非空列</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; notNullColumns;</span><br><span class="line">  <span class="comment">// 列前缀，自动拼接在列名前，可以为空</span></span><br><span class="line">  <span class="keyword">private</span> String columnPrefix;</span><br><span class="line">  <span class="comment">// 主键、构造器标识</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultFlag&gt; flags;</span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; composites;</span><br><span class="line">  <span class="comment">// 结果集</span></span><br><span class="line">  <span class="keyword">private</span> String resultSet;</span><br><span class="line">  <span class="comment">// 外键列</span></span><br><span class="line">  <span class="keyword">private</span> String foreignColumn;</span><br><span class="line">  <span class="comment">// 是否启用懒加载，嵌套查询时生效</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> lazy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取-ResultMap-对象"><a href="#获取-ResultMap-对象" class="headerlink" title="获取 ResultMap 对象"></a>获取 ResultMap 对象</h3><p>ResultMap 可以通过 MappedStatement 获取，且获取的是一个不可修改的 List 集合。因此 ResultMap 的修改要点：</p><ol><li>遍历所有结果集映射；</li><li>反射重置结果集列表；</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultHanlderInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 获取默认处理器</span></span><br><span class="line">DefaultResultSetHandler defaultResultSetHandler = (DefaultResultSetHandler) invocation.getTarget();</span><br><span class="line">    <span class="comment">// mybatis 元数据对象，辅助工具，屏蔽反射受检异常</span></span><br><span class="line">        MetaObject metaStatementHandler = SystemMetaObject.forObject(defaultResultSetHandler);</span><br><span class="line">    <span class="comment">// 获取映射语句，当前执行 SQL 的所有信息</span></span><br><span class="line">        <span class="comment">// 其中存在 List&lt;ResultMap&gt; 属性，每一个 ResultMap 对应一个 Java Bean，</span></span><br><span class="line">        <span class="comment">// 一般只有一个值，即 SQL 的返回值</span></span><br><span class="line">        MappedStatement mappedStatement = (MappedStatement) metaStatementHandler.getValue(<span class="string">&quot;mappedStatement&quot;</span>);</span><br><span class="line">        <span class="comment">// 处理 ResultMap</span></span><br><span class="line">        <span class="keyword">for</span> (ResultMap resultMap: mappedStatement.getResultMap) &#123;</span><br><span class="line">            <span class="comment">// 重建 ResultMap</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="重建-ResultMap"><a href="#重建-ResultMap" class="headerlink" title="重建 ResultMap"></a>重建 ResultMap</h3><p>ResultMap 的获取并不复杂，事实上很轻易的就可以拿到，通过调试或者查看源码，可知，通过 getter 方法可以得到列映射关系，ResultMapping，同样这也是不可修改的 List 集合，但不同的是，直接通过反射修改是不会生效的，所有的（列或结果集）映射关系必须要先向 mybatis 的 configuration 注册才行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重建 ResultMap</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultMap <span class="title">rebuild</span><span class="params">(MappedStatement ms, ResultMap resultMap)</span> </span>&#123;</span><br><span class="line">       MapperBuilderAssistant builderAssistant = getMapperBuilderAssistant(ms);</span><br><span class="line">       <span class="comment">// 先获取原有的 ResultMapping 列表，仅对要修改的部分做处理（增、改、删）</span></span><br><span class="line">       List&lt;ResultMapping&gt; resultMappings = Lists.newArrayList(resultMap.getResultMappings().iterator());</span><br><span class="line">       <span class="comment">// 增加一个新的映射</span></span><br><span class="line">       resultMappings.add(getResultMapping());</span><br><span class="line">       <span class="comment">// 注册 ResultMap 到 configuration</span></span><br><span class="line">       ResultMapResolver resultMapResolver = <span class="keyword">new</span> ResultMapResolver(builderAssistant,</span><br><span class="line">               <span class="string">&quot;id，唯一标识，不可重复&quot;</span>),</span><br><span class="line">               resultMap.getType(), <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">               <span class="comment">// 将 resultMappings 设为不可变 list</span></span><br><span class="line">               Collections.unmodifiableList(resultMappings), 是否自动映射);</span><br><span class="line">       <span class="keyword">return</span> resultMapResolver.resolve();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建一个新的列映射关系</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultMapping <span class="title">getResultMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ResultMapping.Builder(builderAssistant.getConfiguration(),</span><br><span class="line">                       getProperty(<span class="string">&quot;属性名&quot;</span>))</span><br><span class="line">                       .column(<span class="string">&quot;列名&quot;</span>))</span><br><span class="line">                       .typeHandler(类型处理器.class)</span><br><span class="line">                       .jdbcType(JdbcType.value))</span><br><span class="line">                       .javaType(Java 类型.class)</span><br><span class="line">           .nestedResultMapId(<span class="string">&quot;嵌套的 ResultMap id， 需要先注册&quot;</span>)</span><br><span class="line">                       .build())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取映射器构建助手</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ms 映射语句</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 映射器构建助手</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> MapperBuilderAssistant <span class="title">getMapperBuilderAssistant</span><span class="params">(MappedStatement ms)</span> </span>&#123;</span><br><span class="line">       Configuration configuration = ms.getConfiguration();</span><br><span class="line">       String resource = ms.getResource();</span><br><span class="line">       String nameSpace = ms.getId().substring(<span class="number">0</span>, ms.getId().lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">       MapperBuilderAssistant builderAssistant = <span class="keyword">new</span> MapperBuilderAssistant(configuration, resource);</span><br><span class="line">       builderAssistant.setCurrentNamespace(nameSpace);</span><br><span class="line">       <span class="keyword">return</span> builderAssistant;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li>对应 （XML 文件）没有 ResultMap（或使用 ResultType）的结果集，需要设置自动映射（autoMapping = true），否则可能出现属性丢失的问题；</li><li>仅仅（通过反射）修改 ResultMap 的 resultMappings 属性不会生效，因为 ResultMapping 用于记录映射关系，却不是 Mybatis Configuration 真实的读取的信息，需要通过 ResultMapResolver 解析器读取信息，并注册到配置中心；</li><li>对于使用线程变量做拦截器标记时（如 PageHelper），在最终返回时拦截器结束时需要对线程变量进行 clear，谨防 OOM；</li><li>也可以在拦截器中直接读取 ResultSet，手动进行映射，或使用 Json 等工具，最终返回格式化后的对象，但需要考虑到列名与属性名不一样的场景，且对 Mybatis 映射产生破坏（不推荐）；</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过修改 ResultMap 可以任意的进行结果集映射，就像在 XML 中定义了 <ResultMap/> 标签一样，但不同的是，其可以通过注解或参数等方式，对某个查询进行标记，可以在运行时动态的修改返回查询结果，且 ResultMap 会被 Mybaits 自动缓存。</p>]]></content>
      
      
      <categories>
          
          <category> Mybatis </category>
          
          <category> 拦截器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 拦截器 </tag>
            
            <tag> 结果集 </tag>
            
            <tag> Mybatis </tag>
            
            <tag> ResultMap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自动发行插件</title>
      <link href="2020/12/04/yuque/%E8%87%AA%E5%8A%A8%E5%8F%91%E8%A1%8C%E6%8F%92%E4%BB%B6/"/>
      <url>2020/12/04/yuque/%E8%87%AA%E5%8A%A8%E5%8F%91%E8%A1%8C%E6%8F%92%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在项目迭代过程中，需要为不同的版本号打上 Tag，对于发行的稳定版本则需要上传到指定的仓库。手动操作则过于繁琐，且无法统一 Tag 的样式，因此需要一款实现自动的可配置的发行工具。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>使用 <a href="https://maven.apache.org/maven-release/maven-release-plugin/index.html">maven-release-plugin</a> 插件，其提供了自动追赠版本号、自动切换 snapshots 和 releases 版本、以及自动打 Tag 与版本发行等功能。</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 父模块 pom.xml --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- git 地址 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">connection</span>&gt;</span>scm:git:url<span class="tag">&lt;/<span class="name">connection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">developerConnection</span>&gt;</span>scm:git:url<span class="tag">&lt;/<span class="name">developerConnection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tag</span>&gt;</span>HEAD<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scm</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-release-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0-M1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">username</span>&gt;</span>scm 用户名<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 对于 github 用户，（当密码无效时）可能需要 repo token 权限（代替密码） --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">password</span>&gt;</span>scm 密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">scmCommentPrefix</span>&gt;</span>[提交信息的前缀]<span class="tag">&lt;/<span class="name">scmCommentPrefix</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 子模块的版本号与父模块是否一致 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">autoVersionSubmodules</span>&gt;</span>true<span class="tag">&lt;/<span class="name">autoVersionSubmodules</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- tag 的格式，如 v1.0.0 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">tagNameFormat</span>&gt;</span>v@&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tagNameFormat</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 跳过测试以及生成 javadoc 文档（注释不规范时会报错）--&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">arguments</span>&gt;</span>-DskipTests -DuseReleaseProfile=false<span class="tag">&lt;/<span class="name">arguments</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- tag 的路径，gitee 路径，主要是快 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">tagBase</span>&gt;</span>https://gitee.com/&#123;用户名&#125;/&#123;项目名&#125;/tags<span class="tag">&lt;/<span class="name">tagBase</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置发行路径，这里配置的是阿里云效的私有仓库 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 需要在 settings.xml 中配置 server 的用户名和密码，且指定的 id 需要和下面的一致 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>rdc-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://packages.aliyun.com/maven/repository/2046382-release-Kot3ui/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>rdc-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://packages.aliyun.com/maven/repository/2046382-snapshot-sZVDXF/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- settings.xml --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- id 需要和上面一致 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>rdc-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">username</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>rdc-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br></pre></td></tr></table></figure><p>正式发行一定要配置 <code>distributionManagement</code> 且要注意授权信息（账号、密码）是否填写且正确，否则授权无法通过产生 401 异常。</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 预备发行：打 Tag，自动切换快照版本</span></span><br><span class="line">mvn release:prepare</span><br><span class="line"><span class="comment"># 将已有的 Tag 发行到指定仓库</span></span><br><span class="line">mvn release:perform</span><br><span class="line"><span class="comment"># 异常时回滚</span></span><br><span class="line">mvn release:rollback</span><br></pre></td></tr></table></figure><p>在 idea 可以通过可视化插件使用，需要注意的时，正式发行前一定要先进行预备发行。且每次打 Tag 时必须要求 git 是最新提交，正式发行使用的是上次 Tag（历史提交） 中的 pom，因此每次修改需要先提交到 git。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1607019495482-66a4eaac-b962-45ee-8685-b00b5de461b9.png#align=left&display=inline&height=392&margin=%5Bobject%20Object%5D&name=image.png&originHeight=392&originWidth=554&size=35138&status=done&style=none&width=554" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1607019495482-66a4eaac-b962-45ee-8685-b00b5de461b9.png#align=left&display=inline&height=392&margin=%5Bobject%20Object%5D&name=image.png&originHeight=392&originWidth=554&size=35138&status=done&style=none&width=554" srcset="data:image/png;base64,666" alt="image.png"></p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li>提交时出现 <code>remote: Invalid username or password</code>，确保自己的登录信息没有错，则尝试使用 repo token 来替换密码；</li><li>发布 prepare 之后，会产生各个模块的 pom 备份文件，最好在提交之前加入 .gitignore;</li></ol>]]></content>
      
      
      <categories>
          
          <category> Maven </category>
          
          <category> 插件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Maven </tag>
            
            <tag> 插件 </tag>
            
            <tag> 发版 </tag>
            
            <tag> Tag </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>聚合项目版本号管理</title>
      <link href="2020/12/03/yuque/%E8%81%9A%E5%90%88%E9%A1%B9%E7%9B%AE%E7%89%88%E6%9C%AC%E5%8F%B7%E7%AE%A1%E7%90%86/"/>
      <url>2020/12/03/yuque/%E8%81%9A%E5%90%88%E9%A1%B9%E7%9B%AE%E7%89%88%E6%9C%AC%E5%8F%B7%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在 Maven 聚合工程中，通常修改版本号是一件较为繁琐的过程，特别是子模块较多时，复制粘贴也得谨防遗漏，因此需要一款自动化工具，来完成机械的工作。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>插件 <a href="https://mvnrepository.com/artifact/org.codehaus.mojo/versions-maven-plugin">versions-maven-plugin</a> 正是用来解决这类痛点。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 父模块 pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>yyy<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>a.b.c<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 聚合子项目 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>模块-A<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">module</span>&gt;</span>模块-B<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">module</span>&gt;</span>模块-C<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>模块-D<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 统一子模块版本号，$&#123;project.version&#125; 为父项目版本号 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 子模块相互依赖时无需指定版本号 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>模块-A<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 引入插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>versions-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 子模块 pom.xml --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- parent 填入完整的父项目信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>yyy<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>a.b.c<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure><p>idea 中可以通过 Maven 插件栏选中 versions:set，快速设置。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1607007203997-376d28fb-4d09-426b-bf2c-3529edc3f2bc.png#align=left&display=inline&height=437&margin=%5Bobject%20Object%5D&name=image.png&originHeight=437&originWidth=618&size=36244&status=done&style=none&width=618" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1607007203997-376d28fb-4d09-426b-bf2c-3529edc3f2bc.png#align=left&display=inline&height=437&margin=%5Bobject%20Object%5D&name=image.png&originHeight=437&originWidth=618&size=36244&status=done&style=none&width=618" srcset="data:image/png;base64,666" alt="image.png"><br>在运行窗口填写版本号即可。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1607007473025-e2efb12e-d6bc-495c-8731-60bb45a1ecfb.png#align=left&display=inline&height=247&margin=%5Bobject%20Object%5D&name=image.png&originHeight=247&originWidth=928&size=30085&status=done&style=none&width=928" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1607007473025-e2efb12e-d6bc-495c-8731-60bb45a1ecfb.png#align=left&display=inline&height=247&margin=%5Bobject%20Object%5D&name=image.png&originHeight=247&originWidth=928&size=30085&status=done&style=none&width=928" srcset="data:image/png;base64,666" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> maven </category>
          
          <category> 聚合项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> maven </tag>
            
            <tag> 聚合项目 </tag>
            
            <tag> 版本更新 </tag>
            
            <tag> version </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis XML 新增异常</title>
      <link href="2020/11/27/yuque/Mybatis%20XML%20%E6%96%B0%E5%A2%9E%E5%BC%82%E5%B8%B8/"/>
      <url>2020/11/27/yuque/Mybatis%20XML%20%E6%96%B0%E5%A2%9E%E5%BC%82%E5%B8%B8/</url>
      
        <content type="html"><![CDATA[<h2 id="异常信息"><a href="#异常信息" class="headerlink" title="异常信息"></a>异常信息</h2><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org<span class="variable">.springframework</span><span class="variable">.dao</span><span class="variable">.DataIntegrityViolationException</span>:</span><br><span class="line">### Error updating database.  Cause: java<span class="variable">.sql</span><span class="variable">.SQLException</span>: Field &#x27;id&#x27; doesn&#x27;t have a <span class="keyword">default</span> value</span><br><span class="line">### The error may exist in file [xxx<span class="variable">.xml</span>]</span><br><span class="line">### The error may involve xxxMapper<span class="variable">.insert</span>-Inline</span><br><span class="line">### The error occurred <span class="keyword">while</span> setting parameters</span><br><span class="line">### SQL: insert into xxx                                                 create_time )           values ( ?,             ?,             ?,             ?,                                                    ? )</span><br><span class="line">### Cause: java<span class="variable">.sql</span><span class="variable">.SQLException</span>: Field &#x27;id&#x27; doesn&#x27;t have a <span class="keyword">default</span> value</span><br><span class="line">; Field &#x27;id&#x27; doesn&#x27;t have a <span class="keyword">default</span> value; nested exception is java<span class="variable">.sql</span><span class="variable">.SQLException</span>: Field &#x27;id&#x27; doesn&#x27;t have a <span class="keyword">default</span> value</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>原因：插入时没有指定 id，且数据库没有自增主键。<br>处理：在 xml 中添加 <code>&lt;if test=&quot;id != null&quot;&gt;id,&lt;/if&gt;</code> 手动设置 id；或者在数据库中设置自增。</p>]]></content>
      
      
      <categories>
          
          <category> mybatis </category>
          
          <category> xml </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis </tag>
            
            <tag> xml </tag>
            
            <tag> insert </tag>
            
            <tag> 主键 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多字段联合校验</title>
      <link href="2020/11/18/yuque/%E5%A4%9A%E5%AD%97%E6%AE%B5%E8%81%94%E5%90%88%E6%A0%A1%E9%AA%8C/"/>
      <url>2020/11/18/yuque/%E5%A4%9A%E5%AD%97%E6%AE%B5%E8%81%94%E5%90%88%E6%A0%A1%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<p>tags: [参数校验,@GroupSequenceProvider,hibernate validator,Bean Validation]<br>categories: [springboot,参数校验]</p><hr><h2 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h2><p>在使用进行数据校验时，经常会遇到需要多个字段组合式的校验。<br><strong>例如</strong></p><ul><li>某个嘉年华俱乐部门票对不同人群存在不同的定价：</li></ul><ol><li>年龄必须大于 12 岁；</li><li>12 ~ 18 岁半价；</li><li>18 岁以上全价；</li><li>coser 则可以免费；</li></ol><p>换句话来说，任何年龄大于 12 岁的人都可以购买全价，对于半价票需要校验年龄是否满足未成年，对于免费票需要校验是否是 coser。</p><h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><p>入场时，需要根据门票类型动态的切换校验分组，定义如下的 Person 类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@GroupSequenceProvider(Person.FareTypeGroupSequenceProvider.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 年龄</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Min(value = 12, message = &quot;年龄最小不低于 12 岁&quot;)</span></span><br><span class="line">    <span class="meta">@Max(value = 18, message = &quot;年龄大于 18 岁需要购买全价门票&quot;, groups=WhenIsHalf.class)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 票价[0=免费,1=半价,2=全价]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;票价类型不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer fareType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是 coser</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AssertTrue(message = &quot;只有 coser 才可以免费进去&quot;, groups = WhenIsFree.class)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean coser;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WhenIsFree</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WhenIsHalf</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验分组处理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FareTypeGroupSequenceProvider</span> <span class="keyword">implements</span> <span class="title">DefaultGroupSequenceProvider</span>&lt;<span class="title">Person</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> List&lt;Class&lt;?&gt;&gt; getValidationGroups(Person person) &#123;</span><br><span class="line">            ArrayList&lt;Class&lt;?&gt;&gt; list = Lists.newArrayList();</span><br><span class="line">            list.add(Person.class);</span><br><span class="line">            <span class="comment">// 判空</span></span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(person)) &#123;</span><br><span class="line">                <span class="comment">// 当 fareType = 0 时</span></span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(person.getFareType(), <span class="number">0</span>)) &#123;</span><br><span class="line">                list.add(WhenIsFree.class);</span><br><span class="line">                &#125; <span class="keyword">else</span> (Objects.equals(person.getFareType(), <span class="number">1</span>)) &#123;</span><br><span class="line">                list.add(WhenIsHalf.class);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol><li>DefaultGroupSequenceProvider 类型是泛型类，必须指定为需要参数校验的 Bean 类型；</li><li>DefaultGroupSequenceProvider.getValidationGroups 方法返回的 list 中必须包含 Bean 类型;</li><li>DefaultGroupSequenceProvider 只能增强 Default.class 分组;</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>HttpMediaTypeNotAcceptableException</title>
      <link href="2020/10/22/yuque/HttpMediaTypeNotAcceptableException/"/>
      <url>2020/10/22/yuque/HttpMediaTypeNotAcceptableException/</url>
      
        <content type="html"><![CDATA[<h2 id="异常描述"><a href="#异常描述" class="headerlink" title="异常描述"></a>异常描述</h2><p>导出 Excel 时产生异常，提示：Could not find acceptable representation。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.HttpMediaTypeNotAcceptableException: Could not find acceptable representation</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor.writeWithMessageConverters(AbstractMessageConverterMethodProcessor.java:307)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor.handleReturnValue(RequestResponseBodyMethodProcessor.java:180)</span><br><span class="line">at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:82)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:122)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver.doResolveHandlerMethodException(ExceptionHandlerExceptionResolver.java:412)</span><br><span class="line">at org.springframework.web.servlet.handler.AbstractHandlerMethodExceptionResolver.doResolveException(AbstractHandlerMethodExceptionResolver.java:61)</span><br><span class="line">at org.springframework.web.servlet.handler.AbstractHandlerExceptionResolver.resolveException(AbstractHandlerExceptionResolver.java:140)</span><br><span class="line">at org.springframework.web.servlet.handler.HandlerExceptionResolverComposite.resolveException(HandlerExceptionResolverComposite.java:79)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.processHandlerException(DispatcherServlet.java:1298)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.processDispatchResult(DispatcherServlet.java:1110)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1056)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:942)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1005)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:897)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:645)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:882)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:750)</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:712)</span><br><span class="line">at org.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:580)</span><br><span class="line">at org.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:516)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.custom(StandardHostValve.java:388)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.status(StandardHostValve.java:253)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.throwable(StandardHostValve.java:348)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:173)</span><br><span class="line">at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:92)</span><br><span class="line">at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)</span><br><span class="line">at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:343)</span><br><span class="line">at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:408)</span><br><span class="line">at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)</span><br><span class="line">at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:853)</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1587)</span><br><span class="line">at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)</span><br><span class="line">at java.lang.Thread.run(Thread.java:748)</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>向 response 中写入流时，接口不能存在 json 格式的返回值。将返回值改成 void 即可解决问题。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>消费者</title>
      <link href="2020/08/26/yuque/%E6%B6%88%E8%B4%B9%E8%80%85/"/>
      <url>2020/08/26/yuque/%E6%B6%88%E8%B4%B9%E8%80%85/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>接手了一个陈年的 dubbo 项目，现准备抽离某个模块，以前的聚合工程太大了，不想动，就另起了一个项目作为消费者调用之前的服务。<br>之前只在聚合项目中进行服务互调，现在两个项目之间完全独立，只通过 dubbo 交互，因此出现了一些问题，在此记录一下。</p><h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><h3 id="Refrence"><a href="#Refrence" class="headerlink" title="@Refrence"></a>@Refrence</h3><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><p>服务消费者引用服务注解。提供了大量的配置属性，实际上使用时，只需标记注解，所有属性采用默认设置即可。<br>对于消费者而言，期望的是开箱即用的服务，因此服务提供者应该应该装配合理的默认属性，避免消费者进行不透明操作。</p><h4 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h4><p>@Reference 不能直接标注在接口上，其提供远程服务自动注入功能，类似于 @Autowired、@Resource 注解，应在类属性字段或 setter 方法上使用。<br>接口的<strong>类限定名</strong>必须和服务提供者一致，否则出现无法获取服务的异常。<br><strong>注意：</strong>interfaceName 属性指定的接口名并不会生效。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to check the status of the service &lt;ServiceName&gt;. No provider available for the service &lt;ServiceName&gt; from the url zookeeper:&#x2F;&#x2F;&lt;URL&gt; to the consume &lt;IP&gt; use dubbo version 2.7.6</span><br></pre></td></tr></table></figure><p>同样，接口暴露的参数的<strong>类限定名</strong>必须和服务提供者一致，否则会出现序列化异常的报错。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.apache.dubbo.remoting.RemotingException: Fail to decode request due to: RpcInvocation [methodName&#x3D;&lt;MethodName&gt;, parameterTypes&#x3D;null, arguments&#x3D;null, attachments&#x3D;&#123;path&#x3D;&lt;ServiceName&gt;, input&#x3D;348, dubbo&#x3D;2.0.2, version&#x3D;0.0.0&#125;]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>实际上消费端错误信息并不是很清晰，通过服务端日志，可以看到是在 rpc 解析时出现类无法找到的异常，该类 <ServiceName> 是接口参数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[New I&#x2F;O worker #10] WARN c.a.d.r.p.d.DecodeableRpcInvocation [Slf4jLogger.java : 62]  [DUBBO] Decode rpc invocation failed: Read invocation data failed.</span><br><span class="line">java.lang.ClassNotFoundException: &lt;ServiceName&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="EnableDubbo"><a href="#EnableDubbo" class="headerlink" title="@EnableDubbo"></a>@EnableDubbo</h3><p>用于启用 dubbo 服务，需要指定接口的包名提供扫描。</p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
          <category> dubbo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dubbo </tag>
            
            <tag> springboot </tag>
            
            <tag> 踩坑日记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>页面加载优化</title>
      <link href="2020/08/14/yuque/%E9%A1%B5%E9%9D%A2%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96/"/>
      <url>2020/08/14/yuque/%E9%A1%B5%E9%9D%A2%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="GZIP-压缩"><a href="#GZIP-压缩" class="headerlink" title="GZIP 压缩"></a>GZIP 压缩</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install compression-webpack-plugin --save-dev</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CompressionPlugin = <span class="built_in">require</span>(<span class="string">&quot;compression-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">cfg.plugins.push(<span class="keyword">new</span> CompressionPlugin());</span><br></pre></td></tr></table></figure><h2 id="ES6-压缩"><a href="#ES6-压缩" class="headerlink" title="ES6 压缩"></a>ES6 压缩</h2><p>使用 <code>terser-webpack-plugin</code> 插件对 es6 语法的 js 文件进行压缩。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install terser-webpack-plugin --save-dev</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> TerserPlugin = <span class="built_in">require</span>(<span class="string">&quot;terser-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">cfg.plugins.push(</span><br><span class="line">  <span class="keyword">new</span> TerserPlugin(&#123;</span><br><span class="line">    cache: <span class="literal">true</span>,</span><br><span class="line">    parallel: <span class="literal">true</span>,</span><br><span class="line">    sourceMap: <span class="literal">true</span>,</span><br><span class="line">    terserOptions: &#123;</span><br><span class="line">      compress: &#123;</span><br><span class="line">        drop_debugger: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p><strong>注意：</strong>使用 UglifyJs 打包会报错。<br>提示不能识别 <code>const</code> 等 ES6 的语法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Unexpected token: keyword «const» [js/vendor.58d16842.js:46032,0]</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>装饰器</title>
      <link href="2020/08/13/yuque/%E8%A3%85%E9%A5%B0%E5%99%A8/"/>
      <url>2020/08/13/yuque/%E8%A3%85%E9%A5%B0%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="使用理解"><a href="#使用理解" class="headerlink" title="使用理解"></a>使用理解</h2><p>在 JavaScript 中，装饰器的作用可以类比 Java 的注解。但其更多的类似于 AOP 语法糖，因为其本身不需要指定处理器，装饰器在定义时即可对目标进行环绕增强，可以有效地剥离出与业务无关的模板代码，减少冗余。其本质上是一个特定类型的函数，通过 <code>@函数名</code> 的方式使用。</p><h2 id="装饰器类型"><a href="#装饰器类型" class="headerlink" title="装饰器类型"></a>装饰器类型</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> TypedPropertyDescriptor&lt;T&gt; &#123;</span><br><span class="line">  enumerable?: <span class="built_in">boolean</span>;</span><br><span class="line">  configurable?: <span class="built_in">boolean</span>;</span><br><span class="line">  writable?: <span class="built_in">boolean</span>;</span><br><span class="line">  value?: T;</span><br><span class="line">  get?: <span class="function">() =&gt;</span> T;</span><br><span class="line">  set?: <span class="function">(<span class="params">value: T</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> ClassDecorator = <span class="xml"><span class="tag">&lt;<span class="name">TFunction</span> <span class="attr">extends</span> <span class="attr">Function</span>&gt;</span>(</span></span><br><span class="line"><span class="xml">  target: TFunction</span></span><br><span class="line"><span class="xml">) =&gt; TFunction | void;</span></span><br><span class="line"><span class="xml">declare type PropertyDecorator = (</span></span><br><span class="line"><span class="xml">  target: Object,</span></span><br><span class="line"><span class="xml">  propertyKey: string | symbol</span></span><br><span class="line"><span class="xml">) =&gt; void;</span></span><br><span class="line">declare type MethodDecorator = &lt;T&gt;(</span><br><span class="line">  target: Object,</span><br><span class="line">  propertyKey: string | symbol,</span><br><span class="line">  descriptor: TypedPropertyDescriptor&lt;T&gt;</span><br><span class="line">) =&gt; TypedPropertyDescriptor&lt;T&gt; | void;</span><br><span class="line">declare type ParameterDecorator = (</span><br><span class="line">  target: Object,</span><br><span class="line">  propertyKey: string | symbol,</span><br><span class="line">  parameterIndex: number</span><br><span class="line">) =&gt; void;</span><br></pre></td></tr></table></figure><p>通过 TypeScript 的声明文件，可以清晰的看到装饰器类型定义，对于不同类型的装饰器，其方法参数总是固定的且通过上下文注入。换言之，装饰器本身是不支持的自定义参数的，为了突破这一限制，通常使用工厂模式，即通过工厂函数接收参数，并返回一个装饰器函数。</p><h2 id="装饰器工厂"><a href="#装饰器工厂" class="headerlink" title="装饰器工厂"></a>装饰器工厂</h2><p>上文提到，工厂模式并不是装饰器的过度设计，而是对其本身功能的再次加强，是为了提供可自定义入参。下面是一个方法装饰器工厂的一般形式。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法装饰器工厂</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">methodDecoratorFactory</span>(<span class="params">msg: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line"><span class="comment">// do something...(预处理)</span></span><br><span class="line">  <span class="keyword">return</span> funtion(target: <span class="built_in">Object</span>,</span><br><span class="line">    propertyKey: <span class="built_in">string</span>,</span><br><span class="line">    decorator: TypedPropertyDescriptor&lt;<span class="built_in">any</span>&gt;) &#123;</span><br><span class="line">    <span class="comment">// 记录原方法</span></span><br><span class="line">    <span class="keyword">const</span> fn = decorator.value;</span><br><span class="line">    <span class="comment">// 重新定义方法，使用装饰器环绕原方法</span></span><br><span class="line">    <span class="comment">// 不能使用箭头函数，否则会丢失上下文（this 会指向箭头函数）</span></span><br><span class="line">    decorator.value = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 前置处理</span></span><br><span class="line">      <span class="comment">// arguments 需要解构传入，否则会将原参数包装成数组</span></span><br><span class="line">      <span class="comment">// 或 使用 fn.apply(this. arguments)</span></span><br><span class="line">      <span class="keyword">const</span> result = fn.call(<span class="built_in">this</span>, ...arguments)</span><br><span class="line">      <span class="comment">// 后置处理</span></span><br><span class="line">      <span class="comment">// 必须返回原方法结果，否则会丢失结果</span></span><br><span class="line">      <span class="keyword">return</span>  result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decorator;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="实践意义"><a href="#实践意义" class="headerlink" title="实践意义"></a>实践意义</h2><h3 id="日志装饰器"><a href="#日志装饰器" class="headerlink" title="日志装饰器"></a>日志装饰器</h3><p>记录方法的入参、出参以及执行时间。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">hander?: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> loggerInfo = <span class="built_in">Object</span>.seal(&#123;</span><br><span class="line">    method: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    input: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    output: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    custom: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    timeuse: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 一个用于记录使用时间的对象</span></span><br><span class="line">  <span class="keyword">const</span> timeUse = TimeUse.get();</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    target: <span class="built_in">Object</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    key: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    descriptor: TypedPropertyDescriptor&lt;<span class="built_in">any</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">TypedPropertyDescriptor</span>&lt;<span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> oldValue = descriptor.value;</span><br><span class="line">    descriptor.value = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      loggerInfo.method = key;</span><br><span class="line">      <span class="keyword">const</span> args: <span class="built_in">Array</span>&lt;<span class="built_in">any</span>&gt; = [];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> <span class="built_in">arguments</span>) &#123;</span><br><span class="line">        args.push(<span class="built_in">arguments</span>[index]);</span><br><span class="line">      &#125;</span><br><span class="line">      loggerInfo.input = args.join(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">      <span class="comment">// 执行原方法</span></span><br><span class="line">      <span class="keyword">const</span> value = <span class="keyword">await</span> oldValue.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">      loggerInfo.output = value;</span><br><span class="line">      hander &amp;&amp;</span><br><span class="line">        (loggerInfo.custom = hander(loggerInfo.input, loggerInfo.output) || <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 被调用时，会自动发出一个事件</span></span><br><span class="line">      loggerInfo.timeuse = <span class="string">`<span class="subst">$&#123;timeUse.off()&#125;</span>ms`</span>;</span><br><span class="line">      <span class="built_in">console</span>.debug(loggerInfo);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> descriptor;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="加载装饰器"><a href="#加载装饰器" class="headerlink" title="加载装饰器"></a>加载装饰器</h2><p>在异步请求数据时显示加载动画。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> loading = <span class="function"><span class="keyword">function</span> (<span class="params">message: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    target: <span class="built_in">Object</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    propertyKey: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    decorator: TypedPropertyDescriptor&lt;<span class="built_in">any</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 记录原方法</span></span><br><span class="line">    <span class="keyword">const</span> fn = decorator.value;</span><br><span class="line">    decorator.value = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Loading 是 UI 框架中的加载动画</span></span><br><span class="line">        Loading.show(&#123; message &#125;);</span><br><span class="line">        <span class="keyword">const</span> resp = <span class="keyword">await</span> fn.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 此时需要在 finally 关闭动画，防止异常时被阻塞</span></span><br><span class="line">        Loading.hide();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> decorator;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>装饰器只能在类及其成员属性上使用，不能作用在静态方法（类方法）上。</p>]]></content>
      
      
      <categories>
          
          <category> Typescript </category>
          
          <category> 装饰器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Typescript </tag>
            
            <tag> Javascript </tag>
            
            <tag> 注解 </tag>
            
            <tag> 装饰器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MapStruct 未生效</title>
      <link href="2020/07/23/yuque/MapStruct%20%E6%9C%AA%E7%94%9F%E6%95%88/"/>
      <url>2020/07/23/yuque/MapStruct%20%E6%9C%AA%E7%94%9F%E6%95%88/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>无法找不到实现类 <code>Cannot find implementation</code>。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="1-包含-Swagger-依赖"><a href="#1-包含-Swagger-依赖" class="headerlink" title="1. 包含 Swagger 依赖"></a>1. 包含 Swagger 依赖</h3><p>在项目中使用了 swagger，需要将其中的 mapstruct 排除后，重新在 pom 中添加。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>重新引入：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Oracle 误删数据恢复</title>
      <link href="2020/06/17/yuque/Oracle%20%E8%AF%AF%E5%88%A0%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D/"/>
      <url>2020/06/17/yuque/Oracle%20%E8%AF%AF%E5%88%A0%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D/</url>
      
        <content type="html"><![CDATA[<h2 id="DELETE-误删方案"><a href="#DELETE-误删方案" class="headerlink" title="DELETE 误删方案"></a>DELETE 误删方案</h2><p>Oracle 提供闪回，在数据被删除后还没有进行大量操作（被删除数据的块没有被覆写），即可通过闪回方式直接找回删除的数据。</p><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol><li>确认数据删除时间；</li><li><code>select * from 表名 as of timestamp to_timestamp(&#39;时间&#39;,&#39;yyyy-mm-dd hh24:mi:ss&#39;)</code>，可查询出该表的历史数据；</li><li><code>insert into 表明 (查询 sql)</code>，可将查询出的数据直接插入到表中；</li></ol>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
          <category> Oracle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> oracle </tag>
            
            <tag> sql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo 自动提取摘要</title>
      <link href="2020/06/08/yuque/Hexo%20%E8%87%AA%E5%8A%A8%E6%8F%90%E5%8F%96%E6%91%98%E8%A6%81/"/>
      <url>2020/06/08/yuque/Hexo%20%E8%87%AA%E5%8A%A8%E6%8F%90%E5%8F%96%E6%91%98%E8%A6%81/</url>
      
        <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>通过添加  <code>&lt;!-- more --&gt;</code>  标记，可以手动切割文章，实现在列表页面仅显示文章摘要。但像这样在文章内部手动添加标记的方法，对文章进行了侵入式的改造，添加了与内容实际无关的信息，并不是很理想。<br>为了能够实现自动添加摘要，可以通过现有的 hexo 插件来实现，如：hexo-excerpt，hexo-auto-excerpt。但两者各自存在一定的局限，并不能很好的实现预期的效果，因此必须手动对其插件代码进行改造。</p><h2 id="插件对比"><a href="#插件对比" class="headerlink" title="插件对比"></a>插件对比</h2><p><strong>hexo-excerpt</strong>：作用在生成器执行过程中，通过 dom 树自动提取文章内容，摘要提取相对完整灵活，但是只能作用在首页列表；<br><strong>hexo-auto-excerpt</strong>：作用在文章后置过滤器执行过程中，通过指定固定的字符数自动提取文章内容，可以为所用列表项添加摘要；</p><h2 id="插件实现"><a href="#插件实现" class="headerlink" title="插件实现"></a>插件实现</h2><p>在参考了上述两个插件的源码之后，发现将其实现机制组合起来，可以有效的解决当前的痛点。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> htmlparser = <span class="built_in">require</span>(<span class="string">&quot;htmlparser2&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> domutils = <span class="built_in">require</span>(<span class="string">&quot;domutils&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> defaults = <span class="built_in">require</span>(<span class="string">&quot;lodash.defaults&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// hexo-excerpt 中提供的方法，具体见下文</span></span><br><span class="line"><span class="keyword">const</span> Filter = <span class="built_in">require</span>(<span class="string">&quot;./lib/dom-filter&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> DEFAULT_CONFIG = &#123;</span><br><span class="line">  depth: <span class="number">2</span>,</span><br><span class="line">  excerpt_excludes: [],</span><br><span class="line">  more_excludes: [],</span><br><span class="line">  hideWholePostExcerpts: <span class="literal">false</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册过滤器，参考 hexo-auto-excerpt</span></span><br><span class="line">hexo.extend.filter.register(<span class="string">&quot;after_post_render&quot;</span>, excerpt);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局参数</span></span><br><span class="line"><span class="keyword">let</span> excerptFilter;</span><br><span class="line"><span class="keyword">let</span> moreFilter;</span><br><span class="line"><span class="keyword">let</span> opts;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提取文章摘要, 此部分提取自 hexo-excerpt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Document&#125;</span> </span>post 文章</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">excerpt</span>(<span class="params">post</span>) </span>&#123;</span><br><span class="line">  init();</span><br><span class="line">  <span class="comment">//honour the &lt;!-- more --&gt; !!!</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    /&lt;!--\s*more\s*--&gt;/.test(post.content) ||</span><br><span class="line">    post.content.indexOf(<span class="string">&#x27;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&#x27;</span>) !== -<span class="number">1</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> post;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> nodes = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> parser = <span class="keyword">new</span> htmlparser.Parser(</span><br><span class="line">    <span class="keyword">new</span> htmlparser.DomHandler(<span class="function">(<span class="params">err, dom</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">        nodes = dom;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;),</span><br><span class="line">    &#123;</span><br><span class="line">      decodeEntities: <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  parser.write(post.content);</span><br><span class="line">  parser.done();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// tracks how many tag nodes we found</span></span><br><span class="line">  <span class="keyword">let</span> stopIndex = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// tracks how many nodes we found in total</span></span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (; index &lt; nodes.length &amp;&amp; stopIndex &lt;= opts.depth; index++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nodes[index].type === <span class="string">&quot;tag&quot;</span> &amp;&amp; excerptFilter.match(nodes[index])) &#123;</span><br><span class="line">      stopIndex++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set correct excerpt and more nodes values</span></span><br><span class="line">  <span class="keyword">let</span> excerptNodes = nodes.slice(<span class="number">0</span>, index);</span><br><span class="line">  <span class="keyword">let</span> moreNodes = nodes.slice(index);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// filter nodes</span></span><br><span class="line">  excerptNodes = excerptFilter.filter(excerptNodes);</span><br><span class="line">  moreNodes = moreFilter.filter(moreNodes);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the hideWholePostExcerpts option is set to true (the default), don&#x27;t show</span></span><br><span class="line">  <span class="comment">// excerpts for short posts (i.e. ones where the excerpt is the whole post)</span></span><br><span class="line">  <span class="keyword">if</span> (moreNodes.length != <span class="number">0</span> || !opts.hideWholePostExcerpts) &#123;</span><br><span class="line">    post.excerpt = excerptNodes</span><br><span class="line">      .map(<span class="function">(<span class="params">node</span>) =&gt;</span> domutils.getOuterHTML(node))</span><br><span class="line">      .join(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    post.more = moreNodes.map(<span class="function">(<span class="params">node</span>) =&gt;</span> domutils.getOuterHTML(node)).join(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> post;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> config = hexo.config;</span><br><span class="line">  <span class="keyword">let</span> legacy = &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (config.excerpt_depth) &#123;</span><br><span class="line">    hexo.log.warn(</span><br><span class="line">      <span class="string">&quot;excerpt_depth is deprecated, please use excerpt.depth instead.&quot;</span></span><br><span class="line">    );</span><br><span class="line">    legacy.depth = config.excerpt_depth;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  opts = opts || defaults(&#123;&#125;, config.excerpt, legacy, DEFAULT_CONFIG);</span><br><span class="line">  opts.depth = <span class="built_in">parseInt</span>(opts.depth);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(opts.excerpt_excludes))</span><br><span class="line">    opts.excerpt_excludes = [opts.excerpt_excludes];</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(opts.more_excludes))</span><br><span class="line">    opts.more_excludes = [opts.more_excludes];</span><br><span class="line">  excerptFilter = excerptFilter || <span class="keyword">new</span> Filter(hexo, opts.excerpt_excludes);</span><br><span class="line">  moreFilter = moreFilter || <span class="keyword">new</span> Filter(hexo, opts.more_excludes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> domutils = <span class="built_in">require</span>(<span class="string">&quot;domutils&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> CSSselect = <span class="built_in">require</span>(<span class="string">&quot;css-select&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Filter</span>(<span class="params">hexo, excludes</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.hexo = hexo;</span><br><span class="line">  <span class="built_in">this</span>.selectors = excludes.map(<span class="built_in">this</span>._compile.bind(<span class="built_in">this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Filter.prototype._compile = <span class="function"><span class="keyword">function</span> (<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> CSSselect.compile(selector);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">this</span>.hexo.log.error(</span><br><span class="line">      <span class="string">&quot;hexo-excerpt: Ignore invalid CSS selector: &quot;</span> + selector</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">n</span>) =&gt;</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Filter.prototype.match = <span class="function"><span class="keyword">function</span> (<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// not match any</span></span><br><span class="line">  <span class="keyword">return</span> !<span class="built_in">this</span>.selectors.some(<span class="function">(<span class="params">s</span>) =&gt;</span> s(node));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Filter.prototype.filter = <span class="function"><span class="keyword">function</span> (<span class="params">nodes</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// remove inner nodes that doesn&#x27;t match</span></span><br><span class="line">  domutils</span><br><span class="line">    .filter(<span class="function">(<span class="params">n</span>) =&gt;</span> !<span class="built_in">this</span>.match(n), nodes)</span><br><span class="line">    .forEach(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line">      domutils.removeElement(node);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// only keep top level nodes that match</span></span><br><span class="line">  <span class="keyword">return</span> nodes.filter(<span class="built_in">this</span>.match.bind(<span class="built_in">this</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Filter;</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="不完备方法"><a href="#不完备方法" class="headerlink" title="不完备方法"></a>不完备方法</h3><p>一开始是查看 hexo-excerpt 的源码，准备在标签页生成期处理，参考 hexo-generator-tag 的实现过程，最终可以实现在标签页提取摘要，但对于分类页面，仍然需要做相同的处理，随即放弃，此处仅作记录。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pagination = <span class="built_in">require</span>(<span class="string">&quot;hexo-pagination&quot;</span>);</span><br><span class="line">hexo.extend.generator.register(<span class="string">&quot;tag&quot;</span>, generator);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generator</span>(<span class="params">db</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> config = <span class="built_in">this</span>.config;</span><br><span class="line">  <span class="keyword">const</span> perPage = config.tag_generator.per_page;</span><br><span class="line">  <span class="keyword">const</span> paginationDir = config.pagination_dir || <span class="string">&quot;page&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> orderBy = config.tag_generator.order_by || <span class="string">&quot;-date&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> tags = db.tags;</span><br><span class="line">  <span class="keyword">let</span> tagDir;</span><br><span class="line"></span><br><span class="line">  init();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> pages = tags.reduce(<span class="function">(<span class="params">result, tag</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tag.length) <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> posts = tag.posts.sort(orderBy);</span><br><span class="line">    <span class="comment">// 预处理 posts，提取摘要，excerpt 方法定义在上文</span></span><br><span class="line">    posts.data = posts.data.map(excerpt);</span><br><span class="line">    <span class="keyword">const</span> data = pagination(tag.path, posts, &#123;</span><br><span class="line">      perPage: perPage,</span><br><span class="line">      layout: [<span class="string">&quot;tag&quot;</span>, <span class="string">&quot;archive&quot;</span>, <span class="string">&quot;index&quot;</span>],</span><br><span class="line">      format: paginationDir + <span class="string">&quot;/%d/&quot;</span>,</span><br><span class="line">      data: &#123;</span><br><span class="line">        tag: tag.name,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result.concat(data);</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// generate tag index page, usually /tags/index.html</span></span><br><span class="line">  <span class="keyword">if</span> (config.tag_generator.enable_index_page) &#123;</span><br><span class="line">    tagDir = config.tag_dir;</span><br><span class="line">    <span class="keyword">if</span> (tagDir[tagDir.length - <span class="number">1</span>] !== <span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">      tagDir += <span class="string">&quot;/&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pages.push(&#123;</span><br><span class="line">      path: tagDir,</span><br><span class="line">      layout: [<span class="string">&quot;tag-index&quot;</span>, <span class="string">&quot;tag&quot;</span>, <span class="string">&quot;archive&quot;</span>, <span class="string">&quot;index&quot;</span>],</span><br><span class="line">      <span class="comment">// posts: db.posts,</span></span><br><span class="line">      data: &#123;</span><br><span class="line">        base: tagDir,</span><br><span class="line">        total: <span class="number">1</span>,</span><br><span class="line">        current: <span class="number">1</span>,</span><br><span class="line">        current_url: tagDir,</span><br><span class="line">        <span class="comment">// posts: db.posts,</span></span><br><span class="line">        prev: <span class="number">0</span>,</span><br><span class="line">        prev_link: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        next: <span class="number">0</span>,</span><br><span class="line">        next_link: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        tags: tags,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pages;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="辅助"><a href="#辅助" class="headerlink" title="辅助"></a>辅助</h3><p>在研究时为了查看 hexo 的 post 具体的结构定义的打印函数，尝试过程中，并没有找到如何进行调试，因此将其打印后查看。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章属性打印</span></span><br><span class="line"><span class="comment"> * 查看其文章结构</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Document&#125;</span> </span>document 文章</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">documentPrint</span>(<span class="params"><span class="built_in">document</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">document</span> <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;documentPrint ====== begin&quot;</span>);</span><br><span class="line">    <span class="built_in">document</span>.forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> documentPrint(item));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;documentPrint ====== end&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="built_in">document</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">document</span>.hasOwnProperty(key)) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = <span class="built_in">document</span>[key];</span><br><span class="line">      <span class="keyword">if</span> (!<span class="string">&quot;more、_content、raw&quot;</span>.includes(key)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;====&gt; %o: %o&quot;</span>, key, value);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;====&gt; %o: %o&quot;</span>, key, <span class="string">&quot;[blog]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 边缘技术 </category>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> blog </tag>
            
            <tag> excerpt </tag>
            
            <tag> 语雀编辑器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git remote fail</title>
      <link href="2020/06/01/yuque/git%20remote%20fail/"/>
      <url>2020/06/01/yuque/git%20remote%20fail/</url>
      
        <content type="html"><![CDATA[<h2 id="异常描述"><a href="#异常描述" class="headerlink" title="异常描述"></a>异常描述</h2><p>在使用 git fetch 等命令同步远程仓库时失败：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">remote: The project you were looking <span class="keyword">for</span> could not be found.</span><br><span class="line">fatal: repository <span class="string">&#x27;远程仓库地址&#x27;</span> not found</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p><strong>原因</strong>：username 不匹配。登录的错误的用户名或密码，或者使用 vpn 连接时，vpn 账号和 git 账号不匹配。<br>可以通过查看<strong>凭据管理器</strong>检查 git 的用户名和密码，并将其修改成正确的信息。<br>Windows 路径：控制面板\所有控制面板项\凭据管理器<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1590977602678-b422e8a2-5ec9-4935-8bea-374597414f46.png#align=left&display=inline&height=283&margin=%5Bobject%20Object%5D&name=image.png&originHeight=565&originWidth=994&size=57725&status=done&style=none&width=497" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1590977602678-b422e8a2-5ec9-4935-8bea-374597414f46.png#align=left&display=inline&height=283&margin=%5Bobject%20Object%5D&name=image.png&originHeight=565&originWidth=994&size=57725&status=done&style=none&width=497" srcset="data:image/png;base64,666" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> 版本控制 </category>
          
          <category> windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
            <tag> windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo 博客搭建</title>
      <link href="2020/05/11/yuque/Hexo%20%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/"/>
      <url>2020/05/11/yuque/Hexo%20%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="文章摘要"><a href="#文章摘要" class="headerlink" title="文章摘要"></a>文章摘要</h2><p>为了在列表页面隐藏全文，实现“阅读全文”的折叠按钮，需要在 md 文件上手动添加标记  <code>&lt;!-- more --&gt;</code>，对文件本身产生了侵入，更好的方式是通过  <code>npm install hexo-excerpt --save</code>  插件，来实现自动根据目录层级生成摘要。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">excerpt:</span></span><br><span class="line">  <span class="attr">depth:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">excerpt_excludes:</span> []</span><br><span class="line">  <span class="attr">more_excludes:</span> []</span><br><span class="line">  <span class="attr">hideWholePostExcerpts:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="文章路径"><a href="#文章路径" class="headerlink" title="文章路径"></a>文章路径</h2><p>默认的路径中若包含中文，将会生成又臭又长的一段字符串，影响阅读体验。<br>使用  <code>npm install hexo-abbrlink --save</code> 插件，可以自动地将文章标题映射成一串短字符串。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 源路径生成跪在，:key 表示动态值</span></span><br><span class="line"><span class="comment"># permalink: :year/:month/:day/:title/</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:year/:month/:day/:abbrlink.html</span></span><br><span class="line"><span class="comment">## 启用算法生成不重复文件编号</span></span><br><span class="line"><span class="attr">abbrlink:</span></span><br><span class="line">  <span class="attr">alg:</span> <span class="string">crc132</span> <span class="comment">#算法： crc16(default) and crc32</span></span><br><span class="line">  <span class="attr">rep:</span> <span class="string">hex</span> <span class="comment"># dec为十进制，hex为十六进制</span></span><br></pre></td></tr></table></figure><h2 id="RSS-订阅"><a href="#RSS-订阅" class="headerlink" title="RSS 订阅"></a>RSS 订阅</h2><p>RSS 虽然小众，却能带来很好的阅读体验，因为订阅的权力是面向读者的，且不会有广告之类的阅读干扰。<br>使用  <code>npm install hexo-generator-feed --save</code>  插件可以自动生成支持 RSS 订阅的 XML 文件。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feed:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">atom</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">atom.xml</span></span><br><span class="line">  <span class="attr">limit:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure><h2 id="PWA-支持"><a href="#PWA-支持" class="headerlink" title="PWA 支持"></a>PWA 支持</h2><h3 id="hexo-service-worker-插件"><a href="#hexo-service-worker-插件" class="headerlink" title="hexo-service-worker 插件"></a>hexo-service-worker 插件</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-service-worker --save</span><br></pre></td></tr></table></figure><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>该插件是 <code>hexo-offline</code> 的改进版，具有相同的配置以及更强的功能。同样，我在其仓库的文档中并没有找到 sw.js 的配置入口，因此采用了手动注册（sw.js）的方式。</p><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### _config.yml</span></span><br><span class="line"><span class="attr">import:</span></span><br><span class="line">  <span class="comment"># meta:</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">  <span class="attr">link:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;link</span> <span class="string">rel=&quot;shortcut</span> <span class="string">icon&quot;</span> <span class="string">href=&quot;/favicon.ico&quot;&gt;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;link</span> <span class="string">rel=&quot;manifest&quot;</span> <span class="string">href=&quot;/manifest.json&quot;&gt;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;script</span> <span class="string">src=&quot;/sw-register.js&quot;/&gt;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;script</span> <span class="string">src=&quot;/sw.js&quot;/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># offline config passed to sw-precache.</span></span><br><span class="line"><span class="attr">service_worker:</span></span><br><span class="line">  <span class="attr">maximumFileSizeToCacheInBytes:</span> <span class="number">5242880</span></span><br><span class="line">  <span class="attr">staticFileGlobs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">public/**/*.&#123;js,html,css,png,jpg,gif,svg,eot,ttf,woff,woff2&#125;</span></span><br><span class="line">  <span class="attr">stripPrefix:</span> <span class="string">public</span></span><br><span class="line">  <span class="attr">verbose:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment">## 缓存策略，支持列表</span></span><br><span class="line">  <span class="attr">runtimeCaching:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">urlPattern:</span> <span class="string">/**/*</span></span><br><span class="line">      <span class="attr">handler:</span> <span class="string">cacheFirst</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">origin:</span> <span class="string">imgchr.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">urlPattern:</span> <span class="string">/**/*</span></span><br><span class="line">      <span class="attr">handler:</span> <span class="string">cacheFirst</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">origin:</span> <span class="string">cdn.jsdelivr.net</span></span><br></pre></td></tr></table></figure><h4 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h4><h5 id="sw-register-js"><a href="#sw-register-js" class="headerlink" title="sw-register.js"></a><a href="https://gist.githubusercontent.com/DaiwenZh5/db6935c85106e8981f55d084c507a661/raw/e2f6b74240d18b96da0c27f296ec9e003bf9b434/sw-register.js">sw-register.js</a></h5><h5 id="sw-js"><a href="#sw-js" class="headerlink" title="sw.js"></a><a href="https://gist.githubusercontent.com/DaiwenZh5/db6935c85106e8981f55d084c507a661/raw/e2f6b74240d18b96da0c27f296ec9e003bf9b434/sw.js">sw.js</a></h5><p>需要注意此文件头部的变量（用于定义要缓存的资源），可能要调整。</p><h3 id="hexo-pwa-插件"><a href="#hexo-pwa-插件" class="headerlink" title="hexo-pwa 插件"></a><del>hexo-pwa 插件</del></h3><blockquote><p>不想降级 hexo， 已放弃使用的改插件了，/(ㄒ o ㄒ)/~~</p></blockquote><h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-pwa --save</span><br></pre></td></tr></table></figure><p>bash</p><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p>该插件已经年久失修了， <a href="https://github.com/lavas-project/hexo-pwa/commit/23429d125c10fe7979510033591ad36c4adcd478">上次提交 23429d1</a>（截止 2020-03-21），该插件尚且不兼容  <code>hexo@4.2.0</code>，降级后可正常使用。</p><p><a href="https://github.com/lavas-project/hexo-pwa">插件地址</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">hexo -version</span><br><span class="line"><span class="comment"># 安装指定版本</span></span><br><span class="line">npm install hexo@4.1.1 --save</span><br></pre></td></tr></table></figure><h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><p>需要指定 manifest.json 文件及 sw.js 文件的相对（根）路径。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pwa:</span></span><br><span class="line">  <span class="attr">manifest:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/manifest.json</span></span><br><span class="line">    <span class="attr">body:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;名称&quot;</span></span><br><span class="line">      <span class="attr">short_name:</span> <span class="string">&quot;短名称&quot;</span></span><br><span class="line">      <span class="attr">theme_color:</span> <span class="string">&quot;主题颜色，标题栏颜色&quot;</span></span><br><span class="line">      <span class="attr">background_color:</span> <span class="string">&quot;背景色&quot;</span></span><br><span class="line">      <span class="attr">display:</span> <span class="string">&quot;standalone&quot;</span></span><br><span class="line">      <span class="attr">Scope:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">      <span class="attr">start_url:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">      <span class="attr">icons:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">src:</span> <span class="string">/images/logos/48.png</span></span><br><span class="line">          <span class="attr">sizes:</span> <span class="string">48x48</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">image/png</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">src:</span> <span class="string">/images/logos/96.png</span></span><br><span class="line">          <span class="attr">sizes:</span> <span class="string">96x96</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">image/png</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">src:</span> <span class="string">/images/logos/128.png</span></span><br><span class="line">          <span class="attr">sizes:</span> <span class="string">128x128</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">image/png</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">src:</span> <span class="string">/images/logos/144.png</span></span><br><span class="line">          <span class="attr">sizes:</span> <span class="string">144x144</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">image/png</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">src:</span> <span class="string">/images/logos/192.png</span></span><br><span class="line">          <span class="attr">sizes:</span> <span class="string">192x192</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">image/png</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">src:</span> <span class="string">/images/logos/512.png</span></span><br><span class="line">          <span class="attr">sizes:</span> <span class="string">512x512</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">image/png</span></span><br><span class="line">  <span class="attr">serviceWorker:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/sw.js</span></span><br><span class="line">    <span class="attr">preload:</span></span><br><span class="line">      <span class="attr">urls:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/</span></span><br><span class="line">      <span class="attr">posts:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">opts:</span></span><br><span class="line">      <span class="attr">networkTimeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="type">!!js/regexp</span> <span class="string">/hm.baidu.com/</span></span><br><span class="line">        <span class="attr">strategy:</span> <span class="string">networkOnly</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="type">!!js/regexp</span> <span class="string">/.*\.(js|css|jpg|jpeg|png|gif)$/</span></span><br><span class="line">        <span class="attr">strategy:</span> <span class="string">cacheFirst</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="type">!!js/regexp</span> <span class="string">/\//</span></span><br><span class="line">        <span class="attr">strategy:</span> <span class="string">networkFirst</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><h2 id="图标"><a href="#图标" class="headerlink" title="图标"></a>图标</h2><p>需要不同尺寸的图标，推荐使用 svg 图片导出不同尺寸，<a href="https://www.logosc.cn/">白嫖的 Logo 设计网站</a>：生成好图片后，F12 打开“元素”面板，选中图片，复制出 svg 标签使用 TXT 文本另存为 logo.svg。此时可以使用 AI 来处理，矢量图的好处就是可以无损的进行放大（于 2020-05-12）。</p><h3 id="清单"><a href="#清单" class="headerlink" title="清单"></a>清单</h3><p>需要添加 manifest.json 到 sources 目录下，并在模板中手动引用。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">import:</span></span><br><span class="line">  <span class="attr">link:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&lt;link rel=&#x27;manifest&#x27; href=&#x27;/manifest.json&#x27;&gt;&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;名称&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;short_name&quot;</span>: <span class="string">&quot;短名称&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;theme_color&quot;</span>: <span class="string">&quot;主题色，标题栏颜色&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;background_color&quot;</span>: <span class="string">&quot;背景色&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;display&quot;</span>: <span class="string">&quot;standalone&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Scope&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;start_url&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;icons&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;src&quot;</span>: <span class="string">&quot;相对 sources 的图片地址&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sizes&quot;</span>: <span class="string">&quot;48x48&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;src&quot;</span>: <span class="string">&quot;相对 sources 的图片地址&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sizes&quot;</span>: <span class="string">&quot;96x96&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;src&quot;</span>: <span class="string">&quot;相对 sources 的图片地址&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sizes&quot;</span>: <span class="string">&quot;128x128&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;src&quot;</span>: <span class="string">&quot;相对 sources 的图片地址&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sizes&quot;</span>: <span class="string">&quot;144x144&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;src&quot;</span>: <span class="string">&quot;相对 sources 的图片地址&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sizes&quot;</span>: <span class="string">&quot;192x192&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;src&quot;</span>: <span class="string">&quot;相对 sources 的图片地址&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sizes&quot;</span>: <span class="string">&quot;512x512&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/png&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;splash_pages&quot;</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><p>需要添加 sw.js 到 sources 目录下。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> workboxVersion = <span class="string">&quot;5.0.0&quot;</span>;</span><br><span class="line">importScripts(</span><br><span class="line">  <span class="string">`https://storage.googleapis.com/workbox-cdn/releases/<span class="subst">$&#123;workboxVersion&#125;</span>/workbox-sw.js`</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (workbox) &#123;</span><br><span class="line">  workbox.setConfig(&#123;</span><br><span class="line">    modulePathPrefix: <span class="string">`https://storage.googleapis.com/workbox-cdn/releases/<span class="subst">$&#123;workboxVersion&#125;</span>`</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  workbox.precaching.precache([<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/index.html&quot;</span>]);</span><br><span class="line"></span><br><span class="line">  workbox.routing.registerRoute(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;^https?://博客地址/?$&quot;</span>),</span><br><span class="line">    workbox.strategies.networkFirst()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  workbox.routing.registerRoute(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;.*.html&quot;</span>),</span><br><span class="line">    workbox.strategies.networkFirst()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  workbox.routing.registerRoute(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;.*.(?:js|css)&quot;</span>),</span><br><span class="line">    workbox.strategies.staleWhileRevalidate()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  workbox.routing.registerRoute(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;https://imgchr.com/&quot;</span>),</span><br><span class="line">    workbox.strategies.cacheFirst()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  workbox.routing.registerRoute(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;https://cdn.jsdelivr.net/&quot;</span>),</span><br><span class="line">    workbox.strategies.cacheFirst()</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="语雀文章获取"><a href="#语雀文章获取" class="headerlink" title="语雀文章获取"></a>语雀文章获取</h2><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><a href="https://github.com/x-cold/yuque-hexo">参加插件官方配置</a></p><h3 id="标签使用"><a href="#标签使用" class="headerlink" title="标签使用"></a>标签使用</h3><p>语雀本身的  🔖（标签组件）只会被渲染成普通的字符串，必须通过手动添加 <a href="https://hexo.io/zh-cn/docs/front-matter">front-matter</a>  才可以。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tags: [标签 1, 标签 2]</span><br><span class="line">categories: [一级分类, 二级分类]</span><br><span class="line"></span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>在语雀中，可以配合 🔖 字符串形式，如本文中使用方式：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1589360257532-d8257566-3b97-4978-8c73-0476ec375013.png#align=left&display=inline&height=83&margin=%5Bobject%20Object%5D&name=image.png&originHeight=110&originWidth=400&size=9768&status=done&style=none&width=300" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1589360257532-d8257566-3b97-4978-8c73-0476ec375013.png#align=left&display=inline&height=83&margin=%5Bobject%20Object%5D&name=image.png&originHeight=110&originWidth=400&size=9768&status=done&style=none&width=300" srcset="data:image/png;base64,666" alt="image.png"></p><h3 id="图片防盗链处理"><a href="#图片防盗链处理" class="headerlink" title="图片防盗链处理"></a>图片防盗链处理</h3><p>添加  <code>&lt;meta name=&quot;referrer&quot; content=&quot;no-referrer&quot; /&gt;</code>  到模板 head 可解决。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/_config.yml</span></span><br><span class="line"><span class="attr">import:</span></span><br><span class="line">  <span class="attr">meta:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;meta</span> <span class="string">name=&quot;referrer&quot;</span> <span class="string">content=&quot;no-referrer&quot;/&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/x-cold/yuque-hexo/issues/41">参见插件官方 issue </a></p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> Blog </tag>
            
            <tag> Github Pages </tag>
            
            <tag> 语雀 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>🕷 统一异常处理</title>
      <link href="2020/04/23/yuque/%F0%9F%95%B7%20%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/"/>
      <url>2020/04/23/yuque/%F0%9F%95%B7%20%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="🚩-需求描述"><a href="#🚩-需求描述" class="headerlink" title="🚩 需求描述"></a>🚩 需求描述</h2><p>将接口访问所有异常进行统一处理。在业务逻辑编写时，应该将所有可预知的异常定义好，并设定唯一的错误代码，在异常发生时，通过统一的返回值自动包装，提供给前端优化的错误提示，并能够通过错误代码快速定位异常类型。</p><h2 id="🐘-异常对象"><a href="#🐘-异常对象" class="headerlink" title="🐘 异常对象"></a>🐘 异常对象</h2><p>定义一个业务层异常，用于抛出业务逻辑上的异常错误。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor(access = AccessLevel.PRIVATE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误代码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ServiceException <span class="title">of</span><span class="params">(ExceptionEnum exceptionEnum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServiceException(exceptionEnum.code, exceptionEnum.message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中  <code>ExceptionEnum</code>  类是用于描述异常的枚举类型，定义异常的错误代码及错误信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">ExceptionEnum</span> </span>&#123;</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String code;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span>  String message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="📄-代码实现"><a href="#📄-代码实现" class="headerlink" title="📄 代码实现"></a>📄 代码实现</h2><p>通过  <code>@RestControllerAdive</code>  提升作用域，通过  <code>@ExceptionHandler</code> 注解来处理不同的异常。</p><h3 id="🔢-业务层异常"><a href="#🔢-业务层异常" class="headerlink" title="🔢 业务层异常"></a>🔢 业务层异常</h3><p>所有的业务逻辑错误触发的异常。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理业务异常</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exception 异常</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 统一返回值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ExceptionHandler(ServiceException.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title">handleServiceException</span><span class="params">(ServiceException exception)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RestResponse.error(exception.code, exception.message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="⁉-未知异常"><a href="#⁉-未知异常" class="headerlink" title="⁉ 未知异常"></a>⁉ 未知异常</h3><p>用于捕捉其他的所有不可预知的错误，可能是表字段的数据异常，导致数据库在更新时无法动态的生成 SQL（在编写时默认该值不为空，但被人为删除了），而产生的 dao 层异常，也有可能时系统资源被占用，导致文件无法写入的 IO 异常，不可控制的网络超时异常等等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 其他未知的所有异常</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exception 异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 统一返回值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title">handleOtherException</span><span class="params">(Exception exception)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.error(exception.getMessage());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="🔐-参数校验异常"><a href="#🔐-参数校验异常" class="headerlink" title="🔐 参数校验异常"></a>🔐 参数校验异常</h3><p>需要使用 <code>@Validated</code> 注解标记在 Controller 的类、方法或参数上。对于验证规则，使用 <code>javax.validation.constraints</code> 和 <code>org.hibernate.validator.constraints</code> 包中的规则注解。具体使用此处不细究，仅对异常的处理进行展开。<br>该异常表现为接口访问错误，但具体的错误提示信息并未写入到响应，服务端异常信息如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javax.validation.ConstraintViolationException: common.msg: 消息不能为空</span><br><span class="line">...异常堆栈信息</span><br></pre></td></tr></table></figure><p>可以建立一个指定异常为  ConstraintViolationException 的处理器，用于封装参数错误的异常信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(ConstraintViolationException.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title">constraintViolationExceptionHandler</span><span class="params">(ConstraintViolationException e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RestResponse.error(((ConstraintViolation) e.getConstraintViolations().toArray()[<span class="number">0</span>]).getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中 <code>ConstraintViolation</code> 可能不止一个参数校验的结果，取第（任）一个即可。</p><h3 id="🔍-404-异常"><a href="#🔍-404-异常" class="headerlink" title="🔍 404 异常"></a>🔍 404 异常</h3><p>尽管 Spring 默认实现了 <code>/error</code>（即接口访问出错）情况下的处理，（在 Postman 上随手输出一个接口，模拟 404）如：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2020-01-07T16:37:31.160+0000&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;status&quot;</span>: <span class="number">404</span>,</span><br><span class="line">  <span class="attr">&quot;error&quot;</span>: <span class="string">&quot;Not Found&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;No message available&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/123&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但在某些时候，需要针对错误访问进行特殊的处理，此时可以实现 <code>ErrorController</code> 接口进行自定义拓展。<br>如下对 4xx、5xx 系列的错误状态进行处理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;error&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestResponse&lt;Object&gt; <span class="title">errorHandle</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    HttpStatus status = getStatus(request);</span><br><span class="line">    <span class="keyword">if</span> (status.is4xxClientError()) &#123;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.error(<span class="string">&quot;客户端访问出错&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (status.is5xxServerError()) &#123;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.error(<span class="string">&quot;服务器访问异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> RestResponse.error(<span class="string">&quot;未知异常&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，在条件分支中，对某个具体的状态做判断，可以更细致化的处理不同的访问错误。</p><h4 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h4><ol><li>在 <code>@Exception</code> 中进行状态判断，对错误请求做处理；</li><li>（未测试）在资源目录（<code>/resources/public/error</code>）下添加错误访问页面，命名为 404.html、500.html 等；</li><li>（未测试）配置 <code>EmbeddedServletContainerCustomizer</code> 实现；</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>📑 统一日志记录</title>
      <link href="2020/04/23/yuque/%F0%9F%93%91%20%E7%BB%9F%E4%B8%80%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/"/>
      <url>2020/04/23/yuque/%F0%9F%93%91%20%E7%BB%9F%E4%B8%80%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h2 id="🚩-需求描述"><a href="#🚩-需求描述" class="headerlink" title="🚩 需求描述"></a>🚩 需求描述</h2><p>能够在每次访问接口时，自动记录入参、出参的全局统一日志。</p><h2 id="📈-方案与分析"><a href="#📈-方案与分析" class="headerlink" title="📈 方案与分析"></a>📈 方案与分析</h2><p><strong>说明</strong>：日志作用的所有接口上，且需要统一形式，因此是不考虑在接口中手写的。</p><h3 id="📋-方案一"><a href="#📋-方案一" class="headerlink" title="📋 方案一"></a>📋 方案一</h3><p>理想的情况下是通过 spring aop 快速进入开发状态，然后在打包时通过 aspectj 处理器在编译期织入代码。因为 spring aop 采用 aspectj 语法，且提供了强大但简单的注解支持，因此可以很轻松的实现切面。但是 spring 的 aop 是运行时的（反射），相对于静态织入的 aspectj 来说，性能差距是极大的。而使用 aspectj 处理器每次需要手动清除之前编译的代码，否则新的代码无法实时编译的，比较麻烦，因此比较适合在打包时提供 aspectj 编译处理</p><h3 id="📋-方案二"><a href="#📋-方案二" class="headerlink" title="📋  方案二"></a>📋  方案二</h3><p>spring 其他内置增强接口， <code>@RestControllerAdive</code>，可以为注解类提升作用域，而  <code>ResponseBodyAdive</code>，<code>RequestBodyAdive</code>  接口，则可以为实现类提供预处理出参、入参的接口数据，两相结合，则可以实现类似的环绕式的出入参日志记录</p><h3 id="📋-方案三"><a href="#📋-方案三" class="headerlink" title="📋  方案三"></a>📋  方案三</h3><p>使用拦截器或过滤器，但其匹配规则是作用在 url 上，粒度太大不够细致。</p><h2 id="📄-代码实现"><a href="#📄-代码实现" class="headerlink" title="📄 代码实现"></a>📄 代码实现</h2><p>此处通过 aop 实现，需要注意的是，若通过  <code>ResponseBodyAdive</code>  接口来处理统一返回值，则不能使用  <code>@Around</code>  的环绕切面，因为该切面要求方法的出参类型是不能修改的，而使用被统一返回类型包装的对象，是与切面方法的实际返回值是不一样的，故下面使用 <code>@Before</code>、<code>@AfterReturning</code> 方法分别处理接口入参、和参数两个状态。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录日志信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LogInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 请求 id</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String requestId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 开始时间</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">long</span> startTime;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * gson 工具</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Gson gson;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ThreadLocal&lt;LogInfo&gt; logInfo = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(value = &quot;@annotation(com.包名.annotation.Log)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">point</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法执行前</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint 切点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before(value = &quot;point()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LogRequestInfo</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        String uuid = UUID.randomUUID().toString();</span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        <span class="comment">// 缓存线程变量信息</span></span><br><span class="line">        logInfo.set(<span class="keyword">new</span> LogInfo(uuid, System.currentTimeMillis(), gson));</span><br><span class="line">        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        HttpServletRequest request = Objects.requireNonNull(attributes).getRequest();</span><br><span class="line">        StringBuilder requestLog = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        Signature signature = joinPoint.getSignature();</span><br><span class="line">        requestLog.append(<span class="string">&quot;[&quot;</span>).append(uuid).append(<span class="string">&quot;] -&gt; &quot;</span>)</span><br><span class="line">                .append(<span class="string">&quot;请求信息：&quot;</span>).append(<span class="string">&quot;URL = &#123;&quot;</span>).append(request.getRequestURI()).append(<span class="string">&quot;&#125;, &quot;</span>)</span><br><span class="line">                .append(<span class="string">&quot;请求方式 = &#123;&quot;</span>).append(request.getMethod()).append(<span class="string">&quot;&#125;, &quot;</span>)</span><br><span class="line">                .append(<span class="string">&quot;请求IP = &#123;&quot;</span>).append(request.getRemoteAddr()).append(<span class="string">&quot;&#125;, &quot;</span>)</span><br><span class="line">                .append(<span class="string">&quot;类方法 = &#123;&quot;</span>).append(signature.getDeclaringTypeName()).append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">                .append(signature.getName()).append(<span class="string">&quot;&#125;, &quot;</span>);</span><br><span class="line">        <span class="comment">// 处理请求参数</span></span><br><span class="line">        String[] paramNames = ((MethodSignature) signature).getParameterNames();</span><br><span class="line">        Object[] paramValues = joinPoint.getArgs();</span><br><span class="line">        <span class="keyword">int</span> paramLength = <span class="keyword">null</span> == paramNames ? <span class="number">0</span> : paramNames.length;</span><br><span class="line">        <span class="keyword">if</span> (paramLength == <span class="number">0</span>) &#123;</span><br><span class="line">            requestLog.append(<span class="string">&quot;请求参数 = &#123;&#125; &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            requestLog.append(<span class="string">&quot;请求参数 = [&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paramLength - <span class="number">1</span>; i++) &#123;</span><br><span class="line">                requestLog.append(paramNames[i]).append(<span class="string">&quot;=&quot;</span>).append(gson.toJson(paramValues[i])).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            requestLog.append(paramNames[paramLength - <span class="number">1</span>]).append(<span class="string">&quot;=&quot;</span>).append(gson.toJson(paramValues[paramLength - <span class="number">1</span>])).append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(requestLog.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法执行后</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AfterReturning(returning = &quot;target&quot;, pointcut = &quot;point()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logResultVOInfo</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        LogInfo logInfo = <span class="keyword">this</span>.logInfo.get();</span><br><span class="line">        <span class="comment">// 删除线程变量</span></span><br><span class="line">        <span class="keyword">this</span>.logInfo.remove();</span><br><span class="line">        <span class="keyword">long</span> offTime = System.currentTimeMillis() - logInfo.startTime;</span><br><span class="line">        log.info(String.format(<span class="string">&quot;[%s] -&gt; 请求结果：%s [%dms]&quot;</span>, logInfo.requestId, logInfo.gson.toJson(target), offTime));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为实际上，两个切面方法是独立的作用域，为了线程安全，故使用线程变量来存储请求的日志信息，主要记录该请求的唯一编号（此处使用 UUID），开始时间，同时又都需要将对象 json 化，所以也缓存了 gson 对象。<br>同样的方法，也可以通过实现增强接口，重写其预处理入参、出参的方法来提供日志支持。</p><hr><p>java spring log web aop</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB 使用记录</title>
      <link href="2020/04/15/yuque/MongoDB%20%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/"/>
      <url>2020/04/15/yuque/MongoDB%20%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h2 id="⚙-配置"><a href="#⚙-配置" class="headerlink" title="⚙ 配置"></a>⚙ 配置</h2><p>mongo 默认是无认证登录的，即使在设置用户名和密码后，也是需要手动修改配置文件开启授权认证。<br>当然，在开启授权之前，应该连接数据库，创建必要的用户账户。</p><h3 id="💾-连接数据库"><a href="#💾-连接数据库" class="headerlink" title="💾 连接数据库"></a>💾 连接数据库</h3><p>直接使用 Navicat 连接即可，初始时选择无验证连接。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1586931848670-c9b19620-4ad4-4e71-9e7b-7ca8f82bfb6f.png#align=left&display=inline&height=372&margin=%5Bobject%20Object%5D&name=image.png&originHeight=743&originWidth=667&size=22300&status=done&style=stroke&width=334" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1586931848670-c9b19620-4ad4-4e71-9e7b-7ca8f82bfb6f.png#align=left&display=inline&height=372&margin=%5Bobject%20Object%5D&name=image.png&originHeight=743&originWidth=667&size=22300&status=done&style=stroke&width=334" srcset="data:image/png;base64,666" alt="image.png"><br>成功连接之后若未显示任何数据库，则选择连接之后，在顶部导航栏选中【查看】-【显示隐藏的项目】，之后可以看到默认的数据库 admin、config、local 等。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1586931787072-781628c7-49a7-41dc-a174-0b3b532a1013.png#align=left&display=inline&height=166&margin=%5Bobject%20Object%5D&name=image.png&originHeight=220&originWidth=170&size=6902&status=done&style=none&width=128" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1586931787072-781628c7-49a7-41dc-a174-0b3b532a1013.png#align=left&display=inline&height=166&margin=%5Bobject%20Object%5D&name=image.png&originHeight=220&originWidth=170&size=6902&status=done&style=none&width=128" srcset="data:image/png;base64,666" alt="image.png"></p><h3 id="🆔-创建账户"><a href="#🆔-创建账户" class="headerlink" title="🆔 创建账户"></a>🆔 创建账户</h3><p>选择 admin 数据库，新建查询，创建一个超级用户（用户之后连接登录认证的）。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.createUser(</span><br><span class="line">&#123;</span><br><span class="line">user:&quot;root&quot;,</span><br><span class="line">pwd:&quot;root&quot;,</span><br><span class="line">roles:[&#123;role:&quot;root&quot;,db:&quot;admin&quot;&#125;]</span><br><span class="line">&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>也可以创建其他数据库，并设置相应的角色，但需注意，空的数据库默认是不会保存的，因此在新建数据库之后，应该写入一条临时数据。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 插入任意数据，之后可以删除</span></span><br><span class="line">db.[数据库名].insert(&#123;&#x27;key&#x27;: &#x27;value&#x27;&#125;)</span><br></pre></td></tr></table></figure><h3 id="✍-修改配置"><a href="#✍-修改配置" class="headerlink" title="✍ 修改配置"></a>✍ 修改配置</h3><p>开启授权验证。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">vim /etc/mongod.conf</span><br><span class="line">-----</span><br><span class="line"><span class="comment"># 启用权限控制</span></span><br><span class="line">security:</span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure><h3 id="😨-一个意外"><a href="#😨-一个意外" class="headerlink" title="😨 一个意外"></a>😨 一个意外</h3><p>删库宣言   仅以此纪念我消逝的数据 👀<br>All your data is a backed up. You must pay 0.015 BTC to 1Dy28zwYdyPYzWjGzuRLJeGeiEabG61AFZ 48 hours for recover it. After 48 hours expiration we will leaked and exposed all your data. Also do not forget about GDPR. You can buy bitcoin here, does not take much time to buy <a href="https://localbitcoins.com/">https://localbitcoins.com</a> with this guide <a href="https://localbitcoins.com/guides/how-to-buy-bitcoins">https://localbitcoins.com/guides/how-to-buy-bitcoins</a> After paying write to me in the mail with your DB IP: <a href="mailto:&#x67;&#x33;&#116;&#x5f;&#98;&#97;&#x73;&#x65;&#x40;&#x70;&#x72;&#111;&#116;&#111;&#x6e;&#109;&#97;&#105;&#x6c;&#x2e;&#x63;&#x6f;&#x6d;">&#x67;&#x33;&#116;&#x5f;&#98;&#97;&#x73;&#x65;&#x40;&#x70;&#x72;&#111;&#116;&#111;&#x6e;&#109;&#97;&#105;&#x6c;&#x2e;&#x63;&#x6f;&#x6d;</a>“</p><hr><p>您的所有数据都已备份。您必须支付 0.015 BTC 才能花费 48 小时恢复。48 小时到期后，我们将泄露并暴露您的所有数据。也不要忘记 GDPR。你可以在这里购买比特币，不需要花太多时间购买 <a href="https://localbitcoins.com/">https://localbitcoins.com</a> 使用本指南 <a href="https://localbitcoins.com/guides/how-to-buy-bitcoins">https://localbitcoins.com/guides/how-to-buy-bitcoins</a> 付款后，请用您的 DB IP 给我写信: <a href="mailto:&#x67;&#x33;&#116;&#95;&#98;&#x61;&#115;&#x65;&#64;&#112;&#114;&#x6f;&#x74;&#x6f;&#110;&#x6d;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#x6d;">&#x67;&#x33;&#116;&#95;&#98;&#x61;&#115;&#x65;&#64;&#112;&#114;&#x6f;&#x74;&#x6f;&#110;&#x6d;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#x6d;</a>”</p><h2 id="⚔-常用命令"><a href="#⚔-常用命令" class="headerlink" title="⚔ 常用命令"></a>⚔ 常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service mongod &lt;指令&gt;</span><br><span class="line">重启           restart</span><br><span class="line">启动           start</span><br><span class="line">停止           stop</span><br></pre></td></tr></table></figure><hr><p>mongodb 4.2.5 配置 安装</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>🐘 统一返回对象</title>
      <link href="2020/04/14/yuque/%F0%9F%90%98%20%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1/"/>
      <url>2020/04/14/yuque/%F0%9F%90%98%20%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="🚩-需求描述"><a href="#🚩-需求描述" class="headerlink" title="🚩 需求描述"></a>🚩 需求描述</h2><p>封装统一的接口返回对象，使得前端能够获取格式规整的数据。</p><h2 id="📦-封装对象"><a href="#📦-封装对象" class="headerlink" title="📦 封装对象"></a>📦 封装对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestResponse</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取统一返回类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code    返回码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    返回数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> success 返回结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 提示信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">of</span><span class="params">(String code, T data, <span class="keyword">boolean</span> success, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestResponse&lt;&gt;(code, data, success, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回操作成功的统一类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#success&#125; = true &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code    返回码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    返回数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 提示信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">success</span><span class="params">(String code, T data, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> of(code, data, <span class="keyword">true</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回操作成功的统一类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#success&#125; = true &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#code&#125; = 0 &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    返回数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 提示信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">success</span><span class="params">(T data, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> success(<span class="string">&quot;0&quot;</span>, data, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回操作成功的统一类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#success&#125; = true &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#code&#125; = 0 &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#message&#125; = 响应成功 &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data 返回数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;  数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">success</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> success(data, <span class="string">&quot;响应成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回操作失败的统一类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#success&#125; = false &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code    返回码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    返回数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 提示信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">error</span><span class="params">(String code, T data, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> of(code, data, <span class="keyword">false</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回操作成功的统一类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#success&#125; = false &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#data&#125; = null &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 提示信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">error</span><span class="params">(String code, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> error(code, <span class="keyword">null</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回操作成功的统一类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#success&#125; = true &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#code&#125; = -1 &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#data&#125; = null &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">error</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> error(<span class="string">&quot;-1&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="🏗-实现基础"><a href="#🏗-实现基础" class="headerlink" title="🏗 实现基础"></a>🏗 实现基础</h2><p>spring 中提供了  <code>ResponseBodyAdvice</code> 接口，用于 http 请求在写入响应流之前的处理，为统一返回对象提供了相对便捷的实现方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResponseBodyAdvice</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Whether this component supports the given controller method return type</span></span><br><span class="line"><span class="comment"> * and the selected &#123;<span class="doctag">@code</span> HttpMessageConverter&#125; type.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> returnType the return type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> converterType the selected converter type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if &#123;<span class="doctag">@link</span> #beforeBodyWrite&#125; should be invoked;</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter returnType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Invoked after an &#123;<span class="doctag">@code</span> HttpMessageConverter&#125; is selected and just before</span></span><br><span class="line"><span class="comment"> * its write method is invoked.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> body the body to be written</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> returnType the return type of the controller method</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> selectedContentType the content type selected through content negotiation</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> selectedConverterType the converter type selected to write to the response</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request the current request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response the current response</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the body that was passed in or a modified (possibly new) instance</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">T <span class="title">beforeBodyWrite</span><span class="params">(<span class="meta">@Nullable</span> T body, MethodParameter returnType, MediaType selectedContentType,</span></span></span><br><span class="line"><span class="function"><span class="params">Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; selectedConverterType,</span></span></span><br><span class="line"><span class="function"><span class="params">ServerHttpRequest request, ServerHttpResponse response)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th><strong>方法名</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td>supports()</td><td>通过判断响应返回值类型及消息转换器的类型决定是否启用该组件</td></tr><tr><td>beforeBodyWrite()</td><td>当组件启用时，该方法返回值将作为最终的响应数据写入到流</td></tr></tbody></table><h3 id="🔜-流程"><a href="#🔜-流程" class="headerlink" title="🔜 流程"></a>🔜 流程</h3><ol><li>创建一个实现 <code>ResponseBodyAdvice</code> 接口的类；</li><li>在 <code>supports()</code> 中跳过已经封装过（即类型已经是 <code>RestResponse</code>）的返回值，避免多次封装；</li><li>在 <code>beforeBodyWrite()</code> 方法中进行统一返回类型的封装；</li></ol><h3 id="📄-实现代码"><a href="#📄-实现代码" class="headerlink" title="📄 实现代码"></a>📄 实现代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter returnType, Class converterType)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当返回值类型已经时包装类时跳过</span></span><br><span class="line">    <span class="keyword">return</span> !returnType.getParameterType().equals(RestResponse.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">beforeBodyWrite</span><span class="params">(Object body,</span></span></span><br><span class="line"><span class="function"><span class="params">                              MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params">                              MediaType selectedContentType,</span></span></span><br><span class="line"><span class="function"><span class="params">                              Class selectedConverterType,</span></span></span><br><span class="line"><span class="function"><span class="params">                              ServerHttpRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                              ServerHttpResponse response)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1、处理无返回值（即 void）类型的方法</span></span><br><span class="line">    <span class="keyword">if</span> (returnType.getParameterType().equals(Void.class)) &#123;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(<span class="keyword">new</span> Object());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2、Spring 默认使用 StringHttpMessageConverter 处理 String 类型的返回值</span></span><br><span class="line">    <span class="comment">// 一旦被包装成统一对象后，不能被转换成字符串，而产生类型转换异常 - 见下方注①</span></span><br><span class="line">    <span class="keyword">if</span> (body <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="comment">// 2.1、用于重置字符串的响应类型为 application/json</span></span><br><span class="line">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        <span class="comment">// 2.2 将统一对象转换成 json 字符串</span></span><br><span class="line">        <span class="keyword">return</span> JSON.toJSONString(RestResponse.success(body));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3、其他所有情况</span></span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="☝-注意事项"><a href="#☝-注意事项" class="headerlink" title="☝ 注意事项"></a>☝ 注意事项</h3><p>注 ①：需要对 String 类型的返回值进行额外的处理，因为 Spring 通过返回值类型来决定<a href="#jTGLT">消息转换器</a>的选择，所以 String 类型的返回值会默认使用 <code>StringHttpMessageConverter</code> 处理器，但是在 <code>beforeBodyWrite()</code>  处理后，其类型被修改为  <code>RestResponse</code>，因此无法进行转换，出现如下报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.example.bean.RestResponse cannot be cast to java.lang.String</span><br></pre></td></tr></table></figure><p>为了能够处理 String 类型返回值，此处将其封装成统一类型之后再次使用 Json 转换器将其转换成 Json 字符串，最终将向响应流写入如下格式的数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;code&quot;:&quot;0&quot;,&quot;data&quot;:&quot;收到消息: 123&quot;,&quot;message&quot;:&quot;响应成功&quot;,&quot;success&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>使用 Postman 表现形式为不支持格式化的字符串，因为其 <code>Content-Type：application/json</code>，所以此处通过 <code>response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</code> 强制将响应类型标记为 Json 格式。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;code&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: <span class="string">&quot;收到消息: 123&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;响应成功&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;success&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="💪-功能增强"><a href="#💪-功能增强" class="headerlink" title="💪 功能增强"></a>💪 功能增强</h2><p>任何类都可以实现 <code>ResponseBodyAdvice</code> 接口，但是为了使其产生预期效果，需要了解其作用范围，默认仅为该类本身，也就是说，若由 Controller 实现，则仅对该控制器生效。因此该接口通常配合 <code>@ControllerAdvice</code> 注解使用。</p><h2 id="🍂-其他"><a href="#🍂-其他" class="headerlink" title="🍂 其他"></a>🍂 其他</h2><h3 id="📩-消息转换器"><a href="#📩-消息转换器" class="headerlink" title="📩 消息转换器"></a>📩 消息转换器</h3><p>Spring 向响应流写入数据是通过消息转换器（实现 <code>HttpMessageConverter</code> 接口）来处理的，其默认实现了一系列转换器，链式的处理返回值，直到能够正常写入响应流 。对于复杂类型默认使用<code>MappingJackson2HttpMessageConverter</code> 处理器，将复杂类型转换为 Json 格式的字符串，对于字符串类型默认使用 <code>StringHttpMessageConverter</code> 处理器。</p><h3 id="ControllerAdvice-注解"><a href="#ControllerAdvice-注解" class="headerlink" title="ControllerAdvice 注解"></a>ControllerAdvice 注解</h3><hr><p>Java bean web spring</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Maven 多环境打包</title>
      <link href="2020/04/10/yuque/Maven%20%E5%A4%9A%E7%8E%AF%E5%A2%83%E6%89%93%E5%8C%85/"/>
      <url>2020/04/10/yuque/Maven%20%E5%A4%9A%E7%8E%AF%E5%A2%83%E6%89%93%E5%8C%85/</url>
      
        <content type="html"><![CDATA[<h2 id="📃-需求描述"><a href="#📃-需求描述" class="headerlink" title="📃 需求描述"></a>📃 需求描述</h2><p>项目在开发时需要进行多环境部署打包，每个环境间的配置信息并不互通，若要进行人为的手动替换，不但增加了机械且额外的工作量，还容易出错，因此需要通过配置 Maven，使得能够为不同环境打包不同的配置信息。</p><h2 id="🙋-解决方案"><a href="#🙋-解决方案" class="headerlink" title="🙋 解决方案"></a>🙋 解决方案</h2><h3 id="🗃-resources-目录"><a href="#🗃-resources-目录" class="headerlink" title="🗃 resources 目录"></a>🗃 resources 目录</h3><h4 id="📁-目录配置"><a href="#📁-目录配置" class="headerlink" title="📁 目录配置"></a>📁 目录配置</h4><p>在 resource 目录下添加 env 目录，用于放置不同的环境，如开发环境、测试环境，在 env 下创建 dev、test 目录即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resources</span><br><span class="line"> └── env</span><br><span class="line">     ├── dev</span><br><span class="line">     └── test</span><br></pre></td></tr></table></figure><p>当然，文件名可以为任意有效字符，但需要语义清楚，并与 pom 中指定路径相对应。</p><h4 id="⚙-Maven-配置"><a href="#⚙-Maven-配置" class="headerlink" title="⚙ Maven 配置"></a>⚙ Maven 配置</h4><p>在 pom 中添加环境属性，与 env 中创建的环境目录相应。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 开发环境--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources/env/dev<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 默认激活 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 测试环境 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>test<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources/env/test<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></table></figure><p>此时，在 idea 侧边的 maven 插件中的 Profiles 已经可以看到可选环境。</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1586521866007-323f18f8-dd68-4328-abd1-246954dd7fb4.png#align=left&display=inline&height=226&margin=%5Bobject%20Object%5D&name=image.png&originHeight=146&originWidth=179&size=3775&status=done&style=none&width=277" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1586521866007-323f18f8-dd68-4328-abd1-246954dd7fb4.png#align=left&display=inline&height=226&margin=%5Bobject%20Object%5D&name=image.png&originHeight=146&originWidth=179&size=3775&status=done&style=none&width=277" srcset="data:image/png;base64,666" alt="image.png"></p><h4 id="🔧-细节处理"><a href="#🔧-细节处理" class="headerlink" title="🔧 细节处理"></a>🔧 细节处理</h4><p>此处会将 env 目录也一同打包，但实际上在这打包后已经是无用文件了，因此需要将其剔除。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--打包之后不包含 env --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/env/**<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!-- 同名的文件无法被覆盖，需要在此排除，比如：</span></span><br><span class="line"><span class="comment">                 一些文件（spring 的配置文件）是在开发时必须引用且放置在根目录（resources）下，即不能删除 --&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>application-xxx.yml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="📰-webapps-目录"><a href="#📰-webapps-目录" class="headerlink" title="📰 webapps 目录"></a>📰 webapps 目录</h3><h4 id="📁-目录配置-1"><a href="#📁-目录配置-1" class="headerlink" title="📁 目录配置"></a>📁 目录配置</h4><p>同样，需要现在 webapps 目录下为不同的环境配置不同的文件路径，如下 prod 、test 分别表示生产和测试环境。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">webapps</span><br><span class="line"> └── env</span><br><span class="line">     ├── prod</span><br><span class="line">     └── test</span><br></pre></td></tr></table></figure><h4 id="⚙-Maven-配置-1"><a href="#⚙-Maven-配置-1" class="headerlink" title="⚙ Maven 配置"></a>⚙ Maven 配置</h4><p>与之前的不同的是，webapps 下面的文件需要借助 maven-war-plugin 插件。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-war-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- webapp 中需要排除的文件，此处去除掉存放环境配置的目录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">warSourceExcludes</span>&gt;</span></span><br><span class="line">            env/test/**,env/prod/**</span><br><span class="line">        <span class="tag">&lt;/<span class="name">warSourceExcludes</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 在 webapp 中需要动态加载的资源 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">webResources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 指定加载路径 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/webapp/env/$&#123;active&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 相对于 webapp 的目录 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 是否过滤, 开启后会将匹配到的 directory 中的文件替换到 targetPath 中 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">webResources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="🚩-注意"><a href="#🚩-注意" class="headerlink" title="🚩 注意"></a>🚩 注意</h4><p>为了实现多环境配置，此处在  directory 中，使用了变量 active 来动态匹配路径。至于其值则是通过各个环境的配置文件定义的。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 测试环境 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>test<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">active</span>&gt;</span>test<span class="tag">&lt;/<span class="name">active</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 生产环境 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>prod<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">active</span>&gt;</span>prod<span class="tag">&lt;/<span class="name">active</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></table></figure><p>此处并没有为每个环境直接指定路径，而是设置了一个 key 为 active 的属性，其 value 对应各自环境的文件夹名。</p>]]></content>
      
      
      <categories>
          
          <category> Maven </category>
          
          <category> 插件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 多环境 </tag>
            
            <tag> Maven </tag>
            
            <tag> 插件 </tag>
            
            <tag> 发版 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring 项目打包后运行报错</title>
      <link href="2020/04/09/yuque/Spring%20%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E5%90%8E%E8%BF%90%E8%A1%8C%E6%8A%A5%E9%94%99/"/>
      <url>2020/04/09/yuque/Spring%20%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E5%90%8E%E8%BF%90%E8%A1%8C%E6%8A%A5%E9%94%99/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>使用 IDE 编译可正常运行，但是打包之后在运行时报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassNotFoundException: com.fasterxml.jackson.core.TSFBuilder</span><br></pre></td></tr></table></figure><h2 id="分析及解决"><a href="#分析及解决" class="headerlink" title="分析及解决"></a>分析及解决</h2><p>表面上是无法找到 jackson 中的某个类，但是在确认过 pom 后发现该依赖已经添加。<br>实际上是因为当前引用的 jackson 依赖与 spring 版本不兼容。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 之前的配置</span><br><span class="line">jackson 2.9.2 &lt;----&gt; spring 5.2.5 ✖</span><br><span class="line"></span><br><span class="line"># 修正之后</span><br><span class="line">jackson 2.10.3 &lt;----&gt; spring 5.2.5 ✔</span><br></pre></td></tr></table></figure><p>调整版本号可正常运行。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Vue Ts 中使用 axios</title>
      <link href="2020/04/07/yuque/Vue%20Ts%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20axios/"/>
      <url>2020/04/07/yuque/Vue%20Ts%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20axios/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在使用  typescript  编写  Vue 时无法识别 axios 的类型。在指定类型声明文件后依然无效。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AxiosInstance &#125; <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="built_in">module</span> <span class="string">&quot;Vue/types/vue&quot;</span> &#123;</span><br><span class="line">  <span class="keyword">interface</span> Vue &#123;</span><br><span class="line">    $axios: AxiosInstance;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 在原型链上挂载</span></span><br><span class="line">Vue.prototype.$axios = axios;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无法识别类型</span></span><br><span class="line"><span class="built_in">this</span>.$axios;</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>安装 vue-axios 插件。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> VueAxios <span class="keyword">from</span> <span class="string">&quot;vue-axios&quot;</span>;</span><br><span class="line">Vue.use(VueAxios, axios);</span><br><span class="line"><span class="comment">// 消除报错</span></span><br><span class="line"><span class="built_in">this</span>.axios;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>插件式注解</title>
      <link href="2020/03/24/yuque/%E6%8F%92%E4%BB%B6%E5%BC%8F%E6%B3%A8%E8%A7%A3/"/>
      <url>2020/03/24/yuque/%E6%8F%92%E4%BB%B6%E5%BC%8F%E6%B3%A8%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<p>其前身是来自 java 6 的 APT （abstract processor tool），自 java 8 之后被插件式注解 API （pluggable annotation processing api） 取代。其本质上是提供用户在编译器访问注解元数据，处理和自定义编译输出，并能够创建新的源文件等等。</p><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><ul><li>用于生成模板代码，减少工作量，并保证了实际源码的简洁（如：lombok）；</li><li>取代大量通过反射处理注解的方式，提高代码的运行性能（如：对象的序列化）；</li></ul><h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><ul><li>MapStruct：java bean 映射注解处理器；</li></ul><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><p>插件式注解是通过继承虚注解处理器（AbstractProcessor）来实现的，通过在其核心方法  （process）中匹配相应注解，可以实现在编译时向项目中输出 java 源文件。</p><h3 id="01-注解"><a href="#01-注解" class="headerlink" title="01.注解"></a>01.注解</h3><p>创建注解 “@Hello”。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Hello &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="02-处理器"><a href="#02-处理器" class="headerlink" title="02.处理器"></a>02.处理器</h3><p>创建名为 “HelloProcessor”的处理器，并指定其支持的源码为 java 8，处理上述注解（ “@Hello”）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SupportedSourceVersion(SourceVersion.RELEASE_8)</span></span><br><span class="line"><span class="meta">@SupportedAnnotationTypes(&quot;com.example.annotation.Hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HELLO_TEMPLATE =</span><br><span class="line">            <span class="string">&quot;package %1$s;\n\npublic class %2$sHello &#123;\n  public static void sayHello() &#123;\n    System.out.println(\&quot;Hello %3$s\&quot;);\n  &#125;\n&#125;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; set, RoundEnvironment roundEnvironment)</span> </span>&#123;</span><br><span class="line">        roundEnvironment.getElementsAnnotatedWith(Hello.class).forEach(element -&gt; &#123;</span><br><span class="line">            TypeElement typeElem = (TypeElement) element;</span><br><span class="line">            String typeName = typeElem.getQualifiedName().toString();</span><br><span class="line">            Filer filer = processingEnv.getFiler();</span><br><span class="line">            <span class="keyword">try</span> (Writer sw = filer.createSourceFile(typeName + <span class="string">&quot;Hello&quot;</span>).openWriter()) &#123;</span><br><span class="line">                log(<span class="string">&quot;生成 &quot;</span> + typeName + <span class="string">&quot;Hello 源码&quot;</span>);</span><br><span class="line">                <span class="keyword">int</span> lastIndex = typeName.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">                sw.write(String.format(HELLO_TEMPLATE, typeName.substring(<span class="number">0</span>, lastIndex), typeName.substring(lastIndex + <span class="number">1</span>), typeName));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                processingEnv.getMessager().printMessage(Diagnostic.Kind.ERROR, e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (processingEnv.getOptions().containsKey(<span class="string">&quot;debug&quot;</span>)) &#123;</span><br><span class="line">            processingEnv.getMessager().printMessage(Diagnostic.Kind.NOTE, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="03-作用"><a href="#03-作用" class="headerlink" title="03.作用"></a>03.作用</h3><p>凡是被 “@Hello” 标记的类，都会生成以其类名 + Hello 形式的类，该类仅有一个类方法（sayHello）。在 Person 类上标记注解，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Hello</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br></pre></td></tr></table></figure><h3 id="04-效果"><a href="#04-效果" class="headerlink" title="04.效果"></a>04.效果</h3><p>最终在 【模块名】\target\generated-sources\annotations 下生成如下类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonHello</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Hello com.example.bean.Person&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="01-Maven-编译插件"><a href="#01-Maven-编译插件" class="headerlink" title="01.Maven 编译插件"></a>01.Maven 编译插件</h3><p>通过在  maven-compiler-plugin 插件中指定注解处理器。在多模块中，可以仅仅在需要提供注解处理器支持的模块中添加配置，亦可在父模块中添加（为所有子模块支持）。但实际上，注解处理器的代码在编译完成（生成源文件）之后，就已经完成其使命，因此在其他模块中，使用 provided 引用，在编译时会排除该依赖。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!--指定源文件生成路径，默认为当前模块下 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                    &lt;generatedSourcesDirectory&gt;$&#123;project.build.directory&#125;/generated-sources/&lt;/generatedSourcesDirectory&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">annotationProcessors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">annotationProcessor</span>&gt;</span></span><br><span class="line">                com.example.processor.HelloProcessor</span><br><span class="line">            <span class="tag">&lt;/<span class="name">annotationProcessor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">annotationProcessors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>无法支持 lombok 插件。与其一起使用，会出现如下报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java: 找不到符号</span><br></pre></td></tr></table></figure><h3 id="02-Java-服务注册"><a href="#02-Java-服务注册" class="headerlink" title="02.Java 服务注册"></a>02.Java 服务注册</h3><p>通过 spi 服务注册的方式。<br>当然需要添加（注解处理器的模块）依赖。<br>在注解处理器所在模块（或项目中）的 resources，创建 javax.annotation.processing.Processor 文件，目录结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">resources</span><br><span class="line"> └── META-INF</span><br><span class="line">     └── services</span><br><span class="line">         ├── java.lang.Process</span><br><span class="line">         └── javax.annotation.processing.Processor</span><br></pre></td></tr></table></figure><p>在此文件中，填写自定义的注解处理器（如上面的）：com.example.processor.HelloProcessor。<br>（实测）该方法兼容 lombok 插件。</p><h4 id="额外的配置"><a href="#额外的配置" class="headerlink" title="额外的配置"></a>额外的配置</h4><p>直接注册会产生注解处理器无法找到的错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.8.1:compile (default-compile) on project processor: Compilation failure</span><br><span class="line">服务配置文件不正确, 或构造处理程序对象javax.annotation.processing.Processor: Provider com.example.processor.HelloProcessor not found时抛出异常错误</span><br></pre></td></tr></table></figure><p>此时需要在该模块下配置  maven-compiler-plugin 插件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.8.1&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;source&gt;1.8&lt;&#x2F;source&gt;</span><br><span class="line">        &lt;target&gt;1.8&lt;&#x2F;target&gt;</span><br><span class="line">        &lt;!-- 不加这一句编译会报找不到processor的异常--&gt;</span><br><span class="line">        &lt;compilerArgument&gt;-proc:none&lt;&#x2F;compilerArgument&gt;</span><br><span class="line">    &lt;&#x2F;configuration&gt;</span><br><span class="line">&lt;&#x2F;plugin&gt;</span><br></pre></td></tr></table></figure><h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h4><p>在其他博客中提到，可以使用 google 的 AutoService 注解，为注解处理器自动生成服务注册文件。但是在实际测试时，发现其所生成的文件名为：java.lang.process，与上述不符，且并不能为注解提供注解处理器的支持。</p><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>注解处理器在编译器生成代码，因此在使用（生成的代码）时需要先编译，使用 maven 插件 compiler（或 javac 命令）进行编译，最终可以得到此<a href="#BYRnB">效果</a>。</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>下面是用于生成 builder 类的注解及处理器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Builder &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SupportedAnnotationTypes(&quot;com.example.Builder&quot;)</span></span><br><span class="line"><span class="meta">@SupportedSourceVersion(SourceVersion.RELEASE_8)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuilderProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Filer filer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</span><br><span class="line">        filer = processingEnv.getFiler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Processing &quot;</span> + annotations + roundEnv);</span><br><span class="line">        Set&lt;? extends Element&gt; elementsAnnotatedWith = roundEnv.getElementsAnnotatedWith(Builder.class);</span><br><span class="line">        elementsAnnotatedWith.forEach(element -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (element.getKind() != ElementKind.CLASS) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;not class&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            TypeMirror elementTypeMirror = element.asType();</span><br><span class="line">            String builderClassName = element.getSimpleName() + <span class="string">&quot;Builder&quot;</span>;</span><br><span class="line">            TypeSpec.Builder typeBuilder = TypeSpec.classBuilder(builderClassName)</span><br><span class="line">                    .addModifiers(Modifier.FINAL, Modifier.PUBLIC);</span><br><span class="line"></span><br><span class="line">            MethodSpec.Builder builderMethod = MethodSpec.methodBuilder(<span class="string">&quot;build&quot;</span>)</span><br><span class="line">                    .returns(TypeName.get(element.asType()))</span><br><span class="line">                    .addModifiers(Modifier.PUBLIC)</span><br><span class="line">                    .addStatement(<span class="string">&quot;$T instance = new $T()&quot;</span>, TypeName.get(elementTypeMirror), TypeName.get(elementTypeMirror));</span><br><span class="line"></span><br><span class="line">            element.getEnclosedElements().forEach(field -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (field.getKind() == ElementKind.FIELD) &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> isStatic = field.getModifiers().contains(STATIC);</span><br><span class="line">                    <span class="keyword">if</span> (isStatic) &#123;</span><br><span class="line">                        System.out.println(field.getSimpleName() + <span class="string">&quot; is static&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    String fieldName = field.getSimpleName().toString();</span><br><span class="line">                    System.out.println(fieldName);</span><br><span class="line">                    String transformedName = upperFirstChar(fieldName);</span><br><span class="line"></span><br><span class="line">                    MethodSpec methodSpec = MethodSpec.methodBuilder(<span class="string">&quot;build&quot;</span> + transformedName)</span><br><span class="line">                            .returns(TypeName.get(element.asType()))</span><br><span class="line">                            .returns(ClassName.get(<span class="string">&quot;com.example&quot;</span>, builderClassName))</span><br><span class="line">                            .addModifiers(Modifier.PUBLIC)</span><br><span class="line">                            .addParameter(TypeName.get(field.asType()), field.getSimpleName().toString())</span><br><span class="line">                            .addStatement(<span class="string">&quot;this.$L = $L;return this&quot;</span>, field.getSimpleName().toString()</span><br><span class="line">                                    , field.getSimpleName().toString())</span><br><span class="line">                            .build();</span><br><span class="line"></span><br><span class="line">                    FieldSpec fieldSpec = FieldSpec.builder(TypeName.get(field.asType()),</span><br><span class="line">                            fieldName, Modifier.PRIVATE).build();</span><br><span class="line"></span><br><span class="line">                    String fieldSetName = upperFirstChar(fieldName);</span><br><span class="line">                    builderMethod.addStatement(<span class="string">&quot;instance.set$L(this.$L)&quot;</span>, fieldSetName, fieldName);</span><br><span class="line">                    typeBuilder.addField(fieldSpec);</span><br><span class="line">                    typeBuilder.addMethod(methodSpec);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            builderMethod.addStatement(<span class="string">&quot;return instance&quot;</span>);</span><br><span class="line"></span><br><span class="line">            typeBuilder.addMethod(builderMethod.build());</span><br><span class="line"></span><br><span class="line">            TypeSpec typeSpec = typeBuilder.build();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                JavaFile.builder(<span class="string">&quot;com.example&quot;</span>, typeSpec).build().writeTo(System.out);</span><br><span class="line">                JavaFile.builder(<span class="string">&quot;com.example&quot;</span>, typeSpec).build().writeTo(filer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">upperFirstChar</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name.length() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line">        String firstChar = name.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase();</span><br><span class="line">        <span class="keyword">if</span> (name.length() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> firstChar + name.substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> firstChar;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="问题-2"><a href="#问题-2" class="headerlink" title="问题"></a>问题</h2><p>一些在测试中遇到但还没有解决的问题：</p><ul><li><input checked="" disabled="" type="checkbox"> <del>测试过程中发现在 idea 的配置中 lombok 的注解处理器被自定义的替换掉了，导致无法使用</del>（见<a href="#EKVDN"> Java 服务注册</a>）;</li></ul><hr><p>apt  jdk 8   注解   代码生成</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>进程管理</title>
      <link href="2020/02/21/yuque/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/"/>
      <url>2020/02/21/yuque/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="查看进程"><a href="#查看进程" class="headerlink" title="查看进程"></a>查看进程</h2><p>**<code>ps</code> **用于报告当前系统的进程状态。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 help 查看 ps 所有指令</span></span><br><span class="line">ps [options] [--<span class="built_in">help</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用指令</span></span><br><span class="line"><span class="comment">## grep 搜索字符串，匹配进程名</span></span><br><span class="line"><span class="comment">## &gt; 进程名 = 路径 + 文件名</span></span><br><span class="line"><span class="comment">## &gt; 当匹配非路径时会在所有目录下进行模糊查询</span></span><br><span class="line"><span class="comment">## &gt; 当匹配文件的绝对路径时，会精确查找进程</span></span><br><span class="line"><span class="comment">## &gt; 当匹配目录时，会查询该目录下所有进程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看指定名称的所有进程详细信息</span></span><br><span class="line">ps -aux | grep &lt;string&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看指定名称的所有进程信息</span></span><br><span class="line">ps -ef | grep &lt;string&gt;</span><br></pre></td></tr></table></figure><h2 id="杀死进程"><a href="#杀死进程" class="headerlink" title="杀死进程"></a>杀死进程</h2><p><code>**kill**</code>** **删除执行中的程序或工作。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 ? 查看 kill 用法</span></span><br><span class="line"><span class="built_in">kill</span> -?</span><br><span class="line"><span class="comment">## 用法:kill [-s 信号声明 | -n 信号编号 | -信号声明] 进程号 | 任务声明 ... 或 kill -l [信号声明]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 列出所有信息名称</span></span><br><span class="line"><span class="built_in">kill</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用第九种信号，通过指定的 pid 强制查杀进程</span></span><br><span class="line"><span class="built_in">kill</span> -9 &lt;pid&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 其他常用信号</span></span><br><span class="line">HUP     1    终端断线</span><br><span class="line">INT     2    中断（同 Ctrl + C）</span><br><span class="line">QUIT    3    退出（同 Ctrl + \）</span><br><span class="line">TERM   15    终止</span><br><span class="line">KILL    9    强制终止</span><br><span class="line">CONT   18    继续（与STOP相反， <span class="built_in">fg</span>/<span class="built_in">bg</span>命令）</span><br><span class="line">STOP   19    暂停（同 Ctrl + Z）</span><br></pre></td></tr></table></figure><h2 id="查杀进程"><a href="#查杀进程" class="headerlink" title="查杀进程"></a>查杀进程</h2><p>使用  <code>**ps**</code>** <strong>、</strong><code>kill</code>**  组合，可以在查找进程后直接杀死。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 强制查杀指定名称的进程</span></span><br><span class="line"><span class="comment">## string 指定为目录，进行批量查杀进程（已验证）</span></span><br><span class="line"><span class="comment">## awk 的作用是指定输出某一列，awk &#x27;&#123;print $2&#125;&#x27; 输出第二列，即 pid</span></span><br><span class="line">ps -ef | grep &lt;string&gt; | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | xargs <span class="built_in">kill</span> -9</span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="built_in">kill</span> -9 `ps -ef | grep &lt;string&gt; | grep -v grep|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 输出 pid 到文件，然后遍历（未验证）</span></span><br><span class="line">ps -ef | grep &lt;string&gt; | grep -v grep | awk -F<span class="string">&#x27; &#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> &gt;  ./fock_chang.txt</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> pid; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$pid</span>; <span class="built_in">kill</span> -9 <span class="variable">$pid</span>; <span class="keyword">done</span> &lt; ./fock_chang.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">## 输出 pid 到内存，然后遍历（未验证）</span></span><br><span class="line"><span class="keyword">for</span> pid <span class="keyword">in</span> `ps -ef | grep &lt;string&gt; | grep -v grep | awk -F<span class="string">&#x27; &#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`;<span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$pid</span>;<span class="built_in">kill</span> -9 <span class="variable">$xx</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>自定义 JDK 锁</title>
      <link href="2020/02/12/yuque/%E8%87%AA%E5%AE%9A%E4%B9%89%20JDK%20%E9%94%81/"/>
      <url>2020/02/12/yuque/%E8%87%AA%E5%AE%9A%E4%B9%89%20JDK%20%E9%94%81/</url>
      
        <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>从设计者的角度考量如何实现一个较为完整的 JDK 锁（Lock 接口）。<br>预期的效果：</p><ul><li><input checked="" disabled="" type="checkbox"> <a href="#B1lXa">不可重入锁</a>：当线程持有锁后再次尝试获取锁会被阻塞；</li><li><input checked="" disabled="" type="checkbox"> <a href="#bUk7r">可重入锁</a>：线程可重复获取锁，多次持有将其同步状态计数器累计加一，释放则减一，直到计数器为零时，表示锁完全被释放，其他线程可恢复；</li><li><input disabled="" type="checkbox"> <a href="#jtihU">公平锁</a>：按照线程进入 lock 的先后顺序，依次获取锁；</li><li><input disabled="" type="checkbox"> 独占锁（排他锁）：只有一个线程可以持有锁；</li><li><input disabled="" type="checkbox"> 完全实现 Lock 接口：实现该接口所有方法；</li></ul><h2 id="CAS-机制"><a href="#CAS-机制" class="headerlink" title="CAS 机制"></a>CAS 机制</h2><p>Compare And Set（Swap），即比较并设置（替换）：对于变量，将预期值 Old 通过内存地址 V 于变量进行比较，当通过校验时，将新值 New 赋值给内存 V。</p><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul><li>数据库乐观锁更新；</li><li>网站访问量；</li><li>Atomic 原子类；</li><li>JVM 内部的 Unsafe 类；</li></ul><h3 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h3><ul><li>只能保证单个变量在多线程下的安全性，对代码块无效；</li><li>ABA 问题：即仅对结果进行预期控制，无法约束过程，可能在执行过程中发生如： A-&gt;B-&gt;A 这样的状态变化，解决方法是追加版本号；</li></ul><h2 id="Lock-接口"><a href="#Lock-接口" class="headerlink" title="Lock 接口"></a>Lock 接口</h2><p>Lock 接口位于 J.U.C（java.util.concurrent）的 locks 包下，区别于 JVM 内置锁（synchronized），该接口通过手动实现 JDK 锁，而能够提供灵活的锁管理机制，如：尝试非阻塞式获取锁、可中断获取锁、可超时获取锁。</p><h2 id="不可重入锁"><a href="#不可重入锁" class="headerlink" title="不可重入锁"></a>不可重入锁</h2><ul><li>简单的实现了获取锁/释放锁的操作；</li><li>通过 CAS 机制，判断当前线程是否持有锁；</li><li>需要频繁读写等待队列，此处使用  <code>LinkedBlockingQueue&lt;Thread&gt;</code>  来保证在线程安全的前提下提供更好的性能；</li><li>此处使用了 Lock 来修改了线程状态，因此并不是<a href="#ExkUz">自旋锁</a>。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 无限循环直到当前线程持有锁</span></span><br><span class="line">    <span class="keyword">while</span> (!owner.compareAndSet(<span class="keyword">null</span>, Thread.currentThread())) &#123;</span><br><span class="line">        <span class="comment">// 将当前线程添加到等待队列</span></span><br><span class="line">        waiter.add(Thread.currentThread());</span><br><span class="line">        <span class="comment">// 挂起当前线程</span></span><br><span class="line">        LockSupport.park();</span><br><span class="line">        <span class="comment">// 线程被唤醒后，从等待队列移除当前线程</span></span><br><span class="line">        waiter.remove(Thread.currentThread());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当前线程持有锁时执行释放锁</span></span><br><span class="line">    <span class="keyword">if</span> (owner.compareAndSet(Thread.currentThread(), <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="comment">// 释放挂起线程</span></span><br><span class="line">        <span class="keyword">for</span> (Thread thread : waiter) &#123;</span><br><span class="line">            LockSupport.unpark(thread);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><ul><li>在 number 自增时添加锁；</li><li>创建 5 个线程，每个线程遍历 1000 次，对 number = 0，进行自增，预期结果为 5000；</li><li>在线程切换时，需要添加休眠时间，否则程序执行过快，无法看到预期效果；</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Lock simpleLock = <span class="keyword">new</span> SimpleLock();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    simpleLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        number++;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        simpleLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    SimpleLockTest simpleLockTest = <span class="keyword">new</span> SimpleLockTest();</span><br><span class="line">    <span class="keyword">int</span> threadNumber = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> max = <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threadNumber; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; max; j++) &#123;</span><br><span class="line">                <span class="comment">//                        Files.readAllLines(Paths.get(&quot;C:\\Users\\daiwenzh5\\Downloads\\激活码 (3).txt&quot;));</span></span><br><span class="line">                  simpleLockTest.increment();</span><br><span class="line">                simpleLockTest.doubleLock();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">    System.out.printf(<span class="string">&quot;simpleLockTest.number = %d&quot;</span>, simpleLockTest.number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">simpleLockTest.number &#x3D; 5000</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure><h3 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h3><ul><li>当线程未能获取锁时，让线程不停的执行循环体，而不修改线程状态，通过循环来阻塞无锁线程，称之为<strong>自旋锁；</strong></li><li>但是由于每个线程都需要执行循环，当线程数不停增加时，性能下降明显，所以自旋锁仅适用于线程竞争不激烈（<strong>线程数量少</strong>），持有锁的时间短（<strong>频繁切换线程</strong>）的场景；</li></ul><h2 id="可重入锁"><a href="#可重入锁" class="headerlink" title="可重入锁"></a>可重入锁</h2><p>在普通的不可重入锁的基础上，为线程获取锁的状态添加一个计数器，一旦线程持有锁则计数器自增，在锁未被释放之前，只有持有锁的线程可以再次获取锁，使得计数器不断增加。<br>在线程释放锁时，每一次都使得计数器自减，直到其值为 0 时，表示线程完全释放了锁，此时将锁持有者线程置空即可。</p><h3 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h3><ul><li>当同步方法嵌套使用时，需要使用可重入锁，用以避免死锁问题；</li></ul><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><ul><li>无锁的线程通过循环遍历进行挂起；</li><li>线程一旦持有锁，则退出循环，并将其同步计数器自增；</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断当前线程是否持有锁，若没有则尝试获取锁，获取成功则推出循环</span></span><br><span class="line">    <span class="keyword">while</span> (!(owner.get() == Thread.currentThread() ||</span><br><span class="line">            owner.compareAndSet(<span class="keyword">null</span>, Thread.currentThread()))) &#123;</span><br><span class="line">        waiter.add(Thread.currentThread());</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        waiter.remove(Thread.currentThread());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 同步状态计数器自增</span></span><br><span class="line">    count.incrementAndGet();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.printf(<span class="string">&quot;ownerThread:%s,currentThread:%s%n&quot;</span>,</span><br><span class="line">            owner.get() == <span class="keyword">null</span> ? <span class="string">&quot;null&quot;</span> : owner.get().getName(),</span><br><span class="line">            Thread.currentThread().getName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断当前线程是否持有锁</span></span><br><span class="line">    <span class="keyword">if</span> (owner.get() == Thread.currentThread()) &#123;</span><br><span class="line">        <span class="comment">// 对同步状态计数器每次自减后判断其值是否为 0</span></span><br><span class="line">        <span class="comment">// 0 表示锁被释放</span></span><br><span class="line">        <span class="keyword">if</span> (count.decrementAndGet() == <span class="number">0</span>) &#123;</span><br><span class="line">            owner.set(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">for</span> (Thread thread : waiter) &#123;</span><br><span class="line">                LockSupport.unpark(thread);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>在测试代码内部添加两重嵌套的同步方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doubleLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    simpleLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        count ++;</span><br><span class="line">        <span class="comment">// number ++ 自增的同步方法</span></span><br><span class="line">        increment();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        simpleLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="结果-1"><a href="#结果-1" class="headerlink" title="结果"></a>结果</h3><p>程序成功执行并退出，且结果符合预期，两重同步锁嵌套未发生死锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">simpleLockTest.number = <span class="number">5000</span>, count = <span class="number">5000</span></span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure><h2 id="公平锁"><a href="#公平锁" class="headerlink" title="公平锁"></a>公平锁</h2><ul><li>按照进入 lock 的先后顺序（即等待队列），依次给线程获取锁；</li></ul><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>自定义类加载器</title>
      <link href="2020/02/06/yuque/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8/"/>
      <url>2020/02/06/yuque/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p><em>为什么需要自定义类加载器，其需求是什么？或者说其应用场景是什么？</em></p><ul><li>安全性：Java 代码能够被轻易的反编译，在足够优秀的 IDE 面前，class 文件等价于 java 文件，为了保证代码的安全性，可以将编译后的代码使用约定好的算法进行加密，这样的 class 文件时无法使用 Java 自有的类加载器读取的，此时就需要通过自定义加载器，在读取类时先解密后加载；</li><li>资源隔离：对于同一 jvm 来说，不同类加载器实例化的同名类对象，实际上是不相等，每一个类加载器都相当于一个独立的容器；</li><li>解决 jar 包冲突：基于上一点，同一个类名可以同时存在每一个类加载器中；</li></ul><h2 id="读取加密-class-文件"><a href="#读取加密-class-文件" class="headerlink" title="读取加密 class 文件"></a>读取加密 class 文件</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>自定义类加载器需要继承 ClassLoader 或其增强类 URLClassLoader，其中存在 findClass 方法，用于读取 class 文件，并通过搜索类的限定名对其进行加载，最终返回一个 Class 对象。<br>因此在读取 class 文件时，可以对其二进制字节进行解密，将其还原成原始的 class 文件，然后挂载到 jvm 中。</p><h3 id="局限"><a href="#局限" class="headerlink" title="局限"></a>局限</h3><p>通常情况下，只会使用 java 代码来实现自定义类加载器，不能加载其自身，即类加载器是可以作为反编译的切入点；同时，jvm 加载的类字节存在内存中，也是可以被访问的，狠一点的方法是通过其他语言来实现类加载器，但也不能完全避免反编译。</p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul><li>单例模式：自定义类加载器在使用时，会加载指定类，每次实例化类加载器，每个对象之间同样是资源隔离的，因此，频繁调用会使得 jvm 中挂载的类越来越多，最终导致内存溢出，因此需要将自定义类加载器设计成单例模式，spring 项目中，注册成 bean 即可被 spring 托管；</li></ul><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><h4 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h4><ul><li>继承自  <code>URLClassLoader</code>，特点是可以指定外部 jar 或 class 文件；</li><li>主要重写  <code>findClass</code> 方法，用于读取 class 文件二级制字节并加载类；</li><li>需要在读取字节后对其解密；</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleClassLoader</span><span class="params">(URL... urls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(urls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">for</span> (URL url: <span class="keyword">this</span>.getURLs()) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = decrypt(url) ;</span><br><span class="line">            <span class="comment">// 将二进制字节转换成 java.lang.Class</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.defineClass(name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] decrypt(URL url) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> SimpleEncryptUtils.decrypt(url.openStream());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;【类文件解码】jar 或 class 不存在&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        testPeople();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testPeople</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        String target = &quot;C:\\Users\\daiwenzh5\\Desktop\\test\\People-origin.class&quot;;</span></span><br><span class="line">        String target = <span class="string">&quot;C:\\Users\\daiwenzh5\\Desktop\\test\\People-encrypt-1581006788342.class&quot;</span>;</span><br><span class="line">        test(target, <span class="string">&quot;com.example.demo.bean.People&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="异或加密"><a href="#异或加密" class="headerlink" title="异或加密"></a>异或加密</h4><ul><li>特点是简单，便于测试;</li><li>核心方法是  <code>byte[] encrypt(byte[] bytes, String key)</code>，其他方法都是基于此方法的重载，便于使用；</li><li><code>main</code>  方法中对  <code>People.class</code>  文件使用异或加密，并导出得到加密后的文件；</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleEncryptUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_KEY = <span class="string">&quot;daiwenzh5♪(＾∀＾●)ﾉ&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] bytes, String key) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] keyBytes = key.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bytes.length; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">byte</span> keyByte : keyBytes) &#123;</span><br><span class="line">                bytes[i] = (<span class="keyword">byte</span>) (bytes[i] ^ keyByte);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] bytes) &#123;</span><br><span class="line">        <span class="keyword">return</span> encrypt(bytes, DEFAULT_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrypt(InputStream inputStream) &#123;</span><br><span class="line">        <span class="keyword">return</span> encrypt(inputStream, DEFAULT_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrypt(InputStream inputStream, String key) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            BufferedInputStream bufferedInputStream = <span class="keyword">new</span> BufferedInputStream(inputStream);</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[bufferedInputStream.available()];</span><br><span class="line">            bufferedInputStream.read(bytes);</span><br><span class="line">            <span class="keyword">return</span> encrypt(bytes, key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] decrypt(<span class="keyword">byte</span>[] bytes, String key) &#123;</span><br><span class="line">        <span class="comment">// 因为是取反，所以解密过程和加密过程一致</span></span><br><span class="line">        <span class="keyword">return</span> encrypt(bytes, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] decrypt(<span class="keyword">byte</span>[] bytes) &#123;</span><br><span class="line">        <span class="comment">// 因为是取反，所以解密过程和加密过程一致</span></span><br><span class="line">        <span class="keyword">return</span> decrypt(bytes, DEFAULT_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] decrypt(InputStream inputStream) &#123;</span><br><span class="line">        <span class="comment">// 因为是取反，所以解密过程和加密过程一致</span></span><br><span class="line">        <span class="keyword">return</span> decrypt(inputStream, DEFAULT_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] decrypt(InputStream inputStream, String key) &#123;</span><br><span class="line">        <span class="comment">// 因为是取反，所以解密过程和加密过程一致</span></span><br><span class="line">        <span class="keyword">return</span> encrypt(inputStream, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encryptFile</span><span class="params">(String src, String dist)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Path path = Paths.get(dist);</span><br><span class="line">            <span class="keyword">if</span> (!Files.exists(path)) &#123;</span><br><span class="line">                Files.createFile(path);</span><br><span class="line">            &#125;</span><br><span class="line">            Files.write(path, Objects.requireNonNull(encrypt(Files.newInputStream(Paths.get(src)))));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decryptFile</span><span class="params">(String src, String dist)</span> </span>&#123;</span><br><span class="line">        encryptFile(src, dist);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testDecryptFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 加密文件</span></span><br><span class="line"><span class="comment">//        String src = &quot;C:\\Users\\daiwenzh5\\Desktop\\test\\People-origin.class&quot;;</span></span><br><span class="line">        String src = <span class="string">&quot;C:\\Users\\daiwenzh5\\Desktop\\test\\People-encrypt-1581006788342.class&quot;</span>;</span><br><span class="line">        <span class="comment">// 解密路径</span></span><br><span class="line">        String dist = <span class="string">&quot;C:\\Users\\daiwenzh5\\Desktop\\test\\People-decrypt-&quot;</span> + time + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line">        System.out.printf(<span class="string">&quot;文件名：People-decrypt-%d.class%n&quot;</span>, time);</span><br><span class="line">        decryptFile(src, dist);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testEncryptFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 源文件</span></span><br><span class="line">        String src = <span class="string">&quot;C:\\Users\\daiwenzh5\\Desktop\\test\\People-origin.class&quot;</span>;</span><br><span class="line">        <span class="comment">// 加密路径</span></span><br><span class="line">        String dist = <span class="string">&quot;C:\\Users\\daiwenzh5\\Desktop\\test\\People-encrypt-&quot;</span> + time + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line">        System.out.printf(<span class="string">&quot;文件名：People-encrypt-%d.class%n&quot;</span>, time);</span><br><span class="line">        encryptFile(src, dist);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testString</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] encrypt = encrypt(content.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(encrypt, StandardCharsets.UTF_8));</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(decrypt(encrypt), StandardCharsets.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        testString(&quot;hello world&quot;);</span></span><br><span class="line">        testEncryptFile();</span><br><span class="line"><span class="comment">//        testDecryptFile();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="class-文件"><a href="#class-文件" class="headerlink" title="class 文件"></a>class 文件</h4><ul><li><a href="https://raw.githubusercontent.com/DaiwenZh5/files/master/%E8%AF%AD%E9%9B%80/People-origin.class">People-origin.class</a>（原始文件）</li><li><a href="https://raw.githubusercontent.com/DaiwenZh5/files/master/%E8%AF%AD%E9%9B%80/People-encrypt-1581006788342.class">People-encrypt-1581006788342.class</a>（加密文件）</li></ul><h4 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h4><ul><li>加密 class 文件被成功读取，并通过反射正确输出对象类名；</li><li>如期地打印其使用的类加载器；</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">People</span><br><span class="line">com.example.demo.configs.SimpleClassLoader@1218025c</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Spring Aop 插件式开发</title>
      <link href="2020/02/05/yuque/Spring%20Aop%20%E6%8F%92%E4%BB%B6%E5%BC%8F%E5%BC%80%E5%8F%91/"/>
      <url>2020/02/05/yuque/Spring%20Aop%20%E6%8F%92%E4%BB%B6%E5%BC%8F%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>spring aop 能够对其托管的 bean 进行无侵入式的增强，原有代码与增强代码之间解耦，但是其配置始终是写死在项目中，对其管理依旧需要重启项目，这对生产来说是比较麻烦的。<br>插件式开发正是解决此类问题的一种有效方案，能够提供灵活的、可插拔式的热更新（即无重启更新），通过定义合适的配置文件，能够提供方便有效且统一的管理页面。同时，也可基于环境读取不同的配置，实现同一插件在不同环境的个性化配置。<br>对于插件来说，只要向运行项目提供透明的配置信息，则可以在项目外直接被识别并使用。</p><h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>JVM 通过类加载器在启动时加载 class 文件，且一般地只会加载一次，但在程序内可以通过手动配置类加载器，可提供要加载的类的 jar 包路径及限定名，将其读取并加载到虚拟机，之后通过反射可以实例化加载的类对象，最后注册成 spring bean 之后就可以被 spring 托管。</p><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="插件的基本配置"><a href="#插件的基本配置" class="headerlink" title="插件的基本配置"></a>插件的基本配置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;config&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;active&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;className&quot;</span>: <span class="string">&quot;com.example.plugin.libs.LogPlugin&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;jarRemoteUrl&quot;</span>: <span class="string">&quot;C:WorkspaceVSCodeProjectsJavademosrcmain\resourcesplugins&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;日志插件&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th><strong>属性</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td>id</td><td>唯一标识</td></tr><tr><td>name</td><td>插件名称</td></tr><tr><td>jarRemoteUrl</td><td>jar 包的地址</td></tr><tr><td>className</td><td>类的限定名</td></tr><tr><td>active</td><td>是否激活</td></tr></tbody></table><p>注：以上为必备属性，亦可添加描述、版本号等其他属性。</p><h3 id="类加载器读取插件"><a href="#类加载器读取插件" class="headerlink" title="类加载器读取插件"></a>类加载器读取插件</h3><p>URLClassLoader 类加载器可以通过路径来读取 jar 包，但由于其 addURL 方法并不是被 public 修饰，无法直接访问，因此需要通过反射来获取该方法的使用权限。<br>同时应该避免多次加载重复文件。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载插件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> plugin 插件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回 aop 通知对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Advice <span class="title">load</span><span class="params">(PluginConfig plugin)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 若缓存中已存在该类，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (adviceCache.containsKey(plugin.getClassName())) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【加载插件】读取缓存成功&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> adviceCache.get(plugin.getClassName());</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;【加载插件】正在读取插件配置...&quot;</span>);</span><br><span class="line">    <span class="comment">// 获取插件 jar 包路径</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        URL targetUrl = Paths.get(plugin.getJarRemoteUrl()).toUri().toURL();</span><br><span class="line">        <span class="comment">// 获取当前项目的类加载器</span></span><br><span class="line">        URLClassLoader loader = (URLClassLoader) <span class="keyword">this</span>.getClass().getClassLoader();</span><br><span class="line">        <span class="keyword">boolean</span> isLoader = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 遍历已加载类</span></span><br><span class="line">        <span class="keyword">for</span> (URL url : loader.getURLs()) &#123;</span><br><span class="line">            <span class="comment">// 当前插件已经被加载退出</span></span><br><span class="line">            <span class="keyword">if</span> (url.equals(targetUrl)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;【加载插件】插件已被加载！&quot;</span>);</span><br><span class="line">                isLoader = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 当该插件尚未被加载</span></span><br><span class="line">        <span class="keyword">if</span> (!isLoader) &#123;</span><br><span class="line">            <span class="comment">// 反射获取类加载器的 addURL 方法</span></span><br><span class="line">            <span class="keyword">if</span> (addURLMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;【加载插件】初次调用，获取类加载器的 addURL 方法&quot;</span>);</span><br><span class="line">                addURLMethod = URLClassLoader.class.getDeclaredMethod(<span class="string">&quot;addURL&quot;</span>, URL.class);</span><br><span class="line">                <span class="keyword">if</span> (!addURLMethod.isAccessible()) &#123;</span><br><span class="line">                    addURLMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;【加载插件】正在加载插件：&quot;</span> + targetUrl);</span><br><span class="line">            <span class="comment">// 类加载器获取将插件的 jar 路径</span></span><br><span class="line">            addURLMethod.invoke(loader, targetUrl);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 加载类</span></span><br><span class="line">        Class&lt;?&gt; adviceClass = Class.forName(plugin.getClassName());</span><br><span class="line">        <span class="comment">// 创建插件对象，并缓存</span></span><br><span class="line">        System.out.println(<span class="string">&quot;【加载插件】生成插件并缓存&quot;</span>);</span><br><span class="line">        adviceCache.put(adviceClass.getName(), (Advice) adviceClass.newInstance());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MalformedURLException | NoSuchMethodException | SecurityException | IllegalAccessException</span><br><span class="line">            | IllegalArgumentException | InvocationTargetException | ClassNotFoundException</span><br><span class="line">            | InstantiationException e) &#123;</span><br><span class="line">        System.out.println(e.getLocalizedMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> adviceCache.get(plugin.getClassName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="注册成-spring-bean"><a href="#注册成-spring-bean" class="headerlink" title="注册成 spring bean"></a>注册成 spring bean</h3><p>此处的插件基于 aop。对于 aop 增强的 bean 会被 spring 自动在最顶层上生成一个 Advised 的增强类，因此插件的最终去向是被应用在 <code>bean instanceof Advised</code> （即被增强的）spring 类对象上，当然，插件实现是应该继承 spring aop 的通知接口，如  <code>MethodBeforeAdvice</code>  等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogPlugin</span> <span class="keyword">implements</span> <span class="title">MethodBeforeAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Method method, Object[] args, Object target)</span> </span>&#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">                method.getDeclaringClass().getName() + <span class="string">&quot;.&quot;</span> + method.getName() + <span class="string">&quot;,args = &quot;</span> + Arrays.toString(args));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////// 激活插件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 激活插件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id 插件 id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">active</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    PluginConfig pluginConfig = pluginConfigMap.get(id);</span><br><span class="line">    System.out.println(<span class="string">&quot;【插件激活】正在激活插件：&quot;</span> + pluginConfig);</span><br><span class="line">    <span class="comment">// 检查插件是否被加载</span></span><br><span class="line">    <span class="keyword">if</span> (!pluginConfigMap.containsKey(id)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;【插件激活】尚未读取插件配置信息，无法激活&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Object bean;</span><br><span class="line">    <span class="keyword">for</span> (String name : applicationContext.getBeanDefinitionNames()) &#123;</span><br><span class="line">        bean = applicationContext.getBean(name);</span><br><span class="line">        <span class="keyword">if</span> (bean == <span class="keyword">this</span> || !(bean <span class="keyword">instanceof</span> Advised) || findAdvice((Advised) bean, pluginConfig.getClassName())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.printf(<span class="string">&quot;【插件激活】正在为【%s】激活插件&quot;</span>, name);</span><br><span class="line">        <span class="comment">// 对增强 bean 应用插件</span></span><br><span class="line">        ((Advised) bean).addAdvice(<span class="keyword">this</span>.load(pluginConfig));</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;【插件激活】激活完毕&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul><li>使用  <code>spring-boot-maven-plugin</code>  打包会同时生成两个 jar 包，一种是可直接执行的<strong>程序包</strong>（.jar），另一种是作为外部引用的<strong>依赖包</strong>（.jar.original）。这里需要的是<strong>依赖包</strong>，使用压缩软件打开可以看到，其目录结构完全符合类的限定名（jar/包名/类名）；而可执行程序的目录是（jar/BOOT-INF/classes/包名/类名）；</li><li>对于类加载器，可以使用当前类的加载器  <code>(URLClassLoader) this.getClass().getClassLoader()</code>，也可以使用系统类加载器  <code>(URLClassLoader) ClassLoader.getSystemClassLoader()</code>，但都需要<strong>转型</strong>为 <code>URLClassLoader</code>，因为其可以加载外部 jar 或 class 文件；</li><li>spring aop 接口对 bean 的要求是其顶层实现必须继承  <code>Advised</code> 接口，因此，对于需要支持插件增强的 bean 必须已经被 aop 切入，所以最好的做法是提前使用一个空白的切面组件对 bean 进行标记，如：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(value = &quot;execution(* com.example.demo.controller..*.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际上，切面方法内不执行任何操作，目的是将  <code>com.example.demo.controller</code> 包下的所有方法都连接上切          面；</p><h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>包括但不限于以下几种：</p><ul><li>日志；</li><li>性能监控；</li><li>权限拦截器；</li></ul><h2 id="待测试"><a href="#待测试" class="headerlink" title="待测试"></a>待测试</h2><ul><li>自动加载插件：通过监听插件所在目录变化，自动读取插件配置并加载插件；</li><li>自动生成插件配置：统一插件的生成方式，能够在打包时自动的生成插件的配置信息；</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Git 配置多账户</title>
      <link href="2020/01/20/yuque/Git%20%E9%85%8D%E7%BD%AE%E5%A4%9A%E8%B4%A6%E6%88%B7/"/>
      <url>2020/01/20/yuque/Git%20%E9%85%8D%E7%BD%AE%E5%A4%9A%E8%B4%A6%E6%88%B7/</url>
      
        <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>需要为不同的 git （如：github、gitlab、gitee）配置 ssh，因为 ssh 内置了账户（邮箱），所以一旦这些 git 的账户名不同，自然得为其配置不同的 ssh 文件。</p><h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><ol><li>打开 shell，进入  <code>C:\Users\%username%\.ssh</code>  目录；</li><li>输入：<code>ssh-keygen -t rsa -C &#39;zhudaiwen@git.51baiwang.com&#39; -f ./gitlab_bw/id_rsa</code>，生成密钥并指定其存放在  <code>.ssh/gitlab_bw</code>（目录名意为公司自建的 gitlab 服务器，此处随意，或任意不同的文件名即可）;</li><li>在  <code>.ssh</code> 目录下，新建  <code>config</code>  文件，在其内指定 git 服务器对应的域名（主机名或 IP），</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># gitlab_bw</span><br><span class="line">Host git.51baiwang.com</span><br><span class="line">HostName git.51baiwang.com</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line">IdentityFile &quot;C:\Users\daiwenzh5\.ssh\gitlab_bw\id_rsa&quot;</span><br></pre></td></tr></table></figure><ol start="4"><li>为其他不同的 git 账户重复上述步骤（需要注意步骤 2 时，须命名不同或存放不同目录）。</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>PageHelper 分页结果类型转换</title>
      <link href="2020/01/05/yuque/PageHelper%20%E5%88%86%E9%A1%B5%E7%BB%93%E6%9E%9C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/"/>
      <url>2020/01/05/yuque/PageHelper%20%E5%88%86%E9%A1%B5%E7%BB%93%E6%9E%9C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在 Mybatis 中使用 PageHelper 插件可以轻易的实现分页查询，但是对于某些时候，从库中直接返回的 Po 对象并不是最终需要返回的类型，即分页中的结果集需要进行类型转换，当然，转换过程中不能丢失分页信息。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>通过观察 PageHelper 插件的源码可以知道，其分页结果为 <code>Page</code> 对象，继承了  <code>ArrayList</code> 对象，其结果集通过泛型来约束类型。而实际上，java 中的泛型类型约束偏向于编译器层面，即由编译器对泛型进行类型检查，一旦编译通过，最终会转换为原始类型，称之为类型（泛型）擦除，正是有这样的机制存在，此处可以较为简单的实现对分页结果的类型转换。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ol><li>启动分页器，执行查询 sql 执行分页，设定结果集类型未 <code>T</code>；</li><li>提取分页结果并进行类型转换，设转换类型为 <code>E</code>，保存结果为 <code>result</code>（<code>List&lt;E&gt;</code>） 变量；</li><li>对分页对象 <code>Page&lt;T&gt;</code>  执行其继承自父类的  <code>ArrayList#clear()</code> 方法，清除原结果集；</li><li>对 <code>Page&lt;T&gt;</code> 对象进行显示的强转，转换结果类型与 <code>result</code>（<code>E</code>） 变量保持一致，此处会出现编译器警告，但实际上由于类型擦除的机制存在，在编译后的类型始终是原始类型 <code>Page</code>，（且已经提前清空了强转之前的泛型类型对象）因此此处忽略警告对编译结果不会造成异常影响；</li><li>最后将转换的结果  <code>result</code>  置入强转后的  <code>Page&lt;E&gt;</code>  对象中。</li></ol><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageHelpers</span>&lt;<span class="title">K</span>, <span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Page&lt;E&gt; page;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始分页</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageNum  页码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageSize 每页显示数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> execute  查询 sql</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mapper   结果集转换方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回 &#123;<span class="doctag">@code</span> PageHelpers&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PageHelpers&lt;K, E&gt; <span class="title">startPage</span><span class="params">(<span class="keyword">int</span> pageNum, <span class="keyword">int</span> pageSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       Supplier&lt;?&gt; execute,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       Function&lt;? <span class="keyword">super</span> K, ? extends E&gt; mapper</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        Page&lt;K&gt; origin = PageHelper.startPage(pageNum, pageSize);</span><br><span class="line">        <span class="comment">// 必须使用函数参数，来保住查询 sql 是紧跟分页器之后执行</span></span><br><span class="line">        <span class="comment">// 否则，分页器无法捕捉查询结果集</span></span><br><span class="line">        execute.get();</span><br><span class="line">        <span class="comment">// 转换结果集类型</span></span><br><span class="line">        List&lt;E&gt; result = origin.getResult().stream().map(mapper).collect(Collectors.toList());</span><br><span class="line">        origin.clear();</span><br><span class="line">        <span class="comment">// 泛型仅作编译时类型约束，编译后统一转换为最小继承的类型，</span></span><br><span class="line">        <span class="comment">// 此处未限定，即转换为 Object，因此当确保使用时类型正确，是可以进行强转的</span></span><br><span class="line">        page = (Page&lt;E&gt;) origin;</span><br><span class="line">        page.addAll(result);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取分页信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> PageInfo&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PageInfo&lt;E&gt; <span class="title">getPageInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> get().toPageInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回分页对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> Page&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;E&gt; <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> page;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>当然，使用  <code>BeanUtils#copyProperties()</code>  复制对象的属性，或者使用反射提取其字段，都是可以实现对分页结果的类型转换。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Spring 注入 bean 失败</title>
      <link href="2020/01/03/yuque/Spring%20%E6%B3%A8%E5%85%A5%20bean%20%E5%A4%B1%E8%B4%A5/"/>
      <url>2020/01/03/yuque/Spring%20%E6%B3%A8%E5%85%A5%20bean%20%E5%A4%B1%E8%B4%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>项目启动时报错，提示无法注入 bean，需要设置在  <code>@EnableAsync</code>  或  <code>@EnableCaching</code>  上配置属性 <code>proxyTargetClass=true</code> 强行使用 CGLib 代理。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">***************************</span><br><span class="line">APPLICATION FAILED TO START</span><br><span class="line">***************************</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line"></span><br><span class="line">The bean &#39;invoiceMapper&#39; could not be injected as a &#39;com.xxx.yyyMapper&#39; because it is a JDK dynamic proxy that implements:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Action:</span><br><span class="line"></span><br><span class="line">Consider injecting the bean as one of its interfaces or forcing the use of CGLib-based proxies by setting proxyTargetClass&#x3D;true on @EnableAsync and&#x2F;or @EnableCaching.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Process finished with exit code 1</span><br></pre></td></tr></table></figure><h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>这是在注入 bean <code>invoiceMapper</code> 时使用了  <code>@Resource</code>  而不是 spring 的  <code>@Autowired</code>，前者通过名称来匹配对象，先根据注入 bean 的变量名来查找，找不到则根据类名查找，若遇到同名对象但类型不一致时，就会出现注入失败的问题。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>在注入变量时，将变量名写作类名小写形式的变量，尽量完整，若仍然有同名现象，可重新指定 bean 的名称。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> AbcxxxopqService abcxxxopqService;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Springboot 整合 Mybatis</title>
      <link href="2019/12/29/yuque/Springboot%20%E6%95%B4%E5%90%88%20Mybatis/"/>
      <url>2019/12/29/yuque/Springboot%20%E6%95%B4%E5%90%88%20Mybatis/</url>
      
        <content type="html"><![CDATA[<h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><h3 id="MapperScan"><a href="#MapperScan" class="headerlink" title="@MapperScan"></a>@MapperScan</h3><p>Springboot 的依赖注入需要通过  <code>@ComponentScan</code>  来扫描所配置的 bean，但是该组件会忽略抽象类和接口，因此 Mybatis 的 mapper 接口就需要使用其专门为 Springboot 依赖注入提供的  <code>@MapperScan</code>  扫描器。<br>通常配置扫描基础包（可以设多个）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan(basePackages = &quot;com.example.dao.mapper&quot;)</span></span><br></pre></td></tr></table></figure><p>若不配置，则会出现 bean 注入失败的问题。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.beans.factory.UnsatisfiedDependencyException</span><br><span class="line">Caused by: org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type &#39;com.example.dao.mapper.xxxMapper&#39; available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: &#123;@org.springframework.beans.factory.annotation.Autowired(required&#x3D;true), @org.springframework.beans.factory.annotation.Qualifier(value&#x3D;personMapper)&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Idea 启动报错：命令行太长</title>
      <link href="2019/12/27/yuque/Idea%20%E5%90%AF%E5%8A%A8%E6%8A%A5%E9%94%99%EF%BC%9A%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%A4%AA%E9%95%BF/"/>
      <url>2019/12/27/yuque/Idea%20%E5%90%AF%E5%8A%A8%E6%8A%A5%E9%94%99%EF%BC%9A%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%A4%AA%E9%95%BF/</url>
      
        <content type="html"><![CDATA[<h2 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h2><p>Idea：2019.03<br>Spring boot：1.5.6.Release</p><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>这是从 Git 上拉取的新项目，为修改任何配置，但启动时报错，Idea 提示如：</p><p><img src="https://cdn.nlark.com/yuque/0/2019/png/681418/1577449925140-2fd8571e-817d-409a-bcbc-4335ae69c1fd.png#align=left&display=inline&height=64&name=image.png&originHeight=64&originWidth=523&size=16121&status=done&style=shadow&width=523" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/png/681418/1577449925140-2fd8571e-817d-409a-bcbc-4335ae69c1fd.png#align=left&display=inline&height=64&name=image.png&originHeight=64&originWidth=523&size=16121&status=done&style=shadow&width=523" srcset="data:image/png;base64,666" alt="image.png"></p><p>具体报错信息如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error running &#39;StartupApplication&#39;:</span><br><span class="line">Command line is too long. Shorten command line for StartupApplication.</span><br></pre></td></tr></table></figure><h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>当启动类的路径太长，或者有很多参数，使得启动时的命令行长度过长，就会使得程序无法启动，这是大多数操作系统都有的限制。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>Idea 有以下几种方式来尝试缩短类路径：</p><ul><li>none：默认选项，Idea 不进行处理，命令行超出长度限制之后会提示用户配置缩短器；</li><li>JAR manifest：Idea 通过临时的 classpath.jar 传递长的类路径。原始类路径在 MANIFEST.MF 中定义为 classpath.jar 中的类路径属性。</li><li>修改启动配置，选择 【JAR manifest】即可。</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2019/png/681418/1577450345626-e4413407-f572-4de8-8347-ec70736aff77.png#align=left&display=inline&height=138&name=image.png&originHeight=164&originWidth=886&size=19479&status=done&style=shadow&width=746" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/png/681418/1577450345626-e4413407-f572-4de8-8347-ec70736aff77.png#align=left&display=inline&height=138&name=image.png&originHeight=164&originWidth=886&size=19479&status=done&style=shadow&width=746" srcset="data:image/png;base64,666" alt="image.png"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>打包失败：找不到符号</title>
      <link href="2019/12/26/yuque/%E6%89%93%E5%8C%85%E5%A4%B1%E8%B4%A5%EF%BC%9A%E6%89%BE%E4%B8%8D%E5%88%B0%E7%AC%A6%E5%8F%B7/"/>
      <url>2019/12/26/yuque/%E6%89%93%E5%8C%85%E5%A4%B1%E8%B4%A5%EF%BC%9A%E6%89%BE%E4%B8%8D%E5%88%B0%E7%AC%A6%E5%8F%B7/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在使用 maven 打包时报错，提示：<code>java: 找不到符号</code>  和  <code>java: 程序包 xxx 不存在</code>。而实际上，错误提示中的依赖包已正确添加，清楚缓存、重新导入等方法均已尝试且无效。</p><h2 id="分析与解决"><a href="#分析与解决" class="headerlink" title="分析与解决"></a>分析与解决</h2><h3 id="1-子项目被依赖但后编译"><a href="#1-子项目被依赖但后编译" class="headerlink" title="1. 子项目被依赖但后编译"></a>1. 子项目被依赖但后编译</h3><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>聚合项目中的子项目之间存在依赖，（假设 A 依赖 B）但是被依赖项 B 在父项目中的位置排在 A 后面，导致编译时先打包 A，而使得 A 无法加载 B 的依赖。</p><h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>调整各个模块在父项目（pom 添加 module）中的位置，将最底层的放置在最上面。</p><h3 id="2-编译插件为生成可依赖包"><a href="#2-编译插件为生成可依赖包" class="headerlink" title="2. 编译插件为生成可依赖包"></a>2. 编译插件为生成可依赖包</h3><h4 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h4><p>在多模块项目打包时父模块的 pom.xml 文件中配置了  <code>spring-boot-maven-plugin</code>  插件。<br>该插件会将 Spring 项目打包成可运行的 jar 或 war 程序，而可运行程序无法被用作依赖，因此出现找不到符号或程序包不存在问题。</p><h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h4><h5 id="1-取消在-pom-xml-中的配置"><a href="#1-取消在-pom-xml-中的配置" class="headerlink" title="1. 取消在 pom.xml 中的配置"></a>1. 取消在 pom.xml 中的配置</h5><p>直接去除掉父模块的 pom.xml 中配置的 <code>spring-boot-maven-plugin</code> 插件，使用 Idea 中 maven 插件即可进行打包。<br>缺点是无法在 pom.xml 中统一打包配置。</p><h5 id="2-修改插件配置"><a href="#2-修改插件配置" class="headerlink" title="2. 修改插件配置"></a>2. 修改插件配置</h5><p>在插件中指定配置  <code>&lt;classifier&gt;exec&lt;/classifier&gt;</code>，如此可以同时生成可依赖包和可执行程序。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>exec<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="3-更换插件"><a href="#3-更换插件" class="headerlink" title="3. 更换插件"></a>3. 更换插件</h5><p>不使用  <code>spring-boot-maven-plugin</code>，替换为  <code>maven-compiler-plugin</code> 插件。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Spring boot maven plugin 使用说明</title>
      <link href="2019/12/26/yuque/Spring%20boot%20maven%20plugin%20%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/"/>
      <url>2019/12/26/yuque/Spring%20boot%20maven%20plugin%20%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/</url>
      
        <content type="html"><![CDATA[<h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><p>maven：v3.2+<br>spring-boot-maven-plugin：2.1.9<br>Idea：2019.03</p><h2 id="插件介绍"><a href="#插件介绍" class="headerlink" title="插件介绍"></a>插件介绍</h2><p><code>spring-boot-maven-plugin</code>  插件用于提供 spring boot 在 maven 中的支持。运行用户将项目打包成独立的可执行程序。<br>该插件中已经集成了丰富的  <code>org.apache.maven</code>  依赖与插件，具体可通过打开 pom 进行查看。<br>提供了以下（指 maven 构建）目标：</p><ol><li>run：运行 spring boot 应用；</li><li>repackage：创建一个可执行的程序；</li><li>start &amp; stop：在 mvn integration-test 阶段，进行 Spring Boot 应用生命周期的管理；</li><li>build-info：生成 Actuator 使用的构建信息文件 build-info.properties；</li></ol><h2 id="目标：repackage"><a href="#目标：repackage" class="headerlink" title="目标：repackage"></a>目标：repackage</h2><h3 id="一、可选配置：指定启动类"><a href="#一、可选配置：指定启动类" class="headerlink" title="一、可选配置：指定启动类"></a>一、可选配置：指定启动类</h3><p>在不指定启动类的情况下，该插件会默认启动第一个找到的  <code>public static void main(String[] args)</code> 方法，当出现以下报错，表示找到不到启动类。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to execute goal org.springframework.boot:spring-boot-maven-plugin:2.1.9.RELEASE:repackage (repackage) on project interface: Execution repackage of goal org.springframework.boot:spring-boot-maven-plugin:2.1.9.RELEASE:repackage failed: Unable to find main class</span><br></pre></td></tr></table></figure><h4 id="1-非继承-spring-boot-starter-parent-的-pom"><a href="#1-非继承-spring-boot-starter-parent-的-pom" class="headerlink" title="1. 非继承  spring-boot-starter-parent  的 pom"></a>1. 非继承  <code>spring-boot-starter-parent</code>  的 pom</h4><p>在插件的  <code>configuration</code>  属性中，通过  <code>mainClass</code>  指定启动类。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>$&#123;start-class&#125;<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-继承-spring-boot-starter-parent-的-pom"><a href="#2-继承-spring-boot-starter-parent-的-pom" class="headerlink" title="2.  继承 spring-boot-starter-parent 的 pom"></a>2.  继承 <code>spring-boot-starter-parent</code> 的 pom</h4><p>在 pom 配置 <code>start-class</code> 属性即可。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">start-class</span>&gt;</span>com.example.startup.Application1<span class="tag">&lt;/<span class="name">start-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这是因为在 <code>spring-boot-starter-parent</code>  中，已经对其进行了默认配置。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>$&#123;start-class&#125;<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="二、可选配置：依赖排除"><a href="#二、可选配置：依赖排除" class="headerlink" title="二、可选配置：依赖排除"></a>二、可选配置：依赖排除</h3><p>用于剔除不需要打包的依赖。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 根据 groupId 以及 artifactId 排除依赖 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">excludeGroupIds</span>&gt;</span>$&#123;groupId&#125;<span class="tag">&lt;/<span class="name">excludeGroupIds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 根据 groupId 以及 artifactId 排除依赖 --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>$&#123;groupId&#125;<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>$&#123;artifactId&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="三、可选配置：分离器"><a href="#三、可选配置：分离器" class="headerlink" title="三、可选配置：分离器"></a>三、可选配置：分离器</h3><p>默认情况下，repackage 构建目标会将打包好的项目再次打包变成可直执行程序，但是这样若是在多模块项目中，模块之间互相依赖，就需要使用分离器（<code>classifier</code>  属性），将依赖的内容和可执行程序分离，这样可以在打包时分别生成可依赖包和可执行程序。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>exec<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="多模块打包问题"><a href="#多模块打包问题" class="headerlink" title="多模块打包问题"></a>多模块打包问题</h4><ul><li>如果不配置分离器，会在打包时提示：“找不到符号”或“应用程序不存在”；</li><li>若插件配置在父模块中，则对于所有模块都会进行分离，而对于 spring 项目，可执行程序只需要包含启动类（如：startup 模块）即可，所以为了避免生成多余的可执行文件，可以只在 startup 模块中配置。</li></ul><h2 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h2><h3 id="一、自定义打包名称"><a href="#一、自定义打包名称" class="headerlink" title="一、自定义打包名称"></a>一、自定义打包名称</h3><p>直接使用 maven 的标准属性  <code>fileName</code>，即可。如：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>程序名称<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="二、跳过单元测试"><a href="#二、跳过单元测试" class="headerlink" title="二、跳过单元测试"></a>二、跳过单元测试</h3><h4 id="1-配置属性"><a href="#1-配置属性" class="headerlink" title="1. 配置属性"></a>1. 配置属性</h4><p>maven 默认在打包时会进行单元测试（这与 spring boot 无关），若要跳过，则需要在 pom 中配置  <code>skipTests</code> 属性，或  <code>maven.test.skip</code>  属性。区别是前者不进行测试但会编译，而后者直接忽略编译。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 编译但不允许 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">skipTests</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skipTests</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 跳过编译 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.test.skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">maven.test.skip</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这是由于 <code>spring-boot-maven-plugin</code>  内集成了  <code>maven-surefire-plugin</code> 插件，该插件专门用来处理 maven 中的单元测试。</p><h4 id="2-使用-Idea-Maven-插件"><a href="#2-使用-Idea-Maven-插件" class="headerlink" title="2. 使用 Idea Maven 插件"></a>2. 使用 Idea Maven 插件</h4><p>选中 Idea 的 Maven 插件（通常处于有侧边栏）上的蓝色 ⚡ 按钮，即可跳过测试模块。<br><img src="https://cdn.nlark.com/yuque/0/2019/png/681418/1577445913007-37da103d-adf6-408c-b825-09af3edf874c.png#align=left&display=inline&height=59&name=image.png&originHeight=117&originWidth=362&size=38673&status=done&style=none&width=181" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/png/681418/1577445913007-37da103d-adf6-408c-b825-09af3edf874c.png#align=left&display=inline&height=59&name=image.png&originHeight=117&originWidth=362&size=38673&status=done&style=none&width=181" srcset="data:image/png;base64,666" alt="image.png"></p><h4 id="3-自定义-Maven-命令"><a href="#3-自定义-Maven-命令" class="headerlink" title="3. 自定义 Maven 命令"></a>3. 自定义 Maven 命令</h4><p><img src="https://cdn.nlark.com/yuque/0/2019/png/681418/1577447735103-30deb4a9-68e8-4c1d-98a8-6cd3056ea9e4.png#align=left&display=inline&height=423&name=image.png&originHeight=845&originWidth=1332&size=107110&status=done&style=none&width=666" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/png/681418/1577447735103-30deb4a9-68e8-4c1d-98a8-6cd3056ea9e4.png#align=left&display=inline&height=423&name=image.png&originHeight=845&originWidth=1332&size=107110&status=done&style=none&width=666" srcset="data:image/png;base64,666" alt="image.png"></p><h2 id="打包结果"><a href="#打包结果" class="headerlink" title="打包结果"></a>打包结果</h2><p>若配置了分离器，则会生成两个 jar 包文件：</p><ul><li>可执行 jar 包：*.jar；</li><li>可依赖 jar 包：*.original.jar</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Notepad ++ 配置 nginx.conf 语法高亮</title>
      <link href="2019/12/25/yuque/Notepad%20++%20%E9%85%8D%E7%BD%AE%20nginx.conf%20%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE/"/>
      <url>2019/12/25/yuque/Notepad%20++%20%E9%85%8D%E7%BD%AE%20nginx.conf%20%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE/</url>
      
        <content type="html"><![CDATA[<h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><p>版本：notepad++V7.8.2(64-bit)。<br>语言：中文。</p><h2 id="配置步骤"><a href="#配置步骤" class="headerlink" title="配置步骤"></a>配置步骤</h2><ol><li>在导航栏选择【语言】-【User Defined Language】-【Open User Defined Language folder…】，最终会打开一个用于放置用于自定义语言配置的文件夹；</li><li>下载  <a href="https://raw.github.com/dslatten/nginx_npp/master/userDefineLang_nginx.xml">userDefineLang_nginx.xml</a>，将其添加到上步打开的文件夹；</li><li>重新在导航选择【语言】-【Nginx】。</li></ol><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>为了防止连接挂掉或者 git 访问不了，下面贴出了具体的配置文件。<br>该文件内容完全获取自互联网。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">NotepadPlus</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">UserLang</span> <span class="attr">name</span>=<span class="string">&quot;Nginx&quot;</span> <span class="attr">ext</span>=<span class="string">&quot;conf&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Settings</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Global</span> <span class="attr">caseIgnored</span>=<span class="string">&quot;yes&quot;</span> <span class="attr">escapeChar</span>=<span class="string">&quot;\&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">TreatAsSymbol</span> <span class="attr">comment</span>=<span class="string">&quot;no&quot;</span> <span class="attr">commentLine</span>=<span class="string">&quot;yes&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Prefix</span> <span class="attr">words1</span>=<span class="string">&quot;yes&quot;</span> <span class="attr">words2</span>=<span class="string">&quot;yes&quot;</span> <span class="attr">words3</span>=<span class="string">&quot;no&quot;</span> <span class="attr">words4</span>=<span class="string">&quot;no&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">KeywordLists</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Keywords</span> <span class="attr">name</span>=<span class="string">&quot;Delimiters&quot;</span>&gt;</span>000000<span class="tag">&lt;/<span class="name">Keywords</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Keywords</span> <span class="attr">name</span>=<span class="string">&quot;Folder+&quot;</span>&gt;</span>&#123;<span class="tag">&lt;/<span class="name">Keywords</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Keywords</span> <span class="attr">name</span>=<span class="string">&quot;Folder-&quot;</span>&gt;</span>&#125;<span class="tag">&lt;/<span class="name">Keywords</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Keywords</span> <span class="attr">name</span>=<span class="string">&quot;Operators&quot;</span>&gt;</span>&#x27; &quot; * ; [ ] ^ ~ =<span class="tag">&lt;/<span class="name">Keywords</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Keywords</span> <span class="attr">name</span>=<span class="string">&quot;Comment&quot;</span>&gt;</span>1 1 2 2 0#<span class="tag">&lt;/<span class="name">Keywords</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Keywords</span> <span class="attr">name</span>=<span class="string">&quot;Words1&quot;</span>&gt;</span>$ CONTENT_ DOCUMENT_ GATEWAY_ HTTP_ HTTPS if_not_empty PATH_ QUERY_ REDIRECT_ REMOTE_ REQUEST_ SCGI SCRIPT_ SERVER_<span class="tag">&lt;/<span class="name">Keywords</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Keywords</span> <span class="attr">name</span>=<span class="string">&quot;Words2&quot;</span>&gt;</span>@<span class="tag">&lt;/<span class="name">Keywords</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Keywords</span> <span class="attr">name</span>=<span class="string">&quot;Words3&quot;</span>&gt;</span>http server events location include<span class="tag">&lt;/<span class="name">Keywords</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Keywords</span> <span class="attr">name</span>=<span class="string">&quot;Words4&quot;</span>&gt;</span>accept_mutex accept_mutex_delay access_log add_after_body add_before_body add_header addition_types aio alias allow ancient_browser ancient_browser_value auth auth_basic auth_basic_user_file auth_http auth_http_header auth_http_timeout autoindex autoindex_exact_size autoindex_localtime break charset charset_map charset_types chunked_transfer_encoding client_body_buffer_size client_body_in_file_only client_body_in_single_buffer client_body_temp_path client_body_timeout client_header_buffer_size client_header_timeout client_max_body_size connection_pool_size create_full_put_path daemon dav_access dav_methods debug_connection debug_points default_type deny devpoll_changes devpoll_events directio directio_alignment disable_symlinks empty_gif env epoll_events error_log error_page expires fastcgi_buffer_size fastcgi_buffers fastcgi_busy_buffers_size fastcgi_cache fastcgi_cache_bypass fastcgi_cache_key fastcgi_cache_lock fastcgi_cache_lock_timeout fastcgi_cache_methods fastcgi_cache_min_uses fastcgi_cache_path fastcgi_cache_purge fastcgi_cache_use_stale fastcgi_cache_valid fastcgi_connect_timeout fastcgi_hide_header fastcgi_ignore_client_abort fastcgi_ignore_headers fastcgi_index fastcgi_intercept_errors fastcgi_keep_conn fastcgi_max_temp_file_size fastcgi_next_upstream fastcgi_no_cache fastcgi_param fastcgi_pass fastcgi_pass_header fastcgi_read_timeout fastcgi_redirect_errors fastcgi_send_timeout fastcgi_split_path_info fastcgi_store fastcgi_store_access fastcgi_temp_file_write_size fastcgi_temp_path flv geo geoip_city geoip_country google_perftools_profiles gzip gzip_buffers gzip_comp_level gzip_disable gzip_http_version gzip_min_length gzip_proxied gzip_static gzip_types gzip_vary if if_modified_since ignore_invalid_headers image_filter image_filter_buffer image_filter_jpeg_quality image_filter_sharpen image_filter_transparency imap_capabilities imap_client_buffer include index internal ip_hash keepalive keepalive_disable keepalive_requests keepalive_timeout kqueue_changes kqueue_events large_client_header_buffers limit_conn limit_conn_log_level limit_conn_zone limit_except limit_rate limit_rate_after limit_req limit_req_log_level limit_req_zone limit_zone lingering_close lingering_time lingering_timeout listen location lock_file log_format log_format_combined log_not_found log_subrequest map map_hash_bucket_size map_hash_max_size master_process max_ranges memcached_buffer_size memcached_connect_timeout memcached_next_upstream memcached_pass memcached_read_timeout memcached_send_timeout merge_slashes min_delete_depth modern_browser modern_browser_value mp4 mp4_buffer_size mp4_max_buffer_size msie_padding msie_refresh multi_accept open_file_cache open_file_cache_errors open_file_cache_min_uses open_file_cache_valid open_log_file_cache optimize_server_names override_charset pcre_jit perl perl_modules perl_require perl_set pid pop3_auth pop3_capabilities port_in_redirect post_action postpone_output protocol proxy proxy_buffer proxy_buffer_size proxy_buffering proxy_buffers proxy_busy_buffers_size proxy_cache proxy_cache_bypass proxy_cache_key proxy_cache_lock proxy_cache_lock_timeout proxy_cache_methods proxy_cache_min_uses proxy_cache_path proxy_cache_use_stale proxy_cache_valid proxy_connect_timeout proxy_cookie_domain proxy_cookie_path proxy_headers_hash_bucket_size proxy_headers_hash_max_size proxy_hide_header proxy_http_version proxy_ignore_client_abort proxy_ignore_headers proxy_intercept_errors proxy_max_temp_file_size proxy_method proxy_next_upstream proxy_no_cache proxy_pass proxy_pass_error_message proxy_pass_header proxy_pass_request_body proxy_pass_request_headers proxy_read_timeout proxy_redirect proxy_redirect_errors proxy_send_lowat proxy_send_timeout proxy_set_body proxy_set_header proxy_ssl_session_reuse proxy_store proxy_store_access proxy_temp_file_write_size proxy_temp_path proxy_timeout proxy_upstream_fail_timeout proxy_upstream_max_fails random_index read_ahead real_ip_header recursive_error_pages request_pool_size reset_timedout_connection resolver resolver_timeout return rewrite root rtsig_overflow_events rtsig_overflow_test rtsig_overflow_threshold rtsig_signo satisfy satisfy_any secure_link_secret send_lowat send_timeout sendfile sendfile_max_chunk server server_name server_name_in_redirect server_names_hash_bucket_size server_names_hash_max_size server_tokens set set_real_ip_from smtp_auth smtp_capabilities so_keepalive source_charset split_clients ssi ssi_silent_errors ssi_types ssi_value_length ssl ssl_certificate ssl_certificate_key ssl_ciphers ssl_client_certificate ssl_crl ssl_dhparam ssl_engine ssl_prefer_server_ciphers ssl_protocols ssl_session_cache ssl_session_timeout ssl_verify_client ssl_verify_depth starttls stub_status sub_filter sub_filter_once sub_filter_types tcp_nodelay tcp_nopush timeout timer_resolution try_files types types_hash_bucket_size types_hash_max_size underscores_in_headers uninitialized_variable_warn upstream use user userid userid_domain userid_expires userid_name userid_p3p userid_path userid_service valid_referers variables_hash_bucket_size variables_hash_max_size worker_connections worker_cpu_affinity worker_priority worker_processes worker_rlimit_core worker_rlimit_nofile worker_rlimit_sigpending working_directory xclient xml_entities xslt_entities xslt_stylesheet xslt_types<span class="tag">&lt;/<span class="name">Keywords</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">KeywordLists</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Styles</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;DEFAULT&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;11&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;000000&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;1&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;FOLDEROPEN&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;12&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;0000AA&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;1&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;FOLDERCLOSE&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;13&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;0000AA&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;1&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;KEYWORD1&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;5&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;AA00AA&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;1&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;KEYWORD2&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;6&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;0000FF&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;1&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;KEYWORD3&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;7&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;0000AA&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;1&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;KEYWORD4&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;8&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;AA0000&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;1&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;COMMENT&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;1&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;000000&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;0&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;COMMENT LINE&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;2&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;AAAAAA&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;1&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;NUMBER&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;4&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;000000&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;0&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;OPERATOR&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;10&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;000000&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;0&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;DELIMINER1&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;14&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;000000&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;0&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;DELIMINER2&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;15&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;000000&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">colorStyle</span>=<span class="string">&quot;0&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">WordsStyle</span> <span class="attr">name</span>=<span class="string">&quot;DELIMINER3&quot;</span> <span class="attr">styleID</span>=<span class="string">&quot;16&quot;</span> <span class="attr">fgColor</span>=<span class="string">&quot;000000&quot;</span> <span class="attr">bgColor</span>=<span class="string">&quot;FFFFFF&quot;</span> <span class="attr">fontName</span>=<span class="string">&quot;&quot;</span> <span class="attr">fontStyle</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Styles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">UserLang</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">NotepadPlus</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis 插入 DATE 只有年月日</title>
      <link href="2019/12/23/yuque/Mybatis%20%E6%8F%92%E5%85%A5%20DATE%20%E5%8F%AA%E6%9C%89%E5%B9%B4%E6%9C%88%E6%97%A5/"/>
      <url>2019/12/23/yuque/Mybatis%20%E6%8F%92%E5%85%A5%20DATE%20%E5%8F%AA%E6%9C%89%E5%B9%B4%E6%9C%88%E6%97%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在使用 Insert 插入数据到 Oracle 中时，对于  <code>java.util.Date</code>  类型数据，只会记录年月日，丢失了时分秒。</p><h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>在插入数据时指定了  <code>Date</code>  类型的 JDBC 类型为  <code>DATE</code>，其在向 Oracle 插入数据时，会默认调用  <code>DateOnlyTypeHandler</code>  处理  <code>DATE</code>  类型的日期，转化 Java 类型到 Sql 格式。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;updateTime,jdbcType=DATE&#125;</span><br></pre></td></tr></table></figure><p>Mybatis 通过  <code>TypeHandlerRegistry</code>  注册 Java 类型与 JDBC 类型之间的映射关系：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java 类型为 Date.class，不指定 jdbc 类型，则默认使用 DateTypeHandler</span></span><br><span class="line">register(Date.class, <span class="keyword">new</span> DateTypeHandler());</span><br><span class="line"><span class="comment">// java 类型为 Date.class，jdbc 类型为 DATE，则默认使用 DateOnlyTypeHandler</span></span><br><span class="line">register(Date.class, JdbcType.DATE, <span class="keyword">new</span> DateOnlyTypeHandler());</span><br><span class="line"><span class="comment">// java 类型为 Date.class，jdbc 类型为 TIME，则默认使用 DateOnlyTypeHandler</span></span><br><span class="line">register(Date.class, JdbcType.TIME, <span class="keyword">new</span> TimeOnlyTypeHandler());</span><br><span class="line"><span class="comment">// 不指定 java 类型，jdbc 类型为 TIMESTAMP，则默认使用 DateTypeHandler</span></span><br><span class="line">register(JdbcType.TIMESTAMP, <span class="keyword">new</span> DateTypeHandler());</span><br><span class="line"><span class="comment">// 不指定 java 类型，jdbc 类型为 DATE，则默认使用 DateOnlyTypeHandler</span></span><br><span class="line">register(JdbcType.DATE, <span class="keyword">new</span> DateOnlyTypeHandler());</span><br><span class="line"><span class="comment">// 不指定 java 类型，jdbc 类型为 TIME，则默认使用 DateOnlyTypeHandler</span></span><br><span class="line">register(JdbcType.TIME, <span class="keyword">new</span> TimeOnlyTypeHandler());</span><br></pre></td></tr></table></figure><p>在  <code>DateOnlyTypeHandler</code> 中，使用了  <code>java.sql.Date</code>  设置时间，该日期格式只会精确到年月日。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNonNullParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, Date parameter, JdbcType jdbcType)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    ps.setDate(i, <span class="keyword">new</span> java.sql.Date((parameter.getTime())));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>参考  <code>TypeHandlerRegistry</code>  中的映射关系可以得出以下解决方案：</p><ol><li>不指定 JDBC 类型；</li><li>指定 JDBC 类型为  <code>TIMESTAMP</code>；</li><li>指定  typeHandler 为  <code>org.apache.ibatis.type.DateTypeHandler</code>（需要写全处理器的限定名），且指定处理优先级最高。</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Spring 服务端推送（SSE）</title>
      <link href="2019/12/20/yuque/Spring%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A8%E9%80%81%EF%BC%88SSE%EF%BC%89/"/>
      <url>2019/12/20/yuque/Spring%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A8%E9%80%81%EF%BC%88SSE%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是-SSE"><a href="#什么是-SSE" class="headerlink" title="什么是 SSE"></a>什么是 SSE</h2><p>SSE 全程 server-sent event，即服务端推送事件，是服务端到客户端的单向半双工通信技术，适用于服务器向客户端推送实时信息，但是传输量小，且只支持 UTF-8 的编码 key-value 格式的文本数据流，不能传输二进制流。</p><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><p>使用 Spring 提供的  <code>SseEmitter</code>  封装类，每隔 2s 向客户端推送一次数据，共推送 5 次。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/emitter&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> SseEmitter <span class="title">sseEmitter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       SseEmitter sseEmitter = <span class="keyword">new</span> SseEmitter(<span class="number">0L</span>);</span><br><span class="line">       taskExecutor.execute(() -&gt; &#123;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   sseEmitter.send(<span class="string">&quot;第&quot;</span> + i + <span class="string">&quot;次发送&quot;</span>);</span><br><span class="line">                   log.info(<span class="string">&quot;第 &#123;&#125; 次发送&quot;</span>, i);</span><br><span class="line">                   Thread.sleep(<span class="number">1000</span> * <span class="number">2</span>);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;</span><br><span class="line">                   log.error(<span class="string">&quot;发生异常了: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">                   sseEmitter.completeWithError(e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           sseEmitter.complete();</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">return</span> sseEmitter;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="访问效果"><a href="#访问效果" class="headerlink" title="访问效果"></a>访问效果</h2><p><img src="https://cdn.nlark.com/yuque/0/2019/gif/681418/1576828554373-b0409ba4-ea52-4f79-905b-4d37a41d5f7e.gif#align=left&display=inline&height=242&name=sse-emitter.gif&originHeight=242&originWidth=698&size=20483&status=done&style=shadow&width=698" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/gif/681418/1576828554373-b0409ba4-ea52-4f79-905b-4d37a41d5f7e.gif#align=left&display=inline&height=242&name=sse-emitter.gif&originHeight=242&originWidth=698&size=20483&status=done&style=shadow&width=698" srcset="data:image/png;base64,666" alt="sse-emitter.gif"></p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol><li>接口中直接返回  <code>SseEmitter</code> 对象，推送事件需要在异步线程中执行。</li><li>若使用 Nginx 代理接口，需要配置  <code>proxy_buffering off;</code>  关闭代理的缓冲流，使得后端推送的数据可以实时刷新。</li><li>SSE 是 HTTP 长连接，需要在连接超时之前推送信息，若无有效推送，可以设置一个标记字符作为维持连接的心跳支持。</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Spring 自定义线程池</title>
      <link href="2019/12/19/yuque/Spring%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
      <url>2019/12/19/yuque/Spring%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>Spring 本身的线程池很简单，每次用到线程都会开辟一个新的线程，效率不高，因此创建一个健壮的线程池，尽量重用现用线程，减少对象创建、消亡的开销是很有必要的。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;task.pool&quot;)</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskExecutorConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 核心线程池大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> corePoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最大线程池大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxPoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活跃时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> keepAliveSeconds;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 队列容量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> queueCapacity;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">taskExecutorPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 标记此处-1，下方会使用匿名类对原生线程池进行拓展</span></span><br><span class="line">        ThreadPoolTaskExecutor executor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        executor.setCorePoolSize(corePoolSize);</span><br><span class="line">        executor.setMaxPoolSize(maxPoolSize);</span><br><span class="line">        executor.setKeepAliveSeconds(keepAliveSeconds);</span><br><span class="line">        executor.setQueueCapacity(queueCapacity);</span><br><span class="line"><span class="comment">//        当线程池达到最大时，不再开启新线程，使用调用者所在线程执行</span></span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="1、添加-Spring-配置"><a href="#1、添加-Spring-配置" class="headerlink" title="1、添加 Spring 配置"></a>1、添加 Spring 配置</h3><p>使用类配置注解，并设置前缀，这样在对象的成员变量会自动注入 spring 的配置文件中的键值对。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;executor.pool&quot;)</span></span><br><span class="line"><span class="meta">@Setter</span></span><br></pre></td></tr></table></figure><p>对应的配置文件，当然需要使用 setter 方法进行赋值：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">executor:</span></span><br><span class="line">  <span class="attr">pool:</span></span><br><span class="line">    <span class="attr">core-pool-size:</span> <span class="number">20</span></span><br><span class="line">    <span class="attr">max-pool-size:</span> <span class="number">40</span></span><br><span class="line">    <span class="attr">keep-alive-seconds:</span> <span class="number">300</span></span><br><span class="line">    <span class="attr">queue-capacity:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure><p>需要的依赖：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h3 id="2、开启异步支持"><a href="#2、开启异步支持" class="headerlink" title="2、开启异步支持"></a>2、开启异步支持</h3><p>使用 <code>@EnableAsync</code>  注解，也可以在启动类上添加。全局只要一个即可开启异步。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAsync</span></span><br></pre></td></tr></table></figure><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>交由 Spring 托管，直接使用依赖注入，注入名称默认为  <code>@Bean</code>  标记的方法名。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource(name = &quot;taskExecutorPool&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> ThreadPoolTaskExecutor taskExecutor;</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="meta">@Async(&quot;taskExecutorPool&quot;)</span></span><br></pre></td></tr></table></figure><h2 id="拓展配置"><a href="#拓展配置" class="headerlink" title="拓展配置"></a>拓展配置</h2><p>当前线程在执行或提交时，不会显示的打印出线程池状态，为了实现这一点，此处通过匿名子类的方式拓展 <code>spring#ThreadPoolTaskExecutor</code>。自然，单独实现子类也可以达成效果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此处代码对应上方标记-1</span></span><br><span class="line">ThreadPoolTaskExecutor executor = <span class="keyword">new</span> ThreadPoolTaskExecutor() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showThreadPoolInfo</span><span class="params">(String prefix)</span></span>&#123;</span><br><span class="line">                ThreadPoolExecutor threadPoolExecutor = getThreadPoolExecutor();</span><br><span class="line">                log.info(<span class="string">&quot;&#123;&#125;&#123;&#125;,线程数: [&#123;&#125;], 已完成线程数: [&#123;&#125;], 活跃线程数: [&#123;&#125;], 队列大小: [&#123;&#125;]&quot;</span>,</span><br><span class="line">                        <span class="keyword">this</span>.getThreadNamePrefix(),</span><br><span class="line">                        prefix,</span><br><span class="line">                        threadPoolExecutor.getTaskCount(),</span><br><span class="line">                        threadPoolExecutor.getCompletedTaskCount(),</span><br><span class="line">                        threadPoolExecutor.getActiveCount(),</span><br><span class="line">                        threadPoolExecutor.getQueue().size());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">                showThreadPoolInfo(<span class="string">&quot;执行线程&quot;</span>);</span><br><span class="line">                <span class="keyword">super</span>.execute(task);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 该方法可忽略，源码中并未使用 startTimeout 参数，直接调用 execute(task)</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable task, <span class="keyword">long</span> startTimeout)</span> </span>&#123;</span><br><span class="line">                showThreadPoolInfo(<span class="string">&quot;执行线程&quot;</span>);</span><br><span class="line">                <span class="keyword">super</span>.execute(task, startTimeout);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</span><br><span class="line">                showThreadPoolInfo(<span class="string">&quot;提交线程&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.submit(task);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span> </span>&#123;</span><br><span class="line">                showThreadPoolInfo(<span class="string">&quot;提交线程&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.submit(task);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ListenableFuture&lt;?&gt; submitListenable(Runnable task) &#123;</span><br><span class="line">                showThreadPoolInfo(<span class="string">&quot;提交监听&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.submitListenable(task);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> &lt;T&gt; <span class="function">ListenableFuture&lt;T&gt; <span class="title">submitListenable</span><span class="params">(Callable&lt;T&gt; task)</span> </span>&#123;</span><br><span class="line">                showThreadPoolInfo(<span class="string">&quot;提交监听&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.submitListenable(task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Async 注解 - 异步调用测试</title>
      <link href="2019/12/18/yuque/Async%20%E6%B3%A8%E8%A7%A3%20-%20%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E6%B5%8B%E8%AF%95/"/>
      <url>2019/12/18/yuque/Async%20%E6%B3%A8%E8%A7%A3%20-%20%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是异步调用"><a href="#什么是异步调用" class="headerlink" title="什么是异步调用"></a>什么是异步调用</h2><p>程序将启用异步调用的操作交由独立线程执行，跳过等待异步调用返回结果，继续往下执行。</p><h2 id="如何启用异步调用"><a href="#如何启用异步调用" class="headerlink" title="如何启用异步调用"></a>如何启用异步调用</h2><ol><li>在 Spring 的启动类（或配置类）上添加  <code>@EnableAsync</code>  开启异步操作支持；</li><li>在需要执行异步的方法上添加  <code>@Async</code>  注解，标记其为异步方法；</li></ol><h2 id="如何处理异步方法的返回结果"><a href="#如何处理异步方法的返回结果" class="headerlink" title="如何处理异步方法的返回结果"></a>如何处理异步方法的返回结果</h2><ol><li>在异步方法中使用 <code>Future</code> 封装返回值，表示其为异步结果，但实际返回时需要使用 <code>AsyncResult</code>  类型，<code>Future</code> 是其顶级接口；</li><li>在异步调用时，当主程序需要调用异步结果时，必须进行自我阻塞（通常使用循环等待异步操作），直到异步方法完成，否则异步结果会丢失；</li></ol><h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><ol><li>配置启动类，开启异步支持。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 忽略其他注解</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>创建一个异步方法，该方法接收字符串与秒数，执行后会在睡眠指定时间之后返回字符串。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AsyncService.class</span></span><br><span class="line"><span class="meta">@Async</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">stringFuture</span><span class="params">(String str, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           Thread.sleep(time * <span class="number">1000</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;&gt;(str);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>创建一个测试方法，该方法调用了上步创建的异步方法，并指定其睡眠 15s 后返回 “hello future” 字符串，且会在等待异步结果时每秒打印一次等待时间。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AsyncServiceTest.class</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">futureString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">long</span> begin = System.currentTimeMillis();</span><br><span class="line">       Future&lt;String&gt; future = asyncService.stringFuture(<span class="string">&quot;hello future&quot;</span>, <span class="number">15</span>);</span><br><span class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (future.isDone()) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   log.info(<span class="string">&quot;future result: &#123;&#125;&quot;</span>, future.get());</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               log.info(<span class="string">&quot;已用时：&#123;&#125;ms&quot;</span>, System.currentTimeMillis() - begin);</span><br><span class="line">               Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       log.info(<span class="string">&quot;futureString 共耗时：&#123;&#125;ms&quot;</span>, System.currentTimeMillis() - begin);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>结果如预期一致，异步结果在等待 15s 后成功打印字符串，并每隔一秒打印等待时间。</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：8ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：1010ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：2010ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：3011ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：4011ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：5012ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：6013ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：7013ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：8013ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：9014ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：10014ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：11015ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：12015ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：13015ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : 已用时：14016ms</span><br><span class="line">c.example.test.service.AsyncServiceTest  : future result: hello future</span><br><span class="line">c.example.test.service.AsyncServiceTest  : futureString 共耗时：15017ms</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="5"><li>取消启动类上的  <code>@EnableAsync</code>  注解，对比执行结果。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现主程序中并未在每秒间隔时间中打印等待时间，即在执行循环时，已经等待 15s，证明没有启用异步调用的程序被阻塞了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c.example.test.service.AsyncServiceTest  : future result: hello future</span><br><span class="line">c.example.test.service.AsyncServiceTest  : futureString 共耗时：15003ms</span><br></pre></td></tr></table></figure><ol start="6"><li>测试时不使用循环等待异步结果。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AsyncServiceTest.class</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">futureStringWithoutLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       log.info(<span class="string">&quot;无循环接收 future 结果测试&quot;</span>);</span><br><span class="line">       <span class="keyword">long</span> begin = System.currentTimeMillis();</span><br><span class="line">       Future&lt;String&gt; future = asyncService.stringFuture(<span class="string">&quot;hello future&quot;</span>, <span class="number">15</span>);</span><br><span class="line">       <span class="keyword">if</span> (future.isDone()) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               log.info(<span class="string">&quot;future result: &#123;&#125;&quot;</span>, future.get());</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       log.info(<span class="string">&quot;futureString 共耗时：&#123;&#125;ms&quot;</span>, System.currentTimeMillis() - begin);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>主程序执行时直接跳过异步方法，且未能接收到异步结果，证明异步方法尽管可以使得程序并行操作，但是在最后接收结果时仍需使用循环进行自我阻塞等待异步结果，执行总时长应为 <code>Max(主程序耗时，异步方法耗时)</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c.example.test.service.AsyncServiceTest  : 无循环接收 future 结果测试</span><br><span class="line">c.example.test.service.AsyncServiceTest  : futureString 共耗时：41ms</span><br></pre></td></tr></table></figure><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul><li>此处使用的 <code>Future</code>  接口接收异步结果，该是异步阻塞接口；</li><li>建议不使用无返回值异步方法，否则内部产生异常不会被感知；</li><li><code>@Async</code>  可以通过注解属性指定线程池，默认使用 <code>SimpleAsyncTaskExecutor</code>；</li></ul><h2 id="专有配置类"><a href="#专有配置类" class="headerlink" title="专有配置类"></a>专有配置类</h2><p>通过实现  <code>AsyncConfigurer</code>  接口可以指定  <code>@Async</code>  的默认线程池，即无需通过注解属性显示指定。<br>此处通过直接注入自定义线程池进行配置  <code>@Async</code>，亦可在该配置类中直接创建线程池，即  <code>new ThreadPoolTaskExecutor()</code> ，并载入配置信息，可参考《<a href="https://www.yuque.com/daiwenzh5/fqxmw5/ub0qx4">Spring 自定义线程池</a>》。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTaskExecutorConfig</span> <span class="keyword">implements</span> <span class="title">AsyncConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;taskExecutorPool&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolTaskExecutor executor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Executor <span class="title">getAsyncExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AsyncUncaughtExceptionHandler <span class="title">getAsyncUncaughtExceptionHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (throwable, method, objects) -&gt; log.error(<span class="string">&quot;异常信息: &#123;&#125;, 异常方法: &#123;&#125;&quot;</span>, throwable.getMessage(), method.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>学习计划</title>
      <link href="2019/12/18/yuque/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/"/>
      <url>2019/12/18/yuque/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/</url>
      
        <content type="html"><![CDATA[<h3 id="学习重点"><a href="#学习重点" class="headerlink" title="学习重点"></a>学习重点</h3><p><img src="https://cdn.nlark.com/yuque/0/2019/png/215718/1567514692551-49e3e165-3fab-4dd7-895e-4b7e9a57ec24.png#align=left&display=inline&height=25&name=image.png&originHeight=25&originWidth=25&size=1539&status=done&width=25" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/png/215718/1567514692551-49e3e165-3fab-4dd7-895e-4b7e9a57ec24.png#align=left&display=inline&height=25&name=image.png&originHeight=25&originWidth=25&size=1539&status=done&width=25" srcset="data:image/png;base64,666" alt="image.png">插入「脑图」并进行编辑<br><img src="https://cdn.nlark.com/yuque/0/2019/png/215718/1567567603546-29ab2829-0200-4200-94a0-c2757113ac2c.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/png/215718/1567567603546-29ab2829-0200-4200-94a0-c2757113ac2c.png" srcset="data:image/png;base64,666"></p><h3 id="学习资源"><a href="#学习资源" class="headerlink" title="学习资源"></a>学习资源</h3><h4 id="课堂-PPT"><a href="#课堂-PPT" class="headerlink" title="课堂 PPT"></a>课堂 PPT</h4><p><img src="https://cdn.nlark.com/yuque/0/2019/png/215718/1567514692551-49e3e165-3fab-4dd7-895e-4b7e9a57ec24.png#align=left&display=inline&height=25&name=image.png&originHeight=25&originWidth=25&size=1539&status=done&width=25" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/png/215718/1567514692551-49e3e165-3fab-4dd7-895e-4b7e9a57ec24.png#align=left&display=inline&height=25&name=image.png&originHeight=25&originWidth=25&size=1539&status=done&width=25" srcset="data:image/png;base64,666" alt="image.png">嵌入「本地文件」，在文档中可预览此文件：</p><blockquote><p>脑图（XMind、Mind Manager、Mind Node）<br>设计文件（PhotoShop、Sketch、Axure)<br>办公文件（PDF、PPT、Word、Excel、Keynote、Pages、Numbers）</p></blockquote><h4 id="教学视频"><a href="#教学视频" class="headerlink" title="教学视频"></a>教学视频</h4><p><img src="https://cdn.nlark.com/yuque/0/2019/png/215718/1567514692551-49e3e165-3fab-4dd7-895e-4b7e9a57ec24.png#align=left&display=inline&height=25&name=image.png&originHeight=25&originWidth=25&size=1539&status=done&width=25" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/png/215718/1567514692551-49e3e165-3fab-4dd7-895e-4b7e9a57ec24.png#align=left&display=inline&height=25&name=image.png&originHeight=25&originWidth=25&size=1539&status=done&width=25" srcset="data:image/png;base64,666" alt="image.png">嵌入「本地视频」或「在线视频」，如优酷及 Bilibili 视频：</p><iframe src="https://player.bilibili.com/player.html?aid=55895675" frameborder="no" allowfullscreen="true"></iframe><h4 id="阅读材料"><a href="#阅读材料" class="headerlink" title="阅读材料"></a>阅读材料</h4><p><img src="https://cdn.nlark.com/yuque/0/2019/png/215718/1567514692551-49e3e165-3fab-4dd7-895e-4b7e9a57ec24.png#align=left&display=inline&height=25&name=image.png&originHeight=25&originWidth=25&size=1539&status=done&width=25" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/png/215718/1567514692551-49e3e165-3fab-4dd7-895e-4b7e9a57ec24.png#align=left&display=inline&height=25&name=image.png&originHeight=25&originWidth=25&size=1539&status=done&width=25" srcset="data:image/png;base64,666" alt="image.png">插入「附件」</p><p><a href="https://www.yuque.com/attachments/yuque/0/2019/pdf/105911/1570525820813-a79b3d0f-38cb-4a73-a2bb-ce8f091f2049.pdf?_lake_card=%7B%22uid%22:%22rc-upload-1567514495288-26%22,%22src%22:%22https://www.yuque.com/attachments/yuque/0/2019/pdf/105911/1570525820813-a79b3d0f-38cb-4a73-a2bb-ce8f091f2049.pdf%22,%22name%22:%22%E7%A4%BA%E4%BE%8BPDF.pdf%22,%22size%22:16189,%22type%22:%22application/pdf%22,%22ext%22:%22pdf%22,%22progress%22:%7B%22percent%22:0%7D,%22status%22:%22done%22,%22percent%22:0,%22id%22:%22wTSXR%22,%22refSrc%22:%22https://www.yuque.com/attachments/yuque/0/2019/pdf/105911/1569247460410-d74712f0-05ce-474b-b914-d76439248860.pdf%22,%22card%22:%22file%22%7D">示例 PDF.pdf</a></p><h3 id="学习计划"><a href="#学习计划" class="headerlink" title="学习计划"></a>学习计划</h3><p><img src="https://cdn.nlark.com/yuque/0/2019/png/215718/1567514692551-49e3e165-3fab-4dd7-895e-4b7e9a57ec24.png#align=left&display=inline&height=25&name=image.png&originHeight=25&originWidth=25&size=1539&status=done&width=25" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/png/215718/1567514692551-49e3e165-3fab-4dd7-895e-4b7e9a57ec24.png#align=left&display=inline&height=25&name=image.png&originHeight=25&originWidth=25&size=1539&status=done&width=25" srcset="data:image/png;base64,666" alt="image.png">插入「表格」，可以在表格框里插入对应的图片、附件、状态</p><table><thead><tr><th align="center"><strong>书名</strong></th><th align="center"><strong>章节</strong></th><th align="center"><strong>计划阅读时间</strong></th><th align="center"><strong>进程</strong></th></tr></thead><tbody><tr><td align="center">《基础有机化学》</td><td align="center">第三章</td><td align="center">2h</td><td align="center">已完成</td></tr><tr><td align="center">《无机化学》</td><td align="center">第一章</td><td align="center">1h</td><td align="center">进行中</td></tr><tr><td align="center">《物理化学》</td><td align="center">第四章</td><td align="center">1h</td><td align="center">未开始</td></tr><tr><td align="center"><img src="https://cdn.nlark.com/yuque/0/2019/jpeg/105911/1571983625842-9d347225-731e-41e0-ab51-91a232a2db72.jpeg#align=left&display=inline&height=3264&name=alex-knight-2EJCSULRwC8-unsplash.jpg&originHeight=3264&originWidth=4896&size=1555309&status=done&width=4896" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/jpeg/105911/1571983625842-9d347225-731e-41e0-ab51-91a232a2db72.jpeg#align=left&display=inline&height=3264&name=alex-knight-2EJCSULRwC8-unsplash.jpg&originHeight=3264&originWidth=4896&size=1555309&status=done&width=4896" srcset="data:image/png;base64,666" alt="alex-knight-2EJCSULRwC8-unsplash.jpg"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr></tbody></table>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>读书笔记</title>
      <link href="2019/12/18/yuque/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
      <url>2019/12/18/yuque/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h4 id=""><a href="#" class="headerlink" title=""></a><img src="https://cdn.nlark.com/yuque/0/2019/png/215718/1567507815646-d739438a-8ffd-4107-9d87-130e2104446a.png#align=left&display=inline&height=232&name=image.png&originHeight=1553&originWidth=1080&size=367334&status=done&width=161" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2019/png/215718/1567507815646-d739438a-8ffd-4107-9d87-130e2104446a.png#align=left&display=inline&height=232&name=image.png&originHeight=1553&originWidth=1080&size=367334&status=done&width=161" srcset="data:image/png;base64,666" alt="image.png"></h4><p><em>插入封面图片，点击图片，设置图片大小</em></p><h4 id="关于本书"><a href="#关于本书" class="headerlink" title="关于本书"></a>关于本书</h4><p>插入「表格」</p><table><thead><tr><th><strong>书名</strong></th><th><a href="https://book.douban.com/subject/25944034/">《菊次郎与佐纪》</a></th><th><strong>作者</strong></th><th>北野武日本</th></tr></thead><tbody><tr><td><strong>出版社</strong></td><td>译林出版社</td><td><strong>阅读日期</strong></td><td>2019 年 2 月</td></tr><tr><td><strong>豆瓣评分</strong></td><td>8.1</td><td><strong>我的评分</strong></td><td>☆☆☆☆</td></tr></tbody></table><h4 id="内容简介"><a href="#内容简介" class="headerlink" title="内容简介"></a>内容简介</h4><p>在此处输入文本<br>你将读到的是北野武的出身、父母、兄弟和家庭的故事。<br>但请放心，这绝非一个自我感觉良好的人写的那种“优良课外读物”。<br>相反，北野武用搞笑到甚至刻薄方式描绘这些人和事，让我们在笑与泪的交织中，看到真情和真实，看到那么多情、柔软的心。</p><h4 id="书摘"><a href="#书摘" class="headerlink" title="书摘"></a>书摘</h4><p>在此处输入文本</p><ul><li>你将读到的是北野武的出身、父母、兄弟和家庭的故事。</li><li>但请放心，这绝非一个自我感觉良好的人写的那种“优良课外读物”。很喜欢这句 ← 方便打标签的状态卡片</li><li>相反，北野武用搞笑到甚至刻薄方式描绘这些人和事，让我们在笑与泪的交织中，看到真情和真实，看到那么多情、柔软的心。</li></ul><h4 id="读后感"><a href="#读后感" class="headerlink" title="读后感"></a>读后感</h4><p>在此处输入文本</p><ul><li>你将读到的是北野武的出身、父母、兄弟和家庭的故事。</li><li>但请放心，这绝非一个自我感觉良好的人写的那种“优良课外读物”。</li><li>相反，北野武用搞笑到甚至刻薄方式描绘这些人和事，让我们在笑与泪的交织中，看到真情和真实，看到那么多情、柔软的心。</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Nginx 转发接口导致超时解决方案</title>
      <link href="2019/12/17/yuque/Nginx%20%E8%BD%AC%E5%8F%91%E6%8E%A5%E5%8F%A3%E5%AF%BC%E8%87%B4%E8%B6%85%E6%97%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
      <url>2019/12/17/yuque/Nginx%20%E8%BD%AC%E5%8F%91%E6%8E%A5%E5%8F%A3%E5%AF%BC%E8%87%B4%E8%B6%85%E6%97%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>生产环境在导出 Excel 时出现连接超时，将数据复制到测试环境，使用本地项目测试时，能够顺利执行。</p><h2 id="环境差异"><a href="#环境差异" class="headerlink" title="环境差异"></a>环境差异</h2><p>生产环境使用 Nginx 代理接口，而本地项目没有使用，将本地启用 Nginx 之后，同样出现超时现象。</p><h2 id="原因总结"><a href="#原因总结" class="headerlink" title="原因总结"></a>原因总结</h2><p>Nginx 限制了转发 Http 请求的连接时间。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="一、修改-Nginx-转发模块的超时时间"><a href="#一、修改-Nginx-转发模块的超时时间" class="headerlink" title="一、修改 Nginx 转发模块的超时时间"></a>一、修改 Nginx 转发模块的超时时间</h3><p>在 Nginx 对应的转发模块下添加 <code>proxy_read_timeout</code>  属性。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_read_timeout</span> <span class="number">300</span>;</span><br><span class="line"><span class="comment">### 其粒度可以控制在 location、server、http 中，优先级逐次减小，即最外层优先级最低</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">proxy_read_timeout</span> <span class="number">10</span>;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_read_timeout</span> <span class="number">60</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">      <span class="attribute">proxy_read_timeout</span> <span class="number">300</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="属性说明"><a href="#属性说明" class="headerlink" title="属性说明"></a>属性说明</h4><p>在实际表现中，<code>proxy_read_timeout</code>  的时间值为实际超时时间的一半，即假定转发模块的读取超时时间为 60s，使用 Postman 访问时的超时时间为 120s 左右。</p><h4 id="相关属性"><a href="#相关属性" class="headerlink" title="相关属性"></a>相关属性</h4><ul><li><code>proxy_connect_timeout</code> : 后端服务器连接的超时时间，发起握手等候响应超时时间；</li><li><code>proxy_read_timeout</code>: 连接成功后，等候后端服务器响应时间，其实已经进入后端的排队之中等候处理（也可以说是后端服务器处理请求的时间，后端的耗时操作主要占用此时期）；</li><li><code>proxy_send_timeout</code> : 后端服务器数据回传时间，在规定时间之内后端服务器必须传完所有的数据；</li></ul><h3 id="二、后端采用异步任务"><a href="#二、后端采用异步任务" class="headerlink" title="二、后端采用异步任务"></a>二、后端采用异步任务</h3><p>将耗时操作放置在  <code>@Async</code>  标记的方法中，返回  <code>Future</code>  包裹的处理结果，一旦其处理完成，则使用 <code>SSE</code>  推送到前端。</p><h4 id="问题：无法避免配置超时时间属性"><a href="#问题：无法避免配置超时时间属性" class="headerlink" title="问题：无法避免配置超时时间属性"></a>问题：无法避免配置超时时间属性</h4><p>需要注意的是，在使用  <code>SSE</code>  推送时，必须定期返回响应，若超过 Nginx 的最大读取超时时间（<code>proxy_read_timeout</code> ）仍无响应，则依然会出现超时现象。</p><h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>只需在超时之前返回心态标记维持连接，前端忽略标记字符即可。</p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
