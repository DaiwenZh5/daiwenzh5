<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Z&#39;s blog</title>
  
  
  <link href="http://daiwenzh5.github.io/atom.xml" rel="self"/>
  
  <link href="http://daiwenzh5.github.io/"/>
  <updated>2022-04-17T03:31:42.050Z</updated>
  <id>http://daiwenzh5.github.io/</id>
  
  <author>
    <name>daiwenzh5</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>解决 MockMvc 中文乱码</title>
    <link href="http://daiwenzh5.github.io/2022/04/17/yuque/%E8%A7%A3%E5%86%B3%20MockMvc%20%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81/"/>
    <id>http://daiwenzh5.github.io/2022/04/17/yuque/%E8%A7%A3%E5%86%B3%20MockMvc%20%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81/</id>
    <published>2022-04-16T17:12:21.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在 Junit 使用 MockMvc 对 Controller 层进行单元测试时，发现控制台打印的响应结果中文出现乱码，导致断言异常（预期值与结果不符）。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>这是由于 spring 默认字符集为 ISO-8859-1，中文无法被正确的识别。因此只要能够重新设置支持中文的字符集即可解决该问题。</p><h3 id="修改-Servlet-配置"><a href="#修改-Servlet-配置" class="headerlink" title="修改 Servlet 配置"></a>修改 Servlet 配置</h3><p>虽然使用 spring boot 预留的配置可以轻松的解决问题，但是粒度太粗了，一旦设置全局生效，唯一值得庆幸的是，此处需要设置的是字符集，大部分场景下都会使用 UFT-8。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">encoding:</span></span><br><span class="line">      <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 确保响应值被重置字符集</span></span><br><span class="line">      <span class="attr">force-response:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="重写输出方法"><a href="#重写输出方法" class="headerlink" title="重写输出方法"></a>重写输出方法</h3><p>不要使用 <code>MockMvcResultHandlers.print()</code>方法输出响应结果，重新实现 <code>ResultHandler</code>接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForceCharsetPrintingResultHandler</span> <span class="keyword">extends</span> <span class="title">PrintingResultHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CHARSET = <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * UTF-8 字符集的结果打印处理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ForceCharsetPrintingResultHandler UTF_8PrintingResultHandler = <span class="keyword">new</span> ForceCharsetPrintingResultHandler(DEFAULT_CHARSET);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String defaultCharset;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ForceCharsetPrintingResultHandler</span><span class="params">(String defaultCharset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> ResultValuePrinter() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printHeading</span><span class="params">(<span class="meta">@NotNull</span> String heading)</span> </span>&#123;</span><br><span class="line">                System.out.println();</span><br><span class="line">                System.out.printf(<span class="string">&quot;%s:%n&quot;</span>, heading);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printValue</span><span class="params">(<span class="meta">@NotNull</span> String label, Object value)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.getClass().isArray()) &#123;</span><br><span class="line">                    value = CollectionUtils.arrayToList(value);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.printf(<span class="string">&quot;%17s = %s%n&quot;</span>, label, value);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">this</span>.defaultCharset = defaultCharset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">printRequest</span><span class="params">(MockHttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        request.setCharacterEncoding(defaultCharset);</span><br><span class="line">        <span class="keyword">super</span>.printRequest(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">printResponse</span><span class="params">(MockHttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        response.setCharacterEncoding(defaultCharset);</span><br><span class="line">        <span class="keyword">super</span>.printResponse(response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mockMvc.perform()</span><br><span class="line">    <span class="comment">// .andDo(MockMvcResultHandlers.print())</span></span><br><span class="line">    .andDo(ForceCharsetPrintingResultHandler.UTF_8PrintingResultHandler)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;在 Junit 使用 MockMvc 对 Controller 层进行单元测试时，发现控制台打印的响应结果中文出现乱码，导致断言异常（预期值与结果不符）。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/"/>
    
    <category term="Junit" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/Junit/"/>
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/tags/Spring-Boot/"/>
    
    <category term="Junit" scheme="http://daiwenzh5.github.io/tags/Junit/"/>
    
    <category term="MockMvc" scheme="http://daiwenzh5.github.io/tags/MockMvc/"/>
    
    <category term="乱码" scheme="http://daiwenzh5.github.io/tags/%E4%B9%B1%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>非空或校验器</title>
    <link href="http://daiwenzh5.github.io/2022/04/17/yuque/%E9%9D%9E%E7%A9%BA%E6%88%96%E6%A0%A1%E9%AA%8C%E5%99%A8/"/>
    <id>http://daiwenzh5.github.io/2022/04/17/yuque/%E9%9D%9E%E7%A9%BA%E6%88%96%E6%A0%A1%E9%AA%8C%E5%99%A8/</id>
    <published>2022-04-16T16:45:50.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>通过自定义注解，拓展 <code>JSR 303</code>规范，以实现校验参数中多个字段不可同时为空的情况。<br>即指定字段列表中，至少一个为非空值。</p><blockquote><p>等价于多个字段 @NotNull、@NotEmpty、@NotAllBlank 的或操作。</p></blockquote><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="NotAllNull"><a href="#NotAllNull" class="headerlink" title="NotAllNull"></a>NotAllNull</h3><h4 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;FIELD, METHOD, PARAMETER, ANNOTATION_TYPE, TYPE_USE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = NotAllNullConstraintValidator.class)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Repeatable(NotAllNull.List.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NotAllNull &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字段名称</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] value();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提示信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> &quot;</span>&#123;javax.validation.constraints.NotAllNull.message&#125;<span class="string">&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * 分组</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @return Class&lt;?&gt;[]</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    Class&lt;?&gt;[] groups() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * 负载</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @return Class&lt;? extends Payload&gt;[]</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * 在相同元素上面定义多个 NotAllNull 注解</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @see NotAllNull</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    @Target(&#123;FIELD, METHOD, PARAMETER, ANNOTATION_TYPE, TYPE_USE&#125;)</span></span><br><span class="line"><span class="string">    @Retention(RUNTIME)</span></span><br><span class="line"><span class="string">    @Documented</span></span><br><span class="line"><span class="string">    @interface List &#123;</span></span><br><span class="line"><span class="string">        NotAllNull[] value();</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="校验器"><a href="#校验器" class="headerlink" title="校验器"></a>校验器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotAllNullConstraintValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">NotAllNull</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] EMPTY = <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String[] value = EMPTY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(NotAllNull constraintAnnotation)</span> </span>&#123;</span><br><span class="line">        value = constraintAnnotation.value();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Object object, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (value.length == <span class="number">1</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;NotAllNull 仅作用于一个字段 &#123;&#125;， 应当使用 @NotNull 注解！&quot;</span>, value[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(value)</span><br><span class="line">                .map(it -&gt; ReflectionUtils.findField(object.getClass(), it))</span><br><span class="line">                .filter(Objects::nonNull)</span><br><span class="line">                .map(<span class="keyword">this</span>::makeAccessible)</span><br><span class="line">                .map(it -&gt; ReflectionUtils.getField(it, object))</span><br><span class="line">                .anyMatch(Objects::nonNull);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Field <span class="title">makeAccessible</span><span class="params">(Field field)</span> </span>&#123;</span><br><span class="line">        ReflectionUtils.makeAccessible(field);</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="NotAllEmpty"><a href="#NotAllEmpty" class="headerlink" title="NotAllEmpty"></a>NotAllEmpty</h3><h4 id="注解-1"><a href="#注解-1" class="headerlink" title="注解"></a>注解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;FIELD, METHOD, PARAMETER, ANNOTATION_TYPE, TYPE_USE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = NotAllEmptyConstraintValidator.class)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Repeatable(NotAllEmpty.List.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NotAllEmpty &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字段名称</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] value();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提示信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> &quot;</span>&#123;javax.validation.constraints.NotAllNull.message&#125;<span class="string">&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * 分组</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @return Class&lt;?&gt;[]</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    Class&lt;?&gt;[] groups() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * 负载</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @return Class&lt;? extends Payload&gt;[]</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /**</span></span><br><span class="line"><span class="string">     * 在相同元素上面定义多个 NotAllNull 注解</span></span><br><span class="line"><span class="string">     *</span></span><br><span class="line"><span class="string">     * @see NotAllNull</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    @Target(&#123;FIELD, METHOD, PARAMETER, ANNOTATION_TYPE, TYPE_USE&#125;)</span></span><br><span class="line"><span class="string">    @Retention(RUNTIME)</span></span><br><span class="line"><span class="string">    @Documented</span></span><br><span class="line"><span class="string">    @interface List &#123;</span></span><br><span class="line"><span class="string">        NotAllEmpty[] value();</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="校验器-1"><a href="#校验器-1" class="headerlink" title="校验器"></a>校验器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotAllEmptyConstraintValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">NotAllEmpty</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] EMPTY = <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String[] value = EMPTY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(NotAllEmpty constraintAnnotation)</span> </span>&#123;</span><br><span class="line">        value = constraintAnnotation.value();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Object object, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (value.length == <span class="number">1</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;NotAllEmpty 仅作用于一个字段 &#123;&#125;， 应当使用 @NotEmpty 注解！&quot;</span>, value[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(value)</span><br><span class="line">                .map(it -&gt; ReflectionUtils.findField(object.getClass(), it))</span><br><span class="line">                .filter(Objects::nonNull)</span><br><span class="line">                .map(<span class="keyword">this</span>::makeAccessible)</span><br><span class="line">                .map(it -&gt; ReflectionUtils.getField(it, object))</span><br><span class="line">                .filter(Objects::nonNull)</span><br><span class="line">                .anyMatch(<span class="keyword">this</span>::isNotEmpty);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Field <span class="title">makeAccessible</span><span class="params">(Field field)</span> </span>&#123;</span><br><span class="line">        ReflectionUtils.makeAccessible(field);</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNotEmpty</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="keyword">return</span> StringUtils.isNotEmpty((String) value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (value.getClass().isArray()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((Object[]) value).length &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Collection) &#123;</span><br><span class="line">            <span class="keyword">return</span> !((Collection&lt;?&gt;) value).isEmpty();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="国际化消息提示"><a href="#国际化消息提示" class="headerlink" title="国际化消息提示"></a>国际化消息提示</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">javax.validation.constraints.NotAllNull.message</span>=<span class="string">使用 @NotAllNull 的字段不能全为 null</span></span><br><span class="line"><span class="meta">javax.validation.constraints.NotAllEmpty.message</span>=<span class="string">使用 @NotAllEmpty 的字段不能全为空</span></span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p><code>@NotAllBlank</code>（略），至于区别：</p><ul><li>NotNull：作用于所有类型，不是 Null 值；</li><li>NotEmpty：作用于字符串、数组、集合，不是 Null 值，且非空；</li><li>NotBlank：只作用于字符串，不是 Null 值，且 trim 后非空；</li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;通过自定义注解，拓展 &lt;code&gt;JSR 303&lt;/code&gt;规范，以实现校验参数中多个字段不可同时为空的情况。&lt;br&gt;即指定字段列表中，至少一个为非空值。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/"/>
    
    <category term="参数校验注解" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%E6%B3%A8%E8%A7%A3/"/>
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/tags/Spring-Boot/"/>
    
    <category term="注解" scheme="http://daiwenzh5.github.io/tags/%E6%B3%A8%E8%A7%A3/"/>
    
    <category term="JSR 303" scheme="http://daiwenzh5.github.io/tags/JSR-303/"/>
    
    <category term="Hibernate Validator" scheme="http://daiwenzh5.github.io/tags/Hibernate-Validator/"/>
    
  </entry>
  
  <entry>
    <title>Oracle 多行 SQL</title>
    <link href="http://daiwenzh5.github.io/2022/03/23/yuque/Oracle%20%E5%A4%9A%E8%A1%8C%20SQL/"/>
    <id>http://daiwenzh5.github.io/2022/03/23/yuque/Oracle%20%E5%A4%9A%E8%A1%8C%20SQL/</id>
    <published>2022-03-23T14:10:02.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>需要使用查询结果作为参数，进行二次查询。所以需要使用脚本执行多步操作，将查询结果保存在参数中。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="启用多行-SQL"><a href="#启用多行-SQL" class="headerlink" title="启用多行 SQL"></a>启用多行 SQL</h3><p>若需要使用变量，则必须先在外部声明。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DECLARE</span><br><span class="line">-- 变量名 类型;</span><br><span class="line">v_name VARCHAR(16);</span><br><span class="line">BEGIN</span><br><span class="line">-- do something</span><br><span class="line">END;</span><br></pre></td></tr></table></figure><h3 id="变量赋值"><a href="#变量赋值" class="headerlink" title="变量赋值"></a>变量赋值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BEGIN</span><br><span class="line">-- 需要使用 :&#x3D;</span><br><span class="line">v_name :&#x3D; &#39;tony&#39;;</span><br><span class="line">-- 不能使用子查询</span><br><span class="line">select name into v_name from user;</span><br><span class="line">END;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="执行-ALTER-操作"><a href="#执行-ALTER-操作" class="headerlink" title="执行 ALTER 操作"></a>执行 ALTER 操作</h3><p>直接使用会出现异常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PLS-00103: Encountered the symbol &quot;ALTER&quot; when expecting one of the following:</span><br><span class="line"></span><br><span class="line">   ( begin case declare end exception exit for goto if loop mod</span><br><span class="line">   null pragma raise return select update while with</span><br><span class="line">   &lt;an identifier&gt; &lt;a double-quoted delimited-identifier&gt;</span><br><span class="line">   &lt;a bind variable&gt; &lt;&lt; continue close current delete fetch lock</span><br><span class="line">   insert open rollback savepoint set sql execute commit forall</span><br><span class="line">   merge pipe purge</span><br></pre></td></tr></table></figure><p>需要使用立即执行命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXECUTE IMMEDIATE &#39;a SQL&#39;;</span><br><span class="line">-- 若需要变量，则需要使用字符串拼接</span><br><span class="line">EXECUTE IMMEDIATE &#39;a SQL&#39; || v_name;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;需要使用查询结果作为参数，进行二次查询。所以需要使用脚本执行多步操作，将查询结果保存在参数中。&lt;/p&gt;</summary>
    
    
    
    <category term="SQL" scheme="http://daiwenzh5.github.io/categories/SQL/"/>
    
    <category term="Oracle" scheme="http://daiwenzh5.github.io/categories/SQL/Oracle/"/>
    
    
    <category term="Oracle" scheme="http://daiwenzh5.github.io/tags/Oracle/"/>
    
    <category term="SQL" scheme="http://daiwenzh5.github.io/tags/SQL/"/>
    
    <category term="脚本" scheme="http://daiwenzh5.github.io/tags/%E8%84%9A%E6%9C%AC/"/>
    
    <category term="多行" scheme="http://daiwenzh5.github.io/tags/%E5%A4%9A%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>解析 Java8 时间类</title>
    <link href="http://daiwenzh5.github.io/2022/03/07/yuque/%E8%A7%A3%E6%9E%90%20Java8%20%E6%97%B6%E9%97%B4%E7%B1%BB/"/>
    <id>http://daiwenzh5.github.io/2022/03/07/yuque/%E8%A7%A3%E6%9E%90%20Java8%20%E6%97%B6%E9%97%B4%E7%B1%BB/</id>
    <published>2022-03-07T13:09:16.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a>Spring Boot</h2><p>使用 <code>@DateTimeFormat</code> 可以对非 Json （即未被 <code>@RequestBody</code> 修饰的）参数进行反序列化，该注解由 Spring Boot 提供，与序列化工具无关。<br>而需要处理 Json 参数时，则必须借助 Json 序列化框架来实现。</p><h2 id="Jackson"><a href="#Jackson" class="headerlink" title="Jackson"></a>Jackson</h2><p>Jackson 提供了 <code>@JsonFormat</code> 注解，同时用于日期的（反）序列化。但是默认情况下，并不支持 Jsr310 新增的、即 java 8 时间类，如 LocalDate。<br>需要添加依赖（默认继承 Jackson 提供的版本号即可）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>此时，Spring Boot 将自动完成注册。<br>但是，若在项目中手动新建了 Jackson 处理器，或者重新注册了 ObjectMapper Bean，则需要在注册时，修改配置以添加支持：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通常时在 web 配置中重新消息响应器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        <span class="comment">// 注册时间模块</span></span><br><span class="line">      objectMapper.registerModule(<span class="keyword">new</span> JavaTimeModule());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Spring-Boot&quot;&gt;&lt;a href=&quot;#Spring-Boot&quot; class=&quot;headerlink&quot; title=&quot;Spring Boot&quot;&gt;&lt;/a&gt;Spring Boot&lt;/h2&gt;&lt;p&gt;使用 &lt;code&gt;@DateTimeFormat&lt;/code&gt; 可以对非 Json （即未被 &lt;code&gt;@RequestBody&lt;/code&gt; 修饰的）参数进行反序列化，该注解由 Spring Boot 提供，与序列化工具无关。&lt;br&gt;而需要处理 Json 参数时，则必须借助 Json 序列化框架来实现。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/"/>
    
    <category term="Java 8 Time" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/Java-8-Time/"/>
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/tags/Spring-Boot/"/>
    
    <category term="LocalDate" scheme="http://daiwenzh5.github.io/tags/LocalDate/"/>
    
    <category term="Java 8 Time" scheme="http://daiwenzh5.github.io/tags/Java-8-Time/"/>
    
    <category term="JSR310" scheme="http://daiwenzh5.github.io/tags/JSR310/"/>
    
  </entry>
  
  <entry>
    <title>Mybaits LocalDate 解析异常</title>
    <link href="http://daiwenzh5.github.io/2022/03/07/yuque/Mybaits%20LocalDate%20%E8%A7%A3%E6%9E%90%E5%BC%82%E5%B8%B8/"/>
    <id>http://daiwenzh5.github.io/2022/03/07/yuque/Mybaits%20LocalDate%20%E8%A7%A3%E6%9E%90%E5%BC%82%E5%B8%B8/</id>
    <published>2022-03-07T08:10:47.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>mybatis 中 使用 LocalDate 等时间类型无法被正确的映射，出现以下异常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.apache.ibatis.type.TypeException: Error setting non null for parameter #1 with JdbcType null . Try setting a different JdbcType for this parameter or a different configuration property. Cause: java.sql.SQLException: 无效的列类型</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>添加类型处理器依赖即可（3.4 +）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-typehandlers-jsr310<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lastVersion&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>老版本需要手动配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;org.apache.ibatis.type.InstantTypeHandler&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;org.apache.ibatis.type.LocalDateTimeTypeHandler&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;org.apache.ibatis.type.LocalDateTypeHandler&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;org.apache.ibatis.type.LocalTimeTypeHandler&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;org.apache.ibatis.type.OffsetDateTimeTypeHandler&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;org.apache.ibatis.type.OffsetTimeTypeHandler&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;org.apache.ibatis.type.ZonedDateTimeTypeHandler&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;org.apache.ibatis.type.YearTypeHandler&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;org.apache.ibatis.type.MonthTypeHandler&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;org.apache.ibatis.type.YearMonthTypeHandler&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">&quot;org.apache.ibatis.type.JapaneseDateTypeHandler&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/mybatis/typehandlers-jsr310">官网说明</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;mybatis 中 使用 LocalDate 等时间类型无法被正确的映射，出现以下异常：&lt;/p&gt;</summary>
    
    
    
    <category term="Mybaits" scheme="http://daiwenzh5.github.io/categories/Mybaits/"/>
    
    <category term="LocalDate" scheme="http://daiwenzh5.github.io/categories/Mybaits/LocalDate/"/>
    
    
    <category term="LocalDate" scheme="http://daiwenzh5.github.io/tags/LocalDate/"/>
    
    <category term="Mybatis" scheme="http://daiwenzh5.github.io/tags/Mybatis/"/>
    
    <category term="Java 8" scheme="http://daiwenzh5.github.io/tags/Java-8/"/>
    
    <category term="异常" scheme="http://daiwenzh5.github.io/tags/%E5%BC%82%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>RestTemplate 使用</title>
    <link href="http://daiwenzh5.github.io/2022/02/27/yuque/RestTemplate%20%E4%BD%BF%E7%94%A8/"/>
    <id>http://daiwenzh5.github.io/2022/02/27/yuque/RestTemplate%20%E4%BD%BF%E7%94%A8/</id>
    <published>2022-02-27T15:24:11.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h2><p>restTemplate 是 spring 提供的基于 restful 设计的 http 请求客户端。</p><h2 id="使用介绍"><a href="#使用介绍" class="headerlink" title="使用介绍"></a>使用介绍</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>springboot 默认提供了 restTemplate 相关的 Bean，但也可以通过手动注册同类型的 bean 来自定义一些配置，如通用的请求头，拦截器等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">(ClientHttpRequestFactory factory)</span> </span>&#123;</span><br><span class="line">    RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(factory);</span><br><span class="line">    <span class="comment">// 其他设置，如：拦截器、消息处理器等</span></span><br><span class="line">    <span class="keyword">return</span> restTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><p>一般的会将特定功能的拦截器，注册到独立的 restTemplate bean 中，即设置多个 restTemplate bean（默认同类型下只能存在一个 bean，可以使用包装类，装饰器）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义自定义拦截器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomInterceptor</span> <span class="keyword">implements</span> <span class="title">ClientHttpRequestInterceptor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">intercept</span><span class="params">(HttpRequest request, <span class="keyword">byte</span>[] body, ClientHttpRequestExecution execution)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 自定义方法体</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 执行完毕后放行请求</span></span><br><span class="line">        <span class="keyword">return</span> execution.execute(request, body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 添加拦截器</span></span><br><span class="line">restTemplate.getInterceptors().add(<span class="keyword">new</span> CustomInterceptor())</span><br></pre></td></tr></table></figure><h3 id="自定义消息转换器"><a href="#自定义消息转换器" class="headerlink" title="自定义消息转换器"></a>自定义消息转换器</h3><p>项目中经常使用 <code>FastJson</code> 替换 <code>Jackson</code>，实际上项目中存在一个 Json 处理工具即可，（<code>Jackson</code> 挺好用的，感觉 Bug 少多了）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRestTemplate</span><span class="params">(RestTemplate restTemplate)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 重新设置了消息转换器集合，通过遍历过滤了原有的 Jackson 处理器，最后添加了 FastJson 处理器</span></span><br><span class="line">    <span class="comment">// 也可以直接在原有的 list 中使用 remove 去除，再添加</span></span><br><span class="line">    List&lt;HttpMessageConverter&lt;?&gt;&gt; converters = restTemplate.getMessageConverters();</span><br><span class="line">    List&lt;HttpMessageConverter&lt;?&gt;&gt; convertersValid = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; converter : converters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (converter <span class="keyword">instanceof</span> MappingJackson2HttpMessageConverter</span><br><span class="line">                || converter <span class="keyword">instanceof</span> MappingJackson2XmlHttpMessageConverter) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        convertersValid.add(converter);</span><br><span class="line">    &#125;</span><br><span class="line">    convertersValid.add(fastJsonHttpMessageConverter());</span><br><span class="line">    restTemplate.setMessageConverters(convertersValid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * fastJson 消息转换器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> fastJson 消息转换器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> FastJsonHttpMessageConverter <span class="title">fastJsonHttpMessageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;MediaType&gt; mediaTypes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    mediaTypes.add(MediaType.APPLICATION_JSON);</span><br><span class="line">    FastJsonConfig fastJsonConfig = <span class="keyword">new</span> FastJsonConfig();</span><br><span class="line">    fastJsonConfig.setSerializerFeatures(SerializerFeature.DisableCircularReferenceDetect,</span><br><span class="line">            SerializerFeature.WriteMapNullValue,</span><br><span class="line">            SerializerFeature.WriteDateUseDateFormat);</span><br><span class="line">    fastJsonConfig.setDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">    GsonHttpMessageConverter gsonHttpMessageConverter = <span class="keyword">new</span> GsonHttpMessageConverter();</span><br><span class="line">    gsonHttpMessageConverter.setSupportedMediaTypes(mediaTypes);</span><br><span class="line">    FastJsonHttpMessageConverter fastConverter = <span class="keyword">new</span> FastJsonHttpMessageConverter();</span><br><span class="line">    fastConverter.setSupportedMediaTypes(mediaTypes);</span><br><span class="line">    fastConverter.setFastJsonConfig(fastJsonConfig);</span><br><span class="line">    <span class="keyword">return</span> fastConverter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Get-参数设置"><a href="#Get-参数设置" class="headerlink" title="Get 参数设置"></a>Get 参数设置</h3><p>使用 restful 占位符，设置方式和 controller 层一致，如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testGetParam</span><span class="params">()</span> </span>&#123;</span><br><span class="line">restTemplate.getForObject(</span><br><span class="line">        <span class="string">&#x27;route?param1=&#123;param1&#125;&amp;param2=&#123;param2&#125;&#x27;</span>,</span><br><span class="line">        T.class,</span><br><span class="line">        ...参数</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>ps：当然参数也可以使用 Map</em></p><h3 id="List-类型结果"><a href="#List-类型结果" class="headerlink" title="List 类型结果"></a>List 类型结果</h3><p>对于任意使用 List<T> 的结果集，在泛型类型设置上，使用 <code>T[].class</code> 替代，可以很好的避免 List&lt;?&gt; 无法获取具体类型的问题。<br>当然也可以使用 <code>new ParameterizedTypeReference&lt;List&lt;T&gt;&gt;()&#123;&#125;</code>，但其本身是通过生成匿名类（类中的泛型不会被擦除）的方式来记录泛型信息。<br>使用数组类型无疑更简洁优雅。</p><h3 id="自定义-header"><a href="#自定义-header" class="headerlink" title="自定义 header"></a>自定义 header</h3><h4 id="使用-exchange-方法"><a href="#使用-exchange-方法" class="headerlink" title="使用 exchange 方法"></a>使用 exchange 方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HttpHeaders requestHeaders = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">    HttpEntity&lt;UserModel[]&gt; request = <span class="keyword">new</span> HttpEntity&lt;&gt;(requestHeaders);</span><br><span class="line">    val result = restTemplate.exchange(</span><br><span class="line">            <span class="string">&quot;路由&quot;</span>,</span><br><span class="line">            HttpMethod.GET,</span><br><span class="line">            request,</span><br><span class="line">            T[].class,</span><br><span class="line">            ...参数</span><br><span class="line">    ).getBody();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="使用-execute-方法"><a href="#使用-execute-方法" class="headerlink" title="使用 execute 方法"></a>使用 execute 方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testExecute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HttpHeaders requestHeaders = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">    HttpEntity&lt;UserModel[]&gt; request = <span class="keyword">new</span> HttpEntity&lt;&gt;(requestHeaders);</span><br><span class="line">        val requestCallback = restTemplate.httpEntityCallback(request, T[].class);</span><br><span class="line">        val responseExtractor = restTemplate.responseEntityExtractor(T[].class);</span><br><span class="line">        val result = restTemplate.execute(</span><br><span class="line">                <span class="string">&quot;路由&quot;</span>,</span><br><span class="line">                HttpMethod.GET,</span><br><span class="line">                requestCallback,</span><br><span class="line">                responseExtractor,</span><br><span class="line">                ...参数</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;场景描述&quot;&gt;&lt;a href=&quot;#场景描述&quot; class=&quot;headerlink&quot; title=&quot;场景描述&quot;&gt;&lt;/a&gt;场景描述&lt;/h2&gt;&lt;p&gt;restTemplate 是 spring 提供的基于 restful 设计的 http 请求客户端。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/"/>
    
    <category term="Rest Template" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/Rest-Template/"/>
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/tags/Spring-Boot/"/>
    
    <category term="Rest Template" scheme="http://daiwenzh5.github.io/tags/Rest-Template/"/>
    
    <category term="Http 请求" scheme="http://daiwenzh5.github.io/tags/Http-%E8%AF%B7%E6%B1%82/"/>
    
    <category term="Restful" scheme="http://daiwenzh5.github.io/tags/Restful/"/>
    
  </entry>
  
  <entry>
    <title>WebMvc 测试</title>
    <link href="http://daiwenzh5.github.io/2022/02/26/yuque/WebMvc%20%E6%B5%8B%E8%AF%95/"/>
    <id>http://daiwenzh5.github.io/2022/02/26/yuque/WebMvc%20%E6%B5%8B%E8%AF%95/</id>
    <published>2022-02-26T10:38:31.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h2><p>需要对 api 编写测试类，可以采用的方式：</p><ol><li>MockMvc</li><li>RestTemple</li></ol><p>但是由于 MockMvc 的结果值是字符串，虽然提供了 jsonPath 方法解析，但是处理过程丧失了面向对象的优雅，可能其对于 controller 层作单元测试，结合 MockBean，应当会更方便，轻量；而在处理完整的 api 测试，使用 restTemplate 通过泛型可以直接获取到结果对象，处理过程更灵活。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><h3 id="获取端口号"><a href="#获取端口号" class="headerlink" title="获取端口号"></a>获取端口号</h3><p><em>ps：使用 RestTemplate 是需要获取端口号的。</em><br>在启用 <code>@SpringBootTest</code> 时，无法直接从配置文件读取端口号，需要指定 ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(</span></span><br><span class="line"><span class="meta">        classes = SampleApplication.class,</span></span><br><span class="line"><span class="meta">        // 启用配置文件中定义的端口号</span></span><br><span class="line"><span class="meta">    // 也可以通过枚举值切换为随机端口等</span></span><br><span class="line"><span class="meta">        webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure><p>否则会出现 -1 或 null 的情况，之后可以通过常规的 spring 注入方式，来获取端口号，如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. server.port 或 local.server.port</span></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. @Value(&quot;$&#123;local.server.port&#125;&quot;) 等价注解</span></span><br><span class="line"><span class="meta">@LocalServerPort</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 环境变量</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">Environment environment;</span><br><span class="line"><span class="keyword">this</span>.environment.getProperty(<span class="string">&quot;server.port&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="MockMvc"><a href="#MockMvc" class="headerlink" title="MockMvc"></a>MockMvc</h3><p>期间也是测试了 MockMvc 的使用，需要 <code>@AutoConfigureMockMvc</code> 注解在测试类上，启用相关配置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testMockMvc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String expected = <span class="string">&quot;预期的 json 字符串&quot;</span>;</span><br><span class="line">        mockMvc.perform(</span><br><span class="line">                            MockMvcRequestBuilders</span><br><span class="line">                                    .get(<span class="string">&quot;路由&quot;</span>)</span><br><span class="line">                    )</span><br><span class="line">                    .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">                    .andExpect(MockMvcResultMatchers.content().json(expected))</span><br><span class="line">                    .andDo(MockMvcResultHandlers.print());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="使用异常"><a href="#使用异常" class="headerlink" title="使用异常"></a>使用异常</h4><p>但使用过程并不顺利，遇到了以下异常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.util.NestedServletException: Request processing failed; nested exception is java.lang.NullPointerException</span><br><span class="line"></span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:898)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:626)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:883)</span><br><span class="line">at org.springframework.test.web.servlet.TestDispatcherServlet.service(TestDispatcherServlet.java:72)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:733)</span><br></pre></td></tr></table></figure><p>通过异常信息，只能获取到空指针异常，无法直接定位到触发原因，但实际上是由于测试时，没有添加请求参数引起的，因此在遇到类似的异常时，需要注意请求本身是否存在违规的操作，缺失 header、参数等信息。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;场景描述&quot;&gt;&lt;a href=&quot;#场景描述&quot; class=&quot;headerlink&quot; title=&quot;场景描述&quot;&gt;&lt;/a&gt;场景描述&lt;/h2&gt;&lt;p&gt;需要对 api 编写测试类，可以采用的方式：&lt;/p&gt;</summary>
    
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/"/>
    
    <category term="Unit Test" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/Unit-Test/"/>
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/tags/Spring-Boot/"/>
    
    <category term="Unit Test" scheme="http://daiwenzh5.github.io/tags/Unit-Test/"/>
    
    <category term="MVC" scheme="http://daiwenzh5.github.io/tags/MVC/"/>
    
    <category term="Mock" scheme="http://daiwenzh5.github.io/tags/Mock/"/>
    
  </entry>
  
  <entry>
    <title>async setup() 引发异常</title>
    <link href="http://daiwenzh5.github.io/2021/12/09/yuque/async%20setup()%20%E5%BC%95%E5%8F%91%E5%BC%82%E5%B8%B8/"/>
    <id>http://daiwenzh5.github.io/2021/12/09/yuque/async%20setup()%20%E5%BC%95%E5%8F%91%E5%BC%82%E5%B8%B8/</id>
    <published>2021-12-08T20:19:25.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在 uniapp 项目中使用 vue3 开发，在 setup script 标签中使用顶层 await 语句，导致页面空白，而控制台打印异常。</p><h3 id="项目环境"><a href="#项目环境" class="headerlink" title="项目环境"></a>项目环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">编译器: HBX 3.3 Beta</span><br><span class="line">vue: 3.2.23</span><br></pre></td></tr></table></figure><h3 id="异常原因"><a href="#异常原因" class="headerlink" title="异常原因"></a>异常原因</h3><p>这是因为 <a href="https://v3.cn.vuejs.org/api/sfc-script-setup.html#%E9%A1%B6%E5%B1%82-await">顶层 await</a> 必须配合 async setup() 必须与 <code>Suspense</code> 组合使用，而<a href="https://ask.dcloud.net.cn/article/id-37834">当前版本的 uniapp 并不支持该组件</a>。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>在 setup script 中使用 <a href="https://vue3js.cn/global/nextTick.html">nextTick</a> 方法，在回调中使用 await 语句，而非在顶层使用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref, nextTick &#125; from &quot;vue&quot;;</span><br><span class="line">&#x2F;&#x2F; 定义任意响应对象</span><br><span class="line">const anything &#x3D; ref(&quot;hello&quot;);</span><br><span class="line">nextTick(async () &#x3D;&gt; &#123;</span><br><span class="line">  &#x2F;&#x2F; 执行异步方法</span><br><span class="line">  const res &#x3D; await asyncFunction();</span><br><span class="line">  &#x2F;&#x2F; 将返回结果，回写到响应对象的值中</span><br><span class="line">  anything.value &#x3D; res;</span><br><span class="line">&#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h2&gt;&lt;p&gt;在 uniapp 项目中使用 vue3 开发，在 setup script 标签中使用顶层 await 语句，导致页面空白，而控制台打印异常。&lt;/p&gt;</summary>
    
    
    
    <category term="Vue3" scheme="http://daiwenzh5.github.io/categories/Vue3/"/>
    
    <category term="异常" scheme="http://daiwenzh5.github.io/categories/Vue3/%E5%BC%82%E5%B8%B8/"/>
    
    
    <category term="异常" scheme="http://daiwenzh5.github.io/tags/%E5%BC%82%E5%B8%B8/"/>
    
    <category term="Vue3" scheme="http://daiwenzh5.github.io/tags/Vue3/"/>
    
    <category term="Uniapp" scheme="http://daiwenzh5.github.io/tags/Uniapp/"/>
    
    <category term="async setup" scheme="http://daiwenzh5.github.io/tags/async-setup/"/>
    
  </entry>
  
  <entry>
    <title>重复参数校验</title>
    <link href="http://daiwenzh5.github.io/2021/11/22/yuque/%E9%87%8D%E5%A4%8D%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C/"/>
    <id>http://daiwenzh5.github.io/2021/11/22/yuque/%E9%87%8D%E5%A4%8D%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C/</id>
    <published>2021-11-22T13:14:34.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>需要对列表数据中某个字段验重。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>通过自定义注解，借助 spring 参数校验框架，抽象通用逻辑，通过反射获取字段值进行比较。</p><h3 id="注解-NoRepeat"><a href="#注解-NoRepeat" class="headerlink" title="注解 - NoRepeat"></a>注解 - NoRepeat</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 非重复校验</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> daiwenzh5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/11/22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER&#125;)</span></span><br><span class="line"><span class="meta">@Repeatable(NotRepeat.List.class)</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = NotRepeatConstraintValidator.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NotRepeat &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字段名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">field</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增强校验方法注册的 bean 名称 &lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 可以将数据库查重注册为 bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">beanName</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> &quot;</span>&#123;javax.validation.constraints.NotRepeat.message&#125;<span class="string">&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Class&lt;?&gt;[] groups() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @Target(&#123;METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER&#125;)</span></span><br><span class="line"><span class="string">    @Retention(RUNTIME)</span></span><br><span class="line"><span class="string">    @Documented</span></span><br><span class="line"><span class="string">    @interface List &#123;</span></span><br><span class="line"><span class="string">        NotRepeat[] value();</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="校验逻辑"><a href="#校验逻辑" class="headerlink" title="校验逻辑"></a>校验逻辑</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 非重复字段校验</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> daiwenzh5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/11/22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotRepeatConstraintValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">NotRepeat</span>, <span class="title">List</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String field;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;java:S3740&quot;, &quot;rawtypes&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> IRepeatValidator bean;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(NotRepeat constraintAnnotation)</span> </span>&#123;</span><br><span class="line">        field = constraintAnnotation.field();</span><br><span class="line">        message = constraintAnnotation.message();</span><br><span class="line">        <span class="keyword">if</span> (CharSequenceUtil.isNotEmpty(constraintAnnotation.beanName())) &#123;</span><br><span class="line">            bean = SpringUtil.getBean(constraintAnnotation.beanName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(List&lt;?&gt; value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        Consumer&lt;String&gt; setMessage = param -&gt; &#123;</span><br><span class="line">            context.disableDefaultConstraintViolation();</span><br><span class="line">            context.buildConstraintViolationWithTemplate(String.format(</span><br><span class="line">                            message,</span><br><span class="line">                            param</span><br><span class="line">                    ))</span><br><span class="line">                    .addConstraintViolation();</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">var</span> first = findInList(value);</span><br><span class="line">        <span class="keyword">if</span> (first.isPresent()) &#123;</span><br><span class="line">            setMessage.accept(String.format(</span><br><span class="line">                    message,</span><br><span class="line">                    first.get()</span><br><span class="line">            ));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">            first = findInBean(value);</span><br><span class="line">            <span class="keyword">if</span> (first.isPresent()) &#123;</span><br><span class="line">                setMessage.accept(first.get());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从 bean 方法中查找重复项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Optional&lt;String&gt; <span class="title">findInBean</span><span class="params">(List&lt;?&gt; value)</span> </span>&#123;</span><br><span class="line">        Optional&lt;String&gt; first;</span><br><span class="line">        <span class="comment">//noinspection unchecked</span></span><br><span class="line">        first = bean.pick(value)</span><br><span class="line">                .stream()</span><br><span class="line">                .map(Object::toString)</span><br><span class="line">                .sorted()</span><br><span class="line">                .findFirst();</span><br><span class="line">        <span class="keyword">return</span> first;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从参数中查找</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Optional&lt;String&gt; <span class="title">findInList</span><span class="params">(List&lt;?&gt; value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value.stream()</span><br><span class="line">                <span class="comment">// 获取字段值</span></span><br><span class="line">                .map(<span class="keyword">this</span>::getValue)</span><br><span class="line">                <span class="comment">// 去除 null 值</span></span><br><span class="line">                .filter(Objects::nonNull)</span><br><span class="line">                <span class="comment">// 按值分组，并统计数量</span></span><br><span class="line">                .collect(Collectors.groupingBy(</span><br><span class="line">                        Function.identity(),</span><br><span class="line">                        Collectors.counting()</span><br><span class="line">                )).entrySet()</span><br><span class="line">                .stream()</span><br><span class="line">                <span class="comment">// 筛选数量大于 1</span></span><br><span class="line">                .filter(it -&gt; it.getValue() &gt; <span class="number">1</span>)</span><br><span class="line">                <span class="comment">// 取第一个数</span></span><br><span class="line">                .findFirst()</span><br><span class="line">                .map(Map.Entry::getKey)</span><br><span class="line">                .map(Object::toString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">getValue</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ReflectUtil.getFieldValue(object, field);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="增强校验方法"><a href="#增强校验方法" class="headerlink" title="增强校验方法"></a>增强校验方法</h3><h4 id="简单的建造工厂"><a href="#简单的建造工厂" class="headerlink" title="简单的建造工厂"></a>简单的建造工厂</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于 mybatis plus 的重复校验简单工厂</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> daiwenzh5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/11/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@UtilityClass</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepeatValidatorMybatisPlusFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个基于 mybatis plus 的&#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> baseMapper 基于 mybatis plus mapper 类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> field      字段名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> getter     字段的 getter 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;        待校验数据的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt;        mapper 映射的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, R&gt; <span class="function">IRepeatValidator&lt;T&gt; <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            BaseMapper&lt;R&gt; baseMapper,</span></span></span><br><span class="line"><span class="function"><span class="params">            String field,</span></span></span><br><span class="line"><span class="function"><span class="params">            Function&lt;T, String&gt; getter</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> create(baseMapper, field, getter, (list, rQueryWrapper) -&gt; rQueryWrapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个基于 mybatis plus 的&#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> baseMapper  基于 mybatis plus mapper 类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> field       字段名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> getter      字段的 getter 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> moreWrapper 更多查询条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;         待校验数据的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt;         mapper 映射的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, R&gt; <span class="function">IRepeatValidator&lt;T&gt; <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            BaseMapper&lt;R&gt; baseMapper,</span></span></span><br><span class="line"><span class="function"><span class="params">            String field,</span></span></span><br><span class="line"><span class="function"><span class="params">            Function&lt;T, String&gt; getter,</span></span></span><br><span class="line"><span class="function"><span class="params">            BiFunction&lt;List&lt;T&gt;, QueryWrapper&lt;R&gt;, QueryWrapper&lt;R&gt;&gt; moreWrapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> list -&gt; &#123;</span><br><span class="line">            val collect = list.stream()</span><br><span class="line">                    .map(getter)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            <span class="keyword">return</span> baseMapper.selectObjs(</span><br><span class="line">                    moreWrapper.apply(list, <span class="keyword">new</span> QueryWrapper&lt;R&gt;()</span><br><span class="line">                            .select(field)</span><br><span class="line">                            .in(field, collect))</span><br><span class="line">            );</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个基于 mybatis plus 的&#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125; &lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 防止更新时和自身发生验重</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> baseMapper 基于 mybatis plus mapper 类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> field      字段名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> getter     字段的 getter 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id         主键名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idGetter   主键的 getter 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;        待校验数据的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt;        mapper 映射的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, R&gt; <span class="function">IRepeatValidator&lt;T&gt; <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            BaseMapper&lt;R&gt; baseMapper,</span></span></span><br><span class="line"><span class="function"><span class="params">            String field,</span></span></span><br><span class="line"><span class="function"><span class="params">            Function&lt;T, String&gt; getter,</span></span></span><br><span class="line"><span class="function"><span class="params">            String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            Function&lt;T, Object&gt; idGetter</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> create(baseMapper, field, getter, id, idGetter, (list, rQueryWrapper) -&gt; rQueryWrapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个基于 mybatis plus 的&#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125; &lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 防止更新时和自身发生验重</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> baseMapper  基于 mybatis plus mapper 类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> field       字段名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> getter      字段的 getter 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id          主键名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idGetter    主键的 getter 方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> moreWrapper 更多查询条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;         待校验数据的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt;         mapper 映射的实体类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@linkplain</span> IRepeatValidator 重复校验器&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, R&gt; <span class="function">IRepeatValidator&lt;T&gt; <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            BaseMapper&lt;R&gt; baseMapper,</span></span></span><br><span class="line"><span class="function"><span class="params">            String field,</span></span></span><br><span class="line"><span class="function"><span class="params">            Function&lt;T, String&gt; getter,</span></span></span><br><span class="line"><span class="function"><span class="params">            String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            Function&lt;T, Object&gt; idGetter,</span></span></span><br><span class="line"><span class="function"><span class="params">            BiFunction&lt;List&lt;T&gt;, QueryWrapper&lt;R&gt;, QueryWrapper&lt;R&gt;&gt; moreWrapper</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> create(baseMapper, field, getter, (list, rQueryWrapper) -&gt; &#123;</span><br><span class="line">            val ids = list.stream().map(idGetter).collect(Collectors.toList());</span><br><span class="line">            <span class="keyword">return</span> moreWrapper.apply(list, rQueryWrapper.notIn(</span><br><span class="line">                    !ids.isEmpty(),</span><br><span class="line">                    id,</span><br><span class="line">                    ids</span><br><span class="line">            ));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="注册方法"><a href="#注册方法" class="headerlink" title="注册方法"></a>注册方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IRepeatValidator&lt;T&gt; <span class="title">checkSomeField</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RepeatValidatorMybatisPlusFactory.create(</span><br><span class="line">            mapper,</span><br><span class="line">            <span class="string">&quot;字段&quot;</span>,</span><br><span class="line">            T::getField</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>对于更新时的校验，为了防止字段值未修改，但因为在库中查询已存在，导致异常的情况，应该将 id 作为查询条件，筛选出所有不在 id 列表中的数据。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IRepeatValidator&lt;T&gt; <span class="title">checkSomeField</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RepeatValidatorMybatisPlusFactory.create(</span><br><span class="line">            mapper,</span><br><span class="line">            <span class="string">&quot;字段&quot;</span>,</span><br><span class="line">            T::getField,</span><br><span class="line">        <span class="string">&quot;主键&quot;</span>,</span><br><span class="line">        T::getId</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;需要对列表数据中某个字段验重。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring" scheme="http://daiwenzh5.github.io/categories/Spring/"/>
    
    <category term="参数校验" scheme="http://daiwenzh5.github.io/categories/Spring/%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C/"/>
    
    
    <category term="注解" scheme="http://daiwenzh5.github.io/tags/%E6%B3%A8%E8%A7%A3/"/>
    
    <category term="Spring" scheme="http://daiwenzh5.github.io/tags/Spring/"/>
    
    <category term="参数校验" scheme="http://daiwenzh5.github.io/tags/%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C/"/>
    
    <category term="自定义" scheme="http://daiwenzh5.github.io/tags/%E8%87%AA%E5%AE%9A%E4%B9%89/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Config</title>
    <link href="http://daiwenzh5.github.io/2021/11/16/yuque/Spring%20Cloud%20Config/"/>
    <id>http://daiwenzh5.github.io/2021/11/16/yuque/Spring%20Cloud%20Config/</id>
    <published>2021-11-16T02:27:46.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.3.7.RELEASE<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR9<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="常用-API"><a href="#常用-API" class="headerlink" title="常用 API"></a>常用 API</h2><h3 id="查看配置"><a href="#查看配置" class="headerlink" title="查看配置"></a>查看配置</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url = <span class="string">`&#123;&#123;ip&#125;&#125;:&#123;&#123;port&#125;&#125;/&#123;&#123;applitionName&#125;&#125;-&#123;&#123;env&#125;&#125;.yml`</span>;</span><br><span class="line"># 如 http://localhost:10001/client-dev.yml</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1637032589754-b2c9fdd0-f697-4f23-918a-56e0bf8fec20.png#clientId=u91d7d860-cb11-4&from=paste&id=u62516e5c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=129&originWidth=585&originalType=binary%E2%88%B6=1&size=6077&status=done&style=none&taskId=u1cc0e5a8-e346-4c47-a518-b8f4c814de5" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1637032589754-b2c9fdd0-f697-4f23-918a-56e0bf8fec20.png#clientId=u91d7d860-cb11-4&from=paste&id=u62516e5c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=129&originWidth=585&originalType=binary%E2%88%B6=1&size=6077&status=done&style=none&taskId=u1cc0e5a8-e346-4c47-a518-b8f4c814de5" srcset="data:image/png;base64,666" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1637032674037-fdea1b41-ef54-4beb-bef1-47e57c6f0243.png#clientId=u91d7d860-cb11-4&from=paste&id=uf925558c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=124&originWidth=361&originalType=binary%E2%88%B6=1&size=9926&status=done&style=none&taskId=u6930f939-1e03-4a05-8d3b-933922827ca" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1637032674037-fdea1b41-ef54-4beb-bef1-47e57c6f0243.png#clientId=u91d7d860-cb11-4&from=paste&id=uf925558c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=124&originWidth=361&originalType=binary%E2%88%B6=1&size=9926&status=done&style=none&taskId=u6930f939-1e03-4a05-8d3b-933922827ca" srcset="data:image/png;base64,666" alt="image.png"></p><h2 id="本地模式"><a href="#本地模式" class="headerlink" title="本地模式"></a>本地模式</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-server</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">native</span> <span class="comment"># 本地配置的固定启动环境</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">native:</span></span><br><span class="line">          <span class="attr">search-locations:</span> <span class="string">file:///本机地址，支持</span> <span class="string">classpath</span></span><br></pre></td></tr></table></figure><h3 id="环境异常"><a href="#环境异常" class="headerlink" title="环境异常"></a>环境异常</h3><p>当没有指定 <code>spring.profiles.active=native</code> 时，以读取 Git 仓库为配置，出现以下异常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">***************************</span><br><span class="line">APPLICATION FAILED TO START</span><br><span class="line">***************************</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line"></span><br><span class="line">Invalid config server configuration.</span><br><span class="line"></span><br><span class="line">Action:</span><br><span class="line"></span><br><span class="line">If you are using the git profile, you need to set a Git URI in your configuration.  If you are using a native profile and have spring.cloud.config.server.bootstrap&#x3D;true, you need to use a composite configuration.</span><br></pre></td></tr></table></figure><p><strong>注意：</strong>谨防在全局配置了环境变量，由于在系统环境变量中设置了公司常用的环境名，导致配置文件中的激活项被覆盖，而一直无法启动。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1637032468567-08fe3bb9-db11-4448-9ec1-14dc678abab7.png#clientId=u91d7d860-cb11-4&from=paste&height=122&id=ude234aea&margin=%5Bobject%20Object%5D&name=image.png&originHeight=243&originWidth=953&originalType=binary%E2%88%B6=1&size=20704&status=done&style=none&taskId=u8d933ff8-c5b1-421c-9777-4ee2be92e96&width=476.5" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1637032468567-08fe3bb9-db11-4448-9ec1-14dc678abab7.png#clientId=u91d7d860-cb11-4&from=paste&height=122&id=ude234aea&margin=%5Bobject%20Object%5D&name=image.png&originHeight=243&originWidth=953&originalType=binary%E2%88%B6=1&size=20704&status=done&style=none&taskId=u8d933ff8-c5b1-421c-9777-4ee2be92e96&width=476.5" srcset="data:image/png;base64,666" alt="image.png"></p><h2 id="Git-模式"><a href="#Git-模式" class="headerlink" title="Git 模式"></a>Git 模式</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">file:///本机地址</span></span><br></pre></td></tr></table></figure><h3 id="本地仓库"><a href="#本地仓库" class="headerlink" title="本地仓库"></a>本地仓库</h3><p>支持设置 uri 为本地路径，但需要该仓库存在，并且访问的配置（如：client-dev.yml）已被 git 托管。</p><h3 id="远程仓库"><a href="#远程仓库" class="headerlink" title="远程仓库"></a>远程仓库</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">仓库地址</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">用户名</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">密码</span></span><br></pre></td></tr></table></figure><h4 id="加密密码"><a href="#加密密码" class="headerlink" title="加密密码"></a>加密密码</h4><p>由于在项目中使用明文配置密码，不太合适，较好的方式使用对其进行加密。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.ulisesbocchio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jasypt-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 版本号，以 maven 仓库中的配适为准 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jasypt:</span></span><br><span class="line">  <span class="attr">encryptor:</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">加密密码</span></span><br></pre></td></tr></table></figure><p>使用方式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">encrypt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Assertions.assertDoesNotThrow(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> String encrypt = stringEncryptor.encrypt(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        System.out.println(encrypt);</span><br><span class="line">        Assertions.assertEquals(</span><br><span class="line">                <span class="string">&quot;123456&quot;</span>,</span><br><span class="line">                stringEncryptor.decrypt(encrypt)</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在程序中打印出加密后的字符串，并在配置文件中使用 <code>ENC()</code> 包裹，标识其为一串加密字符。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 仅展示密码部分</span></span><br><span class="line"><span class="attr">git:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">ENC(加密字符)</span></span><br></pre></td></tr></table></figure><h2 id="安全认证"><a href="#安全认证" class="headerlink" title="安全认证"></a>安全认证</h2><p>到目前为止，配置中心的所有 api 都是可随意访问的，若需要对公网暴露，则需要添加登录鉴权更安全些。<br>添加 security 依赖，并简单配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-server</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">password123</span></span><br></pre></td></tr></table></figure><h2 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://ip:port/eureka/</span></span><br></pre></td></tr></table></figure><p>并在启动类上添加 <code>@EnableEurekaClient</code> 注解。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;运行环境&quot;&gt;&lt;a href=&quot;#运行环境&quot; class=&quot;headerlink&quot; title=&quot;运行环境&quot;&gt;&lt;/a&gt;运行环境&lt;/h2&gt;&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;java.version&lt;/span&gt;&amp;gt;&lt;/span&gt;1.8&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;java.version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;spring-boot.version&lt;/span&gt;&amp;gt;&lt;/span&gt;2.3.7.RELEASE&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;spring-boot.version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;spring-cloud.version&lt;/span&gt;&amp;gt;&lt;/span&gt;Hoxton.SR9&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;spring-cloud.version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="微服务" scheme="http://daiwenzh5.github.io/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
    <category term="Spring Cloud" scheme="http://daiwenzh5.github.io/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/Spring-Cloud/"/>
    
    
    <category term="Spring Cloud" scheme="http://daiwenzh5.github.io/tags/Spring-Cloud/"/>
    
    <category term="Config" scheme="http://daiwenzh5.github.io/tags/Config/"/>
    
    <category term="微服务" scheme="http://daiwenzh5.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
    <category term="配置中心" scheme="http://daiwenzh5.github.io/tags/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/"/>
    
  </entry>
  
  <entry>
    <title>WebFilter 路径匹配模式不生效</title>
    <link href="http://daiwenzh5.github.io/2021/11/10/yuque/WebFilter%20%E8%B7%AF%E5%BE%84%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%BC%8F%E4%B8%8D%E7%94%9F%E6%95%88/"/>
    <id>http://daiwenzh5.github.io/2021/11/10/yuque/WebFilter%20%E8%B7%AF%E5%BE%84%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%BC%8F%E4%B8%8D%E7%94%9F%E6%95%88/</id>
    <published>2021-11-10T11:23:17.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在登录授权时，需要从 header 中获取 token 进行鉴权，通常使用过滤器处理指定的访问请求，但在使用 <code>@WebFilter</code> 注解时，发现其路径匹配模式不生效，即 <code>url、urlPatterns</code> 属性配置后，拦截了所有请求。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p><code>@WebServlet，@WebFilter，@WebListener</code> 注解，需要和 <code>@ServletComponentScan</code> 注解配套使用，表明其为 servlet 组件，而不是普通的 spring 组件，当使用 <code>@Component</code> 注解后，会优先被注册为 spring 组件，导致 servlet 扫描器失效。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ServletComponentScan(&quot;包名&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(Application.class, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 扫描所有 user 下的路径</span></span><br><span class="line"><span class="meta">@WebFilter(&quot;user/*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>可以通过 <code>FilterRegistrationBean</code> 装饰器，以编程方式手动注册过滤器。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;在登录授权时，需要从 header 中获取 token 进行鉴权，通常使用过滤器处理指定的访问请求，但在使用 &lt;code&gt;@WebFilter&lt;/code&gt; 注解时，发现其路径匹配模式不生效，即 &lt;code&gt;url、urlPatterns&lt;/code&gt; 属性配置后，拦截了所有请求。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/"/>
    
    <category term="WebFilter" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/WebFilter/"/>
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/tags/Spring-Boot/"/>
    
    <category term="WebFilter" scheme="http://daiwenzh5.github.io/tags/WebFilter/"/>
    
    <category term="属性失效" scheme="http://daiwenzh5.github.io/tags/%E5%B1%9E%E6%80%A7%E5%A4%B1%E6%95%88/"/>
    
    <category term="urlPatterns" scheme="http://daiwenzh5.github.io/tags/urlPatterns/"/>
    
  </entry>
  
  <entry>
    <title>Bootstrap 多环境配置</title>
    <link href="http://daiwenzh5.github.io/2021/11/06/yuque/Bootstrap%20%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    <id>http://daiwenzh5.github.io/2021/11/06/yuque/Bootstrap%20%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</id>
    <published>2021-11-06T03:50:40.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>由于在 <code>bootstrap.yml</code> 文件中配置 CI/CD 的环境变量，而本地开发时并没有相关环境，所以需要手动切换其属性，在提交代码时，需要关注该配置文件是否会与云端冲突，极其浪费精力。<br>因此需要能够屏蔽本地与云端配置差异的手段。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>由于在测试过程中，发现使用 <code>bootstrap-local.yml</code> 的方式，无法成功切换环境，因此使用 spring 的指定外部配置文件的方式。通过在项目启动时，添加程序启动参数，手动指定配置文件所在路径 <code>--spring.config.location=classpath:/local/</code>。<br><strong>注意</strong>：<code>local </code> 是在 resources 下建立的目录，需要以 <code>/</code> 结尾表示其为目录。<br>当然，此处亦可精确指定加载哪个配置文件，但每个（放置在 resources 目录下的文件）都需要 <code>classpath:/</code> 开头，以表示其在类加载目录下，多个文件之间以 <code>,</code> 分割。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1636179267460-6b3276bd-cd67-45a0-9dd4-9b163e7b95db.png#clientId=u3f67ee5e-a41f-4&from=paste&height=423&id=u408245c0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=846&originWidth=1304&originalType=binary%E2%88%B6=1&size=105006&status=done&style=none&taskId=u3fbc3b8c-a563-4b16-bfe2-ff87e8c068a&width=652" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1636179267460-6b3276bd-cd67-45a0-9dd4-9b163e7b95db.png#clientId=u3f67ee5e-a41f-4&from=paste&height=423&id=u408245c0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=846&originWidth=1304&originalType=binary%E2%88%B6=1&size=105006&status=done&style=none&taskId=u3fbc3b8c-a563-4b16-bfe2-ff87e8c068a&width=652" srcset="data:image/png;base64,666" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;由于在 &lt;code&gt;bootstrap.yml&lt;/code&gt; 文件中配置 CI/CD 的环境变量，而本地开发时并没有相关环境，所以需要手动切换其属性，在提交代码时，需要关注该配置文件是否会与云端冲突，极其浪费精力。&lt;br&gt;因此需要能够屏蔽本地与云端配置差异的手段。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/"/>
    
    <category term="配置文件" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/tags/Spring-Boot/"/>
    
    <category term="配置文件" scheme="http://daiwenzh5.github.io/tags/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
    
    <category term="多环境" scheme="http://daiwenzh5.github.io/tags/%E5%A4%9A%E7%8E%AF%E5%A2%83/"/>
    
    <category term="Bootstrap" scheme="http://daiwenzh5.github.io/tags/Bootstrap/"/>
    
  </entry>
  
  <entry>
    <title>同时处理 XML 和 JSON 接口</title>
    <link href="http://daiwenzh5.github.io/2021/10/31/yuque/%E5%90%8C%E6%97%B6%E5%A4%84%E7%90%86%20XML%20%E5%92%8C%20JSON%20%E6%8E%A5%E5%8F%A3/"/>
    <id>http://daiwenzh5.github.io/2021/10/31/yuque/%E5%90%8C%E6%97%B6%E5%A4%84%E7%90%86%20XML%20%E5%92%8C%20JSON%20%E6%8E%A5%E5%8F%A3/</id>
    <published>2021-10-31T07:22:11.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>出入参同时支持 XML 和 JSON 格式。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>在接口请求映射器注解中，指定 consumes 的媒体类型，用于标记入参格式，指定 produces 的媒体类型，用于标记出参格式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;地址&quot;,</span></span><br><span class="line"><span class="meta">           consumes = &#123;</span></span><br><span class="line"><span class="meta">               MediaType.APPLICATION_JSON_VALUE,</span></span><br><span class="line"><span class="meta">               MediaType.APPLICATION_XML_VALUE</span></span><br><span class="line"><span class="meta">           &#125;,</span></span><br><span class="line"><span class="meta">           produces = &#123;</span></span><br><span class="line"><span class="meta">               MediaType.APPLICATION_JSON_VALUE,</span></span><br><span class="line"><span class="meta">               MediaType.APPLICATION_XML_VALUE</span></span><br><span class="line"><span class="meta">           &#125;)</span></span><br></pre></td></tr></table></figure><p>同时，需要在 pom 中添加 xml 处理依赖。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 一般的由默认的 spring jackson 依赖控制版本号 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.jaxrs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-jaxrs-xml-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;出入参同时支持 XML 和 JSON 格式。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/"/>
    
    <category term="参数处理" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86/"/>
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/tags/Spring-Boot/"/>
    
    <category term="参数处理" scheme="http://daiwenzh5.github.io/tags/%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86/"/>
    
    <category term="XML" scheme="http://daiwenzh5.github.io/tags/XML/"/>
    
    <category term="JSON" scheme="http://daiwenzh5.github.io/tags/JSON/"/>
    
  </entry>
  
  <entry>
    <title>字段类型不一致的问题分析</title>
    <link href="http://daiwenzh5.github.io/2021/06/11/yuque/%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/"/>
    <id>http://daiwenzh5.github.io/2021/06/11/yuque/%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</id>
    <published>2021-06-11T02:14:30.000Z</published>
    <updated>2022-04-17T03:31:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>使用 mybatis 的结果集自动映射，发生了实体属性类型与表字段类型不一致；但实际上，相关实体的属性与表结构完全匹配。<br>关于实体类，是使用代码生成读取表结构生成的，但使用了公共父类，其中抽取出了一些通用的字段（包括主键、创建时间等）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span>&lt;<span class="title">Id</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableId</span></span><br><span class="line">    <span class="keyword">protected</span> Id id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;create_by&quot;, fill = INSERT, updateStrategy = NEVER)</span></span><br><span class="line">    <span class="keyword">protected</span> String createBy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;create_time&quot;, fill = INSERT, updateStrategy = NEVER)</span></span><br><span class="line">    <span class="keyword">protected</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;update_by&quot;, fill = FieldFill.UPDATE)</span></span><br><span class="line">    <span class="keyword">protected</span> String updateBy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;update_time&quot;, fill = FieldFill.UPDATE)</span></span><br><span class="line">    <span class="keyword">protected</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(&quot;ext1&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String ext1;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(&quot;ext2&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String ext2;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(&quot;ext3&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String ext3;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(&quot;ext4&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String ext4;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>不必计较父类中设置主键的合理性。</p></blockquote><p>BaseEntity.java 是基于 mybatis-plus，因此所有字段添加了相应的注解。<br>实体中依赖 lombok 隐藏 getter、setter 的实现细节，并使用了 @Builder 辅助实体创建。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><ol><li>使用 mybatis plus 的注解式开发，默认启用了 mybatis 的结果集自动映射，会通过构造器创建实体；</li><li>使用 lombok @Builder，导致实体生成了不包含父类属性的全参构造器；</li><li>mybatis 反射获取实体属性，构建属性类型、字段类型以及字段名称的独立列表；</li><li>mybatis 反射获取到实体构造器，当没有默认构造器时，会根据构造器参数索引顺序匹配字段，由于构造器参数长度是小于字段长度的，导致参数类型不匹配；</li></ol><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>在代码中添加默认构造器（通过反射获取，与可见性无关）。</p><h3 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h3><ol><li>不要在表实体中使用 lombok 的 @Builder，@AllArgsConstructor，防止在继承父类时，产生不完全的“全参”构造器；</li><li>或者强制在表实体中启用 lombok 的 @NoArgsConstructor，保证一定存在无参构造器；</li><li>也可以在表实体目录中强制禁止相关 lombok 注解，防止其他开发无意中使用；</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lombok.allArgsConstructor.flagUsage &#x3D; ERROR</span><br><span class="line">lombok.builder.flagUsage &#x3D; ERROR</span><br></pre></td></tr></table></figure><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><h4 id="DefaultResultSetHandler-java"><a href="#DefaultResultSetHandler-java" class="headerlink" title="DefaultResultSetHandler.java"></a>DefaultResultSetHandler.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getRowValue</span><span class="params">(ResultSetWrapper rsw, ResultMap resultMap, String columnPrefix)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ResultLoaderMap lazyLoader = <span class="keyword">new</span> ResultLoaderMap();</span><br><span class="line">   <span class="comment">// 1、创建结果对象</span></span><br><span class="line">  Object rowValue = createResultObject(rsw, resultMap, lazyLoader, columnPrefix);</span><br><span class="line">  <span class="keyword">if</span> (rowValue != <span class="keyword">null</span> &amp;&amp; !hasTypeHandlerForResultObject(rsw, resultMap.getType())) &#123;</span><br><span class="line">    <span class="keyword">final</span> MetaObject metaObject = configuration.newMetaObject(rowValue);</span><br><span class="line">    <span class="keyword">boolean</span> foundValues = <span class="keyword">this</span>.useConstructorMappings;</span><br><span class="line">    <span class="keyword">if</span> (shouldApplyAutomaticMappings(resultMap, <span class="keyword">false</span>)) &#123;</span><br><span class="line">      foundValues = applyAutomaticMappings(rsw, resultMap, metaObject, columnPrefix) || foundValues;</span><br><span class="line">    &#125;</span><br><span class="line">    foundValues = applyPropertyMappings(rsw, resultMap, metaObject, lazyLoader, columnPrefix) || foundValues;</span><br><span class="line">    foundValues = lazyLoader.size() &gt; <span class="number">0</span> || foundValues;</span><br><span class="line">    rowValue = foundValues || configuration.isReturnInstanceForEmptyRow() ? rowValue : <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> rowValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createResultObject</span><span class="params">(ResultSetWrapper rsw, ResultMap resultMap, ResultLoaderMap lazyLoader, String columnPrefix)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.useConstructorMappings = <span class="keyword">false</span>; <span class="comment">// reset previous mapping result</span></span><br><span class="line">  <span class="keyword">final</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">final</span> List&lt;Object&gt; constructorArgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 2、创建结果对象（使用可能存在的构造参数）</span></span><br><span class="line">  Object resultObject = createResultObject(rsw, resultMap, constructorArgTypes, constructorArgs, columnPrefix);</span><br><span class="line">  <span class="keyword">if</span> (resultObject != <span class="keyword">null</span> &amp;&amp; !hasTypeHandlerForResultObject(rsw, resultMap.getType())) &#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;ResultMapping&gt; propertyMappings = resultMap.getPropertyResultMappings();</span><br><span class="line">    <span class="keyword">for</span> (ResultMapping propertyMapping : propertyMappings) &#123;</span><br><span class="line">      <span class="comment">// issue gcode #109 &amp;&amp; issue #149</span></span><br><span class="line">      <span class="keyword">if</span> (propertyMapping.getNestedQueryId() != <span class="keyword">null</span> &amp;&amp; propertyMapping.isLazy()) &#123;</span><br><span class="line">        resultObject = configuration.getProxyFactory().createProxy(resultObject, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.useConstructorMappings = resultObject != <span class="keyword">null</span> &amp;&amp; !constructorArgTypes.isEmpty(); <span class="comment">// set current mapping result</span></span><br><span class="line">  <span class="keyword">return</span> resultObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createResultObject</span><span class="params">(ResultSetWrapper rsw, ResultMap resultMap, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs, String columnPrefix)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Class&lt;?&gt; resultType = resultMap.getType();</span><br><span class="line">  <span class="keyword">final</span> MetaClass metaType = MetaClass.forClass(resultType, reflectorFactory);</span><br><span class="line">  <span class="keyword">final</span> List&lt;ResultMapping&gt; constructorMappings = resultMap.getConstructorResultMappings();</span><br><span class="line">  <span class="keyword">if</span> (hasTypeHandlerForResultObject(rsw, resultType)) &#123;</span><br><span class="line">    <span class="keyword">return</span> createPrimitiveResultObject(rsw, resultMap, columnPrefix);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!constructorMappings.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">return</span> createParameterizedResultObject(rsw, resultType, constructorMappings, constructorArgTypes, constructorArgs, columnPrefix);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resultType.isInterface() || metaType.hasDefaultConstructor()) &#123;</span><br><span class="line">      <span class="comment">// 2.1、使用无参构造器创建对象</span></span><br><span class="line">    <span class="keyword">return</span> objectFactory.create(resultType);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldApplyAutomaticMappings(resultMap, <span class="keyword">false</span>)) &#123;</span><br><span class="line">      <span class="comment">// 2.2、使用有参的构造器创建对象</span></span><br><span class="line">    <span class="keyword">return</span> createByConstructorSignature(rsw, resultType, constructorArgTypes, constructorArgs);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ExecutorException(<span class="string">&quot;Do not know how to create an instance of &quot;</span> + resultType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createByConstructorSignature</span><span class="params">(ResultSetWrapper rsw, Class&lt;?&gt; resultType, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Constructor&lt;?&gt;[] constructors = resultType.getDeclaredConstructors();</span><br><span class="line">  <span class="comment">// 3、获取构造器</span></span><br><span class="line">  <span class="keyword">final</span> Constructor&lt;?&gt; defaultConstructor = findDefaultConstructor(constructors);</span><br><span class="line">  <span class="keyword">if</span> (defaultConstructor != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 4、使用构造器创建对象</span></span><br><span class="line">    <span class="keyword">return</span> createUsingConstructor(rsw, resultType, constructorArgTypes, constructorArgs, defaultConstructor);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Constructor&lt;?&gt; constructor : constructors) &#123;</span><br><span class="line">      <span class="keyword">if</span> (allowedConstructorUsingTypeHandlers(constructor, rsw.getJdbcTypes())) &#123;</span><br><span class="line">        <span class="keyword">return</span> createUsingConstructor(rsw, resultType, constructorArgTypes, constructorArgs, constructor);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ExecutorException(<span class="string">&quot;No constructor found in &quot;</span> + resultType.getName() + <span class="string">&quot; matching &quot;</span> + rsw.getClassNames());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Constructor&lt;?&gt; findDefaultConstructor(<span class="keyword">final</span> Constructor&lt;?&gt;[] constructors) &#123;</span><br><span class="line">    <span class="comment">// 3.1、仅包含一个构造器直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (constructors.length == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> constructors[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.2、返回包含 @AutomapConstructor 的构造器</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">final</span> Constructor&lt;?&gt; constructor : constructors) &#123;</span><br><span class="line">    <span class="keyword">if</span> (constructor.isAnnotationPresent(AutomapConstructor.class)) &#123;</span><br><span class="line">      <span class="keyword">return</span> constructor;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createUsingConstructor</span><span class="params">(ResultSetWrapper rsw, Class&lt;?&gt; resultType, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs, Constructor&lt;?&gt; constructor)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> foundValues = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; constructor.getParameterTypes().length; i++) &#123;</span><br><span class="line">      <span class="comment">// 4.1、通过构造器参数进行匹配参数类型</span></span><br><span class="line">    Class&lt;?&gt; parameterType = constructor.getParameterTypes()[i];</span><br><span class="line">    String columnName = rsw.getColumnNames().get(i);</span><br><span class="line">    TypeHandler&lt;?&gt; typeHandler = rsw.getTypeHandler(parameterType, columnName);</span><br><span class="line">    Object value = typeHandler.getResult(rsw.getResultSet(), columnName);</span><br><span class="line">    constructorArgTypes.add(parameterType);</span><br><span class="line">    constructorArgs.add(value);</span><br><span class="line">    foundValues = value != <span class="keyword">null</span> || foundValues;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> foundValues ? objectFactory.create(resultType, constructorArgTypes, constructorArgs) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h2&gt;&lt;p&gt;使用 mybatis 的结果集自动映射，发生了实体属性类型与表字段类型不一致；但实际上，相关实体的属性与表结构完全匹配。&lt;br&gt;关于实体类，是使用代码生成读取表结构生成的，但使用了公共父类，其中抽取出了一些通用的字段（包括主键、创建时间等）。&lt;/p&gt;</summary>
    
    
    
    <category term="Mybatis" scheme="http://daiwenzh5.github.io/categories/Mybatis/"/>
    
    <category term="结果集" scheme="http://daiwenzh5.github.io/categories/Mybatis/%E7%BB%93%E6%9E%9C%E9%9B%86/"/>
    
    
    <category term="Mybatis" scheme="http://daiwenzh5.github.io/tags/Mybatis/"/>
    
    <category term="结果集" scheme="http://daiwenzh5.github.io/tags/%E7%BB%93%E6%9E%9C%E9%9B%86/"/>
    
    <category term="Lombok" scheme="http://daiwenzh5.github.io/tags/Lombok/"/>
    
    <category term="异常分析" scheme="http://daiwenzh5.github.io/tags/%E5%BC%82%E5%B8%B8%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>JetCache 使用</title>
    <link href="http://daiwenzh5.github.io/2021/04/23/yuque/JetCache%20%E4%BD%BF%E7%94%A8/"/>
    <id>http://daiwenzh5.github.io/2021/04/23/yuque/JetCache%20%E4%BD%BF%E7%94%A8/</id>
    <published>2021-04-23T06:01:54.000Z</published>
    <updated>2022-04-17T03:31:42.054Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="Optional-支持"><a href="#Optional-支持" class="headerlink" title="Optional 支持"></a>Optional 支持</h3><p>由于 Optional 并不支持序列化，因此无法直接将其作为方法返回值、托管给 JetCache。必须对其进行拓展，添加自定义的编码器以及解码器。</p><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><p>依赖于 com.alicp.jetcache:jetcache-core:2.5.16。</p><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>只要将自定义的编码器注册为 bean 即可。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jetcache:</span></span><br><span class="line">  <span class="attr">remote:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">valueEncoder:</span> <span class="string">bean:jetValueEncoder</span></span><br></pre></td></tr></table></figure><h4 id="编码器实现"><a href="#编码器实现" class="headerlink" title="编码器实现"></a>编码器实现</h4><ol><li>在序列化之前，将 Optional 中的值取出，并在打上自定义的标记（IDENTITY_NUMBER 的值），对于非 Optional 类型的数据，则沿用默认的编码器器（JavaValueEncoder）；</li><li>编码器需要注册成 spring bean，启用自定义标记之后，解码器则通过读取自定义标记进行匹配；</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JetValueEncoder</span> <span class="keyword">extends</span> <span class="title">JavaValueEncoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INIT_BUF_SIZE = <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;WeakReference&lt;ByteArrayOutputStream&gt;&gt; THREAD_LOCAL =</span><br><span class="line">            ThreadLocal.withInitial(() -&gt; <span class="keyword">new</span> WeakReference&lt;&gt;(<span class="keyword">new</span> ByteArrayOutputStream(INIT_BUF_SIZE)));</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">int</span> IDENTITY_NUMBER = <span class="number">0x4A953A84</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JetValueEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JetValueEncoder</span><span class="params">(<span class="keyword">boolean</span> useIdentityNumber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(useIdentityNumber);</span><br><span class="line">        registerDecoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册解码器，此处为匿名内部类，直接实例并注册到 DecoderMap，</span></span><br><span class="line">    <span class="comment">// 键值为JetValueEncoder.IDENTITY_NUMBER，自定义标记</span></span><br><span class="line">    <span class="comment">// 实现逻辑，在反序列化之后，将标记匹配的值封装到 Optional 中</span></span><br><span class="line">    <span class="comment">// 标记不匹配的，则被其他解码器处理，不用考虑</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SpringJavaValueDecoder decoder = <span class="keyword">new</span> SpringJavaValueDecoder(<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">doApply</span><span class="params">(<span class="keyword">byte</span>[] buffer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Object obj = <span class="keyword">super</span>.doApply(buffer);</span><br><span class="line">                <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> CacheValueHolder) &#123;</span><br><span class="line">                    CacheValueHolder&lt;Object&gt; valueHolder = (CacheValueHolder&lt;Object&gt;) obj;</span><br><span class="line">                    valueHolder.setValue(Optional.ofNullable(valueHolder.getValue()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> obj;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        DecoderMap.register(JetValueEncoder.IDENTITY_NUMBER, decoder);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] apply(Object value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> CacheValueHolder) &#123;</span><br><span class="line">            CacheValueHolder&lt;Object&gt; valueHolder = (CacheValueHolder&lt;Object&gt;) value;</span><br><span class="line">            Object holderValue = ((CacheValueHolder&lt;?&gt;) value).getValue();</span><br><span class="line">            <span class="keyword">if</span> (holderValue <span class="keyword">instanceof</span> Optional) &#123;</span><br><span class="line">                Optional&lt;?&gt; valeOpt = (Optional&lt;?&gt;) holderValue;</span><br><span class="line">                valeOpt.ifPresent(valueHolder::setValue);</span><br><span class="line">                <span class="keyword">return</span> doApply(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.apply(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从父类中拷贝，由于父类中 IDENTITY_NUMBER 是静态变量，&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     * 且没有提供可重构 getter，所以不得不进行代码搬运法。╮(╯▽╰)╭&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     * 父类中应该使用 getIdentityNumber() 方法获取 IDENTITY_NUMBER 的值，&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> JavaValueEncoder#apply(Object)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] doApply(Object value) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            WeakReference&lt;ByteArrayOutputStream&gt; ref = THREAD_LOCAL.get();</span><br><span class="line">            ByteArrayOutputStream bos = ref.get();</span><br><span class="line">            <span class="keyword">if</span> (bos == <span class="keyword">null</span>) &#123;</span><br><span class="line">                bos = <span class="keyword">new</span> ByteArrayOutputStream(INIT_BUF_SIZE);</span><br><span class="line">                THREAD_LOCAL.set(<span class="keyword">new</span> WeakReference&lt;&gt;(bos));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (useIdentityNumber) &#123;</span><br><span class="line">                    bos.write((IDENTITY_NUMBER &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    bos.write((IDENTITY_NUMBER &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    bos.write((IDENTITY_NUMBER &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    bos.write(IDENTITY_NUMBER &amp; <span class="number">0xFF</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">                oos.writeObject(value);</span><br><span class="line">                oos.flush();</span><br><span class="line">                <span class="keyword">return</span> bos.toByteArray();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                bos.reset();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CacheEncodeException(<span class="string">&quot;Java Encode error. &quot;</span> + <span class="string">&quot;msg=&quot;</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>从源码中 <code>SpringConfigProvider#parseValueEncoder</code> 可以找到编码器的加载入口，当 valueEncoder 属性匹配到 “bean:”前缀的编码器时，则启用该 bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1、ExternalCacheAutoInit#parseGeneralConfig</span></span><br><span class="line">   <span class="comment">// 自动初始化配置</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseGeneralConfig</span><span class="params">(CacheBuilder builder, ConfigTree ct)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.parseGeneralConfig(builder, ct);</span><br><span class="line">       ExternalCacheBuilder ecb = (ExternalCacheBuilder) builder;</span><br><span class="line">       ecb.setKeyPrefix(ct.getProperty(<span class="string">&quot;keyPrefix&quot;</span>));</span><br><span class="line">       <span class="comment">// 设置编码器，指定了配置中的 key：valueEncoder</span></span><br><span class="line">       ecb.setValueEncoder(configProvider.parseValueEncoder(ct.getProperty(<span class="string">&quot;valueEncoder&quot;</span>, CacheConsts.DEFAULT_SERIAL_POLICY)));</span><br><span class="line">       ecb.setValueDecoder(configProvider.parseValueDecoder(ct.getProperty(<span class="string">&quot;valueDecoder&quot;</span>, CacheConsts.DEFAULT_SERIAL_POLICY)));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2、SpringConfigProvider#parseValueEncoder</span></span><br><span class="line">   <span class="comment">// spring 环境中的配置规则，先尝试搜索是否存在注册为 spring bean 的编码器</span></span><br><span class="line">   <span class="keyword">public</span> Function&lt;Object, <span class="keyword">byte</span>[]&gt; parseValueEncoder(String valueEncoder) &#123;</span><br><span class="line">       <span class="comment">// 进入 bean 加载方法</span></span><br><span class="line">       String beanName = parseBeanName(valueEncoder);</span><br><span class="line">       <span class="comment">// bean 名称存在时注册 spring 托管的编码器</span></span><br><span class="line">       <span class="keyword">if</span> (beanName == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">super</span>.parseValueEncoder(valueEncoder);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           Object bean = applicationContext.getBean(beanName);</span><br><span class="line">           <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Function) &#123;</span><br><span class="line">               <span class="keyword">return</span> (Function&lt;Object, <span class="keyword">byte</span>[]&gt;) bean;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> ((SerialPolicy) bean).encoder();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3、SpringConfigProvider#parseBeanName</span></span><br><span class="line"><span class="comment">// bean 名称的解析，需要在配置文件中指定 valueEncode 属性：&#x27;bean:anyName&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">parseBeanName</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 通过 “bean:” 前缀匹配 bean 名称</span></span><br><span class="line">       <span class="keyword">final</span> String beanPrefix = <span class="string">&quot;bean:&quot;</span>;</span><br><span class="line">       <span class="keyword">int</span> len = beanPrefix.length();</span><br><span class="line">       <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; str.startsWith(beanPrefix) &amp;&amp; str.length() &gt; len) &#123;</span><br><span class="line">           <span class="keyword">return</span> str.substring(len);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4、AbstractValueDecoder#apply</span></span><br><span class="line">   <span class="comment">// 解码器入口，对于 useIdentityNumber = true，及开启自定义标记的序列化数据，</span></span><br><span class="line">   <span class="comment">// 需要在 DecoderMap 中通过 identityNumber 进行匹配</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">apply</span><span class="params">(<span class="keyword">byte</span>[] buffer)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (useIdentityNumber) &#123;</span><br><span class="line">               DecoderMap.registerBuildInDecoder();</span><br><span class="line">               <span class="keyword">int</span> identityNumber = parseHeader(buffer);</span><br><span class="line">               AbstractValueDecoder decoder = DecoderMap.getDecoder(identityNumber);</span><br><span class="line">               Objects.requireNonNull(decoder, <span class="string">&quot;no decoder for identity number:&quot;</span> + identityNumber);</span><br><span class="line">               <span class="keyword">return</span> decoder.doApply(buffer);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> doApply(buffer);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> CacheEncodeException(<span class="string">&quot;decode error&quot;</span>, e);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;h2 id=&quot;解决方案&quot;&gt;&lt;a href=&quot;#解决方案&quot; class=&quot;headerlink&quot; title=&quot;解决方案&quot;&gt;&lt;/a&gt;解决方案&lt;/h2&gt;</summary>
    
    
    
    <category term="缓存" scheme="http://daiwenzh5.github.io/categories/%E7%BC%93%E5%AD%98/"/>
    
    <category term="Redis" scheme="http://daiwenzh5.github.io/categories/%E7%BC%93%E5%AD%98/Redis/"/>
    
    
    <category term="JetCache" scheme="http://daiwenzh5.github.io/tags/JetCache/"/>
    
    <category term="多级缓存" scheme="http://daiwenzh5.github.io/tags/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/"/>
    
    <category term="使用" scheme="http://daiwenzh5.github.io/tags/%E4%BD%BF%E7%94%A8/"/>
    
    <category term="拓展" scheme="http://daiwenzh5.github.io/tags/%E6%8B%93%E5%B1%95/"/>
    
  </entry>
  
  <entry>
    <title>Feign 自定义配置</title>
    <link href="http://daiwenzh5.github.io/2021/03/30/yuque/Feign%20%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/"/>
    <id>http://daiwenzh5.github.io/2021/03/30/yuque/Feign%20%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/</id>
    <published>2021-03-30T08:02:00.000Z</published>
    <updated>2022-04-17T03:31:42.054Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在微服务项目中，需要请求第三方接口，通常情况下我们使用 spring 的 restTemplate。但接触到 feign 之后，这种将远程方法伪装成本地接口，屏蔽请求感知的方式，无疑更优雅。<br>但对于 oauth 认证，需要配置请求头，即设置 feign 的自定义配置。</p><h2 id="自定义授权头信息"><a href="#自定义授权头信息" class="headerlink" title="自定义授权头信息"></a>自定义授权头信息</h2><h3 id="请求远程连接"><a href="#请求远程连接" class="headerlink" title="请求远程连接"></a>请求远程连接</h3><p><code>@FeignClient</code> 用于注册接口为 feign 客户端，在 spring cloud 项目中，需要在其 value（或 name）属性中指定对应的微服务名，url 置空（将自动匹配配置中西地址）。当需要调用任意的 http 请求时，只要给定 url 值即可。<br><strong>注意</strong> ：此时，虽然不是请求微服务接口，仍然需要设置 name，填写任意（不冲突的）名称即可。</p><h3 id="授权流程"><a href="#授权流程" class="headerlink" title="授权流程"></a>授权流程</h3><h3 id="授权配置"><a href="#授权配置" class="headerlink" title="授权配置"></a>授权配置</h3><p>需要通过自定义配置属性来指定请求头，对应 <code>@FeignClient</code> 的 configuration 属性。<br>该属性指定一个自定义配置类，用于设置 feign 的任意配置。</p><h4 id="Basic-认证"><a href="#Basic-认证" class="headerlink" title="Basic 认证"></a>Basic 认证</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @Configuration 托管给 spring 之后，会被注册为全局配置</span></span><br><span class="line"><span class="comment">// 局部配置需要指定在 @FeignClient(configuration = SomeAuthConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeAuthConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BasicAuthRequestInterceptor <span class="title">basicAuthRequestInterceptor</span><span class="params">(SomeProperties someProperties)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// someProperties 是一个属性类</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BasicAuthRequestInterceptor(</span><br><span class="line">                someProperties.getAuth().getUser(),</span><br><span class="line">                someProperties.getAuth().getPassword()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="请求-token"><a href="#请求-token" class="headerlink" title="请求 token"></a>请求 token</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(</span></span><br><span class="line"><span class="meta">        name = &quot;some-auth&quot;, url = &quot;$&#123;some.auth.url&#125;&quot;,</span></span><br><span class="line"><span class="meta">        configuration = SomeAuthConfig.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SomeAuthIntegration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 token</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 授权信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/xxx&quot;)</span></span><br><span class="line">    <span class="function">SomeAuthResponse <span class="title">getToken</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="设置-Authorization-Header"><a href="#设置-Authorization-Header" class="headerlink" title="设置 Authorization Header"></a>设置 Authorization Header</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeTokenConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置 header auth</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authIntegration 授权接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 请求拦截器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestInterceptor <span class="title">requestInterceptor</span><span class="params">(SomeAuthIntegration authIntegration)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 此处使用的是 lambda 表达式返回一个实现 RequestInterceptor 的匿名类，</span></span><br><span class="line">        <span class="comment">// 在 lambda 表达式外部的操作会在 bean 注册时生效，</span></span><br><span class="line">        <span class="comment">// 因此，每次获取 token 的操作，应该放在表达式内部</span></span><br><span class="line">        <span class="keyword">return</span> requestTemplate -&gt; &#123;</span><br><span class="line">            SomeAuthResponse authResponse = authIntegration.getToken();</span><br><span class="line">            requestTemplate.header(</span><br><span class="line">                    AUTHORIZATION,</span><br><span class="line">                    StrUtil.format(<span class="string">&quot;&#123;&#125; &#123;&#125;&quot;</span>, authResponse.getTokenType(), authResponse.getAccessToken())</span><br><span class="line">            );</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="已授权请求"><a href="#已授权请求" class="headerlink" title="已授权请求"></a>已授权请求</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(</span></span><br><span class="line"><span class="meta">        name = &quot;some-reply&quot;, url = &quot;$&#123;some.reply.url&#125;&quot;,</span></span><br><span class="line"><span class="meta">        configuration = SomeTokenConfig.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SomeReplyIntegration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回传状态</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status 状态信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/xxx&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(SomeStatus status)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自定义解码器"><a href="#自定义解码器" class="headerlink" title="自定义解码器"></a>自定义解码器</h2><p>当响应信息实际返回的是 json 格式，但头信息描述类型是 <em>Content-Type: text/xml;charset=utf-8</em> （或其他非 *application/json *类型）时，feign 的默认消息转换器无法解析，此时就需要重新使用自定义解码器。<br>在配置类中注册 Decoder bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Decoder <span class="title">someResponseDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SpringDecoder(() -&gt; <span class="keyword">new</span> HttpMessageConverters(</span><br><span class="line">            <span class="keyword">new</span> MappingJackson2HttpMessageConverter() &#123;</span><br><span class="line">                &#123;</span><br><span class="line">                    setSupportedMediaTypes(Lists.newArrayList(MediaType.TEXT_XML));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>feing 基于 http 请求，在其配置类中，可以实现任意 http 的相关配置，包括超时时间、重试次数等。<br>一般情况下，accessToken 存在过期时间，为了防止频繁请求授权，应该在过期之前进行缓存。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;在微服务项目中，需要请求第三方接口，通常情况下我们使用 spring 的 restTemplate。但接触到 feign 之后，这种将远程方法伪装成本地接口，屏蔽请求感知的方式，无疑更优雅。&lt;br&gt;但对于 oauth 认证，需要配置请求头，即设置 feign 的自定义配置。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring" scheme="http://daiwenzh5.github.io/categories/Spring/"/>
    
    <category term="Feign" scheme="http://daiwenzh5.github.io/categories/Spring/Feign/"/>
    
    
    <category term="Feign" scheme="http://daiwenzh5.github.io/tags/Feign/"/>
    
    <category term="Configuration" scheme="http://daiwenzh5.github.io/tags/Configuration/"/>
    
    <category term="HTTP" scheme="http://daiwenzh5.github.io/tags/HTTP/"/>
    
    <category term="拦截器" scheme="http://daiwenzh5.github.io/tags/%E6%8B%A6%E6%88%AA%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>实现 Jar 多版本共存</title>
    <link href="http://daiwenzh5.github.io/2021/03/22/yuque/%E5%AE%9E%E7%8E%B0%20Jar%20%E5%A4%9A%E7%89%88%E6%9C%AC%E5%85%B1%E5%AD%98/"/>
    <id>http://daiwenzh5.github.io/2021/03/22/yuque/%E5%AE%9E%E7%8E%B0%20Jar%20%E5%A4%9A%E7%89%88%E6%9C%AC%E5%85%B1%E5%AD%98/</id>
    <published>2021-03-22T15:04:51.000Z</published>
    <updated>2022-04-17T03:31:42.054Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>现需要实现同时共存两个版本的 SDK，其中存在限定名完全相同的类，但两个类的方法并不完全相同，导致 JVM 在加载时无法按预期的调用类方法。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>由于 SDK 中依赖了大量的封装对象，无法使用简单的反射调用方法，因此自定义类加载器并不能解决。首先想到的是使用 maven 插件，在编译时修改指定的 SDK 的类名，<code>maven-shade-plugin</code> 并不能很好的解决，按照博客中的经验，可以将待处理的模块在一个空白模块中引入，并使用 shade 进行重命名，但是实际类引用的时候，依旧是原类名，只有在 maven 打包后，新名称将被替换值 class 文件中，这就导致了，如果有多个模块进行了调用 SDK，则需要处理多个模块，而且经常出现预期之外的问题，耗费精力。<br>最终是使用 <a href="https://github.com/google/jarjar">jarjar</a> 来解决的。<br><a href="https://code.google.com/archive/p/jarjar/">下载地址</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar jarjar.jar process rule.txt old.jar new.jar</span><br></pre></td></tr></table></figure><p>其中，rule.txt 是任意文件名，其中指定了替换规则：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rule com.old.package.** com.new.package.@1</span><br></pre></td></tr></table></figure><p>或者使用 <a href="http://sonatype.github.io/jarjar-maven-plugin/">jarjar-maven-plugin</a>（未验证）</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;现需要实现同时共存两个版本的 SDK，其中存在限定名完全相同的类，但两个类的方法并不完全相同，导致 JVM 在加载时无法按预期的调用类方法。&lt;/p&gt;</summary>
    
    
    
    <category term="工具" scheme="http://daiwenzh5.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    <category term="Java" scheme="http://daiwenzh5.github.io/categories/%E5%B7%A5%E5%85%B7/Java/"/>
    
    
    <category term="工具" scheme="http://daiwenzh5.github.io/tags/%E5%B7%A5%E5%85%B7/"/>
    
    <category term="Java" scheme="http://daiwenzh5.github.io/tags/Java/"/>
    
    <category term="Jar 冲突" scheme="http://daiwenzh5.github.io/tags/Jar-%E5%86%B2%E7%AA%81/"/>
    
    <category term="多版本" scheme="http://daiwenzh5.github.io/tags/%E5%A4%9A%E7%89%88%E6%9C%AC/"/>
    
  </entry>
  
  <entry>
    <title>打包外部依赖</title>
    <link href="http://daiwenzh5.github.io/2021/03/21/yuque/%E6%89%93%E5%8C%85%E5%A4%96%E9%83%A8%E4%BE%9D%E8%B5%96/"/>
    <id>http://daiwenzh5.github.io/2021/03/21/yuque/%E6%89%93%E5%8C%85%E5%A4%96%E9%83%A8%E4%BE%9D%E8%B5%96/</id>
    <published>2021-03-21T09:30:02.000Z</published>
    <updated>2022-04-17T03:31:42.054Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>由于公司 SDK 没有正式上线，只能提供 jar，需要手动添加依赖，在使用 maven 打包的时候提示找不到符号。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>将外部 jar 使用 maven 管理</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 因为实际不会从远程仓库下载，因此坐标可以填写任意值 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>任意值<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>任意值<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>任意值<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- scope 必须是 system，表明是从本地读取信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>项目中的相对路径<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 额外配置，</span></span><br><span class="line"><span class="comment">默认情况下，外部依赖只会在编译时加载，打包后会丢失，</span></span><br><span class="line"><span class="comment">需要增加以下配置</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- includeSystemScope 开启即可--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">includeSystemScope</span>&gt;</span>true<span class="tag">&lt;/<span class="name">includeSystemScope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;由于公司 SDK 没有正式上线，只能提供 jar，需要手动添加依赖，在使用 maven 打包的时候提示找不到符号。&lt;/p&gt;</summary>
    
    
    
    <category term="Maven" scheme="http://daiwenzh5.github.io/categories/Maven/"/>
    
    <category term="打包" scheme="http://daiwenzh5.github.io/categories/Maven/%E6%89%93%E5%8C%85/"/>
    
    
    <category term="Maven" scheme="http://daiwenzh5.github.io/tags/Maven/"/>
    
    <category term="Lib" scheme="http://daiwenzh5.github.io/tags/Lib/"/>
    
    <category term="Install" scheme="http://daiwenzh5.github.io/tags/Install/"/>
    
    <category term="外部依赖" scheme="http://daiwenzh5.github.io/tags/%E5%A4%96%E9%83%A8%E4%BE%9D%E8%B5%96/"/>
    
  </entry>
  
  <entry>
    <title>LocalDate 解析年月字符串</title>
    <link href="http://daiwenzh5.github.io/2021/02/07/yuque/LocalDate%20%E8%A7%A3%E6%9E%90%E5%B9%B4%E6%9C%88%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    <id>http://daiwenzh5.github.io/2021/02/07/yuque/LocalDate%20%E8%A7%A3%E6%9E%90%E5%B9%B4%E6%9C%88%E5%AD%97%E7%AC%A6%E4%B8%B2/</id>
    <published>2021-02-07T09:20:53.000Z</published>
    <updated>2022-04-17T03:31:42.054Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>使用 LocalDate 解析 <code>yyyy-MM</code> 格式的字符串时异常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.time.DateTimeException: Unable to obtain LocalDate from TemporalAccessor: &#123;Year&#x3D;2021, MonthOfYear&#x3D;1&#125;,ISO of type java.time.format.Parsed</span><br><span class="line">at java.time.LocalDate.from(LocalDate.java:368)</span><br><span class="line">at java.time.format.Parsed.query(Parsed.java:226)</span><br><span class="line">at java.time.format.DateTimeFormatter.parse(DateTimeFormatter.java:1851)</span><br><span class="line">... 2 more</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>字符串解析到 LocalDate 必须具体到日期，因此需要给年月的格式添加默认日期，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ① 调整 DateTimeFormatter</span></span><br><span class="line">     DateTimeFormatter fmt = <span class="keyword">new</span> DateTimeFormatterBuilder()</span><br><span class="line">            .appendPattern(<span class="string">&quot;yyyy-MM&quot;</span>)</span><br><span class="line">        <span class="comment">// 添加默认日期</span></span><br><span class="line">            .parseDefaulting(ChronoField.DAY_OF_MONTH, <span class="number">1</span>)</span><br><span class="line">            .toFormatter();</span><br><span class="line">    <span class="comment">// ② 使用 YearMonth 转换</span></span><br><span class="line">    YearMonth yearMonth = YearMonth.parse(<span class="string">&quot;2021-01&quot;</span>, fmt);</span><br><span class="line">    LocalDate localDate = yearMonth.atEndOfMonth();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;使用 LocalDate 解析 &lt;code&gt;yyyy-MM&lt;/code&gt; 格式的字符串时异常：&lt;/p&gt;</summary>
    
    
    
    <category term="JDK8" scheme="http://daiwenzh5.github.io/categories/JDK8/"/>
    
    <category term="Time" scheme="http://daiwenzh5.github.io/categories/JDK8/Time/"/>
    
    
    <category term="JDK8" scheme="http://daiwenzh5.github.io/tags/JDK8/"/>
    
    <category term="Time" scheme="http://daiwenzh5.github.io/tags/Time/"/>
    
    <category term="LocalDate" scheme="http://daiwenzh5.github.io/tags/LocalDate/"/>
    
    <category term="日期格式化" scheme="http://daiwenzh5.github.io/tags/%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>发布到私有仓库</title>
    <link href="http://daiwenzh5.github.io/2021/02/06/yuque/%E5%8F%91%E5%B8%83%E5%88%B0%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/"/>
    <id>http://daiwenzh5.github.io/2021/02/06/yuque/%E5%8F%91%E5%B8%83%E5%88%B0%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/</id>
    <published>2021-02-05T17:37:56.000Z</published>
    <updated>2022-04-17T03:31:42.054Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>需要将工具类发布到公司的私有仓库中，为了避免每次手动在页面上操作，此处借助 maven 命令行和 idea 启动项实现一键发布。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="配置服务器地址"><a href="#配置服务器地址" class="headerlink" title="配置服务器地址"></a>配置服务器地址</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- maven settings.xml --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 未配置时会提示 401 权限不足 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>仓库名<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">username</span>&gt;</span>账号<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">password</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="发布命令"><a href="#发布命令" class="headerlink" title="发布命令"></a>发布命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令</span></span><br><span class="line">mvn deploy:deploy-file</span><br><span class="line"></span><br><span class="line"><span class="comment">## 自定义参数 -Dparam</span></span><br><span class="line"><span class="comment">## -DgroupId=项目</span></span><br><span class="line"><span class="comment">## -DartifactId=模块</span></span><br><span class="line"><span class="comment">## -Dversion=版本号</span></span><br><span class="line"><span class="comment">## -Dpackaging=打包方式</span></span><br><span class="line"><span class="comment">## -Dfile=本地路径</span></span><br><span class="line"><span class="comment">## -Dsources=源码路径</span></span><br><span class="line"><span class="comment">## -Durl=仓库地址</span></span><br><span class="line"><span class="comment">## -DrepositoryId=指定仓库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如:</span></span><br><span class="line">mvn deploy:deploy-file \</span><br><span class="line">-DgroupId=com.xyz \</span><br><span class="line">-DartifactId=<span class="built_in">test</span> \</span><br><span class="line">-Dversion=1.0.0 \</span><br><span class="line">-Dpackaging=jar \</span><br><span class="line">-Dfile=path/name-1.0.0.jar \</span><br><span class="line">-Dsources=path/name-1.0.0-sources.jar \</span><br><span class="line">-Durl=http://ip/nexus/content/repositories/thirdparty/ \</span><br><span class="line">-DrepositoryId=thirdparty</span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令中可以使用 pom 变量，如 -Dversion=$&#123;project.version&#125;</span></span><br></pre></td></tr></table></figure><h3 id="Idea-中的配置"><a href="#Idea-中的配置" class="headerlink" title="Idea 中的配置"></a>Idea 中的配置</h3><p><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1612548053894-e9ae4173-6e15-4b1c-9a75-f21e63819b56.png#align=left&display=inline&height=883&margin=%5Bobject%20Object%5D&name=image.png&originHeight=883&originWidth=1343&size=128863&status=done&style=none&width=1343" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1612548053894-e9ae4173-6e15-4b1c-9a75-f21e63819b56.png#align=left&display=inline&height=883&margin=%5Bobject%20Object%5D&name=image.png&originHeight=883&originWidth=1343&size=128863&status=done&style=none&width=1343" srcset="data:image/png;base64,666" alt="image.png"><br>此后就可以一键发布了。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1612548199808-4f6c438d-580b-4f28-b336-1bf94f167a8c.png#align=left&display=inline&height=40&margin=%5Bobject%20Object%5D&name=image.png&originHeight=40&originWidth=426&size=11831&status=done&style=none&width=426" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1612548199808-4f6c438d-580b-4f28-b336-1bf94f167a8c.png#align=left&display=inline&height=40&margin=%5Bobject%20Object%5D&name=image.png&originHeight=40&originWidth=426&size=11831&status=done&style=none&width=426" srcset="data:image/png;base64,666" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;需要将工具类发布到公司的私有仓库中，为了避免每次手动在页面上操作，此处借助 maven 命令行和 idea 启动项实现一键发布。&lt;/p&gt;</summary>
    
    
    
    <category term="Maven" scheme="http://daiwenzh5.github.io/categories/Maven/"/>
    
    <category term="命令行" scheme="http://daiwenzh5.github.io/categories/Maven/%E5%91%BD%E4%BB%A4%E8%A1%8C/"/>
    
    
    <category term="Maven" scheme="http://daiwenzh5.github.io/tags/Maven/"/>
    
    <category term="Deploy" scheme="http://daiwenzh5.github.io/tags/Deploy/"/>
    
    <category term="Idea" scheme="http://daiwenzh5.github.io/tags/Idea/"/>
    
    <category term="命令行" scheme="http://daiwenzh5.github.io/tags/%E5%91%BD%E4%BB%A4%E8%A1%8C/"/>
    
  </entry>
  
</feed>
