<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Z&#39;s blog</title>
  
  
  <link href="http://daiwenzh5.github.io/atom.xml" rel="self"/>
  
  <link href="http://daiwenzh5.github.io/"/>
  <updated>2020-12-21T09:51:49.227Z</updated>
  <id>http://daiwenzh5.github.io/</id>
  
  <author>
    <name>daiwenzh5</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>RunnerLayoutUi</title>
    <link href="http://daiwenzh5.github.io/2020/12/20/yuque/RunnerLayoutUi/"/>
    <id>http://daiwenzh5.github.io/2020/12/20/yuque/RunnerLayoutUi/</id>
    <published>2020-12-20T09:20:08.000Z</published>
    <updated>2020-12-21T09:51:49.227Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>仅用于记录插件开发时踩的坑</p></blockquote><h2 id="接口介绍"><a href="#接口介绍" class="headerlink" title="接口介绍"></a>接口介绍</h2><p><code>AnAction</code> 是 Intellij Idea SDK 提供的按钮接口实现下的抽象类，通过继承此类，可以轻易的实现符合 Intellij UI 设计风格的自定义按钮组件。<br>Intellij SDK 中就内置了大量 AnAction 子类，下面是自定义实现的主要重写方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按钮点击时执行</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="拓展子类"><a href="#拓展子类" class="headerlink" title="拓展子类"></a>拓展子类</h2><h3 id="ToggleAction"><a href="#ToggleAction" class="headerlink" title="ToggleAction"></a>ToggleAction</h3><p>用于表示具有选定状态，且在执行（点击按钮）时切换其选定状态的动作。如控制台日志滚动时的自动换行按钮，以及滚动跟随按钮。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断按钮是否被选中</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isSelected</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置按钮何时被设置为选中状态</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setSelected</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e, <span class="keyword">boolean</span> state)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="辅助类"><a href="#辅助类" class="headerlink" title="辅助类"></a>辅助类</h2><h3 id="ActionToolbar"><a href="#ActionToolbar" class="headerlink" title="ActionToolbar"></a>ActionToolbar</h3><p>工具栏，用于操作控制台的一组按钮。<br>在 Git 面板，如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445577369-80a7b177-a107-4c1b-a7d2-a3a1bcdac69d.png#align=left&display=inline&height=315&margin=%5Bobject%20Object%5D&name=image.png&originHeight=315&originWidth=604&size=159886&status=done&style=none&width=604" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445577369-80a7b177-a107-4c1b-a7d2-a3a1bcdac69d.png#align=left&display=inline&height=315&margin=%5Bobject%20Object%5D&name=image.png&originHeight=315&originWidth=604&size=159886&status=done&style=none&width=604" srcset="data:image/png;base64,666" alt="image.png"></p><h4 id="创建方法"><a href="#创建方法" class="headerlink" title="创建方法"></a>创建方法</h4><p><code>ActionManager#createActionToolbar(String, ActionGroup, boolean)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createToolbar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 创建一个按钮组</span></span><br><span class="line">     <span class="keyword">final</span> DefaultActionGroup actions = <span class="keyword">new</span> DefaultActionGroup();</span><br><span class="line">     <span class="comment">// 通过 ConsoleView#createConsoleActions() 方法创建默认按钮</span></span><br><span class="line">     actions.addAll(consoleView.createConsoleActions());</span><br><span class="line">     <span class="comment">// 创建工具栏</span></span><br><span class="line">     ActionToolbar actionToolbar = ActionManager.getInstance()</span><br><span class="line">             .createActionToolbar(ActionPlaces.TOOLBAR, actions, <span class="keyword">false</span>);</span><br><span class="line">     <span class="comment">// 添加到控制台</span></span><br><span class="line">     consoleView.getComponent().add(actionToolbar.getComponent());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>在 <code>ConsoleViewImpl#createConsoleActions()</code> 中提供如下按钮组<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445934503-8f3f4941-7dc1-4d11-95de-c71ae22e08a1.png#align=left&display=inline&height=210&margin=%5Bobject%20Object%5D&name=image.png&originHeight=210&originWidth=32&size=1338&status=done&style=none&width=32" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445934503-8f3f4941-7dc1-4d11-95de-c71ae22e08a1.png#align=left&display=inline&height=210&margin=%5Bobject%20Object%5D&name=image.png&originHeight=210&originWidth=32&size=1338&status=done&style=none&width=32" srcset="data:image/png;base64,666" alt="image.png"></p><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p><code>ConsoleView#createConsoleActions</code> 中需要 Editor 组件被初始化，因此需要先执行 <code>ConsoleView#getComponent</code> 方法。</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;仅用于记录插件开发时踩的坑&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;接口介绍&quot;&gt;&lt;a href=&quot;#接口介绍&quot; class=&quot;headerlink&quot; title=&quot;接口介绍&quot;&gt;&lt;/a&gt;接口介绍&lt;/h2&gt;</summary>
    
    
    
    <category term="Intellij Idea" scheme="http://daiwenzh5.github.io/categories/Intellij-Idea/"/>
    
    <category term="plugin" scheme="http://daiwenzh5.github.io/categories/Intellij-Idea/plugin/"/>
    
    
    <category term="Intellij Idea" scheme="http://daiwenzh5.github.io/tags/Intellij-Idea/"/>
    
    <category term="plugin" scheme="http://daiwenzh5.github.io/tags/plugin/"/>
    
    <category term="swing" scheme="http://daiwenzh5.github.io/tags/swing/"/>
    
    <category term="java" scheme="http://daiwenzh5.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>AnAction</title>
    <link href="http://daiwenzh5.github.io/2020/12/20/yuque/AnAction/"/>
    <id>http://daiwenzh5.github.io/2020/12/20/yuque/AnAction/</id>
    <published>2020-12-20T05:40:21.000Z</published>
    <updated>2020-12-21T09:51:49.250Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>仅用于记录插件开发时踩的坑</p></blockquote><h2 id="接口介绍"><a href="#接口介绍" class="headerlink" title="接口介绍"></a>接口介绍</h2><p><code>AnAction</code> 是 Intellij Idea SDK 提供的按钮接口实现下的抽象类，通过继承此类，可以轻易的实现符合 Intellij UI 设计风格的自定义按钮组件。<br>Intellij SDK 中就内置了大量 AnAction 子类，下面是自定义实现的主要重写方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按钮点击时执行</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="拓展子类"><a href="#拓展子类" class="headerlink" title="拓展子类"></a>拓展子类</h2><h3 id="ToggleAction"><a href="#ToggleAction" class="headerlink" title="ToggleAction"></a>ToggleAction</h3><p>用于表示具有选定状态，且在执行（点击按钮）时切换其选定状态的动作。如控制台日志滚动时的自动换行按钮，以及滚动跟随按钮。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断按钮是否被选中</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isSelected</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置按钮何时被设置为选中状态</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setSelected</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e, <span class="keyword">boolean</span> state)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="辅助类"><a href="#辅助类" class="headerlink" title="辅助类"></a>辅助类</h2><h3 id="ActionToolbar"><a href="#ActionToolbar" class="headerlink" title="ActionToolbar"></a>ActionToolbar</h3><p>工具栏，用于操作控制台的一组按钮。<br>在 Git 面板，如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445577369-80a7b177-a107-4c1b-a7d2-a3a1bcdac69d.png#align=left&display=inline&height=315&margin=%5Bobject%20Object%5D&name=image.png&originHeight=315&originWidth=604&size=159886&status=done&style=none&width=604" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445577369-80a7b177-a107-4c1b-a7d2-a3a1bcdac69d.png#align=left&display=inline&height=315&margin=%5Bobject%20Object%5D&name=image.png&originHeight=315&originWidth=604&size=159886&status=done&style=none&width=604" srcset="data:image/png;base64,666" alt="image.png"></p><h4 id="创建方法"><a href="#创建方法" class="headerlink" title="创建方法"></a>创建方法</h4><p><code>ActionManager#createActionToolbar(String, ActionGroup, boolean)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createToolbar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 创建一个按钮组</span></span><br><span class="line">     <span class="keyword">final</span> DefaultActionGroup actions = <span class="keyword">new</span> DefaultActionGroup();</span><br><span class="line">     <span class="comment">// 通过 ConsoleView#createConsoleActions() 方法创建默认按钮</span></span><br><span class="line">     actions.addAll(consoleView.createConsoleActions());</span><br><span class="line">     <span class="comment">// 创建工具栏</span></span><br><span class="line">     ActionToolbar actionToolbar = ActionManager.getInstance()</span><br><span class="line">             .createActionToolbar(ActionPlaces.TOOLBAR, actions, <span class="keyword">false</span>);</span><br><span class="line">     <span class="comment">// 添加到控制台</span></span><br><span class="line">     consoleView.getComponent().add(actionToolbar.getComponent());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>在 <code>ConsoleViewImpl#createConsoleActions()</code> 中提供如下按钮组<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445934503-8f3f4941-7dc1-4d11-95de-c71ae22e08a1.png#align=left&display=inline&height=210&margin=%5Bobject%20Object%5D&name=image.png&originHeight=210&originWidth=32&size=1338&status=done&style=none&width=32" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445934503-8f3f4941-7dc1-4d11-95de-c71ae22e08a1.png#align=left&display=inline&height=210&margin=%5Bobject%20Object%5D&name=image.png&originHeight=210&originWidth=32&size=1338&status=done&style=none&width=32" srcset="data:image/png;base64,666" alt="image.png"></p><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p><code>ConsoleView#createConsoleActions</code> 中需要 Editor 组件被初始化，因此需要先执行 <code>ConsoleView#getComponent</code> 方法。</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;仅用于记录插件开发时踩的坑&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;接口介绍&quot;&gt;&lt;a href=&quot;#接口介绍&quot; class=&quot;headerlink&quot; title=&quot;接口介绍&quot;&gt;&lt;/a&gt;接口介绍&lt;/h2&gt;</summary>
    
    
    
    <category term="Intellij Idea" scheme="http://daiwenzh5.github.io/categories/Intellij-Idea/"/>
    
    <category term="plugin" scheme="http://daiwenzh5.github.io/categories/Intellij-Idea/plugin/"/>
    
    
    <category term="Intellij Idea" scheme="http://daiwenzh5.github.io/tags/Intellij-Idea/"/>
    
    <category term="plugin" scheme="http://daiwenzh5.github.io/tags/plugin/"/>
    
    <category term="swing" scheme="http://daiwenzh5.github.io/tags/swing/"/>
    
    <category term="java" scheme="http://daiwenzh5.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>结果集拦截器</title>
    <link href="http://daiwenzh5.github.io/2020/12/07/yuque/%E7%BB%93%E6%9E%9C%E9%9B%86%E6%8B%A6%E6%88%AA%E5%99%A8/"/>
    <id>http://daiwenzh5.github.io/2020/12/07/yuque/%E7%BB%93%E6%9E%9C%E9%9B%86%E6%8B%A6%E6%88%AA%E5%99%A8/</id>
    <published>2020-12-07T12:36:53.000Z</published>
    <updated>2020-12-21T09:51:49.300Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>修改已有的结果集，可以对查询的字段与 Java 属性直接进行任意的映射。</p><blockquote><p>实际项目中，为了防止修改表结构而造成锁表，因此采用拓展表放置新的字段，为了不修改原有业务逻辑，故需要使用切面来处理结果集新增的部分字段，将其映射到 Map 中。</p></blockquote><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p><strong>ps: 通过修改 XML 可以完成所有复杂查询，但要考虑到方案适配的通用性，</strong><del><strong>XML ヾ(•ω•`)o</strong></del><strong>。</strong><br>Mybatis 内置的 ResultHandler 拦截器可以对其 ResultMap 对象进行拦截。</p><h3 id="关键的数据结构"><a href="#关键的数据结构" class="headerlink" title="关键的数据结构"></a>关键的数据结构</h3><p>ResultMap 是 Mybatis 的结果集映射对象，与 XML 中 <ResultMap/> 相对应，其中通过 ResultMapping 定义了每一列字段与 Java 属性之间的映射关系，具体数据结构如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultMap</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 唯一标识符</span></span><br><span class="line">  <span class="keyword">private</span> String id;</span><br><span class="line">  <span class="comment">// 映射类型，Map 或 Java Bean</span></span><br><span class="line">  <span class="keyword">private</span> Class&lt;?&gt; type;</span><br><span class="line">  <span class="comment">// 每一列对应的映射关系</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; resultMappings;</span><br><span class="line">  <span class="comment">// 主键的映射关系，有助于生成缓存提升性能，可为空</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; idResultMappings;</span><br><span class="line">  <span class="comment">// 构造器映射关系</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; constructorResultMappings;</span><br><span class="line">  <span class="comment">// 属性映射关系</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; propertyResultMappings;</span><br><span class="line">  <span class="comment">// 被映射的列</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; mappedColumns;</span><br><span class="line">  <span class="comment">// 被映射的属性</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; mappedProperties;</span><br><span class="line">  <span class="comment">// 鉴别器，在不同字典值分别使用不同的映射关系时使用</span></span><br><span class="line">  <span class="keyword">private</span> Discriminator discriminator;</span><br><span class="line">  <span class="comment">// 是否存在嵌套的结果集映射，一对多、一对一时为 true</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedResultMaps;</span><br><span class="line">  <span class="comment">// 是否存在嵌套查询，与 &lt;select/&gt; 标签相对于，存在 N+1</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedQueries;</span><br><span class="line">  <span class="comment">// 是否自动映射，列名与属性名完全一致时启用可以取消显示映射</span></span><br><span class="line">  <span class="keyword">private</span> Boolean autoMapping;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Configuration configuration;</span><br><span class="line">  <span class="comment">// 属性名，Map 的 key 值，或 Java Bean 的属性，自动映射时会按照全局策略转换字符串</span></span><br><span class="line">  <span class="comment">// 默认时下划线转小驼峰</span></span><br><span class="line">  <span class="keyword">private</span> String property;</span><br><span class="line">  <span class="comment">// 列名，该列是嵌套结果集时可以为空，否则需要与属性值一一对应</span></span><br><span class="line">  <span class="keyword">private</span> String column;</span><br><span class="line">  <span class="comment">// Java 类型</span></span><br><span class="line">  <span class="keyword">private</span> Class&lt;?&gt; javaType;</span><br><span class="line">  <span class="comment">// Jdbc 类型</span></span><br><span class="line">  <span class="keyword">private</span> JdbcType jdbcType;</span><br><span class="line">  <span class="comment">// 类型处理器，常用的基本类型可以为空，走内置处理器，对于一些特殊的，如 list（程序） 转 string（数据库），</span></span><br><span class="line">  <span class="comment">// 则需要指定自定义的类型处理器，继承 TypeHandler 实现方法即可</span></span><br><span class="line">  <span class="keyword">private</span> TypeHandler&lt;?&gt; typeHandler;</span><br><span class="line">  <span class="comment">// 嵌套结果集的 Id</span></span><br><span class="line">  <span class="keyword">private</span> String nestedResultMapId;</span><br><span class="line">  <span class="comment">// 嵌套查询的 Id</span></span><br><span class="line">  <span class="keyword">private</span> String nestedQueryId;</span><br><span class="line">  <span class="comment">// 非空列</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; notNullColumns;</span><br><span class="line">  <span class="comment">// 列前缀，自动拼接在列名前，可以为空</span></span><br><span class="line">  <span class="keyword">private</span> String columnPrefix;</span><br><span class="line">  <span class="comment">// 主键、构造器标识</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultFlag&gt; flags;</span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; composites;</span><br><span class="line">  <span class="comment">// 结果集</span></span><br><span class="line">  <span class="keyword">private</span> String resultSet;</span><br><span class="line">  <span class="comment">// 外键列</span></span><br><span class="line">  <span class="keyword">private</span> String foreignColumn;</span><br><span class="line">  <span class="comment">// 是否启用懒加载，嵌套查询时生效</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> lazy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取-ResultMap-对象"><a href="#获取-ResultMap-对象" class="headerlink" title="获取 ResultMap 对象"></a>获取 ResultMap 对象</h3><p>ResultMap 可以通过 MappedStatement 获取，且获取的是一个不可修改的 List 集合。因此 ResultMap 的修改要点：</p><ol><li>遍历所有结果集映射；</li><li>反射重置结果集列表；</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultHanlderInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 获取默认处理器</span></span><br><span class="line">DefaultResultSetHandler defaultResultSetHandler = (DefaultResultSetHandler) invocation.getTarget();</span><br><span class="line">    <span class="comment">// mybatis 元数据对象，辅助工具，屏蔽反射受检异常</span></span><br><span class="line">        MetaObject metaStatementHandler = SystemMetaObject.forObject(defaultResultSetHandler);</span><br><span class="line">    <span class="comment">// 获取映射语句，当前执行 SQL 的所有信息</span></span><br><span class="line">        <span class="comment">// 其中存在 List&lt;ResultMap&gt; 属性，每一个 ResultMap 对应一个 Java Bean，</span></span><br><span class="line">        <span class="comment">// 一般只有一个值，即 SQL 的返回值</span></span><br><span class="line">        MappedStatement mappedStatement = (MappedStatement) metaStatementHandler.getValue(<span class="string">&quot;mappedStatement&quot;</span>);</span><br><span class="line">        <span class="comment">// 处理 ResultMap</span></span><br><span class="line">        <span class="keyword">for</span> (ResultMap resultMap: mappedStatement.getResultMap) &#123;</span><br><span class="line">            <span class="comment">// 重建 ResultMap</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="重建-ResultMap"><a href="#重建-ResultMap" class="headerlink" title="重建 ResultMap"></a>重建 ResultMap</h3><p>ResultMap 的获取并不复杂，事实上很轻易的就可以拿到，通过调试或者查看源码，可知，通过 getter 方法可以得到列映射关系，ResultMapping，同样这也是不可修改的 List 集合，但不同的是，直接通过反射修改是不会生效的，所有的（列或结果集）映射关系必须要先向 mybatis 的 configuration 注册才行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重建 ResultMap</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultMap <span class="title">rebuild</span><span class="params">(MappedStatement ms, ResultMap resultMap)</span> </span>&#123;</span><br><span class="line">       MapperBuilderAssistant builderAssistant = getMapperBuilderAssistant(ms);</span><br><span class="line">       <span class="comment">// 先获取原有的 ResultMapping 列表，仅对要修改的部分做处理（增、改、删）</span></span><br><span class="line">       List&lt;ResultMapping&gt; resultMappings = Lists.newArrayList(resultMap.getResultMappings().iterator());</span><br><span class="line">       <span class="comment">// 增加一个新的映射</span></span><br><span class="line">       resultMappings.add(getResultMapping());</span><br><span class="line">       <span class="comment">// 注册 ResultMap 到 configuration</span></span><br><span class="line">       ResultMapResolver resultMapResolver = <span class="keyword">new</span> ResultMapResolver(builderAssistant,</span><br><span class="line">               <span class="string">&quot;id，唯一标识，不可重复&quot;</span>),</span><br><span class="line">               resultMap.getType(), <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">               <span class="comment">// 将 resultMappings 设为不可变 list</span></span><br><span class="line">               Collections.unmodifiableList(resultMappings), 是否自动映射);</span><br><span class="line">       <span class="keyword">return</span> resultMapResolver.resolve();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建一个新的列映射关系</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultMapping <span class="title">getResultMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ResultMapping.Builder(builderAssistant.getConfiguration(),</span><br><span class="line">                       getProperty(<span class="string">&quot;属性名&quot;</span>))</span><br><span class="line">                       .column(<span class="string">&quot;列名&quot;</span>))</span><br><span class="line">                       .typeHandler(类型处理器.class)</span><br><span class="line">                       .jdbcType(JdbcType.value))</span><br><span class="line">                       .javaType(Java 类型.class)</span><br><span class="line">           .nestedResultMapId(<span class="string">&quot;嵌套的 ResultMap id， 需要先注册&quot;</span>)</span><br><span class="line">                       .build())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取映射器构建助手</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ms 映射语句</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 映射器构建助手</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> MapperBuilderAssistant <span class="title">getMapperBuilderAssistant</span><span class="params">(MappedStatement ms)</span> </span>&#123;</span><br><span class="line">       Configuration configuration = ms.getConfiguration();</span><br><span class="line">       String resource = ms.getResource();</span><br><span class="line">       String nameSpace = ms.getId().substring(<span class="number">0</span>, ms.getId().lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">       MapperBuilderAssistant builderAssistant = <span class="keyword">new</span> MapperBuilderAssistant(configuration, resource);</span><br><span class="line">       builderAssistant.setCurrentNamespace(nameSpace);</span><br><span class="line">       <span class="keyword">return</span> builderAssistant;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li>对应 （XML 文件）没有 ResultMap（或使用 ResultType）的结果集，需要设置自动映射（autoMapping = true），否则可能出现属性丢失的问题；</li><li>仅仅（通过反射）修改 ResultMap 的 resultMappings 属性不会生效，因为 ResultMapping 用于记录映射关系，却不是 Mybatis Configuration 真实的读取的信息，需要通过 ResultMapResolver 解析器读取信息，并注册到配置中心；</li><li>对于使用线程变量做拦截器标记时（如 PageHelper），在最终返回时拦截器结束时需要对线程变量进行 clear，谨防 OOM；</li><li>也可以在拦截器中直接读取 ResultSet，手动进行映射，或使用 Json 等工具，最终返回格式化后的对象，但需要考虑到列名与属性名不一样的场景，且对 Mybatis 映射产生破坏（不推荐）；</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过修改 ResultMap 可以任意的进行结果集映射，就像在 XML 中定义了 <ResultMap/> 标签一样，但不同的是，其可以通过注解或参数等方式，对某个查询进行标记，可以在运行时动态的修改返回查询结果，且 ResultMap 会被 Mybaits 自动缓存。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;修改已有的结果集，可以对查询的字段与 Java 属性直接进行任意的映射。&lt;/p&gt;</summary>
    
    
    
    <category term="Mybatis" scheme="http://daiwenzh5.github.io/categories/Mybatis/"/>
    
    <category term="拦截器" scheme="http://daiwenzh5.github.io/categories/Mybatis/%E6%8B%A6%E6%88%AA%E5%99%A8/"/>
    
    
    <category term="mybatis" scheme="http://daiwenzh5.github.io/tags/mybatis/"/>
    
    <category term="结果集处理" scheme="http://daiwenzh5.github.io/tags/%E7%BB%93%E6%9E%9C%E9%9B%86%E5%A4%84%E7%90%86/"/>
    
    <category term="拦截器" scheme="http://daiwenzh5.github.io/tags/%E6%8B%A6%E6%88%AA%E5%99%A8/"/>
    
    <category term="ResultMap" scheme="http://daiwenzh5.github.io/tags/ResultMap/"/>
    
  </entry>
  
  <entry>
    <title>自动发行插件</title>
    <link href="http://daiwenzh5.github.io/2020/12/04/yuque/%E8%87%AA%E5%8A%A8%E5%8F%91%E8%A1%8C%E6%8F%92%E4%BB%B6/"/>
    <id>http://daiwenzh5.github.io/2020/12/04/yuque/%E8%87%AA%E5%8A%A8%E5%8F%91%E8%A1%8C%E6%8F%92%E4%BB%B6/</id>
    <published>2020-12-03T17:49:09.000Z</published>
    <updated>2020-12-21T09:51:49.324Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在项目迭代过程中，需要为不同的版本号打上 Tag，对于发行的稳定版本则需要上传到指定的仓库。手动操作则过于繁琐，且无法统一 Tag 的样式，因此需要一款实现自动的可配置的发行工具。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>使用 <a href="https://maven.apache.org/maven-release/maven-release-plugin/index.html">maven-release-plugin</a> 插件，其提供了自动追赠版本号、自动切换 snapshots 和 releases 版本、以及自动打 Tag 与版本发行等功能。</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 父模块 pom.xml --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- git 地址 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">connection</span>&gt;</span>scm:git:url<span class="tag">&lt;/<span class="name">connection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">developerConnection</span>&gt;</span>scm:git:url<span class="tag">&lt;/<span class="name">developerConnection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tag</span>&gt;</span>HEAD<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scm</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-release-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0-M1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">username</span>&gt;</span>scm 用户名<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 对于 github 用户，（当密码无效时）可能需要 repo token 权限（代替密码） --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">password</span>&gt;</span>scm 密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">scmCommentPrefix</span>&gt;</span>[提交信息的前缀]<span class="tag">&lt;/<span class="name">scmCommentPrefix</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 子模块的版本号与父模块是否一致 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">autoVersionSubmodules</span>&gt;</span>true<span class="tag">&lt;/<span class="name">autoVersionSubmodules</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- tag 的格式，如 v1.0.0 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">tagNameFormat</span>&gt;</span>v@&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tagNameFormat</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 跳过测试以及生成 javadoc 文档（注释不规范时会报错）--&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">arguments</span>&gt;</span>-DskipTests -DuseReleaseProfile=false<span class="tag">&lt;/<span class="name">arguments</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- tag 的路径，gitee 路径，主要是快 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">tagBase</span>&gt;</span>https://gitee.com/&#123;用户名&#125;/&#123;项目名&#125;/tags<span class="tag">&lt;/<span class="name">tagBase</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置发行路径，这里配置的是阿里云效的私有仓库 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 需要在 settings.xml 中配置 server 的用户名和密码，且指定的 id 需要和下面的一致 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>rdc-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://packages.aliyun.com/maven/repository/2046382-release-Kot3ui/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>rdc-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://packages.aliyun.com/maven/repository/2046382-snapshot-sZVDXF/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- settings.xml --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- id 需要和上面一致 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>rdc-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">username</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>rdc-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br></pre></td></tr></table></figure><p>正式发行一定要配置 <code>distributionManagement</code> 且要注意授权信息（账号、密码）是否填写且正确，否则授权无法通过产生 401 异常。</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 预备发行：打 Tag，自动切换快照版本</span></span><br><span class="line">mvn release:prepare</span><br><span class="line"><span class="comment"># 将已有的 Tag 发行到指定仓库</span></span><br><span class="line">mvn release:perform</span><br><span class="line"><span class="comment"># 异常时回滚</span></span><br><span class="line">mvn release:rollback</span><br></pre></td></tr></table></figure><p>在 idea 可以通过可视化插件使用，需要注意的时，正式发行前一定要先进行预备发行。且每次打 Tag 时必须要求 git 是最新提交，正式发行使用的是上次 Tag（历史提交） 中的 pom，因此每次修改需要先提交到 git。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1607019495482-66a4eaac-b962-45ee-8685-b00b5de461b9.png#align=left&display=inline&height=392&margin=%5Bobject%20Object%5D&name=image.png&originHeight=392&originWidth=554&size=35138&status=done&style=none&width=554" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1607019495482-66a4eaac-b962-45ee-8685-b00b5de461b9.png#align=left&display=inline&height=392&margin=%5Bobject%20Object%5D&name=image.png&originHeight=392&originWidth=554&size=35138&status=done&style=none&width=554" srcset="data:image/png;base64,666" alt="image.png"></p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li>提交时出现 <code>remote: Invalid username or password</code>，确保自己的登录信息没有错，则尝试使用 repo token 来替换密码；</li><li>发布 prepare 之后，会产生各个模块的 pom 备份文件，最好在提交之前加入 .gitignore;</li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;在项目迭代过程中，需要为不同的版本号打上 Tag，对于发行的稳定版本则需要上传到指定的仓库。手动操作则过于繁琐，且无法统一 Tag 的样式，因此需要一款实现自动的可配置的发行工具。&lt;/p&gt;</summary>
    
    
    
    <category term="maven" scheme="http://daiwenzh5.github.io/categories/maven/"/>
    
    <category term="插件" scheme="http://daiwenzh5.github.io/categories/maven/%E6%8F%92%E4%BB%B6/"/>
    
    
    <category term="maven" scheme="http://daiwenzh5.github.io/tags/maven/"/>
    
    <category term="插件" scheme="http://daiwenzh5.github.io/tags/%E6%8F%92%E4%BB%B6/"/>
    
    <category term="发版" scheme="http://daiwenzh5.github.io/tags/%E5%8F%91%E7%89%88/"/>
    
    <category term="tag" scheme="http://daiwenzh5.github.io/tags/tag/"/>
    
  </entry>
  
  <entry>
    <title>聚合项目版本号管理</title>
    <link href="http://daiwenzh5.github.io/2020/12/03/yuque/%E8%81%9A%E5%90%88%E9%A1%B9%E7%9B%AE%E7%89%88%E6%9C%AC%E5%8F%B7%E7%AE%A1%E7%90%86/"/>
    <id>http://daiwenzh5.github.io/2020/12/03/yuque/%E8%81%9A%E5%90%88%E9%A1%B9%E7%9B%AE%E7%89%88%E6%9C%AC%E5%8F%B7%E7%AE%A1%E7%90%86/</id>
    <published>2020-12-03T14:13:46.000Z</published>
    <updated>2020-12-21T09:51:49.337Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在 Maven 聚合工程中，通常修改版本号是一件较为繁琐的过程，特别是子模块较多时，复制粘贴也得谨防遗漏，因此需要一款自动化工具，来完成机械的工作。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>插件 <a href="https://mvnrepository.com/artifact/org.codehaus.mojo/versions-maven-plugin">versions-maven-plugin</a> 正是用来解决这类痛点。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 父模块 pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>yyy<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>a.b.c<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 聚合子项目 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>模块-A<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">module</span>&gt;</span>模块-B<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">module</span>&gt;</span>模块-C<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>模块-D<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 统一子模块版本号，$&#123;project.version&#125; 为父项目版本号 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 子模块相互依赖时无需指定版本号 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>模块-A<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 引入插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>versions-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 子模块 pom.xml --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- parent 填入完整的父项目信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>yyy<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>a.b.c<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure><p>idea 中可以通过 Maven 插件栏选中 versions:set，快速设置。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1607007203997-376d28fb-4d09-426b-bf2c-3529edc3f2bc.png#align=left&display=inline&height=437&margin=%5Bobject%20Object%5D&name=image.png&originHeight=437&originWidth=618&size=36244&status=done&style=none&width=618" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1607007203997-376d28fb-4d09-426b-bf2c-3529edc3f2bc.png#align=left&display=inline&height=437&margin=%5Bobject%20Object%5D&name=image.png&originHeight=437&originWidth=618&size=36244&status=done&style=none&width=618" srcset="data:image/png;base64,666" alt="image.png"><br>在运行窗口填写版本号即可。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1607007473025-e2efb12e-d6bc-495c-8731-60bb45a1ecfb.png#align=left&display=inline&height=247&margin=%5Bobject%20Object%5D&name=image.png&originHeight=247&originWidth=928&size=30085&status=done&style=none&width=928" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1607007473025-e2efb12e-d6bc-495c-8731-60bb45a1ecfb.png#align=left&display=inline&height=247&margin=%5Bobject%20Object%5D&name=image.png&originHeight=247&originWidth=928&size=30085&status=done&style=none&width=928" srcset="data:image/png;base64,666" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;在 Maven 聚合工程中，通常修改版本号是一件较为繁琐的过程，特别是子模块较多时，复制粘贴也得谨防遗漏，因此需要一款自动化工具，来完成机械的工作。&lt;/p&gt;</summary>
    
    
    
    <category term="maven" scheme="http://daiwenzh5.github.io/categories/maven/"/>
    
    <category term="聚合项目" scheme="http://daiwenzh5.github.io/categories/maven/%E8%81%9A%E5%90%88%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="maven" scheme="http://daiwenzh5.github.io/tags/maven/"/>
    
    <category term="聚合项目" scheme="http://daiwenzh5.github.io/tags/%E8%81%9A%E5%90%88%E9%A1%B9%E7%9B%AE/"/>
    
    <category term="版本更新" scheme="http://daiwenzh5.github.io/tags/%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0/"/>
    
    <category term="version" scheme="http://daiwenzh5.github.io/tags/version/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis XML 新增异常</title>
    <link href="http://daiwenzh5.github.io/2020/11/27/yuque/Mybatis%20XML%20%E6%96%B0%E5%A2%9E%E5%BC%82%E5%B8%B8/"/>
    <id>http://daiwenzh5.github.io/2020/11/27/yuque/Mybatis%20XML%20%E6%96%B0%E5%A2%9E%E5%BC%82%E5%B8%B8/</id>
    <published>2020-11-27T14:40:46.000Z</published>
    <updated>2020-12-21T09:51:49.346Z</updated>
    
    <content type="html"><![CDATA[<h2 id="异常信息"><a href="#异常信息" class="headerlink" title="异常信息"></a>异常信息</h2><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org<span class="variable">.springframework</span><span class="variable">.dao</span><span class="variable">.DataIntegrityViolationException</span>:</span><br><span class="line">### Error updating database.  Cause: java<span class="variable">.sql</span><span class="variable">.SQLException</span>: Field &#x27;id&#x27; doesn&#x27;t have a <span class="keyword">default</span> value</span><br><span class="line">### The error may exist in file [xxx<span class="variable">.xml</span>]</span><br><span class="line">### The error may involve xxxMapper<span class="variable">.insert</span>-Inline</span><br><span class="line">### The error occurred <span class="keyword">while</span> setting parameters</span><br><span class="line">### SQL: insert into xxx                                                 create_time )           values ( ?,             ?,             ?,             ?,                                                    ? )</span><br><span class="line">### Cause: java<span class="variable">.sql</span><span class="variable">.SQLException</span>: Field &#x27;id&#x27; doesn&#x27;t have a <span class="keyword">default</span> value</span><br><span class="line">; Field &#x27;id&#x27; doesn&#x27;t have a <span class="keyword">default</span> value; nested exception is java<span class="variable">.sql</span><span class="variable">.SQLException</span>: Field &#x27;id&#x27; doesn&#x27;t have a <span class="keyword">default</span> value</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>原因：插入时没有指定 id，且数据库没有自增主键。<br>处理：在 xml 中添加 <code>&lt;if test=&quot;id != null&quot;&gt;id,&lt;/if&gt;</code> 手动设置 id；或者在数据库中设置自增。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;异常信息&quot;&gt;&lt;a href=&quot;#异常信息&quot; class=&quot;headerlink&quot; title=&quot;异常信息&quot;&gt;&lt;/a&gt;异常信息&lt;/h2&gt;&lt;figure class=&quot;highlight verilog&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;org&lt;span class=&quot;variable&quot;&gt;.springframework&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.dao&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.DataIntegrityViolationException&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;### Error updating database.  Cause: java&lt;span class=&quot;variable&quot;&gt;.sql&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.SQLException&lt;/span&gt;: Field &amp;#x27;id&amp;#x27; doesn&amp;#x27;t have a &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt; value&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;### The error may exist in file [xxx&lt;span class=&quot;variable&quot;&gt;.xml&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;### The error may involve xxxMapper&lt;span class=&quot;variable&quot;&gt;.insert&lt;/span&gt;-Inline&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;### The error occurred &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; setting parameters&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;### SQL: insert into xxx                                                 create_time )           values ( ?,             ?,             ?,             ?,                                                    ? )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;### Cause: java&lt;span class=&quot;variable&quot;&gt;.sql&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.SQLException&lt;/span&gt;: Field &amp;#x27;id&amp;#x27; doesn&amp;#x27;t have a &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt; value&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;; Field &amp;#x27;id&amp;#x27; doesn&amp;#x27;t have a &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt; value; nested exception is java&lt;span class=&quot;variable&quot;&gt;.sql&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.SQLException&lt;/span&gt;: Field &amp;#x27;id&amp;#x27; doesn&amp;#x27;t have a &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt; value&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="mybatis" scheme="http://daiwenzh5.github.io/categories/mybatis/"/>
    
    <category term="xml" scheme="http://daiwenzh5.github.io/categories/mybatis/xml/"/>
    
    
    <category term="mybatis" scheme="http://daiwenzh5.github.io/tags/mybatis/"/>
    
    <category term="xml" scheme="http://daiwenzh5.github.io/tags/xml/"/>
    
    <category term="insert" scheme="http://daiwenzh5.github.io/tags/insert/"/>
    
    <category term="主键" scheme="http://daiwenzh5.github.io/tags/%E4%B8%BB%E9%94%AE/"/>
    
  </entry>
  
  <entry>
    <title>多字段联合校验</title>
    <link href="http://daiwenzh5.github.io/2020/11/18/yuque/%E5%A4%9A%E5%AD%97%E6%AE%B5%E8%81%94%E5%90%88%E6%A0%A1%E9%AA%8C/"/>
    <id>http://daiwenzh5.github.io/2020/11/18/yuque/%E5%A4%9A%E5%AD%97%E6%AE%B5%E8%81%94%E5%90%88%E6%A0%A1%E9%AA%8C/</id>
    <published>2020-11-18T07:01:31.000Z</published>
    <updated>2020-12-21T09:51:49.369Z</updated>
    
    <content type="html"><![CDATA[<p>tags: [参数校验,@GroupSequenceProvider,hibernate validator,Bean Validation]<br>categories: [springboot,参数校验]</p><hr><h2 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h2><p>在使用进行数据校验时，经常会遇到需要多个字段组合式的校验。<br><strong>例如</strong></p><ul><li>某个嘉年华俱乐部门票对不同人群存在不同的定价：</li></ul><ol><li>年龄必须大于 12 岁；</li><li>12 ~ 18 岁半价；</li><li>18 岁以上全价；</li><li>coser 则可以免费；</li></ol><p>换句话来说，任何年龄大于 12 岁的人都可以购买全价，对于半价票需要校验年龄是否满足未成年，对于免费票需要校验是否是 coser。</p><h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><p>入场时，需要根据门票类型动态的切换校验分组，定义如下的 Person 类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@GroupSequenceProvider(Person.FareTypeGroupSequenceProvider.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 年龄</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Min(value = 12, message = &quot;年龄最小不低于 12 岁&quot;)</span></span><br><span class="line">    <span class="meta">@Max(value = 18, message = &quot;年龄大于 18 岁需要购买全价门票&quot;, groups=WhenIsHalf.class)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 票价[0=免费,1=半价,2=全价]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;票价类型不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer fareType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是 coser</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AssertTrue(message = &quot;只有 coser 才可以免费进去&quot;, groups = WhenIsFree.class)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean coser;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WhenIsFree</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WhenIsHalf</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验分组处理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FareTypeGroupSequenceProvider</span> <span class="keyword">implements</span> <span class="title">DefaultGroupSequenceProvider</span>&lt;<span class="title">Person</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> List&lt;Class&lt;?&gt;&gt; getValidationGroups(Person person) &#123;</span><br><span class="line">            ArrayList&lt;Class&lt;?&gt;&gt; list = Lists.newArrayList();</span><br><span class="line">            list.add(Person.class);</span><br><span class="line">            <span class="comment">// 判空</span></span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(person)) &#123;</span><br><span class="line">                <span class="comment">// 当 fareType = 0 时</span></span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(person.getFareType(), <span class="number">0</span>)) &#123;</span><br><span class="line">                list.add(WhenIsFree.class);</span><br><span class="line">                &#125; <span class="keyword">else</span> (Objects.equals(person.getFareType(), <span class="number">1</span>)) &#123;</span><br><span class="line">                list.add(WhenIsHalf.class);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol><li>DefaultGroupSequenceProvider 类型是泛型类，必须指定为需要参数校验的 Bean 类型；</li><li>DefaultGroupSequenceProvider.getValidationGroups 方法返回的 list 中必须包含 Bean 类型;</li><li>DefaultGroupSequenceProvider 只能增强 Default.class 分组;</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;tags: [参数校验,@GroupSequenceProvider,hibernate validator,Bean Validation]&lt;br&gt;categories: [springboot,参数校验]&lt;/p&gt;
&lt;hr&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>HttpMediaTypeNotAcceptableException</title>
    <link href="http://daiwenzh5.github.io/2020/10/22/yuque/HttpMediaTypeNotAcceptableException/"/>
    <id>http://daiwenzh5.github.io/2020/10/22/yuque/HttpMediaTypeNotAcceptableException/</id>
    <published>2020-10-22T08:49:07.000Z</published>
    <updated>2020-12-21T09:51:49.385Z</updated>
    
    <content type="html"><![CDATA[<h2 id="异常描述"><a href="#异常描述" class="headerlink" title="异常描述"></a>异常描述</h2><p>导出 Excel 时产生异常，提示：Could not find acceptable representation。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.HttpMediaTypeNotAcceptableException: Could not find acceptable representation</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor.writeWithMessageConverters(AbstractMessageConverterMethodProcessor.java:307)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor.handleReturnValue(RequestResponseBodyMethodProcessor.java:180)</span><br><span class="line">at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:82)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:122)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver.doResolveHandlerMethodException(ExceptionHandlerExceptionResolver.java:412)</span><br><span class="line">at org.springframework.web.servlet.handler.AbstractHandlerMethodExceptionResolver.doResolveException(AbstractHandlerMethodExceptionResolver.java:61)</span><br><span class="line">at org.springframework.web.servlet.handler.AbstractHandlerExceptionResolver.resolveException(AbstractHandlerExceptionResolver.java:140)</span><br><span class="line">at org.springframework.web.servlet.handler.HandlerExceptionResolverComposite.resolveException(HandlerExceptionResolverComposite.java:79)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.processHandlerException(DispatcherServlet.java:1298)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.processDispatchResult(DispatcherServlet.java:1110)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1056)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:942)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1005)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:897)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:645)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:882)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:750)</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:712)</span><br><span class="line">at org.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:580)</span><br><span class="line">at org.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:516)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.custom(StandardHostValve.java:388)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.status(StandardHostValve.java:253)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.throwable(StandardHostValve.java:348)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:173)</span><br><span class="line">at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:92)</span><br><span class="line">at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)</span><br><span class="line">at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:343)</span><br><span class="line">at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:408)</span><br><span class="line">at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)</span><br><span class="line">at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:853)</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1587)</span><br><span class="line">at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)</span><br><span class="line">at java.lang.Thread.run(Thread.java:748)</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>向 response 中写入流时，接口不能存在 json 格式的返回值。将返回值改成 void 即可解决问题。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;异常描述&quot;&gt;&lt;a href=&quot;#异常描述&quot; class=&quot;headerlink&quot; title=&quot;异常描述&quot;&gt;&lt;/a&gt;异常描述&lt;/h2&gt;&lt;p&gt;导出 Excel 时产生异常，提示：Could not find acceptable representation。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>消费者</title>
    <link href="http://daiwenzh5.github.io/2020/08/26/yuque/%E6%B6%88%E8%B4%B9%E8%80%85/"/>
    <id>http://daiwenzh5.github.io/2020/08/26/yuque/%E6%B6%88%E8%B4%B9%E8%80%85/</id>
    <published>2020-08-26T08:10:22.000Z</published>
    <updated>2020-12-21T09:51:49.414Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>接手了一个陈年的 dubbo 项目，现准备抽离某个模块，以前的聚合工程太大了，不想动，就另起了一个项目作为消费者调用之前的服务。<br>之前只在聚合项目中进行服务互调，现在两个项目之间完全独立，只通过 dubbo 交互，因此出现了一些问题，在此记录一下。</p><h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><h3 id="Refrence"><a href="#Refrence" class="headerlink" title="@Refrence"></a>@Refrence</h3><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><p>服务消费者引用服务注解。提供了大量的配置属性，实际上使用时，只需标记注解，所有属性采用默认设置即可。<br>对于消费者而言，期望的是开箱即用的服务，因此服务提供者应该应该装配合理的默认属性，避免消费者进行不透明操作。</p><h4 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h4><p>@Reference 不能直接标注在接口上，其提供远程服务自动注入功能，类似于 @Autowired、@Resource 注解，应在类属性字段或 setter 方法上使用。<br>接口的<strong>类限定名</strong>必须和服务提供者一致，否则出现无法获取服务的异常。<br><strong>注意：</strong>interfaceName 属性指定的接口名并不会生效。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to check the status of the service &lt;ServiceName&gt;. No provider available for the service &lt;ServiceName&gt; from the url zookeeper:&#x2F;&#x2F;&lt;URL&gt; to the consume &lt;IP&gt; use dubbo version 2.7.6</span><br></pre></td></tr></table></figure><p>同样，接口暴露的参数的<strong>类限定名</strong>必须和服务提供者一致，否则会出现序列化异常的报错。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.apache.dubbo.remoting.RemotingException: Fail to decode request due to: RpcInvocation [methodName&#x3D;&lt;MethodName&gt;, parameterTypes&#x3D;null, arguments&#x3D;null, attachments&#x3D;&#123;path&#x3D;&lt;ServiceName&gt;, input&#x3D;348, dubbo&#x3D;2.0.2, version&#x3D;0.0.0&#125;]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>实际上消费端错误信息并不是很清晰，通过服务端日志，可以看到是在 rpc 解析时出现类无法找到的异常，该类 <ServiceName> 是接口参数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[New I&#x2F;O worker #10] WARN c.a.d.r.p.d.DecodeableRpcInvocation [Slf4jLogger.java : 62]  [DUBBO] Decode rpc invocation failed: Read invocation data failed.</span><br><span class="line">java.lang.ClassNotFoundException: &lt;ServiceName&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="EnableDubbo"><a href="#EnableDubbo" class="headerlink" title="@EnableDubbo"></a>@EnableDubbo</h3><p>用于启用 dubbo 服务，需要指定接口的包名提供扫描。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;接手了一个陈年的 dubbo 项目，现准备抽离某个模块，以前的聚合工程太大了，不想动，就另起了一个项目作为消费者调用之前的服务。&lt;br&gt;之前只在聚合项目中进行服务互调，现在两个项目之间完全独立，只通过 dubbo 交互，因此出现了一些问题，在此记录一下。&lt;/p&gt;</summary>
    
    
    
    <category term="微服务" scheme="http://daiwenzh5.github.io/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
    <category term="dubbo" scheme="http://daiwenzh5.github.io/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/dubbo/"/>
    
    
    <category term="dubbo" scheme="http://daiwenzh5.github.io/tags/dubbo/"/>
    
    <category term="springboot" scheme="http://daiwenzh5.github.io/tags/springboot/"/>
    
    <category term="踩坑日记" scheme="http://daiwenzh5.github.io/tags/%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>ES 6+ 装饰器</title>
    <link href="http://daiwenzh5.github.io/2020/08/13/yuque/ES%206+%20%E8%A3%85%E9%A5%B0%E5%99%A8/"/>
    <id>http://daiwenzh5.github.io/2020/08/13/yuque/ES%206+%20%E8%A3%85%E9%A5%B0%E5%99%A8/</id>
    <published>2020-08-13T05:06:06.000Z</published>
    <updated>2020-12-21T09:51:49.657Z</updated>
    
    <content type="html"><![CDATA[<h2 id="使用理解"><a href="#使用理解" class="headerlink" title="使用理解"></a>使用理解</h2><p>在 JavaScript 中，装饰器的作用可以类比 Java 的注解。但其更多的类似于 AOP 语法糖，因为其本身不需要指定处理器，装饰器在定义时即可对目标进行环绕增强，可以有效地剥离出与业务无关的模板代码，减少冗余。其本质上是一个特定类型的函数，通过 <code>@函数名</code> 的方式使用。</p><h2 id="装饰器类型"><a href="#装饰器类型" class="headerlink" title="装饰器类型"></a>装饰器类型</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> TypedPropertyDescriptor&lt;T&gt; &#123;</span><br><span class="line">  enumerable?: <span class="built_in">boolean</span>;</span><br><span class="line">  configurable?: <span class="built_in">boolean</span>;</span><br><span class="line">  writable?: <span class="built_in">boolean</span>;</span><br><span class="line">  value?: T;</span><br><span class="line">  get?: <span class="function">() =&gt;</span> T;</span><br><span class="line">  set?: <span class="function">(<span class="params">value: T</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> ClassDecorator = <span class="xml"><span class="tag">&lt;<span class="name">TFunction</span> <span class="attr">extends</span> <span class="attr">Function</span>&gt;</span>(</span></span><br><span class="line"><span class="xml">  target: TFunction</span></span><br><span class="line"><span class="xml">) =&gt; TFunction | void;</span></span><br><span class="line"><span class="xml">declare type PropertyDecorator = (</span></span><br><span class="line"><span class="xml">  target: Object,</span></span><br><span class="line"><span class="xml">  propertyKey: string | symbol</span></span><br><span class="line"><span class="xml">) =&gt; void;</span></span><br><span class="line">declare type MethodDecorator = &lt;T&gt;(</span><br><span class="line">  target: Object,</span><br><span class="line">  propertyKey: string | symbol,</span><br><span class="line">  descriptor: TypedPropertyDescriptor&lt;T&gt;</span><br><span class="line">) =&gt; TypedPropertyDescriptor&lt;T&gt; | void;</span><br><span class="line">declare type ParameterDecorator = (</span><br><span class="line">  target: Object,</span><br><span class="line">  propertyKey: string | symbol,</span><br><span class="line">  parameterIndex: number</span><br><span class="line">) =&gt; void;</span><br></pre></td></tr></table></figure><p>通过 TypeScript 的声明文件，可以清晰的看到装饰器类型定义，对于不同类型的装饰器，其方法参数总是固定的且通过上下文注入。换言之，装饰器本身是不支持的自定义参数的，为了突破这一限制，通常使用工厂模式，即通过工厂函数接收参数，并返回一个装饰器函数。</p><h2 id="装饰器工厂"><a href="#装饰器工厂" class="headerlink" title="装饰器工厂"></a>装饰器工厂</h2><p>上文提到，工厂模式并不是装饰器的过度设计，而是对其本身功能的再次加强，是为了提供可自定义入参。下面是一个方法装饰器工厂的一般形式。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法装饰器工厂</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">methodDecoratorFactory</span>(<span class="params">msg: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line"><span class="comment">// do something...(预处理)</span></span><br><span class="line">  <span class="keyword">return</span> funtion(target: <span class="built_in">Object</span>,</span><br><span class="line">    propertyKey: <span class="built_in">string</span>,</span><br><span class="line">    decorator: TypedPropertyDescriptor&lt;<span class="built_in">any</span>&gt;) &#123;</span><br><span class="line">    <span class="comment">// 记录原方法</span></span><br><span class="line">    <span class="keyword">const</span> fn = decorator.value;</span><br><span class="line">    <span class="comment">// 重新定义方法，使用装饰器环绕原方法</span></span><br><span class="line">    <span class="comment">// 不能使用箭头函数，否则会丢失上下文（this 会指向箭头函数）</span></span><br><span class="line">    decorator.value = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 前置处理</span></span><br><span class="line">      <span class="comment">// arguments 需要解构传入，否则会将原参数包装成数组</span></span><br><span class="line">      <span class="comment">// 或 使用 fn.apply(this. arguments)</span></span><br><span class="line">      <span class="keyword">const</span> result = fn.call(<span class="built_in">this</span>, ...arguments)</span><br><span class="line">      <span class="comment">// 后置处理</span></span><br><span class="line">      <span class="comment">// 必须返回原方法结果，否则会丢失结果</span></span><br><span class="line">      <span class="keyword">return</span>  result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decorator;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="实践意义"><a href="#实践意义" class="headerlink" title="实践意义"></a>实践意义</h2><h3 id="日志装饰器"><a href="#日志装饰器" class="headerlink" title="日志装饰器"></a>日志装饰器</h3><p>记录方法的入参、出参以及执行时间。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">hander?: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> loggerInfo = <span class="built_in">Object</span>.seal(&#123;</span><br><span class="line">    method: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    input: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    output: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    custom: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    timeuse: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 一个用于记录使用时间的对象</span></span><br><span class="line">  <span class="keyword">const</span> timeUse = TimeUse.get();</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    target: <span class="built_in">Object</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    key: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    descriptor: TypedPropertyDescriptor&lt;<span class="built_in">any</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">TypedPropertyDescriptor</span>&lt;<span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> oldValue = descriptor.value;</span><br><span class="line">    descriptor.value = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      loggerInfo.method = key;</span><br><span class="line">      <span class="keyword">const</span> args: <span class="built_in">Array</span>&lt;<span class="built_in">any</span>&gt; = [];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> <span class="built_in">arguments</span>) &#123;</span><br><span class="line">        args.push(<span class="built_in">arguments</span>[index]);</span><br><span class="line">      &#125;</span><br><span class="line">      loggerInfo.input = args.join(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">      <span class="comment">// 执行原方法</span></span><br><span class="line">      <span class="keyword">const</span> value = <span class="keyword">await</span> oldValue.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">      loggerInfo.output = value;</span><br><span class="line">      hander &amp;&amp;</span><br><span class="line">        (loggerInfo.custom = hander(loggerInfo.input, loggerInfo.output) || <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 被调用时，会自动发出一个事件</span></span><br><span class="line">      loggerInfo.timeuse = <span class="string">`<span class="subst">$&#123;timeUse.off()&#125;</span>ms`</span>;</span><br><span class="line">      <span class="built_in">console</span>.debug(loggerInfo);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> descriptor;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="加载装饰器"><a href="#加载装饰器" class="headerlink" title="加载装饰器"></a>加载装饰器</h2><p>在异步请求数据时显示加载动画。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> loading = <span class="function"><span class="keyword">function</span> (<span class="params">message: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    target: <span class="built_in">Object</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    propertyKey: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    decorator: TypedPropertyDescriptor&lt;<span class="built_in">any</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 记录原方法</span></span><br><span class="line">    <span class="keyword">const</span> fn = decorator.value;</span><br><span class="line">    decorator.value = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Loading 是 UI 框架中的加载动画</span></span><br><span class="line">        Loading.show(&#123; message &#125;);</span><br><span class="line">        <span class="keyword">const</span> resp = <span class="keyword">await</span> fn.apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 此时需要在 finally 关闭动画，防止异常时被阻塞</span></span><br><span class="line">        Loading.hide();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> decorator;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>装饰器只能在类及其成员属性上使用，不能作用在静态方法（类方法）上，在外部方法中，</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;使用理解&quot;&gt;&lt;a href=&quot;#使用理解&quot; class=&quot;headerlink&quot; title=&quot;使用理解&quot;&gt;&lt;/a&gt;使用理解&lt;/h2&gt;&lt;p&gt;在 JavaScript 中，装饰器的作用可以类比 Java 的注解。但其更多的类似于 AOP 语法糖，因为其本身不需要指定处理器，装饰器在定义时即可对目标进行环绕增强，可以有效地剥离出与业务无关的模板代码，减少冗余。其本质上是一个特定类型的函数，通过 &lt;code&gt;@函数名&lt;/code&gt; 的方式使用。&lt;/p&gt;</summary>
    
    
    
    <category term="前端" scheme="http://daiwenzh5.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="js" scheme="http://daiwenzh5.github.io/tags/js/"/>
    
    <category term="ts" scheme="http://daiwenzh5.github.io/tags/ts/"/>
    
    <category term="注解" scheme="http://daiwenzh5.github.io/tags/%E6%B3%A8%E8%A7%A3/"/>
    
    <category term="装饰器" scheme="http://daiwenzh5.github.io/tags/%E8%A3%85%E9%A5%B0%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>MapStruct 未生效</title>
    <link href="http://daiwenzh5.github.io/2020/07/23/yuque/MapStruct%20%E6%9C%AA%E7%94%9F%E6%95%88/"/>
    <id>http://daiwenzh5.github.io/2020/07/23/yuque/MapStruct%20%E6%9C%AA%E7%94%9F%E6%95%88/</id>
    <published>2020-07-23T10:36:49.000Z</published>
    <updated>2020-12-21T09:51:49.669Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>无法找不到实现类 <code>Cannot find implementation</code>。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="1-包含-Swagger-依赖"><a href="#1-包含-Swagger-依赖" class="headerlink" title="1. 包含 Swagger 依赖"></a>1. 包含 Swagger 依赖</h3><p>在项目中使用了 swagger，需要将其中的 mapstruct 排除后，重新在 pom 中添加。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>重新引入：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h2&gt;&lt;p&gt;无法找不到实现类 &lt;code&gt;Cannot find implementation&lt;/code&gt;。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Oracle 误删数据恢复</title>
    <link href="http://daiwenzh5.github.io/2020/06/17/yuque/Oracle%20%E8%AF%AF%E5%88%A0%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D/"/>
    <id>http://daiwenzh5.github.io/2020/06/17/yuque/Oracle%20%E8%AF%AF%E5%88%A0%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D/</id>
    <published>2020-06-17T08:20:31.000Z</published>
    <updated>2020-12-21T09:51:49.682Z</updated>
    
    <content type="html"><![CDATA[<h2 id="DELETE-误删方案"><a href="#DELETE-误删方案" class="headerlink" title="DELETE 误删方案"></a>DELETE 误删方案</h2><p>Oracle 提供闪回，在数据被删除后还没有进行大量操作（被删除数据的块没有被覆写），即可通过闪回方式直接找回删除的数据。</p><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol><li>确认数据删除时间；</li><li><code>select * from 表名 as of timestamp to_timestamp(&#39;时间&#39;,&#39;yyyy-mm-dd hh24:mi:ss&#39;)</code>，可查询出该表的历史数据；</li><li><code>insert into 表明 (查询 sql)</code>，可将查询出的数据直接插入到表中；</li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;DELETE-误删方案&quot;&gt;&lt;a href=&quot;#DELETE-误删方案&quot; class=&quot;headerlink&quot; title=&quot;DELETE 误删方案&quot;&gt;&lt;/a&gt;DELETE 误删方案&lt;/h2&gt;&lt;p&gt;Oracle 提供闪回，在数据被删除后还没有进行大量操作（被删除数据的块没有被覆写），即可通过闪回方式直接找回删除的数据。&lt;/p&gt;</summary>
    
    
    
    <category term="数据库" scheme="http://daiwenzh5.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    <category term="Oracle" scheme="http://daiwenzh5.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Oracle/"/>
    
    
    <category term="oracle" scheme="http://daiwenzh5.github.io/tags/oracle/"/>
    
    <category term="sql" scheme="http://daiwenzh5.github.io/tags/sql/"/>
    
  </entry>
  
  <entry>
    <title>Hexo 自动提取摘要</title>
    <link href="http://daiwenzh5.github.io/2020/06/08/yuque/Hexo%20%E8%87%AA%E5%8A%A8%E6%8F%90%E5%8F%96%E6%91%98%E8%A6%81/"/>
    <id>http://daiwenzh5.github.io/2020/06/08/yuque/Hexo%20%E8%87%AA%E5%8A%A8%E6%8F%90%E5%8F%96%E6%91%98%E8%A6%81/</id>
    <published>2020-06-08T02:23:33.000Z</published>
    <updated>2020-12-21T09:51:49.860Z</updated>
    
    <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>通过添加  <code>&lt;!-- more --&gt;</code>  标记，可以手动切割文章，实现在列表页面仅显示文章摘要。但像这样在文章内部手动添加标记的方法，对文章进行了侵入式的改造，添加了与内容实际无关的信息，并不是很理想。<br>为了能够实现自动添加摘要，可以通过现有的 hexo 插件来实现，如：hexo-excerpt，hexo-auto-excerpt。但两者各自存在一定的局限，并不能很好的实现预期的效果，因此必须手动对其插件代码进行改造。</p><h2 id="插件对比"><a href="#插件对比" class="headerlink" title="插件对比"></a>插件对比</h2><p><strong>hexo-excerpt</strong>：作用在生成器执行过程中，通过 dom 树自动提取文章内容，摘要提取相对完整灵活，但是只能作用在首页列表；<br><strong>hexo-auto-excerpt</strong>：作用在文章后置过滤器执行过程中，通过指定固定的字符数自动提取文章内容，可以为所用列表项添加摘要；</p><h2 id="插件实现"><a href="#插件实现" class="headerlink" title="插件实现"></a>插件实现</h2><p>在参考了上述两个插件的源码之后，发现将其实现机制组合起来，可以有效的解决当前的痛点。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> htmlparser = <span class="built_in">require</span>(<span class="string">&quot;htmlparser2&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> domutils = <span class="built_in">require</span>(<span class="string">&quot;domutils&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> defaults = <span class="built_in">require</span>(<span class="string">&quot;lodash.defaults&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// hexo-excerpt 中提供的方法，具体见下文</span></span><br><span class="line"><span class="keyword">const</span> Filter = <span class="built_in">require</span>(<span class="string">&quot;./lib/dom-filter&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> DEFAULT_CONFIG = &#123;</span><br><span class="line">  depth: <span class="number">2</span>,</span><br><span class="line">  excerpt_excludes: [],</span><br><span class="line">  more_excludes: [],</span><br><span class="line">  hideWholePostExcerpts: <span class="literal">false</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册过滤器，参考 hexo-auto-excerpt</span></span><br><span class="line">hexo.extend.filter.register(<span class="string">&quot;after_post_render&quot;</span>, excerpt);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局参数</span></span><br><span class="line"><span class="keyword">let</span> excerptFilter;</span><br><span class="line"><span class="keyword">let</span> moreFilter;</span><br><span class="line"><span class="keyword">let</span> opts;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提取文章摘要, 此部分提取自 hexo-excerpt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Document&#125;</span> </span>post 文章</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">excerpt</span>(<span class="params">post</span>) </span>&#123;</span><br><span class="line">  init();</span><br><span class="line">  <span class="comment">//honour the &lt;!-- more --&gt; !!!</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    /&lt;!--\s*more\s*--&gt;/.test(post.content) ||</span><br><span class="line">    post.content.indexOf(<span class="string">&#x27;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&#x27;</span>) !== -<span class="number">1</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> post;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> nodes = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> parser = <span class="keyword">new</span> htmlparser.Parser(</span><br><span class="line">    <span class="keyword">new</span> htmlparser.DomHandler(<span class="function">(<span class="params">err, dom</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">        nodes = dom;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;),</span><br><span class="line">    &#123;</span><br><span class="line">      decodeEntities: <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  parser.write(post.content);</span><br><span class="line">  parser.done();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// tracks how many tag nodes we found</span></span><br><span class="line">  <span class="keyword">let</span> stopIndex = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// tracks how many nodes we found in total</span></span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (; index &lt; nodes.length &amp;&amp; stopIndex &lt;= opts.depth; index++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nodes[index].type === <span class="string">&quot;tag&quot;</span> &amp;&amp; excerptFilter.match(nodes[index])) &#123;</span><br><span class="line">      stopIndex++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set correct excerpt and more nodes values</span></span><br><span class="line">  <span class="keyword">let</span> excerptNodes = nodes.slice(<span class="number">0</span>, index);</span><br><span class="line">  <span class="keyword">let</span> moreNodes = nodes.slice(index);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// filter nodes</span></span><br><span class="line">  excerptNodes = excerptFilter.filter(excerptNodes);</span><br><span class="line">  moreNodes = moreFilter.filter(moreNodes);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the hideWholePostExcerpts option is set to true (the default), don&#x27;t show</span></span><br><span class="line">  <span class="comment">// excerpts for short posts (i.e. ones where the excerpt is the whole post)</span></span><br><span class="line">  <span class="keyword">if</span> (moreNodes.length != <span class="number">0</span> || !opts.hideWholePostExcerpts) &#123;</span><br><span class="line">    post.excerpt = excerptNodes</span><br><span class="line">      .map(<span class="function">(<span class="params">node</span>) =&gt;</span> domutils.getOuterHTML(node))</span><br><span class="line">      .join(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    post.more = moreNodes.map(<span class="function">(<span class="params">node</span>) =&gt;</span> domutils.getOuterHTML(node)).join(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> post;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> config = hexo.config;</span><br><span class="line">  <span class="keyword">let</span> legacy = &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (config.excerpt_depth) &#123;</span><br><span class="line">    hexo.log.warn(</span><br><span class="line">      <span class="string">&quot;excerpt_depth is deprecated, please use excerpt.depth instead.&quot;</span></span><br><span class="line">    );</span><br><span class="line">    legacy.depth = config.excerpt_depth;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  opts = opts || defaults(&#123;&#125;, config.excerpt, legacy, DEFAULT_CONFIG);</span><br><span class="line">  opts.depth = <span class="built_in">parseInt</span>(opts.depth);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(opts.excerpt_excludes))</span><br><span class="line">    opts.excerpt_excludes = [opts.excerpt_excludes];</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(opts.more_excludes))</span><br><span class="line">    opts.more_excludes = [opts.more_excludes];</span><br><span class="line">  excerptFilter = excerptFilter || <span class="keyword">new</span> Filter(hexo, opts.excerpt_excludes);</span><br><span class="line">  moreFilter = moreFilter || <span class="keyword">new</span> Filter(hexo, opts.more_excludes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> domutils = <span class="built_in">require</span>(<span class="string">&quot;domutils&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> CSSselect = <span class="built_in">require</span>(<span class="string">&quot;css-select&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Filter</span>(<span class="params">hexo, excludes</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.hexo = hexo;</span><br><span class="line">  <span class="built_in">this</span>.selectors = excludes.map(<span class="built_in">this</span>._compile.bind(<span class="built_in">this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Filter.prototype._compile = <span class="function"><span class="keyword">function</span> (<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> CSSselect.compile(selector);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">this</span>.hexo.log.error(</span><br><span class="line">      <span class="string">&quot;hexo-excerpt: Ignore invalid CSS selector: &quot;</span> + selector</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">n</span>) =&gt;</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Filter.prototype.match = <span class="function"><span class="keyword">function</span> (<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// not match any</span></span><br><span class="line">  <span class="keyword">return</span> !<span class="built_in">this</span>.selectors.some(<span class="function">(<span class="params">s</span>) =&gt;</span> s(node));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Filter.prototype.filter = <span class="function"><span class="keyword">function</span> (<span class="params">nodes</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// remove inner nodes that doesn&#x27;t match</span></span><br><span class="line">  domutils</span><br><span class="line">    .filter(<span class="function">(<span class="params">n</span>) =&gt;</span> !<span class="built_in">this</span>.match(n), nodes)</span><br><span class="line">    .forEach(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line">      domutils.removeElement(node);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// only keep top level nodes that match</span></span><br><span class="line">  <span class="keyword">return</span> nodes.filter(<span class="built_in">this</span>.match.bind(<span class="built_in">this</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Filter;</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="不完备方法"><a href="#不完备方法" class="headerlink" title="不完备方法"></a>不完备方法</h3><p>一开始是查看 hexo-excerpt 的源码，准备在标签页生成期处理，参考 hexo-generator-tag 的实现过程，最终可以实现在标签页提取摘要，但对于分类页面，仍然需要做相同的处理，随即放弃，此处仅作记录。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pagination = <span class="built_in">require</span>(<span class="string">&quot;hexo-pagination&quot;</span>);</span><br><span class="line">hexo.extend.generator.register(<span class="string">&quot;tag&quot;</span>, generator);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generator</span>(<span class="params">db</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> config = <span class="built_in">this</span>.config;</span><br><span class="line">  <span class="keyword">const</span> perPage = config.tag_generator.per_page;</span><br><span class="line">  <span class="keyword">const</span> paginationDir = config.pagination_dir || <span class="string">&quot;page&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> orderBy = config.tag_generator.order_by || <span class="string">&quot;-date&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> tags = db.tags;</span><br><span class="line">  <span class="keyword">let</span> tagDir;</span><br><span class="line"></span><br><span class="line">  init();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> pages = tags.reduce(<span class="function">(<span class="params">result, tag</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tag.length) <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> posts = tag.posts.sort(orderBy);</span><br><span class="line">    <span class="comment">// 预处理 posts，提取摘要，excerpt 方法定义在上文</span></span><br><span class="line">    posts.data = posts.data.map(excerpt);</span><br><span class="line">    <span class="keyword">const</span> data = pagination(tag.path, posts, &#123;</span><br><span class="line">      perPage: perPage,</span><br><span class="line">      layout: [<span class="string">&quot;tag&quot;</span>, <span class="string">&quot;archive&quot;</span>, <span class="string">&quot;index&quot;</span>],</span><br><span class="line">      format: paginationDir + <span class="string">&quot;/%d/&quot;</span>,</span><br><span class="line">      data: &#123;</span><br><span class="line">        tag: tag.name,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result.concat(data);</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// generate tag index page, usually /tags/index.html</span></span><br><span class="line">  <span class="keyword">if</span> (config.tag_generator.enable_index_page) &#123;</span><br><span class="line">    tagDir = config.tag_dir;</span><br><span class="line">    <span class="keyword">if</span> (tagDir[tagDir.length - <span class="number">1</span>] !== <span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">      tagDir += <span class="string">&quot;/&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pages.push(&#123;</span><br><span class="line">      path: tagDir,</span><br><span class="line">      layout: [<span class="string">&quot;tag-index&quot;</span>, <span class="string">&quot;tag&quot;</span>, <span class="string">&quot;archive&quot;</span>, <span class="string">&quot;index&quot;</span>],</span><br><span class="line">      <span class="comment">// posts: db.posts,</span></span><br><span class="line">      data: &#123;</span><br><span class="line">        base: tagDir,</span><br><span class="line">        total: <span class="number">1</span>,</span><br><span class="line">        current: <span class="number">1</span>,</span><br><span class="line">        current_url: tagDir,</span><br><span class="line">        <span class="comment">// posts: db.posts,</span></span><br><span class="line">        prev: <span class="number">0</span>,</span><br><span class="line">        prev_link: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        next: <span class="number">0</span>,</span><br><span class="line">        next_link: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        tags: tags,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pages;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="辅助"><a href="#辅助" class="headerlink" title="辅助"></a>辅助</h3><p>在研究时为了查看 hexo 的 post 具体的结构定义的打印函数，尝试过程中，并没有找到如何进行调试，因此将其打印后查看。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文章属性打印</span></span><br><span class="line"><span class="comment"> * 查看其文章结构</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Document&#125;</span> </span>document 文章</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">documentPrint</span>(<span class="params"><span class="built_in">document</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">document</span> <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;documentPrint ====== begin&quot;</span>);</span><br><span class="line">    <span class="built_in">document</span>.forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> documentPrint(item));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;documentPrint ====== end&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="built_in">document</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">document</span>.hasOwnProperty(key)) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = <span class="built_in">document</span>[key];</span><br><span class="line">      <span class="keyword">if</span> (!<span class="string">&quot;more、_content、raw&quot;</span>.includes(key)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;====&gt; %o: %o&quot;</span>, key, value);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;====&gt; %o: %o&quot;</span>, key, <span class="string">&quot;[blog]&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h2&gt;&lt;p&gt;通过添加  &lt;code&gt;&amp;lt;!-- more --&amp;gt;&lt;/code&gt;  标记，可以手动切割文章，实现在列表页面仅显示文章摘要。但像这样在文章内部手动添加标记的方法，对文章进行了侵入式的改造，添加了与内容实际无关的信息，并不是很理想。&lt;br&gt;为了能够实现自动添加摘要，可以通过现有的 hexo 插件来实现，如：hexo-excerpt，hexo-auto-excerpt。但两者各自存在一定的局限，并不能很好的实现预期的效果，因此必须手动对其插件代码进行改造。&lt;/p&gt;</summary>
    
    
    
    <category term="边缘技术" scheme="http://daiwenzh5.github.io/categories/%E8%BE%B9%E7%BC%98%E6%8A%80%E6%9C%AF/"/>
    
    <category term="前端" scheme="http://daiwenzh5.github.io/categories/%E8%BE%B9%E7%BC%98%E6%8A%80%E6%9C%AF/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="hexo" scheme="http://daiwenzh5.github.io/tags/hexo/"/>
    
    <category term="blog" scheme="http://daiwenzh5.github.io/tags/blog/"/>
    
    <category term="语雀编辑器" scheme="http://daiwenzh5.github.io/tags/%E8%AF%AD%E9%9B%80%E7%BC%96%E8%BE%91%E5%99%A8/"/>
    
    <category term="excerpt" scheme="http://daiwenzh5.github.io/tags/excerpt/"/>
    
  </entry>
  
  <entry>
    <title>git remote fail</title>
    <link href="http://daiwenzh5.github.io/2020/06/01/yuque/git%20remote%20fail/"/>
    <id>http://daiwenzh5.github.io/2020/06/01/yuque/git%20remote%20fail/</id>
    <published>2020-06-01T02:03:50.000Z</published>
    <updated>2020-12-21T09:51:49.882Z</updated>
    
    <content type="html"><![CDATA[<h2 id="异常描述"><a href="#异常描述" class="headerlink" title="异常描述"></a>异常描述</h2><p>在使用 git fetch 等命令同步远程仓库时失败：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">remote: The project you were looking <span class="keyword">for</span> could not be found.</span><br><span class="line">fatal: repository <span class="string">&#x27;远程仓库地址&#x27;</span> not found</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p><strong>原因</strong>：username 不匹配。登录的错误的用户名或密码，或者使用 vpn 连接时，vpn 账号和 git 账号不匹配。<br>可以通过查看<strong>凭据管理器</strong>检查 git 的用户名和密码，并将其修改成正确的信息。<br>Windows 路径：控制面板\所有控制面板项\凭据管理器<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1590977602678-b422e8a2-5ec9-4935-8bea-374597414f46.png#align=left&display=inline&height=283&margin=%5Bobject%20Object%5D&name=image.png&originHeight=565&originWidth=994&size=57725&status=done&style=none&width=497" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1590977602678-b422e8a2-5ec9-4935-8bea-374597414f46.png#align=left&display=inline&height=283&margin=%5Bobject%20Object%5D&name=image.png&originHeight=565&originWidth=994&size=57725&status=done&style=none&width=497" srcset="data:image/png;base64,666" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;异常描述&quot;&gt;&lt;a href=&quot;#异常描述&quot; class=&quot;headerlink&quot; title=&quot;异常描述&quot;&gt;&lt;/a&gt;异常描述&lt;/h2&gt;&lt;p&gt;在使用 git fetch 等命令同步远程仓库时失败：&lt;/p&gt;</summary>
    
    
    
    <category term="版本控制" scheme="http://daiwenzh5.github.io/categories/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/"/>
    
    <category term="windows" scheme="http://daiwenzh5.github.io/categories/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/windows/"/>
    
    
    <category term="git" scheme="http://daiwenzh5.github.io/tags/git/"/>
    
    <category term="windows" scheme="http://daiwenzh5.github.io/tags/windows/"/>
    
  </entry>
  
  <entry>
    <title>Hexo 博客搭建</title>
    <link href="http://daiwenzh5.github.io/2020/05/11/yuque/Hexo%20%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/"/>
    <id>http://daiwenzh5.github.io/2020/05/11/yuque/Hexo%20%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/</id>
    <published>2020-05-11T14:39:30.000Z</published>
    <updated>2020-12-21T09:51:50.025Z</updated>
    
    <content type="html"><![CDATA[<h2 id="文章摘要"><a href="#文章摘要" class="headerlink" title="文章摘要"></a>文章摘要</h2><p>为了在列表页面隐藏全文，实现“阅读全文”的折叠按钮，需要在 md 文件上手动添加标记  <code>&lt;!-- more --&gt;</code>，对文件本身产生了侵入，更好的方式是通过  <code>npm install hexo-excerpt --save</code>  插件，来实现自动根据目录层级生成摘要。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">excerpt:</span></span><br><span class="line">  <span class="attr">depth:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">excerpt_excludes:</span> []</span><br><span class="line">  <span class="attr">more_excludes:</span> []</span><br><span class="line">  <span class="attr">hideWholePostExcerpts:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="文章路径"><a href="#文章路径" class="headerlink" title="文章路径"></a>文章路径</h2><p>默认的路径中若包含中文，将会生成又臭又长的一段字符串，影响阅读体验。<br>使用  <code>npm install hexo-abbrlink --save</code> 插件，可以自动地将文章标题映射成一串短字符串。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 源路径生成跪在，:key 表示动态值</span></span><br><span class="line"><span class="comment"># permalink: :year/:month/:day/:title/</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:year/:month/:day/:abbrlink.html</span></span><br><span class="line"><span class="comment">## 启用算法生成不重复文件编号</span></span><br><span class="line"><span class="attr">abbrlink:</span></span><br><span class="line">  <span class="attr">alg:</span> <span class="string">crc132</span> <span class="comment">#算法： crc16(default) and crc32</span></span><br><span class="line">  <span class="attr">rep:</span> <span class="string">hex</span> <span class="comment"># dec为十进制，hex为十六进制</span></span><br></pre></td></tr></table></figure><h2 id="RSS-订阅"><a href="#RSS-订阅" class="headerlink" title="RSS 订阅"></a>RSS 订阅</h2><p>RSS 虽然小众，却能带来很好的阅读体验，因为订阅的权力是面向读者的，且不会有广告之类的阅读干扰。<br>使用  <code>npm install hexo-generator-feed --save</code>  插件可以自动生成支持 RSS 订阅的 XML 文件。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feed:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">atom</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">atom.xml</span></span><br><span class="line">  <span class="attr">limit:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure><h2 id="PWA-支持"><a href="#PWA-支持" class="headerlink" title="PWA 支持"></a>PWA 支持</h2><h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><p>此处使用的  <code>npm install hexo-pwa --save</code>  插件， <a href="https://github.com/lavas-project/hexo-pwa/commit/23429d125c10fe7979510033591ad36c4adcd478">上次提交 23429d1</a>（截止 2020-03-21），该插件尚且不兼容  <code>hexo@4.2.0</code>，降级后可正常使用。</p><p><a href="https://github.com/lavas-project/hexo-pwa">插件地址</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">hexo -version</span><br><span class="line"><span class="comment"># 安装指定版本</span></span><br><span class="line">npm install hexo@4.1.1 --save</span><br></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>需要指定 manifest.json 文件及 sw.js 文件的相对（根）路径。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pwa:</span></span><br><span class="line">  <span class="attr">manifest:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/manifest.json</span></span><br><span class="line">    <span class="attr">body:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;名称&quot;</span></span><br><span class="line">      <span class="attr">short_name:</span> <span class="string">&quot;短名称&quot;</span></span><br><span class="line">      <span class="attr">theme_color:</span> <span class="string">&quot;主题颜色，标题栏颜色&quot;</span></span><br><span class="line">      <span class="attr">background_color:</span> <span class="string">&quot;背景色&quot;</span></span><br><span class="line">      <span class="attr">display:</span> <span class="string">&quot;standalone&quot;</span></span><br><span class="line">      <span class="attr">Scope:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">      <span class="attr">start_url:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">      <span class="attr">icons:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">src:</span> <span class="string">/images/logos/48.png</span></span><br><span class="line">          <span class="attr">sizes:</span> <span class="string">48x48</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">image/png</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">src:</span> <span class="string">/images/logos/96.png</span></span><br><span class="line">          <span class="attr">sizes:</span> <span class="string">96x96</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">image/png</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">src:</span> <span class="string">/images/logos/128.png</span></span><br><span class="line">          <span class="attr">sizes:</span> <span class="string">128x128</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">image/png</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">src:</span> <span class="string">/images/logos/144.png</span></span><br><span class="line">          <span class="attr">sizes:</span> <span class="string">144x144</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">image/png</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">src:</span> <span class="string">/images/logos/192.png</span></span><br><span class="line">          <span class="attr">sizes:</span> <span class="string">192x192</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">image/png</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">src:</span> <span class="string">/images/logos/512.png</span></span><br><span class="line">          <span class="attr">sizes:</span> <span class="string">512x512</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">image/png</span></span><br><span class="line">  <span class="attr">serviceWorker:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/sw.js</span></span><br><span class="line">    <span class="attr">preload:</span></span><br><span class="line">      <span class="attr">urls:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/</span></span><br><span class="line">      <span class="attr">posts:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">opts:</span></span><br><span class="line">      <span class="attr">networkTimeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="type">!!js/regexp</span> <span class="string">/hm.baidu.com/</span></span><br><span class="line">        <span class="attr">strategy:</span> <span class="string">networkOnly</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="type">!!js/regexp</span> <span class="string">/.*\.(js|css|jpg|jpeg|png|gif)$/</span></span><br><span class="line">        <span class="attr">strategy:</span> <span class="string">cacheFirst</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="type">!!js/regexp</span> <span class="string">/\//</span></span><br><span class="line">        <span class="attr">strategy:</span> <span class="string">networkFirst</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><h2 id="图标"><a href="#图标" class="headerlink" title="图标"></a>图标</h2><p>需要不同尺寸的图标，推荐使用 svg 图片导出不同尺寸，<a href="https://www.logosc.cn/">白嫖的 Logo 设计网站</a>：生成好图片后，F12 打开“元素”面板，选中图片，复制出 svg 标签使用 TXT 文本另存为 logo.svg。此时可以使用 AI 来处理，矢量图的好处就是可以无损的进行放大（于 2020-05-12）。</p><h3 id="清单"><a href="#清单" class="headerlink" title="清单"></a>清单</h3><p>需要添加 manifest.json 到 sources 目录下，并在模板中手动引用。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">import:</span></span><br><span class="line">  <span class="attr">link:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&lt;link rel=&#x27;manifest&#x27; href=&#x27;/manifest.json&#x27;&gt;&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;名称&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;short_name&quot;</span>: <span class="string">&quot;短名称&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;theme_color&quot;</span>: <span class="string">&quot;主题色，标题栏颜色&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;background_color&quot;</span>: <span class="string">&quot;背景色&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;display&quot;</span>: <span class="string">&quot;standalone&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Scope&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;start_url&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;icons&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;src&quot;</span>: <span class="string">&quot;相对 sources 的图片地址&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sizes&quot;</span>: <span class="string">&quot;48x48&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;src&quot;</span>: <span class="string">&quot;相对 sources 的图片地址&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sizes&quot;</span>: <span class="string">&quot;96x96&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;src&quot;</span>: <span class="string">&quot;相对 sources 的图片地址&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sizes&quot;</span>: <span class="string">&quot;128x128&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;src&quot;</span>: <span class="string">&quot;相对 sources 的图片地址&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sizes&quot;</span>: <span class="string">&quot;144x144&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;src&quot;</span>: <span class="string">&quot;相对 sources 的图片地址&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sizes&quot;</span>: <span class="string">&quot;192x192&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;src&quot;</span>: <span class="string">&quot;相对 sources 的图片地址&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sizes&quot;</span>: <span class="string">&quot;512x512&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/png&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;splash_pages&quot;</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><p>需要添加 sw.js 到 sources 目录下。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> workboxVersion = <span class="string">&quot;5.0.0&quot;</span>;</span><br><span class="line">importScripts(</span><br><span class="line">  <span class="string">`https://storage.googleapis.com/workbox-cdn/releases/<span class="subst">$&#123;workboxVersion&#125;</span>/workbox-sw.js`</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (workbox) &#123;</span><br><span class="line">  workbox.setConfig(&#123;</span><br><span class="line">    modulePathPrefix: <span class="string">`https://storage.googleapis.com/workbox-cdn/releases/<span class="subst">$&#123;workboxVersion&#125;</span>`</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  workbox.precaching.precache([<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/index.html&quot;</span>]);</span><br><span class="line"></span><br><span class="line">  workbox.routing.registerRoute(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;^https?://博客地址/?$&quot;</span>),</span><br><span class="line">    workbox.strategies.networkFirst()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  workbox.routing.registerRoute(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;.*.html&quot;</span>),</span><br><span class="line">    workbox.strategies.networkFirst()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  workbox.routing.registerRoute(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;.*.(?:js|css)&quot;</span>),</span><br><span class="line">    workbox.strategies.staleWhileRevalidate()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  workbox.routing.registerRoute(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;https://imgchr.com/&quot;</span>),</span><br><span class="line">    workbox.strategies.cacheFirst()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  workbox.routing.registerRoute(</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&quot;https://cdn.jsdelivr.net/&quot;</span>),</span><br><span class="line">    workbox.strategies.cacheFirst()</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="语雀文章获取"><a href="#语雀文章获取" class="headerlink" title="语雀文章获取"></a>语雀文章获取</h2><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><a href="https://github.com/x-cold/yuque-hexo">参加插件官方配置</a></p><h3 id="标签使用"><a href="#标签使用" class="headerlink" title="标签使用"></a>标签使用</h3><p>语雀本身的  🔖（标签组件）只会被渲染成普通的字符串，必须通过手动添加 <a href="https://hexo.io/zh-cn/docs/front-matter">front-matter</a>  才可以。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tags: [标签 1, 标签 2]</span><br><span class="line">categories: [一级分类, 二级分类]</span><br><span class="line"></span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>在语雀中，可以配合 🔖 字符串形式，如本文中使用方式：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1589360257532-d8257566-3b97-4978-8c73-0476ec375013.png#align=left&display=inline&height=83&margin=%5Bobject%20Object%5D&name=image.png&originHeight=110&originWidth=400&size=9768&status=done&style=none&width=300" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1589360257532-d8257566-3b97-4978-8c73-0476ec375013.png#align=left&display=inline&height=83&margin=%5Bobject%20Object%5D&name=image.png&originHeight=110&originWidth=400&size=9768&status=done&style=none&width=300" srcset="data:image/png;base64,666" alt="image.png"></p><h3 id="图片防盗链处理"><a href="#图片防盗链处理" class="headerlink" title="图片防盗链处理"></a>图片防盗链处理</h3><p>添加  <code>&lt;meta name=&quot;referrer&quot; content=&quot;no-referrer&quot; /&gt;</code>  到模板 head 可解决。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/_config.yml</span></span><br><span class="line"><span class="attr">import:</span></span><br><span class="line">  <span class="attr">meta:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;meta</span> <span class="string">name=&quot;referrer&quot;</span> <span class="string">content=&quot;no-referrer&quot;/&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/x-cold/yuque-hexo/issues/41">参见插件官方 issue </a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;文章摘要&quot;&gt;&lt;a href=&quot;#文章摘要&quot; class=&quot;headerlink&quot; title=&quot;文章摘要&quot;&gt;&lt;/a&gt;文章摘要&lt;/h2&gt;&lt;p&gt;为了在列表页面隐藏全文，实现“阅读全文”的折叠按钮，需要在 md 文件上手动添加标记  &lt;code&gt;&amp;lt;!-- more --&amp;gt;&lt;/code&gt;，对文件本身产生了侵入，更好的方式是通过  &lt;code&gt;npm install hexo-excerpt --save&lt;/code&gt;  插件，来实现自动根据目录层级生成摘要。&lt;/p&gt;</summary>
    
    
    
    <category term="边缘技术" scheme="http://daiwenzh5.github.io/categories/%E8%BE%B9%E7%BC%98%E6%8A%80%E6%9C%AF/"/>
    
    <category term="前端" scheme="http://daiwenzh5.github.io/categories/%E8%BE%B9%E7%BC%98%E6%8A%80%E6%9C%AF/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="hexo" scheme="http://daiwenzh5.github.io/tags/hexo/"/>
    
    <category term="blog" scheme="http://daiwenzh5.github.io/tags/blog/"/>
    
    <category term="github pages" scheme="http://daiwenzh5.github.io/tags/github-pages/"/>
    
    <category term="语雀编辑器" scheme="http://daiwenzh5.github.io/tags/%E8%AF%AD%E9%9B%80%E7%BC%96%E8%BE%91%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>RestTemplate 使用</title>
    <link href="http://daiwenzh5.github.io/2020/04/30/yuque/RestTemplate%20%E4%BD%BF%E7%94%A8/"/>
    <id>http://daiwenzh5.github.io/2020/04/30/yuque/RestTemplate%20%E4%BD%BF%E7%94%A8/</id>
    <published>2020-04-30T06:35:02.000Z</published>
    <updated>2020-12-21T09:51:50.064Z</updated>
    
    <content type="html"><![CDATA[<h2 id="📑-需求描述"><a href="#📑-需求描述" class="headerlink" title="📑 需求描述"></a>📑 需求描述</h2><p><code>RestTemplate</code> 是 spring 封装了  <code>HttpClient</code> 的一些模板操作的工具类，通过该工具可以很轻松的实现在程序中发送 Http 请求。</p><h2 id="⚙-配置"><a href="#⚙-配置" class="headerlink" title="⚙ 配置"></a>⚙ 配置</h2><p>可以通过直接实例化对象来使用  <code>RestTemplate</code>，但在 spring 中，更好的方式是将其声明成一个组件，交由 spring 托管。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">(ClientHttpRequestFactory factory)</span> </span>&#123;</span><br><span class="line">    RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(factory);</span><br><span class="line">    <span class="comment">// 其他设置，如：拦截器、消息处理器等</span></span><br><span class="line">    <span class="keyword">return</span> restTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="🚧-拦截器"><a href="#🚧-拦截器" class="headerlink" title="🚧 拦截器"></a>🚧 拦截器</h2><p>拦截器需要通过实现  <code>ClientHttpRequestInterceptor</code>  接口（或直接使用 lambda 函数），重载其  <code>intercept</code>  方法，在其中添加自定义动作，但需要在通过验证后放行（否则请求会被拦截）。在  <code>RestTemplate</code>  中，可以存在了一个存放拦截器的集合，将自定义拦截器加入其中接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义自定义拦截器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomInterceptor</span> <span class="keyword">implements</span> <span class="title">ClientHttpRequestInterceptor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">intercept</span><span class="params">(HttpRequest request, <span class="keyword">byte</span>[] body, ClientHttpRequestExecution execution)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 自定义方法体</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 执行完毕后放行请求</span></span><br><span class="line">        <span class="keyword">return</span> execution.execute(request, body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 添加拦截器</span></span><br><span class="line">restTemplate.getInterceptors().add(<span class="keyword">new</span> CustomInterceptor())</span><br></pre></td></tr></table></figure><p>通常可以在拦截器中添加权限验证或日志记录。</p><h2 id="💬-消息转换器"><a href="#💬-消息转换器" class="headerlink" title="💬  消息转换器"></a>💬  消息转换器</h2><p><code>RestTemplate</code>  中默认定义了各种消息处理器，在需要替换时，需要将原有的处理器去除之后在添加，并且其消息处理类型要一致。<code>RestTemplate</code>  中使用 <code>Jackson</code>  来处理 json 以及 xml 数据，通常会将其替换成阿里的 <code>FastJson</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重新设置了消息转换器集合，通过遍历过滤了原有的 Jackson 处理器，最后添加了 FastJson 处理器</span></span><br><span class="line"><span class="comment">// 也可以直接在原有的 list 中使用 remove 去除，再添加</span></span><br><span class="line">List&lt;HttpMessageConverter&lt;?&gt;&gt; converters = restTemplate.getMessageConverters();</span><br><span class="line">List&lt;HttpMessageConverter&lt;?&gt;&gt; convertersValid = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; converter : converters) &#123;</span><br><span class="line">    <span class="keyword">if</span> (converter <span class="keyword">instanceof</span> MappingJackson2HttpMessageConverter</span><br><span class="line">            || converter <span class="keyword">instanceof</span> MappingJackson2XmlHttpMessageConverter) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    convertersValid.add(converter);</span><br><span class="line">&#125;</span><br><span class="line">convertersValid.add(fastJsonHttpMessageConverter());</span><br><span class="line">restTemplate.setMessageConverters(convertersValid);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * fastJson 消息转换器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> fastJson 消息转换器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> FastJsonHttpMessageConverter <span class="title">fastJsonHttpMessageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;MediaType&gt; mediaTypes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    mediaTypes.add(MediaType.APPLICATION_JSON);</span><br><span class="line">    FastJsonConfig fastJsonConfig = <span class="keyword">new</span> FastJsonConfig();</span><br><span class="line">    fastJsonConfig.setSerializerFeatures(SerializerFeature.DisableCircularReferenceDetect,</span><br><span class="line">            SerializerFeature.WriteMapNullValue,</span><br><span class="line">            SerializerFeature.WriteDateUseDateFormat);</span><br><span class="line">    fastJsonConfig.setDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">    GsonHttpMessageConverter gsonHttpMessageConverter = <span class="keyword">new</span> GsonHttpMessageConverter();</span><br><span class="line">    gsonHttpMessageConverter.setSupportedMediaTypes(mediaTypes);</span><br><span class="line">    FastJsonHttpMessageConverter fastConverter = <span class="keyword">new</span> FastJsonHttpMessageConverter();</span><br><span class="line">    fastConverter.setSupportedMediaTypes(mediaTypes);</span><br><span class="line">    fastConverter.setFastJsonConfig(fastJsonConfig);</span><br><span class="line">    <span class="keyword">return</span> fastConverter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="🐘-返回泛型对象"><a href="#🐘-返回泛型对象" class="headerlink" title="🐘 返回泛型对象"></a>🐘 返回泛型对象</h2><p><code>RestTemplate</code> 无法直接准确地返回包含泛型的对象（如 <code>List&lt;String&gt;</code>  最终只会被识别为 <code>List</code> ）。此处可以通过其  <code>exchange</code> 方法中的  <code>ParameterizedTypeReference</code> 参数，设定一个仅包含类型的空对象，即可记录并返回准确的泛型对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ParameterizedTypeReference&lt;List&lt;MyBean&gt;&gt; myBean =</span><br><span class="line">    <span class="keyword">new</span> ParameterizedTypeReference&lt;List&lt;MyBean&gt;&gt;() &#123;&#125;;</span><br><span class="line">ResponseEntity&lt;List&lt;MyBean&gt;&gt; response =</span><br><span class="line">           template.exchange(<span class="string">&quot;https://example.com&quot;</span>,HttpMethod.GET, <span class="keyword">null</span>, myBean);</span><br></pre></td></tr></table></figure><p><strong>注意：</strong>其中的  <code>ParameterizedTypeReference</code>  参数是不能通过泛型方法来封装的，因为封装的泛型依然会被擦除。本质上，该方法是通过生成匿名类（类中的泛型是不会被擦除的，泛型的目的之一是避免生成不必要的类）来记录泛型信息。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;📑-需求描述&quot;&gt;&lt;a href=&quot;#📑-需求描述&quot; class=&quot;headerlink&quot; title=&quot;📑 需求描述&quot;&gt;&lt;/a&gt;📑 需求描述&lt;/h2&gt;&lt;p&gt;&lt;code&gt;RestTemplate&lt;/code&gt; 是 spring 封装了  &lt;code&gt;HttpClient&lt;/code&gt; 的一些模板操作的工具类，通过该工具可以很轻松的实现在程序中发送 Http 请求。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>🕷 统一异常处理</title>
    <link href="http://daiwenzh5.github.io/2020/04/23/yuque/%F0%9F%95%B7%20%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/"/>
    <id>http://daiwenzh5.github.io/2020/04/23/yuque/%F0%9F%95%B7%20%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/</id>
    <published>2020-04-23T11:02:43.000Z</published>
    <updated>2020-12-21T09:51:50.115Z</updated>
    
    <content type="html"><![CDATA[<h2 id="🚩-需求描述"><a href="#🚩-需求描述" class="headerlink" title="🚩 需求描述"></a>🚩 需求描述</h2><p>将接口访问所有异常进行统一处理。在业务逻辑编写时，应该将所有可预知的异常定义好，并设定唯一的错误代码，在异常发生时，通过统一的返回值自动包装，提供给前端优化的错误提示，并能够通过错误代码快速定位异常类型。</p><h2 id="🐘-异常对象"><a href="#🐘-异常对象" class="headerlink" title="🐘 异常对象"></a>🐘 异常对象</h2><p>定义一个业务层异常，用于抛出业务逻辑上的异常错误。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor(access = AccessLevel.PRIVATE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误代码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ServiceException <span class="title">of</span><span class="params">(ExceptionEnum exceptionEnum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServiceException(exceptionEnum.code, exceptionEnum.message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中  <code>ExceptionEnum</code>  类是用于描述异常的枚举类型，定义异常的错误代码及错误信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">ExceptionEnum</span> </span>&#123;</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String code;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span>  String message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="📄-代码实现"><a href="#📄-代码实现" class="headerlink" title="📄 代码实现"></a>📄 代码实现</h2><p>通过  <code>@RestControllerAdive</code>  提升作用域，通过  <code>@ExceptionHandler</code> 注解来处理不同的异常。</p><h3 id="🔢-业务层异常"><a href="#🔢-业务层异常" class="headerlink" title="🔢 业务层异常"></a>🔢 业务层异常</h3><p>所有的业务逻辑错误触发的异常。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理业务异常</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exception 异常</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 统一返回值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ExceptionHandler(ServiceException.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title">handleServiceException</span><span class="params">(ServiceException exception)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RestResponse.error(exception.code, exception.message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="⁉-未知异常"><a href="#⁉-未知异常" class="headerlink" title="⁉ 未知异常"></a>⁉ 未知异常</h3><p>用于捕捉其他的所有不可预知的错误，可能是表字段的数据异常，导致数据库在更新时无法动态的生成 SQL（在编写时默认该值不为空，但被人为删除了），而产生的 dao 层异常，也有可能时系统资源被占用，导致文件无法写入的 IO 异常，不可控制的网络超时异常等等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 其他未知的所有异常</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exception 异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 统一返回值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title">handleOtherException</span><span class="params">(Exception exception)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.error(exception.getMessage());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="🔐-参数校验异常"><a href="#🔐-参数校验异常" class="headerlink" title="🔐 参数校验异常"></a>🔐 参数校验异常</h3><p>需要使用 <code>@Validated</code> 注解标记在 Controller 的类、方法或参数上。对于验证规则，使用 <code>javax.validation.constraints</code> 和 <code>org.hibernate.validator.constraints</code> 包中的规则注解。具体使用此处不细究，仅对异常的处理进行展开。<br>该异常表现为接口访问错误，但具体的错误提示信息并未写入到响应，服务端异常信息如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javax.validation.ConstraintViolationException: common.msg: 消息不能为空</span><br><span class="line">...异常堆栈信息</span><br></pre></td></tr></table></figure><p>可以建立一个指定异常为  ConstraintViolationException 的处理器，用于封装参数错误的异常信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(ConstraintViolationException.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title">constraintViolationExceptionHandler</span><span class="params">(ConstraintViolationException e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RestResponse.error(((ConstraintViolation) e.getConstraintViolations().toArray()[<span class="number">0</span>]).getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中 <code>ConstraintViolation</code> 可能不止一个参数校验的结果，取第（任）一个即可。</p><h3 id="🔍-404-异常"><a href="#🔍-404-异常" class="headerlink" title="🔍 404 异常"></a>🔍 404 异常</h3><p>尽管 Spring 默认实现了 <code>/error</code>（即接口访问出错）情况下的处理，（在 Postman 上随手输出一个接口，模拟 404）如：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2020-01-07T16:37:31.160+0000&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;status&quot;</span>: <span class="number">404</span>,</span><br><span class="line">  <span class="attr">&quot;error&quot;</span>: <span class="string">&quot;Not Found&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;No message available&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/123&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但在某些时候，需要针对错误访问进行特殊的处理，此时可以实现 <code>ErrorController</code> 接口进行自定义拓展。<br>如下对 4xx、5xx 系列的错误状态进行处理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;error&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestResponse&lt;Object&gt; <span class="title">errorHandle</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    HttpStatus status = getStatus(request);</span><br><span class="line">    <span class="keyword">if</span> (status.is4xxClientError()) &#123;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.error(<span class="string">&quot;客户端访问出错&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (status.is5xxServerError()) &#123;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.error(<span class="string">&quot;服务器访问异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> RestResponse.error(<span class="string">&quot;未知异常&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，在条件分支中，对某个具体的状态做判断，可以更细致化的处理不同的访问错误。</p><h4 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h4><ol><li>在 <code>@Exception</code> 中进行状态判断，对错误请求做处理；</li><li>（未测试）在资源目录（<code>/resources/public/error</code>）下添加错误访问页面，命名为 404.html、500.html 等；</li><li>（未测试）配置 <code>EmbeddedServletContainerCustomizer</code> 实现；</li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;🚩-需求描述&quot;&gt;&lt;a href=&quot;#🚩-需求描述&quot; class=&quot;headerlink&quot; title=&quot;🚩 需求描述&quot;&gt;&lt;/a&gt;🚩 需求描述&lt;/h2&gt;&lt;p&gt;将接口访问所有异常进行统一处理。在业务逻辑编写时，应该将所有可预知的异常定义好，并设定唯一的错误代码，在异常发生时，通过统一的返回值自动包装，提供给前端优化的错误提示，并能够通过错误代码快速定位异常类型。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>📑 统一日志记录</title>
    <link href="http://daiwenzh5.github.io/2020/04/23/yuque/%F0%9F%93%91%20%E7%BB%9F%E4%B8%80%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/"/>
    <id>http://daiwenzh5.github.io/2020/04/23/yuque/%F0%9F%93%91%20%E7%BB%9F%E4%B8%80%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/</id>
    <published>2020-04-23T10:07:48.000Z</published>
    <updated>2020-12-21T09:51:50.144Z</updated>
    
    <content type="html"><![CDATA[<h2 id="🚩-需求描述"><a href="#🚩-需求描述" class="headerlink" title="🚩 需求描述"></a>🚩 需求描述</h2><p>能够在每次访问接口时，自动记录入参、出参的全局统一日志。</p><h2 id="📈-方案与分析"><a href="#📈-方案与分析" class="headerlink" title="📈 方案与分析"></a>📈 方案与分析</h2><p><strong>说明</strong>：日志作用的所有接口上，且需要统一形式，因此是不考虑在接口中手写的。</p><h3 id="📋-方案一"><a href="#📋-方案一" class="headerlink" title="📋 方案一"></a>📋 方案一</h3><p>理想的情况下是通过 spring aop 快速进入开发状态，然后在打包时通过 aspectj 处理器在编译期织入代码。因为 spring aop 采用 aspectj 语法，且提供了强大但简单的注解支持，因此可以很轻松的实现切面。但是 spring 的 aop 是运行时的（反射），相对于静态织入的 aspectj 来说，性能差距是极大的。而使用 aspectj 处理器每次需要手动清除之前编译的代码，否则新的代码无法实时编译的，比较麻烦，因此比较适合在打包时提供 aspectj 编译处理</p><h3 id="📋-方案二"><a href="#📋-方案二" class="headerlink" title="📋  方案二"></a>📋  方案二</h3><p>spring 其他内置增强接口， <code>@RestControllerAdive</code>，可以为注解类提升作用域，而  <code>ResponseBodyAdive</code>，<code>RequestBodyAdive</code>  接口，则可以为实现类提供预处理出参、入参的接口数据，两相结合，则可以实现类似的环绕式的出入参日志记录</p><h3 id="📋-方案三"><a href="#📋-方案三" class="headerlink" title="📋  方案三"></a>📋  方案三</h3><p>使用拦截器或过滤器，但其匹配规则是作用在 url 上，粒度太大不够细致。</p><h2 id="📄-代码实现"><a href="#📄-代码实现" class="headerlink" title="📄 代码实现"></a>📄 代码实现</h2><p>此处通过 aop 实现，需要注意的是，若通过  <code>ResponseBodyAdive</code>  接口来处理统一返回值，则不能使用  <code>@Around</code>  的环绕切面，因为该切面要求方法的出参类型是不能修改的，而使用被统一返回类型包装的对象，是与切面方法的实际返回值是不一样的，故下面使用 <code>@Before</code>、<code>@AfterReturning</code> 方法分别处理接口入参、和参数两个状态。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录日志信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LogInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 请求 id</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String requestId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 开始时间</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">long</span> startTime;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * gson 工具</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Gson gson;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ThreadLocal&lt;LogInfo&gt; logInfo = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(value = &quot;@annotation(com.包名.annotation.Log)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">point</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法执行前</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint 切点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before(value = &quot;point()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LogRequestInfo</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        String uuid = UUID.randomUUID().toString();</span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        <span class="comment">// 缓存线程变量信息</span></span><br><span class="line">        logInfo.set(<span class="keyword">new</span> LogInfo(uuid, System.currentTimeMillis(), gson));</span><br><span class="line">        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        HttpServletRequest request = Objects.requireNonNull(attributes).getRequest();</span><br><span class="line">        StringBuilder requestLog = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        Signature signature = joinPoint.getSignature();</span><br><span class="line">        requestLog.append(<span class="string">&quot;[&quot;</span>).append(uuid).append(<span class="string">&quot;] -&gt; &quot;</span>)</span><br><span class="line">                .append(<span class="string">&quot;请求信息：&quot;</span>).append(<span class="string">&quot;URL = &#123;&quot;</span>).append(request.getRequestURI()).append(<span class="string">&quot;&#125;, &quot;</span>)</span><br><span class="line">                .append(<span class="string">&quot;请求方式 = &#123;&quot;</span>).append(request.getMethod()).append(<span class="string">&quot;&#125;, &quot;</span>)</span><br><span class="line">                .append(<span class="string">&quot;请求IP = &#123;&quot;</span>).append(request.getRemoteAddr()).append(<span class="string">&quot;&#125;, &quot;</span>)</span><br><span class="line">                .append(<span class="string">&quot;类方法 = &#123;&quot;</span>).append(signature.getDeclaringTypeName()).append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">                .append(signature.getName()).append(<span class="string">&quot;&#125;, &quot;</span>);</span><br><span class="line">        <span class="comment">// 处理请求参数</span></span><br><span class="line">        String[] paramNames = ((MethodSignature) signature).getParameterNames();</span><br><span class="line">        Object[] paramValues = joinPoint.getArgs();</span><br><span class="line">        <span class="keyword">int</span> paramLength = <span class="keyword">null</span> == paramNames ? <span class="number">0</span> : paramNames.length;</span><br><span class="line">        <span class="keyword">if</span> (paramLength == <span class="number">0</span>) &#123;</span><br><span class="line">            requestLog.append(<span class="string">&quot;请求参数 = &#123;&#125; &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            requestLog.append(<span class="string">&quot;请求参数 = [&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paramLength - <span class="number">1</span>; i++) &#123;</span><br><span class="line">                requestLog.append(paramNames[i]).append(<span class="string">&quot;=&quot;</span>).append(gson.toJson(paramValues[i])).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            requestLog.append(paramNames[paramLength - <span class="number">1</span>]).append(<span class="string">&quot;=&quot;</span>).append(gson.toJson(paramValues[paramLength - <span class="number">1</span>])).append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(requestLog.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法执行后</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AfterReturning(returning = &quot;target&quot;, pointcut = &quot;point()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logResultVOInfo</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        LogInfo logInfo = <span class="keyword">this</span>.logInfo.get();</span><br><span class="line">        <span class="comment">// 删除线程变量</span></span><br><span class="line">        <span class="keyword">this</span>.logInfo.remove();</span><br><span class="line">        <span class="keyword">long</span> offTime = System.currentTimeMillis() - logInfo.startTime;</span><br><span class="line">        log.info(String.format(<span class="string">&quot;[%s] -&gt; 请求结果：%s [%dms]&quot;</span>, logInfo.requestId, logInfo.gson.toJson(target), offTime));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为实际上，两个切面方法是独立的作用域，为了线程安全，故使用线程变量来存储请求的日志信息，主要记录该请求的唯一编号（此处使用 UUID），开始时间，同时又都需要将对象 json 化，所以也缓存了 gson 对象。<br>同样的方法，也可以通过实现增强接口，重写其预处理入参、出参的方法来提供日志支持。</p><hr><p>java spring log web aop</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;🚩-需求描述&quot;&gt;&lt;a href=&quot;#🚩-需求描述&quot; class=&quot;headerlink&quot; title=&quot;🚩 需求描述&quot;&gt;&lt;/a&gt;🚩 需求描述&lt;/h2&gt;&lt;p&gt;能够在每次访问接口时，自动记录入参、出参的全局统一日志。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>MongoDB 使用记录</title>
    <link href="http://daiwenzh5.github.io/2020/04/15/yuque/MongoDB%20%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/"/>
    <id>http://daiwenzh5.github.io/2020/04/15/yuque/MongoDB%20%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</id>
    <published>2020-04-15T05:28:30.000Z</published>
    <updated>2020-12-21T09:51:50.175Z</updated>
    
    <content type="html"><![CDATA[<h2 id="⚙-配置"><a href="#⚙-配置" class="headerlink" title="⚙ 配置"></a>⚙ 配置</h2><p>mongo 默认是无认证登录的，即使在设置用户名和密码后，也是需要手动修改配置文件开启授权认证。<br>当然，在开启授权之前，应该连接数据库，创建必要的用户账户。</p><h3 id="💾-连接数据库"><a href="#💾-连接数据库" class="headerlink" title="💾 连接数据库"></a>💾 连接数据库</h3><p>直接使用 Navicat 连接即可，初始时选择无验证连接。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1586931848670-c9b19620-4ad4-4e71-9e7b-7ca8f82bfb6f.png#align=left&display=inline&height=372&margin=%5Bobject%20Object%5D&name=image.png&originHeight=743&originWidth=667&size=22300&status=done&style=stroke&width=334" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1586931848670-c9b19620-4ad4-4e71-9e7b-7ca8f82bfb6f.png#align=left&display=inline&height=372&margin=%5Bobject%20Object%5D&name=image.png&originHeight=743&originWidth=667&size=22300&status=done&style=stroke&width=334" srcset="data:image/png;base64,666" alt="image.png"><br>成功连接之后若未显示任何数据库，则选择连接之后，在顶部导航栏选中【查看】-【显示隐藏的项目】，之后可以看到默认的数据库 admin、config、local 等。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1586931787072-781628c7-49a7-41dc-a174-0b3b532a1013.png#align=left&display=inline&height=166&margin=%5Bobject%20Object%5D&name=image.png&originHeight=220&originWidth=170&size=6902&status=done&style=none&width=128" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1586931787072-781628c7-49a7-41dc-a174-0b3b532a1013.png#align=left&display=inline&height=166&margin=%5Bobject%20Object%5D&name=image.png&originHeight=220&originWidth=170&size=6902&status=done&style=none&width=128" srcset="data:image/png;base64,666" alt="image.png"></p><h3 id="🆔-创建账户"><a href="#🆔-创建账户" class="headerlink" title="🆔 创建账户"></a>🆔 创建账户</h3><p>选择 admin 数据库，新建查询，创建一个超级用户（用户之后连接登录认证的）。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.createUser(</span><br><span class="line">&#123;</span><br><span class="line">user:&quot;root&quot;,</span><br><span class="line">pwd:&quot;root&quot;,</span><br><span class="line">roles:[&#123;role:&quot;root&quot;,db:&quot;admin&quot;&#125;]</span><br><span class="line">&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>也可以创建其他数据库，并设置相应的角色，但需注意，空的数据库默认是不会保存的，因此在新建数据库之后，应该写入一条临时数据。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 插入任意数据，之后可以删除</span></span><br><span class="line">db.[数据库名].insert(&#123;&#x27;key&#x27;: &#x27;value&#x27;&#125;)</span><br></pre></td></tr></table></figure><h3 id="✍-修改配置"><a href="#✍-修改配置" class="headerlink" title="✍ 修改配置"></a>✍ 修改配置</h3><p>开启授权验证。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">vim /etc/mongod.conf</span><br><span class="line">-----</span><br><span class="line"><span class="comment"># 启用权限控制</span></span><br><span class="line">security:</span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure><h3 id="😨-一个意外"><a href="#😨-一个意外" class="headerlink" title="😨 一个意外"></a>😨 一个意外</h3><p>删库宣言   仅以此纪念我消逝的数据 👀<br>All your data is a backed up. You must pay 0.015 BTC to 1Dy28zwYdyPYzWjGzuRLJeGeiEabG61AFZ 48 hours for recover it. After 48 hours expiration we will leaked and exposed all your data. Also do not forget about GDPR. You can buy bitcoin here, does not take much time to buy <a href="https://localbitcoins.com/">https://localbitcoins.com</a> with this guide <a href="https://localbitcoins.com/guides/how-to-buy-bitcoins">https://localbitcoins.com/guides/how-to-buy-bitcoins</a> After paying write to me in the mail with your DB IP: <a href="mailto:&#x67;&#x33;&#x74;&#95;&#98;&#97;&#x73;&#101;&#64;&#x70;&#114;&#x6f;&#x74;&#x6f;&#110;&#109;&#97;&#105;&#x6c;&#46;&#x63;&#x6f;&#109;">&#x67;&#x33;&#x74;&#95;&#98;&#97;&#x73;&#101;&#64;&#x70;&#114;&#x6f;&#x74;&#x6f;&#110;&#109;&#97;&#105;&#x6c;&#46;&#x63;&#x6f;&#109;</a>“</p><hr><p>您的所有数据都已备份。您必须支付 0.015 BTC 才能花费 48 小时恢复。48 小时到期后，我们将泄露并暴露您的所有数据。也不要忘记 GDPR。你可以在这里购买比特币，不需要花太多时间购买 <a href="https://localbitcoins.com/">https://localbitcoins.com</a> 使用本指南 <a href="https://localbitcoins.com/guides/how-to-buy-bitcoins">https://localbitcoins.com/guides/how-to-buy-bitcoins</a> 付款后，请用您的 DB IP 给我写信: <a href="mailto:&#x67;&#51;&#116;&#95;&#x62;&#97;&#x73;&#x65;&#x40;&#x70;&#x72;&#x6f;&#x74;&#x6f;&#x6e;&#x6d;&#x61;&#105;&#108;&#x2e;&#x63;&#111;&#x6d;">&#x67;&#51;&#116;&#95;&#x62;&#97;&#x73;&#x65;&#x40;&#x70;&#x72;&#x6f;&#x74;&#x6f;&#x6e;&#x6d;&#x61;&#105;&#108;&#x2e;&#x63;&#111;&#x6d;</a>”</p><h2 id="⚔-常用命令"><a href="#⚔-常用命令" class="headerlink" title="⚔ 常用命令"></a>⚔ 常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service mongod &lt;指令&gt;</span><br><span class="line">重启           restart</span><br><span class="line">启动           start</span><br><span class="line">停止           stop</span><br></pre></td></tr></table></figure><hr><p>mongodb 4.2.5 配置 安装</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;⚙-配置&quot;&gt;&lt;a href=&quot;#⚙-配置&quot; class=&quot;headerlink&quot; title=&quot;⚙ 配置&quot;&gt;&lt;/a&gt;⚙ 配置&lt;/h2&gt;&lt;p&gt;mongo 默认是无认证登录的，即使在设置用户名和密码后，也是需要手动修改配置文件开启授权认证。&lt;br&gt;当然，在开启授权之前，应该连接数据库，创建必要的用户账户。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>🐘 统一返回对象</title>
    <link href="http://daiwenzh5.github.io/2020/04/14/yuque/%F0%9F%90%98%20%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1/"/>
    <id>http://daiwenzh5.github.io/2020/04/14/yuque/%F0%9F%90%98%20%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1/</id>
    <published>2020-04-14T08:45:30.000Z</published>
    <updated>2020-12-21T09:51:50.209Z</updated>
    
    <content type="html"><![CDATA[<h2 id="🚩-需求描述"><a href="#🚩-需求描述" class="headerlink" title="🚩 需求描述"></a>🚩 需求描述</h2><p>封装统一的接口返回对象，使得前端能够获取格式规整的数据。</p><h2 id="📦-封装对象"><a href="#📦-封装对象" class="headerlink" title="📦 封装对象"></a>📦 封装对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestResponse</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取统一返回类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code    返回码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    返回数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> success 返回结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 提示信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">of</span><span class="params">(String code, T data, <span class="keyword">boolean</span> success, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestResponse&lt;&gt;(code, data, success, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回操作成功的统一类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#success&#125; = true &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code    返回码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    返回数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 提示信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">success</span><span class="params">(String code, T data, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> of(code, data, <span class="keyword">true</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回操作成功的统一类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#success&#125; = true &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#code&#125; = 0 &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    返回数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 提示信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">success</span><span class="params">(T data, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> success(<span class="string">&quot;0&quot;</span>, data, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回操作成功的统一类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#success&#125; = true &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#code&#125; = 0 &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#message&#125; = 响应成功 &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data 返回数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;  数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">success</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> success(data, <span class="string">&quot;响应成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回操作失败的统一类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#success&#125; = false &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code    返回码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    返回数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 提示信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">error</span><span class="params">(String code, T data, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> of(code, data, <span class="keyword">false</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回操作成功的统一类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#success&#125; = false &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#data&#125; = null &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 提示信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">error</span><span class="params">(String code, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> error(code, <span class="keyword">null</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回操作成功的统一类型</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#success&#125; = true &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#code&#125; = -1 &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; &#123;<span class="doctag">@link</span> RestResponse#data&#125; = null &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RestResponse&#125; 统一返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RestResponse&lt;T&gt; <span class="title">error</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> error(<span class="string">&quot;-1&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="🏗-实现基础"><a href="#🏗-实现基础" class="headerlink" title="🏗 实现基础"></a>🏗 实现基础</h2><p>spring 中提供了  <code>ResponseBodyAdvice</code> 接口，用于 http 请求在写入响应流之前的处理，为统一返回对象提供了相对便捷的实现方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResponseBodyAdvice</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Whether this component supports the given controller method return type</span></span><br><span class="line"><span class="comment"> * and the selected &#123;<span class="doctag">@code</span> HttpMessageConverter&#125; type.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> returnType the return type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> converterType the selected converter type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if &#123;<span class="doctag">@link</span> #beforeBodyWrite&#125; should be invoked;</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> false&#125; otherwise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter returnType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Invoked after an &#123;<span class="doctag">@code</span> HttpMessageConverter&#125; is selected and just before</span></span><br><span class="line"><span class="comment"> * its write method is invoked.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> body the body to be written</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> returnType the return type of the controller method</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> selectedContentType the content type selected through content negotiation</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> selectedConverterType the converter type selected to write to the response</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request the current request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response the current response</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the body that was passed in or a modified (possibly new) instance</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">T <span class="title">beforeBodyWrite</span><span class="params">(<span class="meta">@Nullable</span> T body, MethodParameter returnType, MediaType selectedContentType,</span></span></span><br><span class="line"><span class="function"><span class="params">Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; selectedConverterType,</span></span></span><br><span class="line"><span class="function"><span class="params">ServerHttpRequest request, ServerHttpResponse response)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th><strong>方法名</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td>supports()</td><td>通过判断响应返回值类型及消息转换器的类型决定是否启用该组件</td></tr><tr><td>beforeBodyWrite()</td><td>当组件启用时，该方法返回值将作为最终的响应数据写入到流</td></tr></tbody></table><h3 id="🔜-流程"><a href="#🔜-流程" class="headerlink" title="🔜 流程"></a>🔜 流程</h3><ol><li>创建一个实现 <code>ResponseBodyAdvice</code> 接口的类；</li><li>在 <code>supports()</code> 中跳过已经封装过（即类型已经是 <code>RestResponse</code>）的返回值，避免多次封装；</li><li>在 <code>beforeBodyWrite()</code> 方法中进行统一返回类型的封装；</li></ol><h3 id="📄-实现代码"><a href="#📄-实现代码" class="headerlink" title="📄 实现代码"></a>📄 实现代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter returnType, Class converterType)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当返回值类型已经时包装类时跳过</span></span><br><span class="line">    <span class="keyword">return</span> !returnType.getParameterType().equals(RestResponse.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">beforeBodyWrite</span><span class="params">(Object body,</span></span></span><br><span class="line"><span class="function"><span class="params">                              MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params">                              MediaType selectedContentType,</span></span></span><br><span class="line"><span class="function"><span class="params">                              Class selectedConverterType,</span></span></span><br><span class="line"><span class="function"><span class="params">                              ServerHttpRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                              ServerHttpResponse response)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1、处理无返回值（即 void）类型的方法</span></span><br><span class="line">    <span class="keyword">if</span> (returnType.getParameterType().equals(Void.class)) &#123;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(<span class="keyword">new</span> Object());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2、Spring 默认使用 StringHttpMessageConverter 处理 String 类型的返回值</span></span><br><span class="line">    <span class="comment">// 一旦被包装成统一对象后，不能被转换成字符串，而产生类型转换异常 - 见下方注①</span></span><br><span class="line">    <span class="keyword">if</span> (body <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="comment">// 2.1、用于重置字符串的响应类型为 application/json</span></span><br><span class="line">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        <span class="comment">// 2.2 将统一对象转换成 json 字符串</span></span><br><span class="line">        <span class="keyword">return</span> JSON.toJSONString(RestResponse.success(body));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3、其他所有情况</span></span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="☝-注意事项"><a href="#☝-注意事项" class="headerlink" title="☝ 注意事项"></a>☝ 注意事项</h3><p>注 ①：需要对 String 类型的返回值进行额外的处理，因为 Spring 通过返回值类型来决定<a href="#jTGLT">消息转换器</a>的选择，所以 String 类型的返回值会默认使用 <code>StringHttpMessageConverter</code> 处理器，但是在 <code>beforeBodyWrite()</code>  处理后，其类型被修改为  <code>RestResponse</code>，因此无法进行转换，出现如下报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.example.bean.RestResponse cannot be cast to java.lang.String</span><br></pre></td></tr></table></figure><p>为了能够处理 String 类型返回值，此处将其封装成统一类型之后再次使用 Json 转换器将其转换成 Json 字符串，最终将向响应流写入如下格式的数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;code&quot;:&quot;0&quot;,&quot;data&quot;:&quot;收到消息: 123&quot;,&quot;message&quot;:&quot;响应成功&quot;,&quot;success&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>使用 Postman 表现形式为不支持格式化的字符串，因为其 <code>Content-Type：application/json</code>，所以此处通过 <code>response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</code> 强制将响应类型标记为 Json 格式。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;code&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: <span class="string">&quot;收到消息: 123&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;响应成功&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;success&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="💪-功能增强"><a href="#💪-功能增强" class="headerlink" title="💪 功能增强"></a>💪 功能增强</h2><p>任何类都可以实现 <code>ResponseBodyAdvice</code> 接口，但是为了使其产生预期效果，需要了解其作用范围，默认仅为该类本身，也就是说，若由 Controller 实现，则仅对该控制器生效。因此该接口通常配合 <code>@ControllerAdvice</code> 注解使用。</p><h2 id="🍂-其他"><a href="#🍂-其他" class="headerlink" title="🍂 其他"></a>🍂 其他</h2><h3 id="📩-消息转换器"><a href="#📩-消息转换器" class="headerlink" title="📩 消息转换器"></a>📩 消息转换器</h3><p>Spring 向响应流写入数据是通过消息转换器（实现 <code>HttpMessageConverter</code> 接口）来处理的，其默认实现了一系列转换器，链式的处理返回值，直到能够正常写入响应流 。对于复杂类型默认使用<code>MappingJackson2HttpMessageConverter</code> 处理器，将复杂类型转换为 Json 格式的字符串，对于字符串类型默认使用 <code>StringHttpMessageConverter</code> 处理器。</p><h3 id="ControllerAdvice-注解"><a href="#ControllerAdvice-注解" class="headerlink" title="ControllerAdvice 注解"></a>ControllerAdvice 注解</h3><hr><p>Java bean web spring</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;🚩-需求描述&quot;&gt;&lt;a href=&quot;#🚩-需求描述&quot; class=&quot;headerlink&quot; title=&quot;🚩 需求描述&quot;&gt;&lt;/a&gt;🚩 需求描述&lt;/h2&gt;&lt;p&gt;封装统一的接口返回对象，使得前端能够获取格式规整的数据。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
</feed>
