<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Z&#39;s blog</title>
  
  
  <link href="http://daiwenzh5.github.io/atom.xml" rel="self"/>
  
  <link href="http://daiwenzh5.github.io/"/>
  <updated>2021-11-11T02:37:59.935Z</updated>
  <id>http://daiwenzh5.github.io/</id>
  
  <author>
    <name>daiwenzh5</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>WebFilter 路径匹配模式不生效</title>
    <link href="http://daiwenzh5.github.io/2021/11/10/yuque/WebFilter%20%E8%B7%AF%E5%BE%84%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%BC%8F%E4%B8%8D%E7%94%9F%E6%95%88/"/>
    <id>http://daiwenzh5.github.io/2021/11/10/yuque/WebFilter%20%E8%B7%AF%E5%BE%84%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%BC%8F%E4%B8%8D%E7%94%9F%E6%95%88/</id>
    <published>2021-11-10T11:23:17.000Z</published>
    <updated>2021-11-11T02:37:59.935Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在登录授权时，需要从 header 中获取 token 进行鉴权，通常使用过滤器处理指定的访问请求，但在使用 <code>@WebFilter</code> 注解时，发现其路径匹配模式不生效，即 <code>url、urlPatterns</code> 属性配置后，拦截了所有请求。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p><code>@WebServlet，@WebFilter，@WebListener</code> 注解，需要和 <code>@ServletComponentScan</code> 注解配套使用，表明其为 servlet 组件，而不是普通的 spring 组件，当使用 <code>@Component</code> 注解后，会优先被注册为 spring 组件，导致 servlet 扫描器失效。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ServletComponentScan(&quot;包名&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(Application.class, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 扫描所有 user 下的路径</span></span><br><span class="line"><span class="meta">@WebFilter(&quot;user/*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>可以通过 <code>FilterRegistrationBean</code> 装饰器，以编程方式手动注册过滤器。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;在登录授权时，需要从 header 中获取 token 进行鉴权，通常使用过滤器处理指定的访问请求，但在使用 &lt;code&gt;@WebFilter&lt;/code&gt; 注解时，发现其路径匹配模式不生效，即 &lt;code&gt;url、urlPatterns&lt;/code&gt; 属性配置后，拦截了所有请求。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/"/>
    
    <category term="WebFilter" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/WebFilter/"/>
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/tags/Spring-Boot/"/>
    
    <category term="WebFilter" scheme="http://daiwenzh5.github.io/tags/WebFilter/"/>
    
    <category term="属性失效" scheme="http://daiwenzh5.github.io/tags/%E5%B1%9E%E6%80%A7%E5%A4%B1%E6%95%88/"/>
    
    <category term="urlPatterns" scheme="http://daiwenzh5.github.io/tags/urlPatterns/"/>
    
  </entry>
  
  <entry>
    <title>Bootstrap 多环境配置</title>
    <link href="http://daiwenzh5.github.io/2021/11/06/yuque/Bootstrap%20%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    <id>http://daiwenzh5.github.io/2021/11/06/yuque/Bootstrap%20%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</id>
    <published>2021-11-06T03:50:40.000Z</published>
    <updated>2021-11-11T02:37:59.947Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>由于在 <code>bootstrap.yml</code> 文件中配置 CI/CD 的环境变量，而本地开发时并没有相关环境，所以需要手动切换其属性，在提交代码时，需要关注该配置文件是否会与云端冲突，极其浪费精力。<br>因此需要能够屏蔽本地与云端配置差异的手段。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>由于在测试过程中，发现使用 <code>bootstrap-local.yml</code> 的方式，无法成功切换环境，因此使用 spring 的指定外部配置文件的方式。通过在项目启动时，添加程序启动参数，手动指定配置文件所在路径 <code>--spring.config.location=classpath:/local/</code>。<br><strong>注意</strong>：<code>local </code> 是在 resources 下建立的目录，需要以 <code>/</code> 结尾表示其为目录。<br>当然，此处亦可精确指定加载哪个配置文件，但每个（放置在 resources 目录下的文件）都需要 <code>classpath:/</code> 开头，以表示其在类加载目录下，多个文件之间以 <code>,</code> 分割。<br>​<img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1636179267460-6b3276bd-cd67-45a0-9dd4-9b163e7b95db.png#clientId=u3f67ee5e-a41f-4&from=paste&height=423&id=u408245c0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=846&originWidth=1304&originalType=binary%E2%88%B6=1&size=105006&status=done&style=none&taskId=u3fbc3b8c-a563-4b16-bfe2-ff87e8c068a&width=652" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1636179267460-6b3276bd-cd67-45a0-9dd4-9b163e7b95db.png#clientId=u3f67ee5e-a41f-4&from=paste&height=423&id=u408245c0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=846&originWidth=1304&originalType=binary%E2%88%B6=1&size=105006&status=done&style=none&taskId=u3fbc3b8c-a563-4b16-bfe2-ff87e8c068a&width=652" srcset="data:image/png;base64,666" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;由于在 &lt;code&gt;bootstrap.yml&lt;/code&gt; 文件中配置 CI/CD 的环境变量，而本地开发时并没有相关环境，所以需要手动切换其属性，在提交代码时，需要关注该配置文件是否会与云端冲突，极其浪费精力。&lt;br&gt;因此需要能够屏蔽本地与云端配置差异的手段。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/"/>
    
    <category term="配置文件" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/tags/Spring-Boot/"/>
    
    <category term="配置文件" scheme="http://daiwenzh5.github.io/tags/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
    
    <category term="多环境" scheme="http://daiwenzh5.github.io/tags/%E5%A4%9A%E7%8E%AF%E5%A2%83/"/>
    
    <category term="Bootstrap" scheme="http://daiwenzh5.github.io/tags/Bootstrap/"/>
    
  </entry>
  
  <entry>
    <title>同时处理 XML 和 JSON 接口</title>
    <link href="http://daiwenzh5.github.io/2021/10/31/yuque/%E5%90%8C%E6%97%B6%E5%A4%84%E7%90%86%20XML%20%E5%92%8C%20JSON%20%E6%8E%A5%E5%8F%A3/"/>
    <id>http://daiwenzh5.github.io/2021/10/31/yuque/%E5%90%8C%E6%97%B6%E5%A4%84%E7%90%86%20XML%20%E5%92%8C%20JSON%20%E6%8E%A5%E5%8F%A3/</id>
    <published>2021-10-31T07:22:11.000Z</published>
    <updated>2021-11-11T02:37:59.959Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>出入参同时支持 XML 和 JSON 格式。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>在接口请求映射器注解中，指定 consumes 的媒体类型，用于标记入参格式，指定 produces 的媒体类型，用于标记出参格式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;地址&quot;,</span></span><br><span class="line"><span class="meta">           consumes = &#123;</span></span><br><span class="line"><span class="meta">               MediaType.APPLICATION_JSON_VALUE,</span></span><br><span class="line"><span class="meta">               MediaType.APPLICATION_XML_VALUE</span></span><br><span class="line"><span class="meta">           &#125;,</span></span><br><span class="line"><span class="meta">           produces = &#123;</span></span><br><span class="line"><span class="meta">               MediaType.APPLICATION_JSON_VALUE,</span></span><br><span class="line"><span class="meta">               MediaType.APPLICATION_XML_VALUE</span></span><br><span class="line"><span class="meta">           &#125;)</span></span><br></pre></td></tr></table></figure><p>同时，需要在 pom 中添加 xml 处理依赖。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 一般的由默认的 spring jackson 依赖控制版本号 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.jaxrs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-jaxrs-xml-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;出入参同时支持 XML 和 JSON 格式。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/"/>
    
    <category term="参数处理" scheme="http://daiwenzh5.github.io/categories/Spring-Boot/%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86/"/>
    
    
    <category term="Spring Boot" scheme="http://daiwenzh5.github.io/tags/Spring-Boot/"/>
    
    <category term="参数处理" scheme="http://daiwenzh5.github.io/tags/%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86/"/>
    
    <category term="XML" scheme="http://daiwenzh5.github.io/tags/XML/"/>
    
    <category term="JSON" scheme="http://daiwenzh5.github.io/tags/JSON/"/>
    
  </entry>
  
  <entry>
    <title>字段类型不一致的问题分析</title>
    <link href="http://daiwenzh5.github.io/2021/06/11/yuque/%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/"/>
    <id>http://daiwenzh5.github.io/2021/06/11/yuque/%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</id>
    <published>2021-06-11T02:14:30.000Z</published>
    <updated>2021-11-11T02:37:59.987Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>使用 mybatis 的结果集自动映射，发生了实体属性类型与表字段类型不一致；但实际上，相关实体的属性与表结构完全匹配。<br>关于实体类，是使用代码生成读取表结构生成的，但使用了公共父类，其中抽取出了一些通用的字段（包括主键、创建时间等）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span>&lt;<span class="title">Id</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableId</span></span><br><span class="line">    <span class="keyword">protected</span> Id id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;create_by&quot;, fill = INSERT, updateStrategy = NEVER)</span></span><br><span class="line">    <span class="keyword">protected</span> String createBy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;create_time&quot;, fill = INSERT, updateStrategy = NEVER)</span></span><br><span class="line">    <span class="keyword">protected</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;update_by&quot;, fill = FieldFill.UPDATE)</span></span><br><span class="line">    <span class="keyword">protected</span> String updateBy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;update_time&quot;, fill = FieldFill.UPDATE)</span></span><br><span class="line">    <span class="keyword">protected</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(&quot;ext1&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String ext1;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(&quot;ext2&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String ext2;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(&quot;ext3&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String ext3;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(&quot;ext4&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String ext4;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>不必计较父类中设置主键的合理性。</p></blockquote><p>BaseEntity.java 是基于 mybatis-plus，因此所有字段添加了相应的注解。<br>实体中依赖 lombok 隐藏 getter、setter 的实现细节，并使用了 @Builder 辅助实体创建。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><ol><li>使用 mybatis plus 的注解式开发，默认启用了 mybatis 的结果集自动映射，会通过构造器创建实体；</li><li>使用 lombok @Builder，导致实体生成了不包含父类属性的全参构造器；</li><li>mybatis 反射获取实体属性，构建属性类型、字段类型以及字段名称的独立列表；</li><li>mybatis 反射获取到实体构造器，当没有默认构造器时，会根据构造器参数索引顺序匹配字段，由于构造器参数长度是小于字段长度的，导致参数类型不匹配；</li></ol><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>在代码中添加默认构造器（通过反射获取，与可见性无关）。</p><h3 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h3><ol><li>不要在表实体中使用 lombok 的 @Builder，@AllArgsConstructor，防止在继承父类时，产生不完全的“全参”构造器；</li><li>或者强制在表实体中启用 lombok 的 @NoArgsConstructor，保证一定存在无参构造器；</li><li>也可以在表实体目录中强制禁止相关 lombok 注解，防止其他开发无意中使用；</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lombok.allArgsConstructor.flagUsage &#x3D; ERROR</span><br><span class="line">lombok.builder.flagUsage &#x3D; ERROR</span><br></pre></td></tr></table></figure><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><h4 id="DefaultResultSetHandler-java"><a href="#DefaultResultSetHandler-java" class="headerlink" title="DefaultResultSetHandler.java"></a>DefaultResultSetHandler.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getRowValue</span><span class="params">(ResultSetWrapper rsw, ResultMap resultMap, String columnPrefix)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ResultLoaderMap lazyLoader = <span class="keyword">new</span> ResultLoaderMap();</span><br><span class="line">   <span class="comment">// 1、创建结果对象</span></span><br><span class="line">  Object rowValue = createResultObject(rsw, resultMap, lazyLoader, columnPrefix);</span><br><span class="line">  <span class="keyword">if</span> (rowValue != <span class="keyword">null</span> &amp;&amp; !hasTypeHandlerForResultObject(rsw, resultMap.getType())) &#123;</span><br><span class="line">    <span class="keyword">final</span> MetaObject metaObject = configuration.newMetaObject(rowValue);</span><br><span class="line">    <span class="keyword">boolean</span> foundValues = <span class="keyword">this</span>.useConstructorMappings;</span><br><span class="line">    <span class="keyword">if</span> (shouldApplyAutomaticMappings(resultMap, <span class="keyword">false</span>)) &#123;</span><br><span class="line">      foundValues = applyAutomaticMappings(rsw, resultMap, metaObject, columnPrefix) || foundValues;</span><br><span class="line">    &#125;</span><br><span class="line">    foundValues = applyPropertyMappings(rsw, resultMap, metaObject, lazyLoader, columnPrefix) || foundValues;</span><br><span class="line">    foundValues = lazyLoader.size() &gt; <span class="number">0</span> || foundValues;</span><br><span class="line">    rowValue = foundValues || configuration.isReturnInstanceForEmptyRow() ? rowValue : <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> rowValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createResultObject</span><span class="params">(ResultSetWrapper rsw, ResultMap resultMap, ResultLoaderMap lazyLoader, String columnPrefix)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.useConstructorMappings = <span class="keyword">false</span>; <span class="comment">// reset previous mapping result</span></span><br><span class="line">  <span class="keyword">final</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">final</span> List&lt;Object&gt; constructorArgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 2、创建结果对象（使用可能存在的构造参数）</span></span><br><span class="line">  Object resultObject = createResultObject(rsw, resultMap, constructorArgTypes, constructorArgs, columnPrefix);</span><br><span class="line">  <span class="keyword">if</span> (resultObject != <span class="keyword">null</span> &amp;&amp; !hasTypeHandlerForResultObject(rsw, resultMap.getType())) &#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;ResultMapping&gt; propertyMappings = resultMap.getPropertyResultMappings();</span><br><span class="line">    <span class="keyword">for</span> (ResultMapping propertyMapping : propertyMappings) &#123;</span><br><span class="line">      <span class="comment">// issue gcode #109 &amp;&amp; issue #149</span></span><br><span class="line">      <span class="keyword">if</span> (propertyMapping.getNestedQueryId() != <span class="keyword">null</span> &amp;&amp; propertyMapping.isLazy()) &#123;</span><br><span class="line">        resultObject = configuration.getProxyFactory().createProxy(resultObject, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.useConstructorMappings = resultObject != <span class="keyword">null</span> &amp;&amp; !constructorArgTypes.isEmpty(); <span class="comment">// set current mapping result</span></span><br><span class="line">  <span class="keyword">return</span> resultObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createResultObject</span><span class="params">(ResultSetWrapper rsw, ResultMap resultMap, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs, String columnPrefix)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Class&lt;?&gt; resultType = resultMap.getType();</span><br><span class="line">  <span class="keyword">final</span> MetaClass metaType = MetaClass.forClass(resultType, reflectorFactory);</span><br><span class="line">  <span class="keyword">final</span> List&lt;ResultMapping&gt; constructorMappings = resultMap.getConstructorResultMappings();</span><br><span class="line">  <span class="keyword">if</span> (hasTypeHandlerForResultObject(rsw, resultType)) &#123;</span><br><span class="line">    <span class="keyword">return</span> createPrimitiveResultObject(rsw, resultMap, columnPrefix);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!constructorMappings.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">return</span> createParameterizedResultObject(rsw, resultType, constructorMappings, constructorArgTypes, constructorArgs, columnPrefix);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resultType.isInterface() || metaType.hasDefaultConstructor()) &#123;</span><br><span class="line">      <span class="comment">// 2.1、使用无参构造器创建对象</span></span><br><span class="line">    <span class="keyword">return</span> objectFactory.create(resultType);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldApplyAutomaticMappings(resultMap, <span class="keyword">false</span>)) &#123;</span><br><span class="line">      <span class="comment">// 2.2、使用有参的构造器创建对象</span></span><br><span class="line">    <span class="keyword">return</span> createByConstructorSignature(rsw, resultType, constructorArgTypes, constructorArgs);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ExecutorException(<span class="string">&quot;Do not know how to create an instance of &quot;</span> + resultType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createByConstructorSignature</span><span class="params">(ResultSetWrapper rsw, Class&lt;?&gt; resultType, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Constructor&lt;?&gt;[] constructors = resultType.getDeclaredConstructors();</span><br><span class="line">  <span class="comment">// 3、获取构造器</span></span><br><span class="line">  <span class="keyword">final</span> Constructor&lt;?&gt; defaultConstructor = findDefaultConstructor(constructors);</span><br><span class="line">  <span class="keyword">if</span> (defaultConstructor != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 4、使用构造器创建对象</span></span><br><span class="line">    <span class="keyword">return</span> createUsingConstructor(rsw, resultType, constructorArgTypes, constructorArgs, defaultConstructor);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Constructor&lt;?&gt; constructor : constructors) &#123;</span><br><span class="line">      <span class="keyword">if</span> (allowedConstructorUsingTypeHandlers(constructor, rsw.getJdbcTypes())) &#123;</span><br><span class="line">        <span class="keyword">return</span> createUsingConstructor(rsw, resultType, constructorArgTypes, constructorArgs, constructor);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ExecutorException(<span class="string">&quot;No constructor found in &quot;</span> + resultType.getName() + <span class="string">&quot; matching &quot;</span> + rsw.getClassNames());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Constructor&lt;?&gt; findDefaultConstructor(<span class="keyword">final</span> Constructor&lt;?&gt;[] constructors) &#123;</span><br><span class="line">    <span class="comment">// 3.1、仅包含一个构造器直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (constructors.length == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> constructors[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.2、返回包含 @AutomapConstructor 的构造器</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">final</span> Constructor&lt;?&gt; constructor : constructors) &#123;</span><br><span class="line">    <span class="keyword">if</span> (constructor.isAnnotationPresent(AutomapConstructor.class)) &#123;</span><br><span class="line">      <span class="keyword">return</span> constructor;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createUsingConstructor</span><span class="params">(ResultSetWrapper rsw, Class&lt;?&gt; resultType, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs, Constructor&lt;?&gt; constructor)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> foundValues = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; constructor.getParameterTypes().length; i++) &#123;</span><br><span class="line">      <span class="comment">// 4.1、通过构造器参数进行匹配参数类型</span></span><br><span class="line">    Class&lt;?&gt; parameterType = constructor.getParameterTypes()[i];</span><br><span class="line">    String columnName = rsw.getColumnNames().get(i);</span><br><span class="line">    TypeHandler&lt;?&gt; typeHandler = rsw.getTypeHandler(parameterType, columnName);</span><br><span class="line">    Object value = typeHandler.getResult(rsw.getResultSet(), columnName);</span><br><span class="line">    constructorArgTypes.add(parameterType);</span><br><span class="line">    constructorArgs.add(value);</span><br><span class="line">    foundValues = value != <span class="keyword">null</span> || foundValues;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> foundValues ? objectFactory.create(resultType, constructorArgTypes, constructorArgs) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h2&gt;&lt;p&gt;使用 mybatis 的结果集自动映射，发生了实体属性类型与表字段类型不一致；但实际上，相关实体的属性与表结构完全匹配。&lt;br&gt;关于实体类，是使用代码生成读取表结构生成的，但使用了公共父类，其中抽取出了一些通用的字段（包括主键、创建时间等）。&lt;/p&gt;</summary>
    
    
    
    <category term="Mybatis" scheme="http://daiwenzh5.github.io/categories/Mybatis/"/>
    
    <category term="结果集" scheme="http://daiwenzh5.github.io/categories/Mybatis/%E7%BB%93%E6%9E%9C%E9%9B%86/"/>
    
    
    <category term="结果集" scheme="http://daiwenzh5.github.io/tags/%E7%BB%93%E6%9E%9C%E9%9B%86/"/>
    
    <category term="Mybatis" scheme="http://daiwenzh5.github.io/tags/Mybatis/"/>
    
    <category term="Lombok" scheme="http://daiwenzh5.github.io/tags/Lombok/"/>
    
    <category term="异常分析" scheme="http://daiwenzh5.github.io/tags/%E5%BC%82%E5%B8%B8%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>JetCache 使用</title>
    <link href="http://daiwenzh5.github.io/2021/04/23/yuque/JetCache%20%E4%BD%BF%E7%94%A8/"/>
    <id>http://daiwenzh5.github.io/2021/04/23/yuque/JetCache%20%E4%BD%BF%E7%94%A8/</id>
    <published>2021-04-23T06:01:54.000Z</published>
    <updated>2021-11-11T02:38:00.023Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="Optional-支持"><a href="#Optional-支持" class="headerlink" title="Optional 支持"></a>Optional 支持</h3><p>由于 Optional 并不支持序列化，因此无法直接将其作为方法返回值、托管给 JetCache。必须对其进行拓展，添加自定义的编码器以及解码器。</p><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><p>依赖于 com.alicp.jetcache:jetcache-core:2.5.16。</p><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>只要将自定义的编码器注册为 bean 即可。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jetcache:</span></span><br><span class="line">  <span class="attr">remote:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">valueEncoder:</span> <span class="string">bean:jetValueEncoder</span></span><br></pre></td></tr></table></figure><h4 id="编码器实现"><a href="#编码器实现" class="headerlink" title="编码器实现"></a>编码器实现</h4><ol><li>在序列化之前，将 Optional 中的值取出，并在打上自定义的标记（IDENTITY_NUMBER 的值），对于非 Optional 类型的数据，则沿用默认的编码器器（JavaValueEncoder）；</li><li>编码器需要注册成 spring bean，启用自定义标记之后，解码器则通过读取自定义标记进行匹配；</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JetValueEncoder</span> <span class="keyword">extends</span> <span class="title">JavaValueEncoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INIT_BUF_SIZE = <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;WeakReference&lt;ByteArrayOutputStream&gt;&gt; THREAD_LOCAL =</span><br><span class="line">            ThreadLocal.withInitial(() -&gt; <span class="keyword">new</span> WeakReference&lt;&gt;(<span class="keyword">new</span> ByteArrayOutputStream(INIT_BUF_SIZE)));</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">int</span> IDENTITY_NUMBER = <span class="number">0x4A953A84</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JetValueEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JetValueEncoder</span><span class="params">(<span class="keyword">boolean</span> useIdentityNumber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(useIdentityNumber);</span><br><span class="line">        registerDecoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册解码器，此处为匿名内部类，直接实例并注册到 DecoderMap，</span></span><br><span class="line">    <span class="comment">// 键值为JetValueEncoder.IDENTITY_NUMBER，自定义标记</span></span><br><span class="line">    <span class="comment">// 实现逻辑，在反序列化之后，将标记匹配的值封装到 Optional 中</span></span><br><span class="line">    <span class="comment">// 标记不匹配的，则被其他解码器处理，不用考虑</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SpringJavaValueDecoder decoder = <span class="keyword">new</span> SpringJavaValueDecoder(<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">doApply</span><span class="params">(<span class="keyword">byte</span>[] buffer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Object obj = <span class="keyword">super</span>.doApply(buffer);</span><br><span class="line">                <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> CacheValueHolder) &#123;</span><br><span class="line">                    CacheValueHolder&lt;Object&gt; valueHolder = (CacheValueHolder&lt;Object&gt;) obj;</span><br><span class="line">                    valueHolder.setValue(Optional.ofNullable(valueHolder.getValue()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> obj;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        DecoderMap.register(JetValueEncoder.IDENTITY_NUMBER, decoder);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] apply(Object value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> CacheValueHolder) &#123;</span><br><span class="line">            CacheValueHolder&lt;Object&gt; valueHolder = (CacheValueHolder&lt;Object&gt;) value;</span><br><span class="line">            Object holderValue = ((CacheValueHolder&lt;?&gt;) value).getValue();</span><br><span class="line">            <span class="keyword">if</span> (holderValue <span class="keyword">instanceof</span> Optional) &#123;</span><br><span class="line">                Optional&lt;?&gt; valeOpt = (Optional&lt;?&gt;) holderValue;</span><br><span class="line">                valeOpt.ifPresent(valueHolder::setValue);</span><br><span class="line">                <span class="keyword">return</span> doApply(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.apply(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从父类中拷贝，由于父类中 IDENTITY_NUMBER 是静态变量，&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     * 且没有提供可重构 getter，所以不得不进行代码搬运法。╮(╯▽╰)╭&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     * 父类中应该使用 getIdentityNumber() 方法获取 IDENTITY_NUMBER 的值，&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> JavaValueEncoder#apply(Object)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] doApply(Object value) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            WeakReference&lt;ByteArrayOutputStream&gt; ref = THREAD_LOCAL.get();</span><br><span class="line">            ByteArrayOutputStream bos = ref.get();</span><br><span class="line">            <span class="keyword">if</span> (bos == <span class="keyword">null</span>) &#123;</span><br><span class="line">                bos = <span class="keyword">new</span> ByteArrayOutputStream(INIT_BUF_SIZE);</span><br><span class="line">                THREAD_LOCAL.set(<span class="keyword">new</span> WeakReference&lt;&gt;(bos));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (useIdentityNumber) &#123;</span><br><span class="line">                    bos.write((IDENTITY_NUMBER &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    bos.write((IDENTITY_NUMBER &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    bos.write((IDENTITY_NUMBER &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    bos.write(IDENTITY_NUMBER &amp; <span class="number">0xFF</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">                oos.writeObject(value);</span><br><span class="line">                oos.flush();</span><br><span class="line">                <span class="keyword">return</span> bos.toByteArray();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                bos.reset();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CacheEncodeException(<span class="string">&quot;Java Encode error. &quot;</span> + <span class="string">&quot;msg=&quot;</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>从源码中 <code>SpringConfigProvider#parseValueEncoder</code> 可以找到编码器的加载入口，当 valueEncoder 属性匹配到 “bean:”前缀的编码器时，则启用该 bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1、ExternalCacheAutoInit#parseGeneralConfig</span></span><br><span class="line">   <span class="comment">// 自动初始化配置</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseGeneralConfig</span><span class="params">(CacheBuilder builder, ConfigTree ct)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.parseGeneralConfig(builder, ct);</span><br><span class="line">       ExternalCacheBuilder ecb = (ExternalCacheBuilder) builder;</span><br><span class="line">       ecb.setKeyPrefix(ct.getProperty(<span class="string">&quot;keyPrefix&quot;</span>));</span><br><span class="line">       <span class="comment">// 设置编码器，指定了配置中的 key：valueEncoder</span></span><br><span class="line">       ecb.setValueEncoder(configProvider.parseValueEncoder(ct.getProperty(<span class="string">&quot;valueEncoder&quot;</span>, CacheConsts.DEFAULT_SERIAL_POLICY)));</span><br><span class="line">       ecb.setValueDecoder(configProvider.parseValueDecoder(ct.getProperty(<span class="string">&quot;valueDecoder&quot;</span>, CacheConsts.DEFAULT_SERIAL_POLICY)));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2、SpringConfigProvider#parseValueEncoder</span></span><br><span class="line">   <span class="comment">// spring 环境中的配置规则，先尝试搜索是否存在注册为 spring bean 的编码器</span></span><br><span class="line">   <span class="keyword">public</span> Function&lt;Object, <span class="keyword">byte</span>[]&gt; parseValueEncoder(String valueEncoder) &#123;</span><br><span class="line">       <span class="comment">// 进入 bean 加载方法</span></span><br><span class="line">       String beanName = parseBeanName(valueEncoder);</span><br><span class="line">       <span class="comment">// bean 名称存在时注册 spring 托管的编码器</span></span><br><span class="line">       <span class="keyword">if</span> (beanName == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">super</span>.parseValueEncoder(valueEncoder);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           Object bean = applicationContext.getBean(beanName);</span><br><span class="line">           <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Function) &#123;</span><br><span class="line">               <span class="keyword">return</span> (Function&lt;Object, <span class="keyword">byte</span>[]&gt;) bean;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> ((SerialPolicy) bean).encoder();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3、SpringConfigProvider#parseBeanName</span></span><br><span class="line"><span class="comment">// bean 名称的解析，需要在配置文件中指定 valueEncode 属性：&#x27;bean:anyName&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">parseBeanName</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 通过 “bean:” 前缀匹配 bean 名称</span></span><br><span class="line">       <span class="keyword">final</span> String beanPrefix = <span class="string">&quot;bean:&quot;</span>;</span><br><span class="line">       <span class="keyword">int</span> len = beanPrefix.length();</span><br><span class="line">       <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; str.startsWith(beanPrefix) &amp;&amp; str.length() &gt; len) &#123;</span><br><span class="line">           <span class="keyword">return</span> str.substring(len);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4、AbstractValueDecoder#apply</span></span><br><span class="line">   <span class="comment">// 解码器入口，对于 useIdentityNumber = true，及开启自定义标记的序列化数据，</span></span><br><span class="line">   <span class="comment">// 需要在 DecoderMap 中通过 identityNumber 进行匹配</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">apply</span><span class="params">(<span class="keyword">byte</span>[] buffer)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (useIdentityNumber) &#123;</span><br><span class="line">               DecoderMap.registerBuildInDecoder();</span><br><span class="line">               <span class="keyword">int</span> identityNumber = parseHeader(buffer);</span><br><span class="line">               AbstractValueDecoder decoder = DecoderMap.getDecoder(identityNumber);</span><br><span class="line">               Objects.requireNonNull(decoder, <span class="string">&quot;no decoder for identity number:&quot;</span> + identityNumber);</span><br><span class="line">               <span class="keyword">return</span> decoder.doApply(buffer);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> doApply(buffer);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> CacheEncodeException(<span class="string">&quot;decode error&quot;</span>, e);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;h2 id=&quot;解决方案&quot;&gt;&lt;a href=&quot;#解决方案&quot; class=&quot;headerlink&quot; title=&quot;解决方案&quot;&gt;&lt;/a&gt;解决方案&lt;/h2&gt;</summary>
    
    
    
    <category term="缓存" scheme="http://daiwenzh5.github.io/categories/%E7%BC%93%E5%AD%98/"/>
    
    <category term="Redis" scheme="http://daiwenzh5.github.io/categories/%E7%BC%93%E5%AD%98/Redis/"/>
    
    
    <category term="JetCache" scheme="http://daiwenzh5.github.io/tags/JetCache/"/>
    
    <category term="多级缓存" scheme="http://daiwenzh5.github.io/tags/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/"/>
    
    <category term="使用" scheme="http://daiwenzh5.github.io/tags/%E4%BD%BF%E7%94%A8/"/>
    
    <category term="拓展" scheme="http://daiwenzh5.github.io/tags/%E6%8B%93%E5%B1%95/"/>
    
  </entry>
  
  <entry>
    <title>Feign 自定义配置</title>
    <link href="http://daiwenzh5.github.io/2021/03/30/yuque/Feign%20%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/"/>
    <id>http://daiwenzh5.github.io/2021/03/30/yuque/Feign%20%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/</id>
    <published>2021-03-30T08:02:00.000Z</published>
    <updated>2021-11-11T02:38:00.051Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在微服务项目中，需要请求第三方接口，通常情况下我们使用 spring 的 restTemplate。但接触到 feign 之后，这种将远程方法伪装成本地接口，屏蔽请求感知的方式，无疑更优雅。<br>但对于 oauth 认证，需要配置请求头，即设置 feign 的自定义配置。</p><h2 id="自定义授权头信息"><a href="#自定义授权头信息" class="headerlink" title="自定义授权头信息"></a>自定义授权头信息</h2><h3 id="请求远程连接"><a href="#请求远程连接" class="headerlink" title="请求远程连接"></a>请求远程连接</h3><p><code>@FeignClient</code> 用于注册接口为 feign 客户端，在 spring cloud 项目中，需要在其 value（或 name）属性中指定对应的微服务名，url 置空（将自动匹配配置中西地址）。当需要调用任意的 http 请求时，只要给定 url 值即可。<br><strong>注意</strong> ：此时，虽然不是请求微服务接口，仍然需要设置 name，填写任意（不冲突的）名称即可。</p><h3 id="授权流程"><a href="#授权流程" class="headerlink" title="授权流程"></a>授权流程</h3><h3 id="授权配置"><a href="#授权配置" class="headerlink" title="授权配置"></a>授权配置</h3><p>需要通过自定义配置属性来指定请求头，对应 <code>@FeignClient</code> 的 configuration 属性。<br>该属性指定一个自定义配置类，用于设置 feign 的任意配置。</p><h4 id="Basic-认证"><a href="#Basic-认证" class="headerlink" title="Basic 认证"></a>Basic 认证</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @Configuration 托管给 spring 之后，会被注册为全局配置</span></span><br><span class="line"><span class="comment">// 局部配置需要指定在 @FeignClient(configuration = SomeAuthConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeAuthConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BasicAuthRequestInterceptor <span class="title">basicAuthRequestInterceptor</span><span class="params">(SomeProperties someProperties)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// someProperties 是一个属性类</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BasicAuthRequestInterceptor(</span><br><span class="line">                someProperties.getAuth().getUser(),</span><br><span class="line">                someProperties.getAuth().getPassword()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="请求-token"><a href="#请求-token" class="headerlink" title="请求 token"></a>请求 token</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(</span></span><br><span class="line"><span class="meta">        name = &quot;some-auth&quot;, url = &quot;$&#123;some.auth.url&#125;&quot;,</span></span><br><span class="line"><span class="meta">        configuration = SomeAuthConfig.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SomeAuthIntegration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 token</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 授权信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/xxx&quot;)</span></span><br><span class="line">    <span class="function">SomeAuthResponse <span class="title">getToken</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="设置-Authorization-Header"><a href="#设置-Authorization-Header" class="headerlink" title="设置 Authorization Header"></a>设置 Authorization Header</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeTokenConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置 header auth</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authIntegration 授权接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 请求拦截器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestInterceptor <span class="title">requestInterceptor</span><span class="params">(SomeAuthIntegration authIntegration)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 此处使用的是 lambda 表达式返回一个实现 RequestInterceptor 的匿名类，</span></span><br><span class="line">        <span class="comment">// 在 lambda 表达式外部的操作会在 bean 注册时生效，</span></span><br><span class="line">        <span class="comment">// 因此，每次获取 token 的操作，应该放在表达式内部</span></span><br><span class="line">        <span class="keyword">return</span> requestTemplate -&gt; &#123;</span><br><span class="line">            SomeAuthResponse authResponse = authIntegration.getToken();</span><br><span class="line">            requestTemplate.header(</span><br><span class="line">                    AUTHORIZATION,</span><br><span class="line">                    StrUtil.format(<span class="string">&quot;&#123;&#125; &#123;&#125;&quot;</span>, authResponse.getTokenType(), authResponse.getAccessToken())</span><br><span class="line">            );</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="已授权请求"><a href="#已授权请求" class="headerlink" title="已授权请求"></a>已授权请求</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(</span></span><br><span class="line"><span class="meta">        name = &quot;some-reply&quot;, url = &quot;$&#123;some.reply.url&#125;&quot;,</span></span><br><span class="line"><span class="meta">        configuration = SomeTokenConfig.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SomeReplyIntegration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回传状态</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status 状态信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/xxx&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(SomeStatus status)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自定义解码器"><a href="#自定义解码器" class="headerlink" title="自定义解码器"></a>自定义解码器</h2><p>当响应信息实际返回的是 json 格式，但头信息描述类型是 <em>Content-Type: text/xml;charset=utf-8</em> （或其他非 *application/json *类型）时，feign 的默认消息转换器无法解析，此时就需要重新使用自定义解码器。<br>在配置类中注册 Decoder bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Decoder <span class="title">someResponseDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SpringDecoder(() -&gt; <span class="keyword">new</span> HttpMessageConverters(</span><br><span class="line">            <span class="keyword">new</span> MappingJackson2HttpMessageConverter() &#123;</span><br><span class="line">                &#123;</span><br><span class="line">                    setSupportedMediaTypes(Lists.newArrayList(MediaType.TEXT_XML));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>feing 基于 http 请求，在其配置类中，可以实现任意 http 的相关配置，包括超时时间、重试次数等。<br>一般情况下，accessToken 存在过期时间，为了防止频繁请求授权，应该在过期之前进行缓存。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;在微服务项目中，需要请求第三方接口，通常情况下我们使用 spring 的 restTemplate。但接触到 feign 之后，这种将远程方法伪装成本地接口，屏蔽请求感知的方式，无疑更优雅。&lt;br&gt;但对于 oauth 认证，需要配置请求头，即设置 feign 的自定义配置。&lt;/p&gt;</summary>
    
    
    
    <category term="Spring" scheme="http://daiwenzh5.github.io/categories/Spring/"/>
    
    <category term="Feign" scheme="http://daiwenzh5.github.io/categories/Spring/Feign/"/>
    
    
    <category term="Feign" scheme="http://daiwenzh5.github.io/tags/Feign/"/>
    
    <category term="Configuration" scheme="http://daiwenzh5.github.io/tags/Configuration/"/>
    
    <category term="HTTP" scheme="http://daiwenzh5.github.io/tags/HTTP/"/>
    
    <category term="拦截器" scheme="http://daiwenzh5.github.io/tags/%E6%8B%A6%E6%88%AA%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>实现 Jar 多版本共存</title>
    <link href="http://daiwenzh5.github.io/2021/03/22/yuque/%E5%AE%9E%E7%8E%B0%20Jar%20%E5%A4%9A%E7%89%88%E6%9C%AC%E5%85%B1%E5%AD%98/"/>
    <id>http://daiwenzh5.github.io/2021/03/22/yuque/%E5%AE%9E%E7%8E%B0%20Jar%20%E5%A4%9A%E7%89%88%E6%9C%AC%E5%85%B1%E5%AD%98/</id>
    <published>2021-03-22T15:04:51.000Z</published>
    <updated>2021-11-11T02:38:00.063Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>现需要实现同时共存两个版本的 SDK，其中存在限定名完全相同的类，但两个类的方法并不完全相同，导致 JVM 在加载时无法按预期的调用类方法。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>由于 SDK 中依赖了大量的封装对象，无法使用简单的反射调用方法，因此自定义类加载器并不能解决。首先想到的是使用 maven 插件，在编译时修改指定的 SDK 的类名，<code>maven-shade-plugin</code> 并不能很好的解决，按照博客中的经验，可以将待处理的模块在一个空白模块中引入，并使用 shade 进行重命名，但是实际类引用的时候，依旧是原类名，只有在 maven 打包后，新名称将被替换值 class 文件中，这就导致了，如果有多个模块进行了调用 SDK，则需要处理多个模块，而且经常出现预期之外的问题，耗费精力。<br>最终是使用 <a href="https://github.com/google/jarjar">jarjar</a> 来解决的。<br><a href="https://code.google.com/archive/p/jarjar/">下载地址</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar jarjar.jar process rule.txt old.jar new.jar</span><br></pre></td></tr></table></figure><p>其中，rule.txt 是任意文件名，其中指定了替换规则：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rule com.old.package.** com.new.package.@1</span><br></pre></td></tr></table></figure><p>或者使用 <a href="http://sonatype.github.io/jarjar-maven-plugin/">jarjar-maven-plugin</a>（未验证）</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;现需要实现同时共存两个版本的 SDK，其中存在限定名完全相同的类，但两个类的方法并不完全相同，导致 JVM 在加载时无法按预期的调用类方法。&lt;/p&gt;</summary>
    
    
    
    <category term="工具" scheme="http://daiwenzh5.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    <category term="Java" scheme="http://daiwenzh5.github.io/categories/%E5%B7%A5%E5%85%B7/Java/"/>
    
    
    <category term="工具" scheme="http://daiwenzh5.github.io/tags/%E5%B7%A5%E5%85%B7/"/>
    
    <category term="Java" scheme="http://daiwenzh5.github.io/tags/Java/"/>
    
    <category term="Jar 冲突" scheme="http://daiwenzh5.github.io/tags/Jar-%E5%86%B2%E7%AA%81/"/>
    
    <category term="多版本" scheme="http://daiwenzh5.github.io/tags/%E5%A4%9A%E7%89%88%E6%9C%AC/"/>
    
  </entry>
  
  <entry>
    <title>打包外部依赖</title>
    <link href="http://daiwenzh5.github.io/2021/03/21/yuque/%E6%89%93%E5%8C%85%E5%A4%96%E9%83%A8%E4%BE%9D%E8%B5%96/"/>
    <id>http://daiwenzh5.github.io/2021/03/21/yuque/%E6%89%93%E5%8C%85%E5%A4%96%E9%83%A8%E4%BE%9D%E8%B5%96/</id>
    <published>2021-03-21T09:30:02.000Z</published>
    <updated>2021-11-11T02:38:00.071Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>由于公司 SDK 没有正式上线，只能提供 jar，需要手动添加依赖，在使用 maven 打包的时候提示找不到符号。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>将外部 jar 使用 maven 管理</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 因为实际不会从远程仓库下载，因此坐标可以填写任意值 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>任意值<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>任意值<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>任意值<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- scope 必须是 system，表明是从本地读取信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>项目中的相对路径<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 额外配置，</span></span><br><span class="line"><span class="comment">默认情况下，外部依赖只会在编译时加载，打包后会丢失，</span></span><br><span class="line"><span class="comment">需要增加以下配置</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- includeSystemScope 开启即可--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">includeSystemScope</span>&gt;</span>true<span class="tag">&lt;/<span class="name">includeSystemScope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;由于公司 SDK 没有正式上线，只能提供 jar，需要手动添加依赖，在使用 maven 打包的时候提示找不到符号。&lt;/p&gt;</summary>
    
    
    
    <category term="Maven" scheme="http://daiwenzh5.github.io/categories/Maven/"/>
    
    <category term="打包" scheme="http://daiwenzh5.github.io/categories/Maven/%E6%89%93%E5%8C%85/"/>
    
    
    <category term="Maven" scheme="http://daiwenzh5.github.io/tags/Maven/"/>
    
    <category term="Lib" scheme="http://daiwenzh5.github.io/tags/Lib/"/>
    
    <category term="Install" scheme="http://daiwenzh5.github.io/tags/Install/"/>
    
    <category term="外部依赖" scheme="http://daiwenzh5.github.io/tags/%E5%A4%96%E9%83%A8%E4%BE%9D%E8%B5%96/"/>
    
  </entry>
  
  <entry>
    <title>LocalDate 解析年月字符串</title>
    <link href="http://daiwenzh5.github.io/2021/02/07/yuque/LocalDate%20%E8%A7%A3%E6%9E%90%E5%B9%B4%E6%9C%88%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    <id>http://daiwenzh5.github.io/2021/02/07/yuque/LocalDate%20%E8%A7%A3%E6%9E%90%E5%B9%B4%E6%9C%88%E5%AD%97%E7%AC%A6%E4%B8%B2/</id>
    <published>2021-02-07T09:20:53.000Z</published>
    <updated>2021-11-11T02:38:00.075Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>使用 LocalDate 解析 <code>yyyy-MM</code> 格式的字符串时异常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.time.DateTimeException: Unable to obtain LocalDate from TemporalAccessor: &#123;Year&#x3D;2021, MonthOfYear&#x3D;1&#125;,ISO of type java.time.format.Parsed</span><br><span class="line">at java.time.LocalDate.from(LocalDate.java:368)</span><br><span class="line">at java.time.format.Parsed.query(Parsed.java:226)</span><br><span class="line">at java.time.format.DateTimeFormatter.parse(DateTimeFormatter.java:1851)</span><br><span class="line">... 2 more</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>字符串解析到 LocalDate 必须具体到日期，因此需要给年月的格式添加默认日期，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ① 调整 DateTimeFormatter</span></span><br><span class="line">     DateTimeFormatter fmt = <span class="keyword">new</span> DateTimeFormatterBuilder()</span><br><span class="line">            .appendPattern(<span class="string">&quot;yyyy-MM&quot;</span>)</span><br><span class="line">        <span class="comment">// 添加默认日期</span></span><br><span class="line">            .parseDefaulting(ChronoField.DAY_OF_MONTH, <span class="number">1</span>)</span><br><span class="line">            .toFormatter();</span><br><span class="line">    <span class="comment">// ② 使用 YearMonth 转换</span></span><br><span class="line">    YearMonth yearMonth = YearMonth.parse(<span class="string">&quot;2021-01&quot;</span>, fmt);</span><br><span class="line">    LocalDate localDate = yearMonth.atEndOfMonth();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;使用 LocalDate 解析 &lt;code&gt;yyyy-MM&lt;/code&gt; 格式的字符串时异常：&lt;/p&gt;</summary>
    
    
    
    <category term="JDK8" scheme="http://daiwenzh5.github.io/categories/JDK8/"/>
    
    <category term="Time" scheme="http://daiwenzh5.github.io/categories/JDK8/Time/"/>
    
    
    <category term="JDK8" scheme="http://daiwenzh5.github.io/tags/JDK8/"/>
    
    <category term="Time" scheme="http://daiwenzh5.github.io/tags/Time/"/>
    
    <category term="LocalDate" scheme="http://daiwenzh5.github.io/tags/LocalDate/"/>
    
    <category term="日期格式化" scheme="http://daiwenzh5.github.io/tags/%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>发布到私有仓库</title>
    <link href="http://daiwenzh5.github.io/2021/02/06/yuque/%E5%8F%91%E5%B8%83%E5%88%B0%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/"/>
    <id>http://daiwenzh5.github.io/2021/02/06/yuque/%E5%8F%91%E5%B8%83%E5%88%B0%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/</id>
    <published>2021-02-05T17:37:56.000Z</published>
    <updated>2021-11-11T02:38:00.083Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>需要将工具类发布到公司的私有仓库中，为了避免每次手动在页面上操作，此处借助 maven 命令行和 idea 启动项实现一键发布。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="配置服务器地址"><a href="#配置服务器地址" class="headerlink" title="配置服务器地址"></a>配置服务器地址</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- maven settings.xml --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 未配置时会提示 401 权限不足 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>仓库名<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">username</span>&gt;</span>账号<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">password</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="发布命令"><a href="#发布命令" class="headerlink" title="发布命令"></a>发布命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令</span></span><br><span class="line">mvn deploy:deploy-file</span><br><span class="line"></span><br><span class="line"><span class="comment">## 自定义参数 -Dparam</span></span><br><span class="line"><span class="comment">## -DgroupId=项目</span></span><br><span class="line"><span class="comment">## -DartifactId=模块</span></span><br><span class="line"><span class="comment">## -Dversion=版本号</span></span><br><span class="line"><span class="comment">## -Dpackaging=打包方式</span></span><br><span class="line"><span class="comment">## -Dfile=本地路径</span></span><br><span class="line"><span class="comment">## -Dsources=源码路径</span></span><br><span class="line"><span class="comment">## -Durl=仓库地址</span></span><br><span class="line"><span class="comment">## -DrepositoryId=指定仓库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如:</span></span><br><span class="line">mvn deploy:deploy-file \</span><br><span class="line">-DgroupId=com.xyz \</span><br><span class="line">-DartifactId=<span class="built_in">test</span> \</span><br><span class="line">-Dversion=1.0.0 \</span><br><span class="line">-Dpackaging=jar \</span><br><span class="line">-Dfile=path/name-1.0.0.jar \</span><br><span class="line">-Dsources=path/name-1.0.0-sources.jar \</span><br><span class="line">-Durl=http://ip/nexus/content/repositories/thirdparty/ \</span><br><span class="line">-DrepositoryId=thirdparty</span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令中可以使用 pom 变量，如 -Dversion=$&#123;project.version&#125;</span></span><br></pre></td></tr></table></figure><h3 id="Idea-中的配置"><a href="#Idea-中的配置" class="headerlink" title="Idea 中的配置"></a>Idea 中的配置</h3><p><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1612548053894-e9ae4173-6e15-4b1c-9a75-f21e63819b56.png#align=left&display=inline&height=883&margin=%5Bobject%20Object%5D&name=image.png&originHeight=883&originWidth=1343&size=128863&status=done&style=none&width=1343" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1612548053894-e9ae4173-6e15-4b1c-9a75-f21e63819b56.png#align=left&display=inline&height=883&margin=%5Bobject%20Object%5D&name=image.png&originHeight=883&originWidth=1343&size=128863&status=done&style=none&width=1343" srcset="data:image/png;base64,666" alt="image.png"><br>此后就可以一键发布了。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/681418/1612548199808-4f6c438d-580b-4f28-b336-1bf94f167a8c.png#align=left&display=inline&height=40&margin=%5Bobject%20Object%5D&name=image.png&originHeight=40&originWidth=426&size=11831&status=done&style=none&width=426" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/681418/1612548199808-4f6c438d-580b-4f28-b336-1bf94f167a8c.png#align=left&display=inline&height=40&margin=%5Bobject%20Object%5D&name=image.png&originHeight=40&originWidth=426&size=11831&status=done&style=none&width=426" srcset="data:image/png;base64,666" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;需要将工具类发布到公司的私有仓库中，为了避免每次手动在页面上操作，此处借助 maven 命令行和 idea 启动项实现一键发布。&lt;/p&gt;</summary>
    
    
    
    <category term="Maven" scheme="http://daiwenzh5.github.io/categories/Maven/"/>
    
    <category term="命令行" scheme="http://daiwenzh5.github.io/categories/Maven/%E5%91%BD%E4%BB%A4%E8%A1%8C/"/>
    
    
    <category term="Maven" scheme="http://daiwenzh5.github.io/tags/Maven/"/>
    
    <category term="Deploy" scheme="http://daiwenzh5.github.io/tags/Deploy/"/>
    
    <category term="Idea" scheme="http://daiwenzh5.github.io/tags/Idea/"/>
    
    <category term="命令行" scheme="http://daiwenzh5.github.io/tags/%E5%91%BD%E4%BB%A4%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>OpenConnect Client 使用</title>
    <link href="http://daiwenzh5.github.io/2021/01/02/yuque/OpenConnect%20Client%20%E4%BD%BF%E7%94%A8/"/>
    <id>http://daiwenzh5.github.io/2021/01/02/yuque/OpenConnect%20Client%20%E4%BD%BF%E7%94%A8/</id>
    <published>2021-01-02T09:01:41.000Z</published>
    <updated>2021-11-11T02:38:00.103Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><ol><li>代替 Cisco 的 AnyConnect 客户端；</li><li>可以实现无交互的静默登录；</li></ol><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 安装源</span></span></span><br><span class="line">yum install epel-release</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 安装客户端</span></span></span><br><span class="line">yum install openconnect</span><br></pre></td></tr></table></figure><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="查看帮助"><a href="#查看帮助" class="headerlink" title="查看帮助"></a>查看帮助</h3><p>详细设置可以查看帮助。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 查看帮助</span></span><br><span class="line">openconnect -h</span><br></pre></td></tr></table></figure><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><p>此处使用密码登录，无密码登录需要服务端配合设置证书。<br>为了实现自动输入密码，使用了管理命令，也可以使用 expect 实现自动执行 Shell 的交互操作。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">server=服务器地址</span><br><span class="line">group=分组名</span><br><span class="line">user=用户名</span><br><span class="line">password=密码</span><br><span class="line">pid_file=pid 文件路径</span><br><span class="line"></span><br><span class="line"><span class="comment">## 登录</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">login</span></span>() &#123;</span><br><span class="line"><span class="keyword">if</span> [ `pidof openconnect` ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;已登录&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$password</span> | openconnect -b --pid-file=<span class="variable">$pid_file</span> --authgroup <span class="variable">$group</span> -u <span class="variable">$user</span> --no-dtls <span class="variable">$server</span></span><br><span class="line"><span class="comment">## 判断启动状态</span></span><br><span class="line"><span class="keyword">if</span> [ `pidof openconnect` == `cat <span class="variable">$pid_file</span>` ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;登录成功&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;登录失败&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 退出</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">logout</span></span>() &#123;</span><br><span class="line">  <span class="comment"># 通过 pid 结束进程</span></span><br><span class="line"><span class="built_in">kill</span> -9 `cat <span class="variable">$pid_file</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;注销成功&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## [] 计算布尔值，需要前后空格</span></span><br><span class="line"><span class="comment">## &quot;$1&quot; 防止无参，或空格作为一个整体字符串</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;login&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">login</span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;logout&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> 参数输入错误，支持的命令 login 或 <span class="built_in">logout</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h3 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h3><p>在用户或全局环境变量中写入脚本路径的别名，使得脚本可以在当前用户的任意目录中，直接通别名调用。<br><strong>注：</strong></p><ol><li>环境变量中可以直接执行脚本（即设置自启）;</li><li><code>~/.bash_profile</code> 用户变量；</li><li><code>/etc/profile</code>     全局变量；</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 写入用户变量</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;alias 别名=&#x27;脚本路径&#x27;&quot;</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="comment">## 刷新变量</span></span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br><span class="line"><span class="comment">## 执行</span></span><br><span class="line"><span class="comment"># 登录</span></span><br><span class="line">别名 login</span><br><span class="line"><span class="comment"># 注销</span></span><br><span class="line">别名 <span class="built_in">logout</span></span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><h4 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## openconnect 授权指令</span></span><br><span class="line">Authentication:</span><br><span class="line">  -u, --user=NAME                 Set login username</span><br><span class="line">      --no-passwd                 Disable password/SecurID authentication</span><br><span class="line">      --non-inter                 Do not expect user input; <span class="built_in">exit</span> <span class="keyword">if</span> it is required</span><br><span class="line">      --passwd-on-stdin           Read password from standard input</span><br><span class="line">      --authgroup=GROUP           Choose authentication login selection</span><br><span class="line">  -F, --form-entry=FORM:OPT=VALUE Provide authentication form responses</span><br><span class="line">  -c, --certificate=CERT          Use SSL client certificate CERT</span><br><span class="line">  -k, --sslkey=KEY                Use SSL private key file KEY</span><br><span class="line">  -e, --cert-expire-warning=DAYS  Warn when certificate lifetime &lt; DAYS</span><br><span class="line">  -g, --usergroup=GROUP           Set login usergroup</span><br><span class="line">  -p, --key-password=PASS         Set key passphrase or TPM SRK PIN</span><br><span class="line">      --key-password-from-fsid    Key passphrase is fsid of file system</span><br><span class="line">      --token-mode=MODE           Software token <span class="built_in">type</span>: rsa, totp, hotp or oidc</span><br><span class="line">      --token-secret=STRING       Software token secret or oidc token</span><br></pre></td></tr></table></figure><h4 id="异常使用"><a href="#异常使用" class="headerlink" title="异常使用"></a>异常使用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 指令</span></span><br><span class="line">-g GROUP</span><br><span class="line"></span><br><span class="line"><span class="comment">## 报错</span></span><br><span class="line">Failed to obtain WebVPN cookie</span><br><span class="line"></span><br><span class="line"><span class="comment">## 解决，替换指令</span></span><br><span class="line">--authgroup=GROUP</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;代替 Cisco 的 AnyConnect 客户端；&lt;/li&gt;
&lt;li&gt;可以实现无交互的静默登录；&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Linux" scheme="http://daiwenzh5.github.io/categories/Linux/"/>
    
    <category term="VPN" scheme="http://daiwenzh5.github.io/categories/Linux/VPN/"/>
    
    
    <category term="Linux" scheme="http://daiwenzh5.github.io/tags/Linux/"/>
    
    <category term="Centos" scheme="http://daiwenzh5.github.io/tags/Centos/"/>
    
    <category term="VPN" scheme="http://daiwenzh5.github.io/tags/VPN/"/>
    
    <category term="OpenConnect" scheme="http://daiwenzh5.github.io/tags/OpenConnect/"/>
    
  </entry>
  
  <entry>
    <title>Cloud Toolkit</title>
    <link href="http://daiwenzh5.github.io/2020/12/27/yuque/Cloud%20Toolkit/"/>
    <id>http://daiwenzh5.github.io/2020/12/27/yuque/Cloud%20Toolkit/</id>
    <published>2020-12-26T19:02:28.000Z</published>
    <updated>2021-11-11T02:38:00.147Z</updated>
    
    <content type="html"><![CDATA[<h2 id="插件介绍"><a href="#插件介绍" class="headerlink" title="插件介绍"></a>插件介绍</h2><p>提供自动部署项目到服务器的能力，并且可以在部署前后执行自定义命令或脚本。</p><h2 id="插件使用"><a href="#插件使用" class="headerlink" title="插件使用"></a>插件使用</h2><h3 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h3><p>在插件市场安装好插件。</p><h3 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h3><ol><li>选择 Alibaba Cloud View 面板：在底部（或侧边栏，或顶部 Tools 导航栏）；</li><li>点击 Add Host：添加服务</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1609011426003-310abca2-44bf-48bf-9b67-e46b63fcfed6.png#align=left&display=inline&height=324&margin=%5Bobject%20Object%5D&name=image.png&originHeight=324&originWidth=1882&size=429886&status=done&style=none&width=1882" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1609011426003-310abca2-44bf-48bf-9b67-e46b63fcfed6.png#align=left&display=inline&height=324&margin=%5Bobject%20Object%5D&name=image.png&originHeight=324&originWidth=1882&size=429886&status=done&style=none&width=1882" srcset="data:image/png;base64,666" alt="image.png"></p><ol><li>填写服务器 ip：可以填多个，换行分隔，但端口得一致；</li><li>指定登录方式：使用 ssh 需要将公钥写入到服务器得 ssh 授权文件中，然后在插件中配置本地私钥路径；</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1609012168668-e935883f-037c-4b39-95f8-86c127b86eb4.png#align=left&display=inline&height=698&margin=%5Bobject%20Object%5D&name=image.png&originHeight=698&originWidth=904&size=58614&status=done&style=none&width=904" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1609012168668-e935883f-037c-4b39-95f8-86c127b86eb4.png#align=left&display=inline&height=698&margin=%5Bobject%20Object%5D&name=image.png&originHeight=698&originWidth=904&size=58614&status=done&style=none&width=904" srcset="data:image/png;base64,666" alt="image.png"></p><h3 id="配置启动项"><a href="#配置启动项" class="headerlink" title="配置启动项"></a>配置启动项</h3><ol><li>选择 Deploy to Host：在 Target Host 中指定（上步添加的）服务器，可以多选;</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1609011861070-2c202c87-3e0b-40ca-9228-5fe051b6d976.png#align=left&display=inline&height=395&margin=%5Bobject%20Object%5D&name=image.png&originHeight=395&originWidth=779&size=35252&status=done&style=none&width=779" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1609011861070-2c202c87-3e0b-40ca-9228-5fe051b6d976.png#align=left&display=inline&height=395&margin=%5Bobject%20Object%5D&name=image.png&originHeight=395&originWidth=779&size=35252&status=done&style=none&width=779" srcset="data:image/png;base64,666" alt="image.png"></p><ol start="2"><li>选择 Upload File：在（聚合项目）使用过程中，Maven Build 会自动（没找到配置项）上传错误的路径，且上传的是 pom，而 Upload File 可以随意指定路径；</li><li>选择 Browse（也可以直接在输入框中填写）：找到打包好的（mvn install 或 target 的）路径；</li><li>填写远程服务器中项目发版的根路径；</li><li>指定部署前执行命令：点击 + 打开拓展菜单；</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1609011815631-31289fd9-1cdd-41c9-9e33-f76f42f969a6.png#align=left&display=inline&height=1033&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1033&originWidth=1343&size=122113&status=done&style=none&width=1343" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1609011815631-31289fd9-1cdd-41c9-9e33-f76f42f969a6.png#align=left&display=inline&height=1033&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1033&originWidth=1343&size=122113&status=done&style=none&width=1343" srcset="data:image/png;base64,666" alt="image.png"></p><ol start="6"><li>选择执行器：此处选择了 maven；</li><li>输入执行命令：填入目标（goal）命令即可，多个命令空格（逗号没试）分隔；</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1609010975617-f3628e9a-6780-4e22-83b6-f8e0d528cf1b.png#align=left&display=inline&height=270&margin=%5Bobject%20Object%5D&name=image.png&originHeight=360&originWidth=310&size=21979&status=done&style=none&width=233" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1609010975617-f3628e9a-6780-4e22-83b6-f8e0d528cf1b.png#align=left&display=inline&height=270&margin=%5Bobject%20Object%5D&name=image.png&originHeight=360&originWidth=310&size=21979&status=done&style=none&width=233" srcset="data:image/png;base64,666" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1609010950894-5ac6e066-0daf-42b8-a964-4f58ac493a14.png#align=left&display=inline&height=108&margin=%5Bobject%20Object%5D&name=image.png&originHeight=195&originWidth=924&size=22623&status=done&style=none&width=510" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1609010950894-5ac6e066-0daf-42b8-a964-4f58ac493a14.png#align=left&display=inline&height=108&margin=%5Bobject%20Object%5D&name=image.png&originHeight=195&originWidth=924&size=22623&status=done&style=none&width=510" srcset="data:image/png;base64,666" alt="image.png"></p><h3 id="后置命令"><a href="#后置命令" class="headerlink" title="后置命令"></a>后置命令</h3><p>在部署（项目上传到服务器）后（在部署的路径中）执行。<br>推荐在服务器上预置脚本来提供更强、更灵活的功能。</p><h4 id="clean-sh"><a href="#clean-sh" class="headerlink" title="clean.sh"></a>clean.sh</h4><p>因为可能会有不同版本号的项目，且没有在打包插件中约定固定的名称，因此服务器上会积累多个版本项目：</p><ol><li>一般的启动脚本（为了忽视版本号），会使用 * 来匹配指定前缀的 jar 以启动项目，如此启动脚本会匹配多个版本的项目，需要清理旧的项目；</li><li>或者需要将之前的 jar 包做成备份；</li></ol><p>所以需要使用脚本找出旧的项目（此时 jar 已经上传）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">file=<span class="string">&#x27;项目名-*&#x27;</span></span><br><span class="line"><span class="comment"># 计算该目录下相同前缀的文件个数</span></span><br><span class="line">num=`ls -tr | grep <span class="variable">$&#123;file&#125;</span> | wc -l`</span><br><span class="line"><span class="built_in">echo</span> 共有 <span class="variable">$num</span> 个文件</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$num</span> -gt 1 ];<span class="keyword">then</span></span><br><span class="line">  <span class="comment"># 计算需要删除的文件个数（保留一个就行）</span></span><br><span class="line">  num=`expr <span class="variable">$num</span> - 1`</span><br><span class="line">  <span class="built_in">echo</span> 找到历史文件: `ls -tr | grep <span class="variable">$&#123;file&#125;</span> | head -<span class="variable">$num</span> | xargs`</span><br><span class="line">  ls -tr  | grep file | head -<span class="variable">$num</span> | xargs -i -n1 rm -rf &#123;&#125; &amp;&amp; <span class="built_in">echo</span> 删除成功!</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> 无历史文件，忽略本次操作</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h4 id="auto-deploy-sh"><a href="#auto-deploy-sh" class="headerlink" title="auto-deploy.sh"></a>auto-deploy.sh</h4><p>脚本的功能上解耦好一点，因此添加一个统一的入口脚本，用来统筹其他的操作，下面的执行方式需要 .sh 的读取权限，通常 <code>chmod 777 ./xxx.sh</code> 给上足够的权限即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">./clean.sh &amp;&amp; ./startup.sh</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ol><li>也可以在 VS Code 安装，（我）用来发前端；</li><li>更多操作，查看<a href="https://www.aliyun.com/product/cloudtoolkit">官方介绍</a> ；</li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;插件介绍&quot;&gt;&lt;a href=&quot;#插件介绍&quot; class=&quot;headerlink&quot; title=&quot;插件介绍&quot;&gt;&lt;/a&gt;插件介绍&lt;/h2&gt;&lt;p&gt;提供自动部署项目到服务器的能力，并且可以在部署前后执行自定义命令或脚本。&lt;/p&gt;</summary>
    
    
    
    <category term="工具" scheme="http://daiwenzh5.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    <category term="Intellij Plugin" scheme="http://daiwenzh5.github.io/categories/%E5%B7%A5%E5%85%B7/Intellij-Plugin/"/>
    
    
    <category term="Intellij Plugin" scheme="http://daiwenzh5.github.io/tags/Intellij-Plugin/"/>
    
    <category term="运维" scheme="http://daiwenzh5.github.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="自动部署" scheme="http://daiwenzh5.github.io/tags/%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2/"/>
    
    <category term="工具" scheme="http://daiwenzh5.github.io/tags/%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>AnAction</title>
    <link href="http://daiwenzh5.github.io/2020/12/20/yuque/AnAction/"/>
    <id>http://daiwenzh5.github.io/2020/12/20/yuque/AnAction/</id>
    <published>2020-12-20T05:40:21.000Z</published>
    <updated>2021-11-11T02:38:00.167Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>仅用于记录插件开发时踩的坑</p></blockquote><h2 id="接口介绍"><a href="#接口介绍" class="headerlink" title="接口介绍"></a>接口介绍</h2><p><code>AnAction</code> 是 Intellij Idea SDK 提供的按钮接口实现下的抽象类，通过继承此类，可以轻易的实现符合 Intellij UI 设计风格的自定义按钮组件。<br>Intellij SDK 中就内置了大量 AnAction 子类，下面是自定义实现的主要重写方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按钮点击时执行</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="拓展子类"><a href="#拓展子类" class="headerlink" title="拓展子类"></a>拓展子类</h2><h3 id="ToggleAction"><a href="#ToggleAction" class="headerlink" title="ToggleAction"></a>ToggleAction</h3><p>用于表示具有选定状态，且在执行（点击按钮）时切换其选定状态的动作。如控制台日志滚动时的自动换行按钮，以及滚动跟随按钮。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断按钮是否被选中</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isSelected</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置按钮何时被设置为选中状态</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setSelected</span><span class="params">(<span class="meta">@NotNull</span> AnActionEvent e, <span class="keyword">boolean</span> state)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="辅助类"><a href="#辅助类" class="headerlink" title="辅助类"></a>辅助类</h2><h3 id="ActionToolbar"><a href="#ActionToolbar" class="headerlink" title="ActionToolbar"></a>ActionToolbar</h3><p>工具栏，用于操作控制台的一组按钮。<br>在 Git 面板，如下：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445577369-80a7b177-a107-4c1b-a7d2-a3a1bcdac69d.png#align=left&display=inline&height=315&margin=%5Bobject%20Object%5D&name=image.png&originHeight=315&originWidth=604&size=159886&status=done&style=none&width=604" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445577369-80a7b177-a107-4c1b-a7d2-a3a1bcdac69d.png#align=left&display=inline&height=315&margin=%5Bobject%20Object%5D&name=image.png&originHeight=315&originWidth=604&size=159886&status=done&style=none&width=604" srcset="data:image/png;base64,666" alt="image.png"></p><h4 id="创建方法"><a href="#创建方法" class="headerlink" title="创建方法"></a>创建方法</h4><p><code>ActionManager#createActionToolbar(String, ActionGroup, boolean)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createToolbar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 创建一个按钮组</span></span><br><span class="line">     <span class="keyword">final</span> DefaultActionGroup actions = <span class="keyword">new</span> DefaultActionGroup();</span><br><span class="line">     <span class="comment">// 通过 ConsoleView#createConsoleActions() 方法创建默认按钮</span></span><br><span class="line">     actions.addAll(consoleView.createConsoleActions());</span><br><span class="line">     <span class="comment">// 创建工具栏</span></span><br><span class="line">     ActionToolbar actionToolbar = ActionManager.getInstance()</span><br><span class="line">             .createActionToolbar(ActionPlaces.TOOLBAR, actions, <span class="keyword">false</span>);</span><br><span class="line">     <span class="comment">// 添加到控制台</span></span><br><span class="line">     consoleView.getComponent().add(actionToolbar.getComponent());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>在 <code>ConsoleViewImpl#createConsoleActions()</code> 中提供如下按钮组<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445934503-8f3f4941-7dc1-4d11-95de-c71ae22e08a1.png#align=left&display=inline&height=210&margin=%5Bobject%20Object%5D&name=image.png&originHeight=210&originWidth=32&size=1338&status=done&style=none&width=32" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1608445934503-8f3f4941-7dc1-4d11-95de-c71ae22e08a1.png#align=left&display=inline&height=210&margin=%5Bobject%20Object%5D&name=image.png&originHeight=210&originWidth=32&size=1338&status=done&style=none&width=32" srcset="data:image/png;base64,666" alt="image.png"></p><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p><code>ConsoleView#createConsoleActions</code> 中需要 Editor 组件被初始化，因此需要先执行 <code>ConsoleView#getComponent</code> 方法。</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;仅用于记录插件开发时踩的坑&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;接口介绍&quot;&gt;&lt;a href=&quot;#接口介绍&quot; class=&quot;headerlink&quot; title=&quot;接口介绍&quot;&gt;&lt;/a&gt;接口介绍&lt;/h2&gt;</summary>
    
    
    
    <category term="Intellij Idea" scheme="http://daiwenzh5.github.io/categories/Intellij-Idea/"/>
    
    <category term="plugin" scheme="http://daiwenzh5.github.io/categories/Intellij-Idea/plugin/"/>
    
    
    <category term="Intellij Idea" scheme="http://daiwenzh5.github.io/tags/Intellij-Idea/"/>
    
    <category term="plugin" scheme="http://daiwenzh5.github.io/tags/plugin/"/>
    
    <category term="swing" scheme="http://daiwenzh5.github.io/tags/swing/"/>
    
    <category term="java" scheme="http://daiwenzh5.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>结果集拦截器</title>
    <link href="http://daiwenzh5.github.io/2020/12/07/yuque/%E7%BB%93%E6%9E%9C%E9%9B%86%E6%8B%A6%E6%88%AA%E5%99%A8/"/>
    <id>http://daiwenzh5.github.io/2020/12/07/yuque/%E7%BB%93%E6%9E%9C%E9%9B%86%E6%8B%A6%E6%88%AA%E5%99%A8/</id>
    <published>2020-12-07T12:36:53.000Z</published>
    <updated>2021-11-11T02:38:00.203Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>修改已有的结果集，可以对查询的字段与 Java 属性直接进行任意的映射。</p><blockquote><p>实际项目中，为了防止修改表结构而造成锁表，因此采用拓展表放置新的字段，为了不修改原有业务逻辑，故需要使用切面来处理结果集新增的部分字段，将其映射到 Map 中。</p></blockquote><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p><strong>ps: 通过修改 XML 可以完成所有复杂查询，但要考虑到方案适配的通用性，</strong><del><strong>XML ヾ(•ω•`)o</strong></del><strong>。</strong><br>Mybatis 内置的 ResultHandler 拦截器可以对其 ResultMap 对象进行拦截。</p><h3 id="关键的数据结构"><a href="#关键的数据结构" class="headerlink" title="关键的数据结构"></a>关键的数据结构</h3><p>ResultMap 是 Mybatis 的结果集映射对象，与 XML 中 <ResultMap/> 相对应，其中通过 ResultMapping 定义了每一列字段与 Java 属性之间的映射关系，具体数据结构如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultMap</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 唯一标识符</span></span><br><span class="line">  <span class="keyword">private</span> String id;</span><br><span class="line">  <span class="comment">// 映射类型，Map 或 Java Bean</span></span><br><span class="line">  <span class="keyword">private</span> Class&lt;?&gt; type;</span><br><span class="line">  <span class="comment">// 每一列对应的映射关系</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; resultMappings;</span><br><span class="line">  <span class="comment">// 主键的映射关系，有助于生成缓存提升性能，可为空</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; idResultMappings;</span><br><span class="line">  <span class="comment">// 构造器映射关系</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; constructorResultMappings;</span><br><span class="line">  <span class="comment">// 属性映射关系</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; propertyResultMappings;</span><br><span class="line">  <span class="comment">// 被映射的列</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; mappedColumns;</span><br><span class="line">  <span class="comment">// 被映射的属性</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; mappedProperties;</span><br><span class="line">  <span class="comment">// 鉴别器，在不同字典值分别使用不同的映射关系时使用</span></span><br><span class="line">  <span class="keyword">private</span> Discriminator discriminator;</span><br><span class="line">  <span class="comment">// 是否存在嵌套的结果集映射，一对多、一对一时为 true</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedResultMaps;</span><br><span class="line">  <span class="comment">// 是否存在嵌套查询，与 &lt;select/&gt; 标签相对于，存在 N+1</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedQueries;</span><br><span class="line">  <span class="comment">// 是否自动映射，列名与属性名完全一致时启用可以取消显示映射</span></span><br><span class="line">  <span class="keyword">private</span> Boolean autoMapping;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Configuration configuration;</span><br><span class="line">  <span class="comment">// 属性名，Map 的 key 值，或 Java Bean 的属性，自动映射时会按照全局策略转换字符串</span></span><br><span class="line">  <span class="comment">// 默认时下划线转小驼峰</span></span><br><span class="line">  <span class="keyword">private</span> String property;</span><br><span class="line">  <span class="comment">// 列名，该列是嵌套结果集时可以为空，否则需要与属性值一一对应</span></span><br><span class="line">  <span class="keyword">private</span> String column;</span><br><span class="line">  <span class="comment">// Java 类型</span></span><br><span class="line">  <span class="keyword">private</span> Class&lt;?&gt; javaType;</span><br><span class="line">  <span class="comment">// Jdbc 类型</span></span><br><span class="line">  <span class="keyword">private</span> JdbcType jdbcType;</span><br><span class="line">  <span class="comment">// 类型处理器，常用的基本类型可以为空，走内置处理器，对于一些特殊的，如 list（程序） 转 string（数据库），</span></span><br><span class="line">  <span class="comment">// 则需要指定自定义的类型处理器，继承 TypeHandler 实现方法即可</span></span><br><span class="line">  <span class="keyword">private</span> TypeHandler&lt;?&gt; typeHandler;</span><br><span class="line">  <span class="comment">// 嵌套结果集的 Id</span></span><br><span class="line">  <span class="keyword">private</span> String nestedResultMapId;</span><br><span class="line">  <span class="comment">// 嵌套查询的 Id</span></span><br><span class="line">  <span class="keyword">private</span> String nestedQueryId;</span><br><span class="line">  <span class="comment">// 非空列</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; notNullColumns;</span><br><span class="line">  <span class="comment">// 列前缀，自动拼接在列名前，可以为空</span></span><br><span class="line">  <span class="keyword">private</span> String columnPrefix;</span><br><span class="line">  <span class="comment">// 主键、构造器标识</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultFlag&gt; flags;</span><br><span class="line">  <span class="keyword">private</span> List&lt;ResultMapping&gt; composites;</span><br><span class="line">  <span class="comment">// 结果集</span></span><br><span class="line">  <span class="keyword">private</span> String resultSet;</span><br><span class="line">  <span class="comment">// 外键列</span></span><br><span class="line">  <span class="keyword">private</span> String foreignColumn;</span><br><span class="line">  <span class="comment">// 是否启用懒加载，嵌套查询时生效</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> lazy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取-ResultMap-对象"><a href="#获取-ResultMap-对象" class="headerlink" title="获取 ResultMap 对象"></a>获取 ResultMap 对象</h3><p>ResultMap 可以通过 MappedStatement 获取，且获取的是一个不可修改的 List 集合。因此 ResultMap 的修改要点：</p><ol><li>遍历所有结果集映射；</li><li>反射重置结果集列表；</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultHanlderInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 获取默认处理器</span></span><br><span class="line">DefaultResultSetHandler defaultResultSetHandler = (DefaultResultSetHandler) invocation.getTarget();</span><br><span class="line">    <span class="comment">// mybatis 元数据对象，辅助工具，屏蔽反射受检异常</span></span><br><span class="line">        MetaObject metaStatementHandler = SystemMetaObject.forObject(defaultResultSetHandler);</span><br><span class="line">    <span class="comment">// 获取映射语句，当前执行 SQL 的所有信息</span></span><br><span class="line">        <span class="comment">// 其中存在 List&lt;ResultMap&gt; 属性，每一个 ResultMap 对应一个 Java Bean，</span></span><br><span class="line">        <span class="comment">// 一般只有一个值，即 SQL 的返回值</span></span><br><span class="line">        MappedStatement mappedStatement = (MappedStatement) metaStatementHandler.getValue(<span class="string">&quot;mappedStatement&quot;</span>);</span><br><span class="line">        <span class="comment">// 处理 ResultMap</span></span><br><span class="line">        <span class="keyword">for</span> (ResultMap resultMap: mappedStatement.getResultMap) &#123;</span><br><span class="line">            <span class="comment">// 重建 ResultMap</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="重建-ResultMap"><a href="#重建-ResultMap" class="headerlink" title="重建 ResultMap"></a>重建 ResultMap</h3><p>ResultMap 的获取并不复杂，事实上很轻易的就可以拿到，通过调试或者查看源码，可知，通过 getter 方法可以得到列映射关系，ResultMapping，同样这也是不可修改的 List 集合，但不同的是，直接通过反射修改是不会生效的，所有的（列或结果集）映射关系必须要先向 mybatis 的 configuration 注册才行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重建 ResultMap</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultMap <span class="title">rebuild</span><span class="params">(MappedStatement ms, ResultMap resultMap)</span> </span>&#123;</span><br><span class="line">       MapperBuilderAssistant builderAssistant = getMapperBuilderAssistant(ms);</span><br><span class="line">       <span class="comment">// 先获取原有的 ResultMapping 列表，仅对要修改的部分做处理（增、改、删）</span></span><br><span class="line">       List&lt;ResultMapping&gt; resultMappings = Lists.newArrayList(resultMap.getResultMappings().iterator());</span><br><span class="line">       <span class="comment">// 增加一个新的映射</span></span><br><span class="line">       resultMappings.add(getResultMapping());</span><br><span class="line">       <span class="comment">// 注册 ResultMap 到 configuration</span></span><br><span class="line">       ResultMapResolver resultMapResolver = <span class="keyword">new</span> ResultMapResolver(builderAssistant,</span><br><span class="line">               <span class="string">&quot;id，唯一标识，不可重复&quot;</span>),</span><br><span class="line">               resultMap.getType(), <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">               <span class="comment">// 将 resultMappings 设为不可变 list</span></span><br><span class="line">               Collections.unmodifiableList(resultMappings), 是否自动映射);</span><br><span class="line">       <span class="keyword">return</span> resultMapResolver.resolve();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建一个新的列映射关系</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultMapping <span class="title">getResultMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ResultMapping.Builder(builderAssistant.getConfiguration(),</span><br><span class="line">                       getProperty(<span class="string">&quot;属性名&quot;</span>))</span><br><span class="line">                       .column(<span class="string">&quot;列名&quot;</span>))</span><br><span class="line">                       .typeHandler(类型处理器.class)</span><br><span class="line">                       .jdbcType(JdbcType.value))</span><br><span class="line">                       .javaType(Java 类型.class)</span><br><span class="line">           .nestedResultMapId(<span class="string">&quot;嵌套的 ResultMap id， 需要先注册&quot;</span>)</span><br><span class="line">                       .build())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取映射器构建助手</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ms 映射语句</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 映射器构建助手</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> MapperBuilderAssistant <span class="title">getMapperBuilderAssistant</span><span class="params">(MappedStatement ms)</span> </span>&#123;</span><br><span class="line">       Configuration configuration = ms.getConfiguration();</span><br><span class="line">       String resource = ms.getResource();</span><br><span class="line">       String nameSpace = ms.getId().substring(<span class="number">0</span>, ms.getId().lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">       MapperBuilderAssistant builderAssistant = <span class="keyword">new</span> MapperBuilderAssistant(configuration, resource);</span><br><span class="line">       builderAssistant.setCurrentNamespace(nameSpace);</span><br><span class="line">       <span class="keyword">return</span> builderAssistant;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li>对应 （XML 文件）没有 ResultMap（或使用 ResultType）的结果集，需要设置自动映射（autoMapping = true），否则可能出现属性丢失的问题；</li><li>仅仅（通过反射）修改 ResultMap 的 resultMappings 属性不会生效，因为 ResultMapping 用于记录映射关系，却不是 Mybatis Configuration 真实的读取的信息，需要通过 ResultMapResolver 解析器读取信息，并注册到配置中心；</li><li>对于使用线程变量做拦截器标记时（如 PageHelper），在最终返回时拦截器结束时需要对线程变量进行 clear，谨防 OOM；</li><li>也可以在拦截器中直接读取 ResultSet，手动进行映射，或使用 Json 等工具，最终返回格式化后的对象，但需要考虑到列名与属性名不一样的场景，且对 Mybatis 映射产生破坏（不推荐）；</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过修改 ResultMap 可以任意的进行结果集映射，就像在 XML 中定义了 <ResultMap/> 标签一样，但不同的是，其可以通过注解或参数等方式，对某个查询进行标记，可以在运行时动态的修改返回查询结果，且 ResultMap 会被 Mybaits 自动缓存。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;修改已有的结果集，可以对查询的字段与 Java 属性直接进行任意的映射。&lt;/p&gt;</summary>
    
    
    
    <category term="Mybatis" scheme="http://daiwenzh5.github.io/categories/Mybatis/"/>
    
    <category term="拦截器" scheme="http://daiwenzh5.github.io/categories/Mybatis/%E6%8B%A6%E6%88%AA%E5%99%A8/"/>
    
    
    <category term="拦截器" scheme="http://daiwenzh5.github.io/tags/%E6%8B%A6%E6%88%AA%E5%99%A8/"/>
    
    <category term="结果集" scheme="http://daiwenzh5.github.io/tags/%E7%BB%93%E6%9E%9C%E9%9B%86/"/>
    
    <category term="Mybatis" scheme="http://daiwenzh5.github.io/tags/Mybatis/"/>
    
    <category term="ResultMap" scheme="http://daiwenzh5.github.io/tags/ResultMap/"/>
    
  </entry>
  
  <entry>
    <title>自动发行插件</title>
    <link href="http://daiwenzh5.github.io/2020/12/04/yuque/%E8%87%AA%E5%8A%A8%E5%8F%91%E8%A1%8C%E6%8F%92%E4%BB%B6/"/>
    <id>http://daiwenzh5.github.io/2020/12/04/yuque/%E8%87%AA%E5%8A%A8%E5%8F%91%E8%A1%8C%E6%8F%92%E4%BB%B6/</id>
    <published>2020-12-03T17:49:09.000Z</published>
    <updated>2021-11-11T02:38:00.215Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在项目迭代过程中，需要为不同的版本号打上 Tag，对于发行的稳定版本则需要上传到指定的仓库。手动操作则过于繁琐，且无法统一 Tag 的样式，因此需要一款实现自动的可配置的发行工具。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>使用 <a href="https://maven.apache.org/maven-release/maven-release-plugin/index.html">maven-release-plugin</a> 插件，其提供了自动追赠版本号、自动切换 snapshots 和 releases 版本、以及自动打 Tag 与版本发行等功能。</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 父模块 pom.xml --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- git 地址 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">connection</span>&gt;</span>scm:git:url<span class="tag">&lt;/<span class="name">connection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">developerConnection</span>&gt;</span>scm:git:url<span class="tag">&lt;/<span class="name">developerConnection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tag</span>&gt;</span>HEAD<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scm</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-release-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0-M1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">username</span>&gt;</span>scm 用户名<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 对于 github 用户，（当密码无效时）可能需要 repo token 权限（代替密码） --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">password</span>&gt;</span>scm 密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">scmCommentPrefix</span>&gt;</span>[提交信息的前缀]<span class="tag">&lt;/<span class="name">scmCommentPrefix</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 子模块的版本号与父模块是否一致 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">autoVersionSubmodules</span>&gt;</span>true<span class="tag">&lt;/<span class="name">autoVersionSubmodules</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- tag 的格式，如 v1.0.0 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">tagNameFormat</span>&gt;</span>v@&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tagNameFormat</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 跳过测试以及生成 javadoc 文档（注释不规范时会报错）--&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">arguments</span>&gt;</span>-DskipTests -DuseReleaseProfile=false<span class="tag">&lt;/<span class="name">arguments</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- tag 的路径，gitee 路径，主要是快 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">tagBase</span>&gt;</span>https://gitee.com/&#123;用户名&#125;/&#123;项目名&#125;/tags<span class="tag">&lt;/<span class="name">tagBase</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置发行路径，这里配置的是阿里云效的私有仓库 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 需要在 settings.xml 中配置 server 的用户名和密码，且指定的 id 需要和下面的一致 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>rdc-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://packages.aliyun.com/maven/repository/2046382-release-Kot3ui/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>rdc-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://packages.aliyun.com/maven/repository/2046382-snapshot-sZVDXF/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- settings.xml --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- id 需要和上面一致 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>rdc-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">username</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>rdc-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br></pre></td></tr></table></figure><p>正式发行一定要配置 <code>distributionManagement</code> 且要注意授权信息（账号、密码）是否填写且正确，否则授权无法通过产生 401 异常。</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 预备发行：打 Tag，自动切换快照版本</span></span><br><span class="line">mvn release:prepare</span><br><span class="line"><span class="comment"># 将已有的 Tag 发行到指定仓库</span></span><br><span class="line">mvn release:perform</span><br><span class="line"><span class="comment"># 异常时回滚</span></span><br><span class="line">mvn release:rollback</span><br></pre></td></tr></table></figure><p>在 idea 可以通过可视化插件使用，需要注意的时，正式发行前一定要先进行预备发行。且每次打 Tag 时必须要求 git 是最新提交，正式发行使用的是上次 Tag（历史提交） 中的 pom，因此每次修改需要先提交到 git。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1607019495482-66a4eaac-b962-45ee-8685-b00b5de461b9.png#align=left&display=inline&height=392&margin=%5Bobject%20Object%5D&name=image.png&originHeight=392&originWidth=554&size=35138&status=done&style=none&width=554" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1607019495482-66a4eaac-b962-45ee-8685-b00b5de461b9.png#align=left&display=inline&height=392&margin=%5Bobject%20Object%5D&name=image.png&originHeight=392&originWidth=554&size=35138&status=done&style=none&width=554" srcset="data:image/png;base64,666" alt="image.png"></p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li>提交时出现 <code>remote: Invalid username or password</code>，确保自己的登录信息没有错，则尝试使用 repo token 来替换密码；</li><li>发布 prepare 之后，会产生各个模块的 pom 备份文件，最好在提交之前加入 .gitignore;</li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;在项目迭代过程中，需要为不同的版本号打上 Tag，对于发行的稳定版本则需要上传到指定的仓库。手动操作则过于繁琐，且无法统一 Tag 的样式，因此需要一款实现自动的可配置的发行工具。&lt;/p&gt;</summary>
    
    
    
    <category term="Maven" scheme="http://daiwenzh5.github.io/categories/Maven/"/>
    
    <category term="插件" scheme="http://daiwenzh5.github.io/categories/Maven/%E6%8F%92%E4%BB%B6/"/>
    
    
    <category term="Maven" scheme="http://daiwenzh5.github.io/tags/Maven/"/>
    
    <category term="插件" scheme="http://daiwenzh5.github.io/tags/%E6%8F%92%E4%BB%B6/"/>
    
    <category term="发版" scheme="http://daiwenzh5.github.io/tags/%E5%8F%91%E7%89%88/"/>
    
    <category term="Tag" scheme="http://daiwenzh5.github.io/tags/Tag/"/>
    
  </entry>
  
  <entry>
    <title>聚合项目版本号管理</title>
    <link href="http://daiwenzh5.github.io/2020/12/03/yuque/%E8%81%9A%E5%90%88%E9%A1%B9%E7%9B%AE%E7%89%88%E6%9C%AC%E5%8F%B7%E7%AE%A1%E7%90%86/"/>
    <id>http://daiwenzh5.github.io/2020/12/03/yuque/%E8%81%9A%E5%90%88%E9%A1%B9%E7%9B%AE%E7%89%88%E6%9C%AC%E5%8F%B7%E7%AE%A1%E7%90%86/</id>
    <published>2020-12-03T14:13:46.000Z</published>
    <updated>2021-11-11T02:38:00.223Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在 Maven 聚合工程中，通常修改版本号是一件较为繁琐的过程，特别是子模块较多时，复制粘贴也得谨防遗漏，因此需要一款自动化工具，来完成机械的工作。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>插件 <a href="https://mvnrepository.com/artifact/org.codehaus.mojo/versions-maven-plugin">versions-maven-plugin</a> 正是用来解决这类痛点。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 父模块 pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>yyy<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>a.b.c<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 聚合子项目 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>模块-A<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">module</span>&gt;</span>模块-B<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">module</span>&gt;</span>模块-C<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>模块-D<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 统一子模块版本号，$&#123;project.version&#125; 为父项目版本号 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 子模块相互依赖时无需指定版本号 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>模块-A<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 引入插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>versions-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 子模块 pom.xml --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- parent 填入完整的父项目信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>yyy<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>a.b.c<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure><p>idea 中可以通过 Maven 插件栏选中 versions:set，快速设置。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1607007203997-376d28fb-4d09-426b-bf2c-3529edc3f2bc.png#align=left&display=inline&height=437&margin=%5Bobject%20Object%5D&name=image.png&originHeight=437&originWidth=618&size=36244&status=done&style=none&width=618" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1607007203997-376d28fb-4d09-426b-bf2c-3529edc3f2bc.png#align=left&display=inline&height=437&margin=%5Bobject%20Object%5D&name=image.png&originHeight=437&originWidth=618&size=36244&status=done&style=none&width=618" srcset="data:image/png;base64,666" alt="image.png"><br>在运行窗口填写版本号即可。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/681418/1607007473025-e2efb12e-d6bc-495c-8731-60bb45a1ecfb.png#align=left&display=inline&height=247&margin=%5Bobject%20Object%5D&name=image.png&originHeight=247&originWidth=928&size=30085&status=done&style=none&width=928" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/681418/1607007473025-e2efb12e-d6bc-495c-8731-60bb45a1ecfb.png#align=left&display=inline&height=247&margin=%5Bobject%20Object%5D&name=image.png&originHeight=247&originWidth=928&size=30085&status=done&style=none&width=928" srcset="data:image/png;base64,666" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;在 Maven 聚合工程中，通常修改版本号是一件较为繁琐的过程，特别是子模块较多时，复制粘贴也得谨防遗漏，因此需要一款自动化工具，来完成机械的工作。&lt;/p&gt;</summary>
    
    
    
    <category term="maven" scheme="http://daiwenzh5.github.io/categories/maven/"/>
    
    <category term="聚合项目" scheme="http://daiwenzh5.github.io/categories/maven/%E8%81%9A%E5%90%88%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="maven" scheme="http://daiwenzh5.github.io/tags/maven/"/>
    
    <category term="聚合项目" scheme="http://daiwenzh5.github.io/tags/%E8%81%9A%E5%90%88%E9%A1%B9%E7%9B%AE/"/>
    
    <category term="版本更新" scheme="http://daiwenzh5.github.io/tags/%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0/"/>
    
    <category term="version" scheme="http://daiwenzh5.github.io/tags/version/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis XML 新增异常</title>
    <link href="http://daiwenzh5.github.io/2020/11/27/yuque/Mybatis%20XML%20%E6%96%B0%E5%A2%9E%E5%BC%82%E5%B8%B8/"/>
    <id>http://daiwenzh5.github.io/2020/11/27/yuque/Mybatis%20XML%20%E6%96%B0%E5%A2%9E%E5%BC%82%E5%B8%B8/</id>
    <published>2020-11-27T14:40:46.000Z</published>
    <updated>2021-11-11T02:38:00.227Z</updated>
    
    <content type="html"><![CDATA[<h2 id="异常信息"><a href="#异常信息" class="headerlink" title="异常信息"></a>异常信息</h2><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org<span class="variable">.springframework</span><span class="variable">.dao</span><span class="variable">.DataIntegrityViolationException</span>:</span><br><span class="line">### Error updating database.  Cause: java<span class="variable">.sql</span><span class="variable">.SQLException</span>: Field &#x27;id&#x27; doesn&#x27;t have a <span class="keyword">default</span> value</span><br><span class="line">### The error may exist in file [xxx<span class="variable">.xml</span>]</span><br><span class="line">### The error may involve xxxMapper<span class="variable">.insert</span>-Inline</span><br><span class="line">### The error occurred <span class="keyword">while</span> setting parameters</span><br><span class="line">### SQL: insert into xxx                                                 create_time )           values ( ?,             ?,             ?,             ?,                                                    ? )</span><br><span class="line">### Cause: java<span class="variable">.sql</span><span class="variable">.SQLException</span>: Field &#x27;id&#x27; doesn&#x27;t have a <span class="keyword">default</span> value</span><br><span class="line">; Field &#x27;id&#x27; doesn&#x27;t have a <span class="keyword">default</span> value; nested exception is java<span class="variable">.sql</span><span class="variable">.SQLException</span>: Field &#x27;id&#x27; doesn&#x27;t have a <span class="keyword">default</span> value</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>原因：插入时没有指定 id，且数据库没有自增主键。<br>处理：在 xml 中添加 <code>&lt;if test=&quot;id != null&quot;&gt;id,&lt;/if&gt;</code> 手动设置 id；或者在数据库中设置自增。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;异常信息&quot;&gt;&lt;a href=&quot;#异常信息&quot; class=&quot;headerlink&quot; title=&quot;异常信息&quot;&gt;&lt;/a&gt;异常信息&lt;/h2&gt;&lt;figure class=&quot;highlight verilog&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;org&lt;span class=&quot;variable&quot;&gt;.springframework&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.dao&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.DataIntegrityViolationException&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;### Error updating database.  Cause: java&lt;span class=&quot;variable&quot;&gt;.sql&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.SQLException&lt;/span&gt;: Field &amp;#x27;id&amp;#x27; doesn&amp;#x27;t have a &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt; value&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;### The error may exist in file [xxx&lt;span class=&quot;variable&quot;&gt;.xml&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;### The error may involve xxxMapper&lt;span class=&quot;variable&quot;&gt;.insert&lt;/span&gt;-Inline&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;### The error occurred &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; setting parameters&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;### SQL: insert into xxx                                                 create_time )           values ( ?,             ?,             ?,             ?,                                                    ? )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;### Cause: java&lt;span class=&quot;variable&quot;&gt;.sql&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.SQLException&lt;/span&gt;: Field &amp;#x27;id&amp;#x27; doesn&amp;#x27;t have a &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt; value&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;; Field &amp;#x27;id&amp;#x27; doesn&amp;#x27;t have a &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt; value; nested exception is java&lt;span class=&quot;variable&quot;&gt;.sql&lt;/span&gt;&lt;span class=&quot;variable&quot;&gt;.SQLException&lt;/span&gt;: Field &amp;#x27;id&amp;#x27; doesn&amp;#x27;t have a &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt; value&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="mybatis" scheme="http://daiwenzh5.github.io/categories/mybatis/"/>
    
    <category term="xml" scheme="http://daiwenzh5.github.io/categories/mybatis/xml/"/>
    
    
    <category term="mybatis" scheme="http://daiwenzh5.github.io/tags/mybatis/"/>
    
    <category term="xml" scheme="http://daiwenzh5.github.io/tags/xml/"/>
    
    <category term="insert" scheme="http://daiwenzh5.github.io/tags/insert/"/>
    
    <category term="主键" scheme="http://daiwenzh5.github.io/tags/%E4%B8%BB%E9%94%AE/"/>
    
  </entry>
  
  <entry>
    <title>多字段联合校验</title>
    <link href="http://daiwenzh5.github.io/2020/11/18/yuque/%E5%A4%9A%E5%AD%97%E6%AE%B5%E8%81%94%E5%90%88%E6%A0%A1%E9%AA%8C/"/>
    <id>http://daiwenzh5.github.io/2020/11/18/yuque/%E5%A4%9A%E5%AD%97%E6%AE%B5%E8%81%94%E5%90%88%E6%A0%A1%E9%AA%8C/</id>
    <published>2020-11-18T07:01:31.000Z</published>
    <updated>2021-11-11T02:38:00.243Z</updated>
    
    <content type="html"><![CDATA[<p>tags: [参数校验,@GroupSequenceProvider,hibernate validator,Bean Validation]<br>categories: [springboot,参数校验]</p><hr><h2 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h2><p>在使用进行数据校验时，经常会遇到需要多个字段组合式的校验。<br><strong>例如</strong></p><ul><li>某个嘉年华俱乐部门票对不同人群存在不同的定价：</li></ul><ol><li>年龄必须大于 12 岁；</li><li>12 ~ 18 岁半价；</li><li>18 岁以上全价；</li><li>coser 则可以免费；</li></ol><p>换句话来说，任何年龄大于 12 岁的人都可以购买全价，对于半价票需要校验年龄是否满足未成年，对于免费票需要校验是否是 coser。</p><h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><p>入场时，需要根据门票类型动态的切换校验分组，定义如下的 Person 类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@GroupSequenceProvider(Person.FareTypeGroupSequenceProvider.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 年龄</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Min(value = 12, message = &quot;年龄最小不低于 12 岁&quot;)</span></span><br><span class="line">    <span class="meta">@Max(value = 18, message = &quot;年龄大于 18 岁需要购买全价门票&quot;, groups=WhenIsHalf.class)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 票价[0=免费,1=半价,2=全价]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull(message = &quot;票价类型不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer fareType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是 coser</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AssertTrue(message = &quot;只有 coser 才可以免费进去&quot;, groups = WhenIsFree.class)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean coser;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WhenIsFree</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WhenIsHalf</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验分组处理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FareTypeGroupSequenceProvider</span> <span class="keyword">implements</span> <span class="title">DefaultGroupSequenceProvider</span>&lt;<span class="title">Person</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> List&lt;Class&lt;?&gt;&gt; getValidationGroups(Person person) &#123;</span><br><span class="line">            ArrayList&lt;Class&lt;?&gt;&gt; list = Lists.newArrayList();</span><br><span class="line">            list.add(Person.class);</span><br><span class="line">            <span class="comment">// 判空</span></span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(person)) &#123;</span><br><span class="line">                <span class="comment">// 当 fareType = 0 时</span></span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(person.getFareType(), <span class="number">0</span>)) &#123;</span><br><span class="line">                list.add(WhenIsFree.class);</span><br><span class="line">                &#125; <span class="keyword">else</span> (Objects.equals(person.getFareType(), <span class="number">1</span>)) &#123;</span><br><span class="line">                list.add(WhenIsHalf.class);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol><li>DefaultGroupSequenceProvider 类型是泛型类，必须指定为需要参数校验的 Bean 类型；</li><li>DefaultGroupSequenceProvider.getValidationGroups 方法返回的 list 中必须包含 Bean 类型;</li><li>DefaultGroupSequenceProvider 只能增强 Default.class 分组;</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;tags: [参数校验,@GroupSequenceProvider,hibernate validator,Bean Validation]&lt;br&gt;categories: [springboot,参数校验]&lt;/p&gt;
&lt;hr&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>HttpMediaTypeNotAcceptableException</title>
    <link href="http://daiwenzh5.github.io/2020/10/22/yuque/HttpMediaTypeNotAcceptableException/"/>
    <id>http://daiwenzh5.github.io/2020/10/22/yuque/HttpMediaTypeNotAcceptableException/</id>
    <published>2020-10-22T08:49:07.000Z</published>
    <updated>2021-11-11T02:38:00.247Z</updated>
    
    <content type="html"><![CDATA[<h2 id="异常描述"><a href="#异常描述" class="headerlink" title="异常描述"></a>异常描述</h2><p>导出 Excel 时产生异常，提示：Could not find acceptable representation。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.HttpMediaTypeNotAcceptableException: Could not find acceptable representation</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor.writeWithMessageConverters(AbstractMessageConverterMethodProcessor.java:307)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor.handleReturnValue(RequestResponseBodyMethodProcessor.java:180)</span><br><span class="line">at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:82)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:122)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver.doResolveHandlerMethodException(ExceptionHandlerExceptionResolver.java:412)</span><br><span class="line">at org.springframework.web.servlet.handler.AbstractHandlerMethodExceptionResolver.doResolveException(AbstractHandlerMethodExceptionResolver.java:61)</span><br><span class="line">at org.springframework.web.servlet.handler.AbstractHandlerExceptionResolver.resolveException(AbstractHandlerExceptionResolver.java:140)</span><br><span class="line">at org.springframework.web.servlet.handler.HandlerExceptionResolverComposite.resolveException(HandlerExceptionResolverComposite.java:79)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.processHandlerException(DispatcherServlet.java:1298)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.processDispatchResult(DispatcherServlet.java:1110)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1056)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:942)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1005)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:897)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:645)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:882)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:750)</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:712)</span><br><span class="line">at org.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:580)</span><br><span class="line">at org.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:516)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.custom(StandardHostValve.java:388)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.status(StandardHostValve.java:253)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.throwable(StandardHostValve.java:348)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:173)</span><br><span class="line">at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:92)</span><br><span class="line">at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)</span><br><span class="line">at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:343)</span><br><span class="line">at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:408)</span><br><span class="line">at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)</span><br><span class="line">at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:853)</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1587)</span><br><span class="line">at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)</span><br><span class="line">at java.lang.Thread.run(Thread.java:748)</span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>向 response 中写入流时，接口不能存在 json 格式的返回值。将返回值改成 void 即可解决问题。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;异常描述&quot;&gt;&lt;a href=&quot;#异常描述&quot; class=&quot;headerlink&quot; title=&quot;异常描述&quot;&gt;&lt;/a&gt;异常描述&lt;/h2&gt;&lt;p&gt;导出 Excel 时产生异常，提示：Could not find acceptable representation。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>消费者</title>
    <link href="http://daiwenzh5.github.io/2020/08/26/yuque/%E6%B6%88%E8%B4%B9%E8%80%85/"/>
    <id>http://daiwenzh5.github.io/2020/08/26/yuque/%E6%B6%88%E8%B4%B9%E8%80%85/</id>
    <published>2020-08-26T08:10:22.000Z</published>
    <updated>2021-11-11T02:38:00.267Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>接手了一个陈年的 dubbo 项目，现准备抽离某个模块，以前的聚合工程太大了，不想动，就另起了一个项目作为消费者调用之前的服务。<br>之前只在聚合项目中进行服务互调，现在两个项目之间完全独立，只通过 dubbo 交互，因此出现了一些问题，在此记录一下。</p><h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><h3 id="Refrence"><a href="#Refrence" class="headerlink" title="@Refrence"></a>@Refrence</h3><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><p>服务消费者引用服务注解。提供了大量的配置属性，实际上使用时，只需标记注解，所有属性采用默认设置即可。<br>对于消费者而言，期望的是开箱即用的服务，因此服务提供者应该应该装配合理的默认属性，避免消费者进行不透明操作。</p><h4 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h4><p>@Reference 不能直接标注在接口上，其提供远程服务自动注入功能，类似于 @Autowired、@Resource 注解，应在类属性字段或 setter 方法上使用。<br>接口的<strong>类限定名</strong>必须和服务提供者一致，否则出现无法获取服务的异常。<br><strong>注意：</strong>interfaceName 属性指定的接口名并不会生效。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to check the status of the service &lt;ServiceName&gt;. No provider available for the service &lt;ServiceName&gt; from the url zookeeper:&#x2F;&#x2F;&lt;URL&gt; to the consume &lt;IP&gt; use dubbo version 2.7.6</span><br></pre></td></tr></table></figure><p>同样，接口暴露的参数的<strong>类限定名</strong>必须和服务提供者一致，否则会出现序列化异常的报错。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.apache.dubbo.remoting.RemotingException: Fail to decode request due to: RpcInvocation [methodName&#x3D;&lt;MethodName&gt;, parameterTypes&#x3D;null, arguments&#x3D;null, attachments&#x3D;&#123;path&#x3D;&lt;ServiceName&gt;, input&#x3D;348, dubbo&#x3D;2.0.2, version&#x3D;0.0.0&#125;]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>实际上消费端错误信息并不是很清晰，通过服务端日志，可以看到是在 rpc 解析时出现类无法找到的异常，该类 <ServiceName> 是接口参数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[New I&#x2F;O worker #10] WARN c.a.d.r.p.d.DecodeableRpcInvocation [Slf4jLogger.java : 62]  [DUBBO] Decode rpc invocation failed: Read invocation data failed.</span><br><span class="line">java.lang.ClassNotFoundException: &lt;ServiceName&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="EnableDubbo"><a href="#EnableDubbo" class="headerlink" title="@EnableDubbo"></a>@EnableDubbo</h3><p>用于启用 dubbo 服务，需要指定接口的包名提供扫描。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h2&gt;&lt;p&gt;接手了一个陈年的 dubbo 项目，现准备抽离某个模块，以前的聚合工程太大了，不想动，就另起了一个项目作为消费者调用之前的服务。&lt;br&gt;之前只在聚合项目中进行服务互调，现在两个项目之间完全独立，只通过 dubbo 交互，因此出现了一些问题，在此记录一下。&lt;/p&gt;</summary>
    
    
    
    <category term="微服务" scheme="http://daiwenzh5.github.io/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
    <category term="dubbo" scheme="http://daiwenzh5.github.io/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/dubbo/"/>
    
    
    <category term="dubbo" scheme="http://daiwenzh5.github.io/tags/dubbo/"/>
    
    <category term="springboot" scheme="http://daiwenzh5.github.io/tags/springboot/"/>
    
    <category term="踩坑日记" scheme="http://daiwenzh5.github.io/tags/%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0/"/>
    
  </entry>
  
</feed>
